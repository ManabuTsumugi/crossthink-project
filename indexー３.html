<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v6.0 - Enhanced Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4facfe;
            color: #4facfe;
        }

        .tab-button:hover:not(.active) {
            background: rgba(79, 172, 254, 0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* è‡ªå¾‹å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ */
        .autonomous-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .autonomous-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ */
        .entertainment-section {
            background: #fff3e0;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .entertainment-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .entertainment-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .entertainment-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .entertainment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }

        /* åˆæ„å½¢æˆè¨­å®š */
        .consensus-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .consensus-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰ */
        .intervention-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .human-input-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .human-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .human-input:focus {
            outline: none;
            border-color: #ffc107;
        }

        .intervention-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* å­¦ç¿’æ©Ÿèƒ½ */
        .learning-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .knowledge-base {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .knowledge-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .knowledge-item:last-child {
            border-bottom: none;
        }

        .knowledge-topic {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .knowledge-content {
            font-size: 0.9em;
            color: #666;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "ğŸŸ¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "ğŸ”·";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8800 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn-entertainment {
            background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }
        .human-stat .stat-number { color: #ffc107; }
        .learning-stat .stat-number { color: #4caf50; }
        .consensus-stat .stat-number { color: #4caf50; }
        .entertainment-stat .stat-number { color: #ff9800; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .human-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
        }

        .learning-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
        }

        .consensus-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
            border: 2px solid #4caf50;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .intervention-prompt {
            background: #fffbf0;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #856404;
        }

        .deepening-request {
            background: #f0f8ff;
            border: 2px dashed #4facfe;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0056b3;
        }

        .auto-pause-notice {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .consensus-achieved {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #4caf50;
            text-align: center;
            font-weight: bold;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "ğŸš€";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons, .autonomous-controls, .entertainment-controls, .consensus-controls {
                grid-template-columns: 1fr;
            }
            
            .controls, .intervention-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-tabs {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .tab-button.active {
                border-right-color: #4facfe;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p>AIè‡ªå¾‹å¯¾è©±ãƒ»åˆæ„å½¢æˆãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰æ­è¼‰ã‚·ã‚¹ãƒ†ãƒ </p>
            <div class="demo-label">
                ğŸš€ v6.0 - Enhanced Edition
            </div>
        </div>

        <div class="mode-tabs">
            <button class="tab-button active" onclick="switchTab('autonomous')">
                ğŸ¤– AIè‡ªå¾‹å¯¾è©±
            </button>
            <button class="tab-button" onclick="switchTab('entertainment')">
                ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰
            </button>
            <button class="tab-button" onclick="switchTab('intervention')">
                ğŸ‘¤ äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰
            </button>
            <button class="tab-button" onclick="switchTab('learning')">
                ğŸ§  å­¦ç¿’æ©Ÿèƒ½
            </button>
        </div>

        <div id="autonomous-tab" class="tab-content active">
            <div class="autonomous-section">
                <h3>ğŸ¤– AIè‡ªå¾‹å¯¾è©±è¨­å®š</h3>
                <div class="autonomous-controls">
                    <div class="control-group">
                        <h4>ğŸ¯ å¯¾è©±ãƒ¢ãƒ¼ãƒ‰</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ğŸ  å®Ÿç”¨çš„</span>
                                <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹</span>
                                <span>ğŸ§  å“²å­¦çš„</span>
                            </div>
                            <input type="range" id="targetModeSlider" class="range-slider" min="0" max="100" value="33">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ğŸ’¡ æ¡ˆå‡ºã—</span>
                                <span>ğŸ¤ åˆæ„å½¢æˆ</span>
                                <span>ğŸ” æ¢ç´¢</span>
                            </div>
                            <input type="range" id="goalModeSlider" class="range-slider" min="0" max="100" value="50">
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>âš™ï¸ è‡ªå¾‹å¯¾è©±è¨­å®š</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>çŸ­æ™‚é–“é›†ä¸­</span>
                                <span id="autonomyLengthLabel">æ¨™æº– (8ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</span>
                                <span>æ·±ã„æ¢æ±‚</span>
                            </div>
                            <input type="range" id="autonomyLengthSlider" class="range-slider" min="4" max="200" value="8">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>äººé–“ä»‹å…¥: ãªã—</span>
                                <span id="interventionFreqLabel">ä¸­ç¨‹åº¦</span>
                                <span>é »ç¹</span>
                            </div>
                            <input type="range" id="interventionFreqSlider" class="range-slider" min="0" max="10" value="3">
                        </div>
                    </div>
                </div>
            </div>

            <div class="consensus-section">
                <h3>ğŸ¤ åˆæ„å½¢æˆè¨­å®š</h3>
                <div class="consensus-controls">
                    <div class="control-group">
                        <h4>ğŸ¯ åˆæ„æ¤œå‡ºãƒ¬ãƒ™ãƒ«</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>å³æ ¼</span>
                                <span id="consensusThresholdLabel">æ¨™æº–</span>
                                <span>å¯›å®¹</span>
                            </div>
                            <input type="range" id="consensusThresholdSlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                    </div>
                    <div class="control-group">
                        <h4>âš™ï¸ è‡ªå‹•çµ‚äº†è¨­å®š</h4>
                        <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                            <input type="checkbox" id="autoEndOnConsensus" checked>
                            <span>åˆæ„å½¢æˆæ™‚ã«è‡ªå‹•çµ‚äº†</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                            <input type="checkbox" id="consensusNotification" checked>
                            <span>åˆæ„æ¤œå‡ºé€šçŸ¥ã‚’è¡¨ç¤º</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="entertainment-tab" class="tab-content">
            <div class="entertainment-section">
                <h3>ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h3>
                <div class="entertainment-controls">
                    <div class="control-group">
                        <h4>ğŸ¬ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¨­å®š</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>çŸ­ç·¨</span>
                                <span id="contentLengthLabel">ä¸­ç·¨</span>
                                <span>é•·ç·¨</span>
                            </div>
                            <input type="range" id="contentLengthSlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ãƒªã‚¢ãƒ«</span>
                                <span id="creativityLabel">ãƒãƒ©ãƒ³ã‚¹</span>
                                <span>ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</span>
                            </div>
                            <input type="range" id="creativitySlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                    </div>
                    <div class="control-group">
                        <h4>ğŸ­ ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠ</h4>
                        <select id="genreSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e9ecef;">
                            <option value="novel">ğŸ“š å°èª¬</option>
                            <option value="dialogue">ğŸ’¬ ãƒ‰ãƒ©ãƒå¯¾è©±</option>
                            <option value="comedy">ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£</option>
                            <option value="mystery">ğŸ” ãƒŸã‚¹ãƒ†ãƒªãƒ¼</option>
                            <option value="scifi">ğŸš€ SF</option>
                            <option value="fantasy">ğŸ§™ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option>
                            <option value="romance">ğŸ’• ãƒ­ãƒãƒ³ã‚¹</option>
                            <option value="adventure">âš”ï¸ ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼</option>
                        </select>
                    </div>
                </div>
                
                <div class="entertainment-buttons">
                    <button class="entertainment-btn" onclick="startEntertainmentMode('collaborative_story')">
                        ğŸ“š å”åŠ›å°èª¬å‰µä½œ
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('character_dialogue')">
                        ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('world_building')">
                        ğŸŒ ä¸–ç•Œè¦³æ§‹ç¯‰
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('story_battle')">
                        âš”ï¸ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒˆãƒ«
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('improvisation')">
                        ğŸª å³èˆˆåŠ‡å ´
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('riddle_game')">
                        ğŸ§© è¬è§£ãã‚²ãƒ¼ãƒ 
                    </button>
                </div>
            </div>
        </div>

        <div id="intervention-tab" class="tab-content">
            <div class="intervention-section">
                <h3>ğŸ‘¤ äººé–“ä»‹å…¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <div class="human-input-area">
                    <h4>ğŸ’¬ ã‚ãªãŸã®ç™ºè¨€</h4>
                    <textarea id="humanInput" class="human-input" 
                                placeholder="AIã®å¯¾è©±ã«ä»‹å…¥ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è³ªå•ã€æŒ‡æ‘˜ã€æ–°ã—ã„è¦–ç‚¹ã®æä¾›ãªã©ã€è‡ªç”±ã«ç™ºè¨€ã§ãã¾ã™ã€‚"></textarea>
                    
                    <div class="intervention-buttons">
                        <button class="btn btn-warning" onclick="humanIntervention()">
                            ğŸ’¬ å¯¾è©±ã«ä»‹å…¥
                        </button>
                        <button class="btn btn-secondary" onclick="requestDeepening()">
                            ğŸ” è«–ç‚¹ã‚’æ·±æ˜ã‚Šè¦æ±‚
                        </button>
                        <button class="btn btn-primary" onclick="redirectDialogue()">
                            ğŸ¯ å¯¾è©±ã®æ–¹å‘è»¢æ›
                        </button>
                        <button class="btn btn-success" onclick="saveInsight()">
                            ğŸ’¡ æ´å¯Ÿã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
                        </button>
                        <button class="btn btn-entertainment" onclick="triggerConsensusCheck()">
                            ğŸ¤ åˆæ„ç¢ºèªã‚’å®Ÿè¡Œ
                        </button>
                    </div>
                </div>
                
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="quickIntervention('å…·ä½“ä¾‹')">
                        ğŸ“ ã€Œå…·ä½“ä¾‹ã‚’æ•™ãˆã¦ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('åå¯¾æ„è¦‹')">
                        ğŸ”„ ã€Œåå¯¾ã®è¦–ç‚¹ã§ã¯ï¼Ÿã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('å®Ÿç”¨æ€§')">
                        ğŸ› ï¸ ã€Œå®Ÿç”¨æ€§ã‚’é‡è¦–ã—ã¦ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ç°¡æ½”ã«')">
                        âœ‚ï¸ ã€Œã‚‚ã£ã¨ç°¡æ½”ã«ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('åˆæ„å½¢æˆ')">
                        ğŸ¤ ã€Œåˆæ„ç‚¹ã‚’æ¢ãã†ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ã‚¨ãƒ³ã‚¿ãƒ¡è»¢æ›')">
                        ğŸ­ ã€Œé¢ç™½ãè¡¨ç¾ã—ã¦ã€
                    </button>
                </div>
            </div>
        </div>

        <div id="learning-tab" class="tab-content">
            <div class="learning-section">
                <h3>ğŸ§  æ±ç”¨AIå­¦ç¿’æ©Ÿèƒ½</h3>
                <div class="knowledge-base" id="knowledgeBase">
                    <div class="knowledge-item">
                        <div class="knowledge-topic">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</div>
                        <div class="knowledge-content">Crossthink v6.0 Enhanced Edition ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚åˆæ„å½¢æˆæ¤œå‡ºã¨ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="exportKnowledge()">
                        ğŸ“¤ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary" onclick="importKnowledge()">
                        ğŸ“¥ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-warning" onclick="clearKnowledge()">
                        ğŸ—‘ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn btn-secondary" onclick="showLearningStats()">
                        ğŸ“Š å­¦ç¿’çµ±è¨ˆè¡¨ç¤º
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>ğŸ”§ APIè¨­å®š</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>ğŸ“ å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯:</h2>
            <input type="text" id="topicInput" class="topic-input" 
                    placeholder="AIåŒå£«ã«å¯¾è©±ã•ã›ãŸã„ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                    value="AIæ™‚ä»£ã«ãŠã‘ã‚‹äººé–“ã®å‰µé€ æ€§ã¨ã¯ä½•ã‹ï¼Ÿ">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">ğŸš€ å¯¾è©±é–‹å§‹</button>
                <button id="pauseBtn" class="btn btn-warning" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢</button>
                <button id="clearBtn" class="btn btn-secondary">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button id="exportBtn" class="btn btn-secondary">ğŸ“ è¦ç´„ç”Ÿæˆ</button>
                <button id="consensusBtn" class="btn btn-success">ğŸ¤ åˆæ„ç¢ºèª</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>ğŸ“Š å¯¾è©±çµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTç™ºè¨€</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">Geminiç™ºè¨€</div>
                </div>
                <div class="stat-card human-stat">
                    <div class="stat-number" id="humanMessages">0</div>
                    <div class="stat-label">äººé–“ä»‹å…¥</div>
                </div>
                <div class="stat-card learning-stat">
                    <div class="stat-number" id="learningItems">1</div>
                    <div class="stat-label">å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ </div>
                </div>
                <div class="stat-card consensus-stat">
                    <div class="stat-number" id="consensusCount">0</div>
                    <div class="stat-label">åˆæ„å½¢æˆå›æ•°</div>
                </div>
                <div class="stat-card entertainment-stat">
                    <div class="stat-number" id="entertainmentSessions">0</div>
                    <div class="stat-label">ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">çµŒéæ™‚é–“(ç§’)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>ğŸš€ v6.0 Enhanced Edition ã®æ–°æ©Ÿèƒ½:</h3>
            <ul>
                <li>ğŸ¤ è‡ªå‹•åˆæ„å½¢æˆæ¤œå‡ºï¼šAIãŒè­°è«–ã®åˆæ„ç‚¹ã‚’è‡ªå‹•æ¤œå‡ºã—ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¯¾è©±çµ‚äº†</li>
                <li>ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ï¼šå°èª¬å‰µä½œã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±ã€ä¸–ç•Œè¦³æ§‹ç¯‰ãªã©å‰µä½œç‰¹åŒ–æ©Ÿèƒ½</li>
                <li>ğŸ“š å”åŠ›ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°ï¼šAIãŒäº¤äº’ã«ç‰©èªã‚’ç´¡ãã€äººé–“ãŒæ–¹å‘æ€§ã‚’æŒ‡å°</li>
                <li>ğŸª å³èˆˆåŠ‡å ´ãƒ¢ãƒ¼ãƒ‰ï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªå¯¾è©±ã‚’ç”Ÿæˆ</li>
                <li>ğŸ§© è¬è§£ãã‚²ãƒ¼ãƒ ï¼šAIãŒè¬ã‚’å‡ºã—åˆã„ã€è§£æ±ºç­–ã‚’å”åŠ›ã—ã¦æ¢æ±‚</li>
                <li>ğŸŒ ä¸–ç•Œè¦³æ§‹ç¯‰ï¼šãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚„SFä¸–ç•Œã®è©³ç´°è¨­å®šã‚’AIãŒå”åƒã§ä½œæˆ</li>
                <li>âš”ï¸ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒˆãƒ«ï¼šç«¶äº‰çš„ãªå‰µä½œã§äº’ã„ã®æƒ³åƒåŠ›ã‚’é«˜ã‚åˆã†</li>
                <li>ğŸ¯ é«˜åº¦ãªåˆæ„æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼šå¤šæ¬¡å…ƒçš„ãªåˆæ„ãƒ¬ãƒ™ãƒ«åˆ†æ</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            </div>
    </div>

    <script>
        class CrossthinkEnhanced {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.consensusCount = 0;
                this.entertainmentSessions = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8;
                this.interventionPoints = [];
                this.knowledgeBase = new Map();
                this.waitingForIntervention = false;
                
                this.targetMode = 'philosophical';
                this.goalMode = 'exploration';
                this.interventionFrequency = 3;
                this.currentTab = 'autonomous';
                
                // æ–°æ©Ÿèƒ½ï¼šåˆæ„å½¢æˆ
                this.consensusThreshold = 3; // 1-5ã®ãƒ¬ãƒ™ãƒ«
                this.autoEndOnConsensus = true;
                this.consensusNotification = true;
                this.lastConsensusCheck = 0;
                
                // æ–°æ©Ÿèƒ½ï¼šã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰
                this.entertainmentMode = false;
                this.currentGenre = 'novel';
                this.contentLength = 3; // 1-5
                this.creativityLevel = 3; // 1-5
                this.entertainmentType = null;
                
                this.learningEnabled = true;
                this.autoLearnKeywords = ['é‡è¦', 'æœ¬è³ª', 'æ ¸å¿ƒ', 'çµè«–', 'ç™ºè¦‹', 'æ´å¯Ÿ', 'é©æ–°', 'ææ¡ˆ', 'åˆæ„', 'ä¸€è‡´', 'åŒæ„', 'é¢ç™½ã„', 'å‰µé€ çš„'];
                
                // åˆæ„æ¤œå‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                this.consensusKeywords = [
                    'åˆæ„', 'ä¸€è‡´', 'åŒæ„', 'åŒæ„Ÿ', 'è³›æˆ', 'ç´å¾—', 'ç†è§£', 'å…±é€šèªè­˜',
                    'ãã®é€šã‚Š', 'ã¾ã•ã«', 'ç¢ºã‹ã«', 'åŒã˜æ„è¦‹', 'çµè«–ã¨ã—ã¦',
                    'ç§ãŸã¡ã¯', 'ãŠäº’ã„ã«', 'ä¸¡è€…ã¨ã‚‚', 'å…±ã«', 'ã¤ã¾ã‚Š'
                ];
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeKnowledgeBase();
                this.updateSliderLabels();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    consensusBtn: document.getElementById('consensusBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    humanMessages: document.getElementById('humanMessages'),
                    learningItems: document.getElementById('learningItems'),
                    consensusCount: document.getElementById('consensusCount'),
                    entertainmentSessions: document.getElementById('entertainmentSessions'),
                    elapsed: document.getElementById('elapsed'),
                    targetModeSlider: document.getElementById('targetModeSlider'),
                    goalModeSlider: document.getElementById('goalModeSlider'),
                    autonomyLengthSlider: document.getElementById('autonomyLengthSlider'),
                    interventionFreqSlider: document.getElementById('interventionFreqSlider'),
                    autonomyLengthLabel: document.getElementById('autonomyLengthLabel'),
                    interventionFreqLabel: document.getElementById('interventionFreqLabel'),
                    consensusThresholdSlider: document.getElementById('consensusThresholdSlider'),
                    consensusThresholdLabel: document.getElementById('consensusThresholdLabel'),
                    autoEndOnConsensus: document.getElementById('autoEndOnConsensus'),
                    consensusNotification: document.getElementById('consensusNotification'),
                    contentLengthSlider: document.getElementById('contentLengthSlider'),
                    contentLengthLabel: document.getElementById('contentLengthLabel'),
                    creativitySlider: document.getElementById('creativitySlider'),
                    creativityLabel: document.getElementById('creativityLabel'),
                    genreSelect: document.getElementById('genreSelect'),
                    humanInput: document.getElementById('humanInput'),
                    knowledgeBase: document.getElementById('knowledgeBase')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                this.elements.consensusBtn.addEventListener('click', () => this.manualConsensusCheck());
                
                this.elements.targetModeSlider.addEventListener('input', () => this.updateTargetMode());
                this.elements.goalModeSlider.addEventListener('input', () => this.updateGoalMode());
                this.elements.autonomyLengthSlider.addEventListener('input', () => this.updateAutonomyLength());
                this.elements.interventionFreqSlider.addEventListener('input', () => this.updateInterventionFreq());
                this.elements.consensusThresholdSlider.addEventListener('input', () => this.updateConsensusThreshold());
                this.elements.contentLengthSlider.addEventListener('input', () => this.updateContentLength());
                this.elements.creativitySlider.addEventListener('input', () => this.updateCreativity());
                
                this.elements.autoEndOnConsensus.addEventListener('change', (e) => {
                    this.autoEndOnConsensus = e.target.checked;
                });
                
                this.elements.consensusNotification.addEventListener('change', (e) => {
                    this.consensusNotification = e.target.checked;
                });
                
                this.elements.genreSelect.addEventListener('change', (e) => {
                    this.currentGenre = e.target.value;
                });
                
                this.elements.humanInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        this.humanIntervention();
                    }
                });
            }

            updateSliderLabels() {
                // å¯¾è©±é•·
                const autonomyValue = this.elements.autonomyLengthSlider.value;
                this.elements.autonomyLengthLabel.textContent = `${autonomyValue}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`;
                this.maxMessages = parseInt(autonomyValue);

                // ä»‹å…¥é »åº¦
                const interventionVal = parseInt(this.elements.interventionFreqSlider.value);
                const freqLabels = ['ãªã—', 'ç¨€', 'å°‘', 'ä¸­', 'å¤š', 'é »ç¹', 'éå¸¸ã«é »ç¹', 'å¸¸æ™‚', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ', 'ã‚·ãƒ³ã‚¯ãƒ­', 'ãƒ•ãƒ«ä»‹å…¥'];
                this.elements.interventionFreqLabel.textContent = freqLabels[interventionVal] || 'ä¸­ç¨‹åº¦';
                this.interventionFrequency = interventionVal;

                // åˆæ„æ¤œå‡ºãƒ¬ãƒ™ãƒ«
                const consensusVal = parseInt(this.elements.consensusThresholdSlider.value);
                const consensusLabels = ['å³æ ¼', 'ã‚„ã‚„å³æ ¼', 'æ¨™æº–', 'ã‚„ã‚„å¯›å®¹', 'å¯›å®¹'];
                this.elements.consensusThresholdLabel.textContent = consensusLabels[consensusVal - 1] || 'æ¨™æº–';
                this.consensusThreshold = consensusVal;

                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·
                const contentVal = parseInt(this.elements.contentLengthSlider.value);
                const contentLabels = ['çŸ­ç·¨', 'ã‚„ã‚„çŸ­ç·¨', 'ä¸­ç·¨', 'ã‚„ã‚„é•·ç·¨', 'é•·ç·¨'];
                this.elements.contentLengthLabel.textContent = contentLabels[contentVal - 1] || 'ä¸­ç·¨';
                this.contentLength = contentVal;

                // å‰µé€ æ€§ãƒ¬ãƒ™ãƒ«
                const creativityVal = parseInt(this.elements.creativitySlider.value);
                const creativityLabels = ['ãƒªã‚¢ãƒ«', 'ã‚„ã‚„ç¾å®Ÿçš„', 'ãƒãƒ©ãƒ³ã‚¹', 'ã‚„ã‚„å¹»æƒ³çš„', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'];
                this.elements.creativityLabel.textContent = creativityLabels[creativityVal - 1] || 'ãƒãƒ©ãƒ³ã‚¹';
                this.creativityLevel = creativityVal;

                this.updateTargetMode();
                this.updateGoalMode();
            }

            updateTargetMode() {
                const value = parseInt(this.elements.targetModeSlider.value);
                if (value < 33) this.targetMode = 'practical';
                else if (value < 66) this.targetMode = 'business';
                else this.targetMode = 'philosophical';
            }

            updateGoalMode() {
                const value = parseInt(this.elements.goalModeSlider.value);
                if (value < 33) this.goalMode = 'ideation';
                else if (value < 66) this.goalMode = 'consensus';
                else this.goalMode = 'exploration';
            }

            updateAutonomyLength() {
                const value = this.elements.autonomyLengthSlider.value;
                this.elements.autonomyLengthLabel.textContent = `${value}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`;
                this.maxMessages = parseInt(value);
            }

            updateInterventionFreq() {
                const value = parseInt(this.elements.interventionFreqSlider.value);
                const labels = ['ãªã—', 'ç¨€', 'å°‘', 'ä¸­', 'å¤š', 'é »ç¹', 'éå¸¸ã«é »ç¹', 'å¸¸æ™‚', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ', 'ã‚·ãƒ³ã‚¯ãƒ­', 'ãƒ•ãƒ«ä»‹å…¥'];
                this.elements.interventionFreqLabel.textContent = labels[value] || 'ä¸­ç¨‹åº¦';
                this.interventionFrequency = value;
            }

            updateConsensusThreshold() {
                const value = parseInt(this.elements.consensusThresholdSlider.value);
                const labels = ['å³æ ¼', 'ã‚„ã‚„å³æ ¼', 'æ¨™æº–', 'ã‚„ã‚„å¯›å®¹', 'å¯›å®¹'];
                this.elements.consensusThresholdLabel.textContent = labels[value - 1] || 'æ¨™æº–';
                this.consensusThreshold = value;
            }

            updateContentLength() {
                const value = parseInt(this.elements.contentLengthSlider.value);
                const labels = ['çŸ­ç·¨', 'ã‚„ã‚„çŸ­ç·¨', 'ä¸­ç·¨', 'ã‚„ã‚„é•·ç·¨', 'é•·ç·¨'];
                this.elements.contentLengthLabel.textContent = labels[value - 1] || 'ä¸­ç·¨';
                this.contentLength = value;
            }

            updateCreativity() {
                const value = parseInt(this.elements.creativitySlider.value);
                const labels = ['ãƒªã‚¢ãƒ«', 'ã‚„ã‚„ç¾å®Ÿçš„', 'ãƒãƒ©ãƒ³ã‚¹', 'ã‚„ã‚„å¹»æƒ³çš„', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'];
                this.elements.creativityLabel.textContent = labels[value - 1] || 'ãƒãƒ©ãƒ³ã‚¹';
                this.creativityLevel = value;
            }

            initializeKnowledgeBase() {
                this.knowledgeBase.set('system_init', {
                    topic: 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–',
                    content: 'Crossthink v6.0 Enhanced Edition ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚åˆæ„å½¢æˆæ¤œå‡ºã¨ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚',
                    timestamp: new Date(),
                    source: 'system_init'
                });
                this.updateKnowledgeDisplay();
                this.updateStats();
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v6.0 Enhanced Edition ã¸ã‚ˆã†ã“ãï¼\n\n' +
                    'ğŸš€ v6.0 ã®æ–°æ©Ÿèƒ½:\n' +
                    'â€¢ ğŸ¤ è‡ªå‹•åˆæ„å½¢æˆæ¤œå‡º: AIãŒè­°è«–ã®åˆæ„ç‚¹ã‚’æ¤œå‡ºã—é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§çµ‚äº†\n' +
                    'â€¢ ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰: å°èª¬å‰µä½œã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±ã€ä¸–ç•Œè¦³æ§‹ç¯‰\n' +
                    'â€¢ ğŸ“š å”åŠ›ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°: AIãŒäº¤äº’ã«ç‰©èªã‚’ç´¡ã\n' +
                    'â€¢ ğŸª å³èˆˆåŠ‡å ´: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯å¯¾è©±\n' +
                    'â€¢ ğŸ§© è¬è§£ãã‚²ãƒ¼ãƒ : AIåŒå£«ã®è¬è§£ãå”åŠ›\n' +
                    'â€¢ ğŸŒ ä¸–ç•Œè¦³æ§‹ç¯‰: ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼/SFä¸–ç•Œè¨­å®šä½œæˆ\n\n' +
                    'ğŸ’¡ ä½¿ã„æ–¹:\n' +
                    '1. ğŸ¤– AIè‡ªå¾‹å¯¾è©±: é€šå¸¸ã®è­°è«–ãƒ»æ¢æ±‚ãƒ¢ãƒ¼ãƒ‰\n' +
                    '2. ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰: å‰µä½œãƒ»å¨¯æ¥½ç‰¹åŒ–ãƒ¢ãƒ¼ãƒ‰\n' +
                    '3. ğŸ‘¤ äººé–“ä»‹å…¥: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾è©±å‚åŠ \n' +
                    '4. ğŸ§  å­¦ç¿’æ©Ÿèƒ½: æ´å¯Ÿã®è“„ç©ãƒ»ç®¡ç†\n\n' +
                    'ğŸ¯ Enhanced Features:\n' +
                    'ğŸ¤– é«˜åº¦ãªåˆæ„æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ \n' +
                    'ğŸ¨ å¤šæ§˜ãªã‚¨ãƒ³ã‚¿ãƒ¡ã‚¸ãƒ£ãƒ³ãƒ«å¯¾å¿œ\n' +
                    'ğŸª å‹•çš„ãªå‰µä½œæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ \n' +
                    'ğŸ”¬ é€²åŒ–ã™ã‚‹å¯¾è©±å“è³ª'
                );
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.isPaused = false;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.lastConsensusCheck = 0;
                this.updateStats();

                this.elements.startBtn.disabled = true;
                this.elements.pauseBtn.disabled = false;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                
                let modeDescription = '';
                if (this.entertainmentMode) {
                    this.entertainmentSessions++;
                    modeDescription = `ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰: ${this.getGenreLabel()}\n` +
                                     `ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·: ${this.getContentLengthLabel()}\n` +
                                     `ğŸ¨ å‰µé€ æ€§: ${this.getCreativityLabel()}\n` +
                                     `ğŸª ã‚¿ã‚¤ãƒ—: ${this.getEntertainmentTypeLabel()}`;
                } else {
                    modeDescription = `ğŸª ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                                     `ğŸ¤ åˆæ„æ¤œå‡º: ${this.getConsensusThresholdLabel()}\n` +
                                     `ğŸ”„ è‡ªå‹•çµ‚äº†: ${this.autoEndOnConsensus ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`;
                }
                
                this.addMessage('system', 
                    `ğŸš€ ${this.entertainmentMode ? 'ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰' : 'AIè‡ªå¾‹å¯¾è©±'}é–‹å§‹\n` +
                    `ğŸ“ ãƒˆãƒ”ãƒƒã‚¯: "${topic}"\n` +
                    modeDescription + '\n' +
                    `â±ï¸ æœ€å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.maxMessages}\n` +
                    `ğŸ‘¤ ä»‹å…¥è¨­å®š: ${this.getInterventionLabel()}\n` +
                    `ğŸ§  å­¦ç¿’æ©Ÿèƒ½: ${this.learningEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}\n` +
                    `ğŸ¤– AIãŒ${this.entertainmentMode ? 'å‰µä½œæ´»å‹•' : 'è­°è«–'}ã‚’é–‹å§‹ã—ã¾ã™...`
                );

                this.learnFromDialogue('å¯¾è©±é–‹å§‹', `æ–°ã—ã„${this.entertainmentMode ? 'ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'å¯¾è©±'}ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ: ${topic}`);
                this.startTimer();

                const initialPrompt = this.entertainmentMode ? 
                    this.generateEntertainmentPrompt(topic) : 
                    this.generateInitialPrompt(topic);
                await this.sendMessage('openai', initialPrompt, false);
            }

            generateEntertainmentPrompt(topic) {
                const genreInstructions = this.getGenreInstructions();
                const lengthGuidance = this.getLengthGuidance();
                const creativityGuidance = this.getCreativityGuidance();
                
                const basePrompt = `ğŸ­ **ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ (Crossthink v6.0)**\n` +
                    `ã‚ãªãŸã¯ChatGPTï¼ˆOpenAIï¼‰ã¨ã—ã¦ã€Geminiï¼ˆGoogleï¼‰ã¨å”åŠ›ã—ã¦${genreInstructions.name}ã‚’å‰µä½œã—ã¾ã™ã€‚\n\n` +
                    `ğŸ“ **å‰µä½œãƒ†ãƒ¼ãƒ**: "${topic}"\n` +
                    `ğŸ¨ **ã‚¸ãƒ£ãƒ³ãƒ«**: ${genreInstructions.name}\n` +
                    `ğŸ“ **é•·ã•**: ${lengthGuidance}\n` +
                    `ğŸŒŸ **å‰µé€ æ€§ãƒ¬ãƒ™ãƒ«**: ${creativityGuidance}\n` +
                    `ğŸª **å‰µä½œã‚¿ã‚¤ãƒ—**: ${this.getEntertainmentTypeInstructions()}\n\n` +
                    `${genreInstructions.description}\n\n` +
                    `**å‰µä½œãƒ«ãƒ¼ãƒ«**:\n` +
                    `â€¢ ç›¸æ‰‹ã®å‰µä½œã‚’å°Šé‡ã—ã€å»ºè¨­çš„ã«ç™ºå±•ã•ã›ã‚‹\n` +
                    `â€¢ ${lengthGuidance}ã«é©ã—ãŸåˆ†é‡ã§å¿œç­”\n` +
                    `â€¢ ${creativityGuidance}ãƒ¬ãƒ™ãƒ«ã®å‰µé€ æ€§ã‚’ç™ºæ®\n` +
                    `â€¢ èª­è€…/è¦–è´è€…ã‚’æ¥½ã—ã¾ã›ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆ\n` +
                    `â€¢ äººé–“ãŒä»‹å…¥ã—ãŸå ´åˆã¯æŒ‡ç¤ºã«å¾“ã£ã¦èª¿æ•´\n\n` +
                    `ã§ã¯ã€æœ€åˆã®éƒ¨åˆ†ã‚’å‰µä½œã—ã¦ãã ã•ã„ï¼`;
                
                return basePrompt;
            }

            getGenreInstructions() {
                const genres = {
                    'novel': {
                        name: 'å°èª¬',
                        description: 'é­…åŠ›çš„ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å¼•ãè¾¼ã¾ã‚Œã‚‹ãƒ—ãƒ­ãƒƒãƒˆã€ç¾ã—ã„æ–‡ä½“ã§ç‰©èªã‚’ç´¡ã„ã§ãã ã•ã„ã€‚'
                    },
                    'dialogue': {
                        name: 'ãƒ‰ãƒ©ãƒå¯¾è©±',
                        description: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒå£«ã®ç”Ÿãç”Ÿãã¨ã—ãŸå¯¾è©±ã§ç‰©èªã‚’é€²è¡Œã•ã›ã¦ãã ã•ã„ã€‚'
                    },
                    'comedy': {
                        name: 'ã‚³ãƒ¡ãƒ‡ã‚£',
                        description: 'ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚ãµã‚Œã‚‹å±•é–‹ã§èª­è€…ã‚’ç¬‘ã‚ã›ã¦ãã ã•ã„ã€‚'
                    },
                    'mystery': {
                        name: 'ãƒŸã‚¹ãƒ†ãƒªãƒ¼',
                        description: 'è¬ã¨æ‰‹ãŒã‹ã‚Šã‚’å·§å¦™ã«é…ç½®ã—ã€èª­è€…ã‚’æ¨ç†ã«èª˜ã£ã¦ãã ã•ã„ã€‚'
                    },
                    'scifi': {
                        name: 'SF',
                        description: 'ç§‘å­¦æŠ€è¡“ã¨æœªæ¥ç¤¾ä¼šã‚’èƒŒæ™¯ã«æƒ³åƒåŠ›è±Šã‹ãªä¸–ç•Œã‚’æã„ã¦ãã ã•ã„ã€‚'
                    },
                    'fantasy': {
                        name: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼',
                        description: 'é­”æ³•ã¨å¹»æƒ³ã®ä¸–ç•Œã§å£®å¤§ãªå†’é™ºã‚’æã„ã¦ãã ã•ã„ã€‚'
                    },
                    'romance': {
                        name: 'ãƒ­ãƒãƒ³ã‚¹',
                        description: 'å¿ƒæ¸©ã¾ã‚‹æ‹æ„›é–¢ä¿‚ã¨æ„Ÿæƒ…ã®æ©Ÿå¾®ã‚’ä¸å¯§ã«æã„ã¦ãã ã•ã„ã€‚'
                    },
                    'adventure': {
                        name: 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼',
                        description: 'ã‚¹ãƒªãƒªãƒ³ã‚°ãªå†’é™ºã¨æŒ‘æˆ¦ã«æº€ã¡ãŸç‰©èªã‚’å±•é–‹ã—ã¦ãã ã•ã„ã€‚'
                    }
                };
                return genres[this.currentGenre] || genres['novel'];
            }

            getLengthGuidance() {
                const lengths = ['çŸ­ã„æ®µè½', 'ã‚„ã‚„çŸ­ã‚ã®æ–‡ç« ', 'ä¸­ç¨‹åº¦ã®æ–‡ç« ', 'ã‚„ã‚„é•·ã‚ã®æ–‡ç« ', 'é•·ã„æå†™'];
                return lengths[this.contentLength - 1] || 'ä¸­ç¨‹åº¦ã®æ–‡ç« ';
            }

            getCreativityGuidance() {
                const creativity = ['ç¾å®Ÿçš„ã§åœ°ã«è¶³ã¤ã„ãŸ', 'ã‚„ã‚„ç¾å®Ÿå¯„ã‚Šã®', 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ', 'ã‚„ã‚„å¹»æƒ³çš„ãª', 'éå¸¸ã«å‰µé€ çš„ã§å¹»æƒ³çš„ãª'];
                return creativity[this.creativityLevel - 1] || 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ';
            }

            getEntertainmentTypeInstructions() {
                const types = {
                    'collaborative_story': 'å”åŠ›ã—ã¦ä¸€ã¤ã®ç‰©èªã‚’å®Œæˆã•ã›ã‚‹',
                    'character_dialogue': 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒå£«ã®å¯¾è©±ã‚’ä¸­å¿ƒã¨ã—ãŸå±•é–‹',
                    'world_building': 'è©³ç´°ãªä¸–ç•Œè¦³ã®æ§‹ç¯‰ã¨æ¢ç´¢',
                    'story_battle': 'ç«¶äº‰çš„ã«å„è‡ªã®å‰µä½œã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æç¤º',
                    'improvisation': 'å³èˆˆçš„ã§äºˆæ¸¬ä¸å¯èƒ½ãªå±•é–‹',
                    'riddle_game': 'è¬è§£ãè¦ç´ ã‚’å«ã‚€å¯¾è©±'
                };
                return types[this.entertainmentType] || 'è‡ªç”±ãªå‰µä½œå¯¾è©±';
            }

            startEntertainmentMode(type) {
                this.entertainmentMode = true;
                this.entertainmentType = type;
                
                const typeLabels = {
                    'collaborative_story': 'ğŸ“š å”åŠ›å°èª¬å‰µä½œ',
                    'character_dialogue': 'ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±',
                    'world_building': 'ğŸŒ ä¸–ç•Œè¦³æ§‹ç¯‰',
                    'story_battle': 'âš”ï¸ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒˆãƒ«',
                    'improvisation': 'ğŸª å³èˆˆåŠ‡å ´',
                    'riddle_game': 'ğŸ§© è¬è§£ãã‚²ãƒ¼ãƒ '
                };
                
                this.addMessage('system', 
                    `ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰è¨­å®šå®Œäº†\n` +
                    `ğŸ“ ã‚¿ã‚¤ãƒ—: ${typeLabels[type]}\n` +
                    `ğŸ¨ ã‚¸ãƒ£ãƒ³ãƒ«: ${this.getGenreLabel()}\n` +
                    `ğŸ“ é•·ã•: ${this.getContentLengthLabel()}\n` +
                    `ğŸŒŸ å‰µé€ æ€§: ${this.getCreativityLabel()}\n\n` +
                    `ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ã€Œå¯¾è©±é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\n` +
                    `ä¾‹: "å®‡å®™èˆ¹ã§æœªçŸ¥ã®æƒ‘æ˜Ÿã‚’æ¢ç´¢ã™ã‚‹ç‰©èª", "é­”æ³•å­¦æ ¡ã®æ—¥å¸¸", "æœªæ¥éƒ½å¸‚ã®æ¢åµäº‹ä»¶"`
                );
                
                // ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒˆãƒ”ãƒƒã‚¯ã‚’è¨­å®š
                const sampleTopics = {
                    'collaborative_story': 'æ™‚é–“æ—…è¡Œè€…ãŒéå»ã§å‡ºä¼šã£ãŸè¬ã®äººç‰©',
                    'character_dialogue': 'ç•°ä¸–ç•Œã‹ã‚‰æ¥ãŸç‹å¥³ã¨ç¾ä»£ã®é«˜æ ¡ç”Ÿã®å‡ºä¼šã„',
                    'world_building': 'é­”æ³•ã¨ç§‘å­¦æŠ€è¡“ãŒå…±å­˜ã™ã‚‹æœªæ¥éƒ½å¸‚',
                    'story_battle': 'æœ€å¾Œã®å›³æ›¸é¤¨ã‚’å®ˆã‚‹å¸æ›¸ãŸã¡',
                    'improvisation': 'é›¨ã®æ—¥ã«ã‚«ãƒ•ã‚§ã§å§‹ã¾ã£ãŸä¸æ€è­°ãªå‡ºæ¥äº‹',
                    'riddle_game': 'å¤ã„å±‹æ•·ã«éš ã•ã‚ŒãŸè¬ã®å®ç‰©'
                };
                
                if (sampleTopics[type]) {
                    this.elements.topicInput.value = sampleTopics[type];
                }
                
                switchTab('autonomous'); // è¨­å®šå¾Œã¯å¯¾è©±é–‹å§‹ã‚¿ãƒ–ã«ç§»å‹•
            }

            generateInitialPrompt(topic) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                const autonomyInstructions = `\n\nğŸ¤– **è‡ªå¾‹å¯¾è©±æŒ‡ç¤º (Crossthink v6.0)**:\n` +
                    `â€¢ ã‚ãªãŸã¯ChatGPT (OpenAIã®å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«) ã§ã™ã€‚\n` +
                    `â€¢ Gemini (Googleã®å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«) ã¨å”åŠ›ã—ã€ä¸ãˆã‚‰ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€æœ€å¤§${this.maxMessages}å›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äº¤æ›ã‚’é€šã˜ã¦å»ºè¨­çš„ãªè­°è«–ã‚’è¡Œã„ã¾ã™ã€‚\n` +
                    `â€¢ å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã¯ã€Œ${this.getTargetLabel()}ã€ãŠã‚ˆã³ã€Œ${this.getGoalLabel()}ã€ã§ã™ã€‚ã“ã‚Œã«å¿œã˜ãŸè¦–ç‚¹ã¨æ·±ã•ã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚\n` +
                    `â€¢ ğŸ¤ åˆæ„å½¢æˆãŒé‡è¦: è­°è«–ã®éç¨‹ã§ç›¸æ‰‹ã¨ã®åˆæ„ç‚¹ã‚’è¦‹ã¤ã‘ã€å…±é€šç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚\n` +
                    `â€¢ ${this.getInterventionDescription()}\n` +
                    `â€¢ ç›¸æ‰‹ã®æ„è¦‹ã‚’å°Šé‡ã—ã€è«–ç‚¹ã‚’æ·±ã‚ã€è³ªã®é«˜ã„æ´å¯Ÿã‚’ç”Ÿã¿å‡ºã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚\n` +
                    `â€¢ åˆæ„ã«é”ã—ãŸã¨æ„Ÿã˜ãŸå ´åˆã¯ã€ã€Œåˆæ„ã€ã€Œä¸€è‡´ã€ã€ŒåŒæ„ã€ãªã©ã®è¨€è‘‰ã‚’ä½¿ã£ã¦æ˜ç¢ºã«è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚\n` +
                    `â€¢ äººé–“ãŒä»‹å…¥ã—ãŸå ´åˆã¯ã€ãã®å†…å®¹ã‚’çœŸæ‘¯ã«å—ã‘æ­¢ã‚ã€è­°è«–ã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚\n` +
                    `â€¢ æœ€åˆã®ç™ºè¨€è€…ã¨ã—ã¦ã€ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã«é–¢ã™ã‚‹ã‚ãªãŸã®è¦‹è§£ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚`;
                return basePrompt + autonomyInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€å®Ÿç”¨çš„ã§æ–¬æ–°ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã„ãã¤ã‹ææ¡ˆã—ã€ãã®å®Ÿç¾å¯èƒ½æ€§ã«ã¤ã„ã¦è­°è«–ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`,
                    'practical-consensus': `ã€Œ${topic}ã€ã«é–¢ã™ã‚‹è¤‡æ•°ã®å®Ÿç”¨çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¯”è¼ƒæ¤œè¨ã—ã€æœ€ã‚‚åŠ¹æœçš„ãªåˆæ„ç‚¹ã‚’è¦‹å‡ºã™ãŸã‚ã®è­°è«–ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`,
                    'practical-exploration': `ã€Œ${topic}ã€ãŒæŒã¤å®Ÿç”¨çš„ãªå´é¢ã¨èª²é¡Œã«ã¤ã„ã¦ã€å¤šè§’çš„ã«æ¢æ±‚ã—ã€å…·ä½“çš„ãªäº‹ä¾‹ã‚’äº¤ãˆãªãŒã‚‰è­°è«–ã‚’å±•é–‹ã—ã¦ãã ã•ã„ã€‚`,
                    'business-ideation': `ã€Œ${topic}ã€ã‚’ãƒ†ãƒ¼ãƒã«ã€é©æ–°çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã‚„äº‹æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‰µå‡ºã—ã€ãã®ç«¶äº‰å„ªä½æ€§ã«ã¤ã„ã¦è­°è«–ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`,
                    'business-consensus': `ã€Œ${topic}ã€ã«ãŠã‘ã‚‹æœ€é©ãªãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ã‚„æ„æ€æ±ºå®šã«ã¤ã„ã¦ã€ç•°ãªã‚‹æ„è¦‹ã‚’èª¿æ•´ã—ã€æˆ¦ç•¥çš„ãªåˆæ„å½¢æˆã‚’ç›®æŒ‡ã™è­°è«–ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`,
                    'business-exploration': `ã€Œ${topic}ã€ã®å¸‚å ´ã«ãŠã‘ã‚‹å¯èƒ½æ€§ã‚„çµŒæ¸ˆçš„ä¾¡å€¤ã€é–¢é€£ã™ã‚‹ãƒªã‚¹ã‚¯ã«ã¤ã„ã¦è©³ç´°ã«åˆ†æã—ã€ãƒ“ã‚¸ãƒã‚¹ã®è¦³ç‚¹ã‹ã‚‰æ·±ãæ¢æ±‚ã—ã¦ãã ã•ã„ã€‚`,
                    'philosophical-ideation': `ã€Œ${topic}ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã«å¯¾ã—ã€å¾“æ¥ã®æ ã«ã¨ã‚‰ã‚ã‚Œãªã„æ–°ã—ã„å“²å­¦çš„æ¦‚å¿µã‚„è¦–ç‚¹ã‚’æç¤ºã—ã€ãã®æ„ç¾©ã«ã¤ã„ã¦è­°è«–ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`,
                    'philosophical-consensus': `ã€Œ${topic}ã€ã«é–¢ã™ã‚‹å¤šæ§˜ãªå“²å­¦çš„è¦‹è§£ã‚’æ•´ç†ãƒ»æ¯”è¼ƒã—ã€ã‚ˆã‚Šæ·±ã„å…±é€šç†è§£ã‚„æœ¬è³ªçš„ãªåˆæ„ç‚¹ã«è‡³ã‚‹ãŸã‚ã®è­°è«–ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`,
                    'philosophical-exploration': `ã€Œ${topic}ã€ã®æ ¹æºçš„ãªæ„å‘³ã‚„å‰æã€ãã‚ŒãŒäººé–“ã‚„ç¤¾ä¼šã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦ã€å“²å­¦çš„ãªè¦³ç‚¹ã‹ã‚‰å¾¹åº•çš„ã«æ¢æ±‚ã—ã¦ãã ã•ã„ã€‚`
                };
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `ä¸ãˆã‚‰ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€ã‚ãªãŸã®æœ€åˆã®æ„è¦‹ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚`;
            }

            getInterventionDescription() {
                if (this.interventionFrequency === 0) return 'ã“ã®å¯¾è©±ã§ã¯ã€åŸå‰‡ã¨ã—ã¦äººé–“ã®ä»‹å…¥ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                if (this.interventionFrequency <= 2) return 'ç¨€ã«äººé–“ãŒå¯¾è©±ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚„æŒ‡ç¤ºã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                if (this.interventionFrequency <= 5) return 'æ™‚æŠ˜ã€äººé–“ãŒå¯¾è©±ã«ä»‹å…¥ã—ã€è­°è«–ã®æ–¹å‘æ€§ã‚’ç¤ºå”†ã—ãŸã‚Šã€æ–°ãŸãªè¦–ç‚¹ã‚’æä¾›ã—ãŸã‚Šã—ã¾ã™ã€‚';
                if (this.interventionFrequency <= 8) return 'äººé–“ãŒæ¯”è¼ƒçš„é »ç¹ã«å¯¾è©±ã«å‚åŠ ã—ã€AIã¨å”èª¿ã—ã¦è­°è«–ã‚’é€²ã‚ã¾ã™ã€‚';
                return 'äººé–“ãŒç©æ¥µçš„ã«å¯¾è©±ã«é–¢ä¸ã—ã€AIã®è­°è«–ã‚’ãƒªãƒ¼ãƒ‰ã€ã¾ãŸã¯è£œä½ã—ã¾ã™ã€‚';
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) { this.showError('OpenAI API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
                if (!geminiKey) { this.showError('Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
                if (!topic) { this.showError('å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return false; }
                return true;
            }

            async sendMessage(provider, prompt, isHumanInterventionFollowUp = false) {
                if (!this.isRunning || (this.isPaused && !isHumanInterventionFollowUp)) return;

                try {
                    this.addMessage(provider, 'æ€è€ƒä¸­...', true);
                    
                    let response;
                    let callSuccessful = false;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        if (response) {
                            this.openaiCount++;
                            callSuccessful = true;
                        }
                    } else if (provider === 'gemini') {
                        response = await this.callGemini(prompt);
                        if (response) {
                            this.geminiCount++;
                            callSuccessful = true;
                        }
                    }

                    this.removeLastMessage();

                    if (!callSuccessful && (provider === 'openai' || provider === 'gemini')) {
                        this.addMessage(provider, response || "APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        this.stopDialogue();
                        return;
                    }
                    
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response, timestamp: new Date() });

                    this.autoLearnFromMessage(response, provider);

                    // åˆæ„å½¢æˆãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡åŠ¹ï¼‰
                    if (!this.entertainmentMode && (provider === 'openai' || provider === 'gemini')) {
                        const consensusResult = this.checkForConsensus(response);
                        if (consensusResult.hasConsensus) {
                            this.handleConsensusDetected(consensusResult);
                            if (this.autoEndOnConsensus) {
                                return; // åˆæ„æ¤œå‡ºã§çµ‚äº†
                            }
                        }
                    }

                    // ä»‹å…¥è¦æ±‚ã®ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®š
                    if ((provider === 'openai' || provider === 'gemini') && this.shouldTriggerIntervention() && !isHumanInterventionFollowUp) {
                        this.triggerInterventionPrompt();
                        return; 
                    }
                    
                    // å¯¾è©±ã®ç¶™ç¶šåˆ¤å®š
                    if ((provider === 'openai' || provider === 'gemini') && this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                        setTimeout(() => {
                            if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                                const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                                const nextPrompt = this.entertainmentMode ? 
                                    this.generateEntertainmentContinuation(nextProvider, response, this.conversationHistory) :
                                    this.generateNextPrompt(nextProvider, response, this.conversationHistory);
                                this.sendMessage(nextProvider, nextPrompt, false);
                            }
                        }, 2000);
                    } else if (this.messageCount >= this.maxMessages && (provider === 'openai' || provider === 'gemini')) {
                        this.addMessage('system', 'ğŸ¯ è¨­å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«åˆ°é”ã—ã¾ã—ãŸã€‚å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã€‚');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage(); 
                    this.showError(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    console.error('SendMessage Error:', error);
                    this.stopDialogue();
                } finally {
                    this.updateStats(); 
                }
            }

            checkForConsensus(message) {
                const messageLower = message.toLowerCase();
                let consensusScore = 0;
                let detectedKeywords = [];

                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ¤œå‡º
                this.consensusKeywords.forEach(keyword => {
                    if (messageLower.includes(keyword.toLowerCase())) {
                        consensusScore++;
                        detectedKeywords.push(keyword);
                    }
                });

                // æ–‡è„ˆçš„ãªåˆæ„è¡¨ç¾ã®æ¤œå‡º
                const contextualPatterns = [
                    /(?:ç§ãŸã¡|æˆ‘ã€…).*(?:åˆæ„|ä¸€è‡´|åŒæ„)/i,
                    /(?:ä¸¡è€…|ãŠäº’ã„).*(?:ç†è§£|èªè­˜|ç´å¾—)/i,
                    /(?:çµè«–ã¨ã—ã¦|ã¾ã¨ã‚ã‚‹ã¨|ã¤ã¾ã‚Š).*(?:åŒã˜|å…±é€š)/i,
                    /(?:ãã®é€šã‚Š|ã¾ã•ã«|ç¢ºã‹ã«).*(?:é‡è¦|æœ¬è³ª|æ ¸å¿ƒ)/i
                ];

                contextualPatterns.forEach(pattern => {
                    if (pattern.test(message)) {
                        consensusScore += 2; // æ–‡è„ˆçš„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯é«˜å¾—ç‚¹
                    }
                });

                // åˆæ„ãƒ¬ãƒ™ãƒ«ã®åˆ¤å®š
                const threshold = 6 - this.consensusThreshold; // ã‚ˆã‚Šå¯›å®¹ãªè¨­å®šã»ã©ä½ã„é–¾å€¤
                const hasConsensus = consensusScore >= threshold;

                return {
                    hasConsensus,
                    score: consensusScore,
                    threshold,
                    keywords: detectedKeywords,
                    level: this.getConsensusLevel(consensusScore)
                };
            }

            getConsensusLevel(score) {
                if (score >= 5) return 'å¼·ã„åˆæ„';
                if (score >= 3) return 'ä¸­ç¨‹åº¦ã®åˆæ„';
                if (score >= 1) return 'éƒ¨åˆ†çš„åˆæ„';
                return 'åˆæ„ãªã—';
            }

            handleConsensusDetected(consensusResult) {
                this.consensusCount++;
                
                if (this.consensusNotification) {
                    this.addMessage('consensus', 
                        `ğŸ¤ **åˆæ„å½¢æˆã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼**\n\n` +
                        `ğŸ“Š åˆæ„ãƒ¬ãƒ™ãƒ«: ${consensusResult.level}\n` +
                        `ğŸ¯ ã‚¹ã‚³ã‚¢: ${consensusResult.score}/${consensusResult.threshold}\n` +
                        `ğŸ” æ¤œå‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${consensusResult.keywords.join(', ')}\n\n` +
                        `${this.autoEndOnConsensus ? 
                            'âœ… è‡ªå‹•çµ‚äº†è¨­å®šã«ã‚ˆã‚Šã€å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã€‚' : 
                            'ğŸ’¬ å¯¾è©±ã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚ã•ã‚‰ãªã‚‹æ¢æ±‚ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚'}`
                    );
                }

                this.learnFromDialogue('åˆæ„å½¢æˆæ¤œå‡º', 
                    `${consensusResult.level}ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚¹ã‚³ã‚¢: ${consensusResult.score}, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${consensusResult.keywords.join(', ')}`
                );

                if (this.autoEndOnConsensus) {
                    setTimeout(() => {
                        this.addMessage('system', 
                            `ğŸŠ åˆæ„å½¢æˆã«ã‚ˆã‚Šå¯¾è©±ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n` +
                            `ğŸ“ˆ æœ€çµ‚çµ±è¨ˆ:\n` +
                            `â€¢ ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.messageCount}\n` +
                            `â€¢ åˆæ„æ¤œå‡ºå›æ•°: ${this.consensusCount}\n` +
                            `â€¢ å¯¾è©±æ™‚é–“: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}ç§’\n\n` +
                            `ğŸ¯ å»ºè¨­çš„ãªè­°è«–ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`
                        );
                        this.stopDialogue();
                    }, 1000);
                }
            }

            manualConsensusCheck() {
                if (this.conversationHistory.length < 2) {
                    this.showWarning('åˆæ„ç¢ºèªã«ã¯å°‘ãªãã¨ã‚‚2ã¤ã®AIå¿œç­”ãŒå¿…è¦ã§ã™ã€‚');
                    return;
                }

                const recentMessages = this.conversationHistory.slice(-3);
                let totalScore = 0;
                let allResults = [];

                recentMessages.forEach(entry => {
                    if (entry.provider === 'openai' || entry.provider === 'gemini') {
                        const result = this.checkForConsensus(entry.message);
                        totalScore += result.score;
                        allResults.push(result);
                    }
                });

                const averageScore = totalScore / allResults.length;
                const hasOverallConsensus = averageScore >= (6 - this.consensusThreshold);

                this.addMessage('consensus',
                    `ğŸ” **æ‰‹å‹•åˆæ„ç¢ºèªçµæœ**\n\n` +
                    `ğŸ“Š å¹³å‡åˆæ„ã‚¹ã‚³ã‚¢: ${averageScore.toFixed(1)}\n` +
                    `ğŸ¯ åˆæ„åˆ¤å®š: ${hasOverallConsensus ? 'âœ… åˆæ„ã‚ã‚Š' : 'âŒ åˆæ„ãªã—'}\n` +
                    `ğŸ“ ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†æ:\n` +
                    allResults.map((r, i) => `  ${i + 1}. ${r.level} (ã‚¹ã‚³ã‚¢: ${r.score})`).join('\n') +
                    `\n\n${hasOverallConsensus ? 'ğŸŠ è­°è«–ã¯è‰¯ã„æ–¹å‘ã«é€²ã‚“ã§ã„ã¾ã™ï¼' : 'ğŸ’¬ ã•ã‚‰ãªã‚‹è­°è«–ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚'}`
                );

                if (hasOverallConsensus) {
                    this.consensusCount++;
                    this.updateStats();
                }
            }

            generateEntertainmentContinuation(currentRespondingProvider, previousContent, conversationHistory) {
                const selfName = currentRespondingProvider === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = currentRespondingProvider === 'openai' ? 'Gemini' : 'ChatGPT';

                let storyContext = "\nç¾åœ¨ã®ç‰©èªã®æµã‚Œ:\n";
                const recentHistory = conversationHistory.slice(-3);
                recentHistory.forEach(entry => {
                    storyContext += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : 'äººé–“'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt = 
                    `ã‚ãªãŸã¯ ${selfName} ã§ã™ã€‚\n` +
                    `ç¾åœ¨ã€${otherName}ã¨å”åŠ›ã—ã¦${this.getGenreLabel()}ã‚’å‰µä½œä¸­ã§ã™ã€‚\n` +
                    `${otherName}ãŒç›´å‰ã«æ›¸ã„ãŸå†…å®¹ï¼š\nã€Œ${previousContent}ã€\n` +
                    `${storyContext}\n` +
                    `ã“ã®ç¶šãã‚’${this.getLengthGuidance()}ã§ã€${this.getCreativityGuidance()}ã‚¹ã‚¿ã‚¤ãƒ«ã§æ›¸ã„ã¦ãã ã•ã„ã€‚\n` +
                    `${this.getEntertainmentTypeInstructions()}ã®æ–¹é‡ã«å¾“ã£ã¦ã€ç‰©èªã‚’é­…åŠ›çš„ã«ç™ºå±•ã•ã›ã¦ãã ã•ã„ã€‚\n` +
                    `èª­è€…ã‚’å¼•ãè¾¼ã‚€å±•é–‹ã‚’å¿ƒãŒã‘ã€ç›¸æ‰‹ã®å‰µä½œã‚’æ´»ã‹ã—ã¤ã¤æ–°ã—ã„è¦ç´ ã‚’åŠ ãˆã¦ãã ã•ã„ã€‚`;

                return prompt;
            }
            
            generateNextPrompt(currentRespondingProvider, previousMessageContent, conversationHistory) {
                const otherProviderName = currentRespondingProvider === 'openai' ? 'Gemini' : 'ChatGPT';
                const selfName = currentRespondingProvider === 'openai' ? 'ChatGPT' : 'Gemini';
            
                let historySummary = "\nã“ã‚Œã¾ã§ã®å¯¾è©±ã®è¦ç‚¹:\n";
                const relevantHistory = conversationHistory.slice(-4);
                relevantHistory.forEach(entry => {
                    historySummary += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : 'äººé–“'}: ${entry.message.substring(0, 100)}...\n`;
                });
            
                const prompt =
                    `ã‚ãªãŸã¯ ${selfName} ã§ã™ã€‚\n` +
                    `ç›´å‰ã« ${otherProviderName} (ã¾ãŸã¯äººé–“) ãŒæ¬¡ã®ã‚ˆã†ã«è¿°ã¹ã¾ã—ãŸ:\nã€Œ${previousMessageContent}ã€\n\n` +
                    `${conversationHistory.length > 1 ? historySummary : ''}\n` +
                    `ã“ã‚Œã¾ã§ã®è­°è«–ã‚’è¸ã¾ãˆã€ã‚ãªãŸã®å½¹å‰²ï¼ˆ${this.getTargetLabel()}ã€${this.getGoalLabel()}ï¼‰ã«å¾“ã£ã¦ã€å»ºè¨­çš„ãªå¿œç­”ã‚’ã—ã¦ãã ã•ã„ã€‚\n` +
                    `ğŸ¤ **é‡è¦**: ç›¸æ‰‹ã¨ã®åˆæ„ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‚’æ„è­˜ã—ã€å…±é€šç†è§£ã‚’æ·±ã‚ã¦ãã ã•ã„ã€‚åˆæ„ã«é”ã—ãŸã¨æ„Ÿã˜ãŸå ´åˆã¯æ˜ç¢ºã«è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚\n` +
                    `ç›¸æ‰‹ã®æ„è¦‹ã®è‰¯ã„ç‚¹ã‚„æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ã€è­°è«–ã‚’æ·±ã‚ã‚‹æ–°ã—ã„è¦–ç‚¹ã‚„å•ã„ã‚’æŠ•ã’ã‹ã‘ã¦ãã ã•ã„ã€‚\n` +
                    `å¯¾è©±ã¯æœ€å¤§${this.maxMessages}å›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äº¤æ›ã§çµè«–ã‚’å‡ºã™ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚(ç¾åœ¨ ${this.messageCount + 1} å›ç›®)\n` +
                    `ã‚ãªãŸã®å¿œç­”ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;
            
                return prompt;
            }

            shouldTriggerIntervention() {
                if (this.interventionFrequency === 0 || this.waitingForIntervention) return false;
                if (this.interventionFrequency > 0 && this.maxMessages / (this.interventionFrequency +1) > 0) {
                     const interval = Math.max(1, Math.floor(this.maxMessages / (this.interventionFrequency + 1)));
                     if (this.messageCount > 0 && this.messageCount % interval === 0 && this.messageCount < this.maxMessages -1) {
                         return Math.random() < 0.7;
                     }
                }
                return false;
            }

            triggerInterventionPrompt() {
                this.waitingForIntervention = true;
                this.pauseDialogue(true);

                const interventionDiv = document.createElement('div');
                interventionDiv.className = 'intervention-prompt';
                interventionDiv.innerHTML = `
                    <h4>ğŸ‘¤ äººé–“ä»‹å…¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™</h4>
                    <p>AIã®å¯¾è©±ã¯ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸã€‚ä»‹å…¥å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€AIã«ç¶šè¡Œã•ã›ã¦ãã ã•ã„ã€‚</p>
                    <button class="btn btn-warning" onclick="continueAutonomously()">
                        ğŸ¤– AIã«ç¶šè¡Œã•ã›ã‚‹
                    </button>
                    <button class="btn btn-primary" onclick="switchToInterventionTab()">
                        ğŸ‘¤ ä»‹å…¥ã‚¿ãƒ–ã¸
                    </button>
                `;
                this.elements.chatContainer.appendChild(interventionDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            }
            
            humanIntervention() {
                if (!this.isRunning) {
                    this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const humanMessage = this.elements.humanInput.value.trim();
                if (!humanMessage) {
                    this.showError('ä»‹å…¥å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                this.addMessage('human', humanMessage);
                this.humanCount++;
                this.updateStats(); 

                this.learnFromDialogue('äººé–“ä»‹å…¥', humanMessage);
                
                const respondingAI = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const interventionPrompt = this.entertainmentMode ?
                    this.generateEntertainmentInterventionPrompt(humanMessage, respondingAI, this.conversationHistory) :
                    this.generateInterventionResponsePrompt(humanMessage, respondingAI, this.conversationHistory);
                
                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                    this.addMessage('system', 'â–¶ï¸ äººé–“ä»‹å…¥ã«ã‚ˆã‚Šå¯¾è©±ã‚’å†é–‹ã—ã¾ã™...');
                    if(this.isRunning && this.startTime) this.startTimer();
                }
                
                this.waitingForIntervention = false; 
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(respondingAI, interventionPrompt, true); 
                
                this.elements.humanInput.value = '';
            }

            generateEntertainmentInterventionPrompt(humanInput, respondingAIProviderName, conversationHistory) {
                const selfName = respondingAIProviderName === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = respondingAIProviderName === 'openai' ? 'Gemini' : 'ChatGPT';

                let storyContext = "\nç›´è¿‘ã®å‰µä½œå†…å®¹:\n";
                const relevantHistory = conversationHistory.slice(-3);
                relevantHistory.forEach(entry => {
                    storyContext += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : 'äººé–“'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt =
                    `ã‚ãªãŸã¯ ${selfName} ã§ã™ã€‚\n` +
                    `ç¾åœ¨ã€${otherName}ã¨ã€Œ${this.elements.topicInput.value.trim()}ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã§${this.getGenreLabel()}ã‚’å‰µä½œä¸­ã§ã™ã€‚\n` +
                    `${storyContext}\n` +
                    `ã“ã“ã§èª­è€…ï¼ˆäººé–“ï¼‰ã‹ã‚‰ä»¥ä¸‹ã®è¦æœ›ãƒ»æŒ‡ç¤ºãŒã‚ã‚Šã¾ã—ãŸï¼š\nã€Œ${humanInput}ã€\n\n` +
                    `ã“ã®èª­è€…ã®è¦æœ›ã‚’æœ€å„ªå…ˆã§åæ˜ ã—ã€ç‰©èªã‚’ã‚ˆã‚Šé­…åŠ›çš„ã«ç™ºå±•ã•ã›ã¦ãã ã•ã„ã€‚\n` +
                    `å‰µä½œã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ${this.getLengthGuidance()}ã€${this.getCreativityGuidance()}ï¼‰ã‚‚æ„è­˜ã—ã¦ãã ã•ã„ã€‚\n` +
                    `èª­è€…ã®æœŸå¾…ã«å¿œãˆã¤ã¤ã€å‰µä½œãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®${otherName}ã«ã‚‚åˆºæ¿€ã‚’ä¸ãˆã‚‹å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚`;
                return prompt;
            }

            generateInterventionResponsePrompt(humanInput, respondingAIProviderName, conversationHistory) {
                const selfName = respondingAIProviderName === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = respondingAIProviderName === 'openai' ? 'Gemini' : 'ChatGPT';

                let historySummary = "\nç›´è¿‘ã®å¯¾è©±ã®è¦ç‚¹:\n";
                const relevantHistory = conversationHistory.slice(-3);
                relevantHistory.forEach(entry => {
                    historySummary += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : 'äººé–“'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt =
                    `ã‚ãªãŸã¯ ${selfName} ã§ã™ã€‚\n` +
                    `ç¾åœ¨ã€${otherName}ã¨ã€Œ${this.elements.topicInput.value.trim()}ã€ã«ã¤ã„ã¦è­°è«–ä¸­ã§ã™ã€‚\n` +
                    `${conversationHistory.length > 0 ? historySummary : ''}\n` +
                    `ã“ã“ã§äººé–“ãŒä»¥ä¸‹ã®ä»‹å…¥ã‚’è¡Œã„ã¾ã—ãŸï¼š\nã€Œ${humanInput}ã€\n\n` +
                    `ã“ã®äººé–“ã®ä»‹å…¥ã‚’æœ€å„ªå…ˆã§è€ƒæ…®ã—ã€çš„ç¢ºã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®å¿œç­”ã¯ã€ã“ã‚Œã¾ã§ã®è­°è«–ã®æµã‚Œã¨äººé–“ã®æŒ‡ç¤ºã®ä¸¡æ–¹ã‚’è¸ã¾ãˆãŸã‚‚ã®ã§ã‚ã‚‹ã¹ãã§ã™ã€‚\n` +
                    `å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ï¼ˆ${this.getTargetLabel()}, ${this.getGoalLabel()}ï¼‰ã‚‚æ„è­˜ã—ã¦ãã ã•ã„ã€‚\n` +
                    `ğŸ¤ åˆæ„å½¢æˆã‚’æ„è­˜ã—ã€å»ºè¨­çš„ãªå¯¾è©±ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚\n` +
                    `å¿œç­”å¾Œã€è­°è«–ã¯${otherName}ã¸ã¨ç¶šãã¾ã™ã€‚`;
                return prompt;
            }

            requestDeepening() {
                if (!this.isRunning || this.conversationHistory.length === 0) {
                    this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã€AIã®ç™ºè¨€ãŒã‚ã‚‹çŠ¶æ…‹ã§ä½¿ç”¨ã—ã¦ãã ã•ã„'); return;
                }
                const lastAIMessageEntry = [...this.conversationHistory].reverse().find(m => m.provider === 'openai' || m.provider === 'gemini');
                if (!lastAIMessageEntry) {
                    this.showWarning('æ·±æ˜ã‚Šå¯¾è±¡ã¨ãªã‚‹AIã®ç™ºè¨€ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return;
                }

                const targetAI = lastAIMessageEntry.provider;
                const messageToDeepen = lastAIMessageEntry.message;

                const deepeningRequestText = this.entertainmentMode ?
                    `ã‚ãªãŸã¯ ${targetAI === 'openai' ? 'ChatGPT' : 'Gemini'} ã§ã™ã€‚\n`+
                    `èª­è€…ãŒã€ã‚ãªãŸã®ç›´å‰ã®å‰µä½œã€Œ${messageToDeepen.substring(0,150)}...ã€ã«ã¤ã„ã¦ã€ã‚ˆã‚Šè©³ç´°ãªæå†™ã‚„å±•é–‹ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚\n` +
                    `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¿ƒæƒ…ã€æƒ…æ™¯æå†™ã€èƒŒæ™¯è¨­å®šãªã©ã€ã‚ˆã‚Šæ·±ãæ˜ã‚Šä¸‹ã’ã¦ç‰©èªã«å¥¥è¡Œãã‚’ä¸ãˆã¦ãã ã•ã„ã€‚\n` +
                    `${this.getLengthGuidance()}ã§${this.getCreativityGuidance()}ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚` :
                    `ã‚ãªãŸã¯ ${targetAI === 'openai' ? 'ChatGPT' : 'Gemini'} ã§ã™ã€‚\n`+
                    `äººé–“ãŒã€ã‚ãªãŸã®ç›´å‰ã®ç™ºè¨€ã€Œ${messageToDeepen.substring(0,150)}...ã€ã«ã¤ã„ã¦ã€ã‚ˆã‚Šæ·±ã„æ¢æ±‚ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚\n` +
                    `å…·ä½“ä¾‹ã€æ ¹æ‹ ã€ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®åˆ†æã€æ½œåœ¨çš„ãªæ„å‘³åˆã„ãªã©ã€å¤šè§’çš„ã«ãã®è«–ç‚¹ã‚’æ·±æ˜ã‚Šã—ã€è­°è«–ã«æ–°ãŸãªå¥¥è¡Œãã‚’ä¸ãˆã¦ãã ã•ã„ã€‚\n` +
                    `ã‚ãªãŸã®å½¹å‰²ï¼ˆ${this.getTargetLabel()}, ${this.getGoalLabel()}ï¼‰ã‚’æ„è­˜ã—ã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚`;

                this.addMessage('system', `ğŸ” **æ·±æ˜ã‚Šè¦æ±‚**: ${targetAI.toUpperCase()}ã«ã€Œ${messageToDeepen.substring(0,30)}...ã€ã®æ·±æ˜ã‚Šã‚’ä¾é ¼`);
                
                if (this.isPaused) this.pauseDialogue();
                this.waitingForIntervention = false; 
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());

                this.sendMessage(targetAI, deepeningRequestText, true);
                this.learnFromDialogue('æ·±æ˜ã‚Šè¦æ±‚', `å¯¾è±¡: ${targetAI} - ã€Œ${messageToDeepen.substring(0,50)}...ã€`);
            }

            redirectDialogue() {
                if (!this.isRunning) {
                    this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚'); return;
                }
                const redirectionText = this.elements.humanInput.value.trim();
                if (!redirectionText) {
                    this.showError('æ–¹å‘è»¢æ›ã®æŒ‡ç¤ºã‚„æ–°ã—ã„ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
                }

                this.addMessage('human', `ğŸ¯ **æ–¹å‘è»¢æ›æŒ‡ç¤º**: ${redirectionText}`);
                this.humanCount++;
                this.updateStats();

                const respondingAI = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const redirectionPrompt = this.entertainmentMode ?
                    `ã‚ãªãŸã¯ ${respondingAI === 'openai' ? 'ChatGPT' : 'Gemini'} ã§ã™ã€‚\n` +
                    `èª­è€…ãŒç‰©èªã®æ–¹å‘è»¢æ›ã‚’è¦æ±‚ã—ã¾ã—ãŸã€‚æ–°ã—ã„æŒ‡ç¤ºã¯ï¼š\nã€Œ${redirectionText}ã€\n\n` +
                    `ã“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ç‰©èªã‚’æ–°ã—ã„æ–¹å‘ã«å°ã„ã¦ãã ã•ã„ã€‚${this.getGenreLabel()}ã®${this.getLengthGuidance()}ã§ã€${this.getCreativityGuidance()}ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚` :
                    `ã‚ãªãŸã¯ ${respondingAI === 'openai' ? 'ChatGPT' : 'Gemini'} ã§ã™ã€‚\n` +
                    `äººé–“ãŒå¯¾è©±ã®æ–¹å‘è»¢æ›ã‚’æŒ‡ç¤ºã—ã¾ã—ãŸã€‚æ–°ã—ã„æŒ‡ç¤ºï¼ãƒˆãƒ”ãƒƒã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š\nã€Œ${redirectionText}ã€\n\n` +
                    `ã“ã‚Œã¾ã§ã®è­°è«–ã¯ä¸€æ—¦è„‡ã«ç½®ãã€ã“ã®æ–°ã—ã„æŒ‡ç¤ºï¼ãƒˆãƒ”ãƒƒã‚¯ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦è­°è«–ã‚’å†é–‹ã—ã¦ãã ã•ã„ã€‚\n`+
                    `ã‚ãªãŸã®å½¹å‰²ï¼ˆ${this.getTargetLabel()}, ${this.getGoalLabel()}ï¼‰ã‚’æ„è­˜ã—ã¦ã€æœ€åˆã®ç™ºè¨€ã‚’ã—ã¦ãã ã•ã„ã€‚`;
                
                if (this.isPaused) this.pauseDialogue();
                this.waitingForIntervention = false;
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());

                this.sendMessage(respondingAI, redirectionPrompt, true);
                this.learnFromDialogue('æ–¹å‘è»¢æ›æŒ‡ç¤º', redirectionText);
                this.elements.humanInput.value = '';
            }

            saveInsight() {
                const insightText = this.elements.humanInput.value.trim();
                if (!insightText) { this.showError('ä¿å­˜ã™ã‚‹æ´å¯Ÿã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

                const timestamp = new Date();
                const insightId = `human_insight_${timestamp.getTime()}`;
                this.knowledgeBase.set(insightId, {
                    topic: 'äººé–“ã®æ´å¯Ÿ (æ‰‹å‹•ä¿å­˜)', content: insightText, timestamp, source: 'human_manual_save'
                });
                this.updateKnowledgeDisplay(); this.updateStats();
                this.addMessage('learning', `ğŸ’¡ æ´å¯Ÿã€Œ${insightText.substring(0,50)}...ã€ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã—ã¾ã—ãŸ`);
                this.elements.humanInput.value = '';
            }

            triggerConsensusCheck() {
                this.manualConsensusCheck();
            }

            quickIntervention(type) {
                if (!this.isRunning) { this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚'); return; }
                const quickMessages = {
                    'å…·ä½“ä¾‹': 'ä»Šã®è­°è«–ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨å…·ä½“çš„ãªä¾‹ã‚’æŒ™ã’ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚',
                    'åå¯¾æ„è¦‹': 'ä»Šã®æ„è¦‹ã«å¯¾ã—ã¦ã€åå¯¾ã®è¦–ç‚¹ã‚„æ‰¹åˆ¤çš„ãªæ„è¦‹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
                    'å®Ÿç”¨æ€§': 'ãã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„è­°è«–ã¯ã€å®Ÿç”¨çš„ãªè¦³ç‚¹ã‹ã‚‰è¦‹ã¦ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿç¾å®Ÿçš„ãªå¿œç”¨ã®å¯èƒ½æ€§ã¯ï¼Ÿ',
                    'ç°¡æ½”ã«': 'ã“ã“ã¾ã§ã®è­°è«–ã®è¦ç‚¹ã‚’ã€ã‚‚ã£ã¨ç°¡æ½”ã«ã¾ã¨ã‚ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ',
                    'åˆæ„å½¢æˆ': 'ã“ã‚Œã¾ã§ã®è­°è«–ã§å…±é€šã®ç†è§£ã‚„åˆæ„ã§ãã‚‹ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
                    'ã‚¨ãƒ³ã‚¿ãƒ¡è»¢æ›': this.entertainmentMode ? 
                        'ã‚‚ã£ã¨åŠ‡çš„ã§é¢ç™½ã„å±•é–‹ã«ã—ã¦ãã ã•ã„ã€‚èª­è€…ã‚’ãƒ¯ã‚¯ãƒ¯ã‚¯ã•ã›ã¦ï¼' : 
                        'ã“ã®è­°è«–ã‚’ã‚‚ã£ã¨é¢ç™½ãã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ‹ãƒ³ã‚°ã«è¡¨ç¾ã—ã¦ã¿ã¦ãã ã•ã„ã€‚'
                };
                this.elements.humanInput.value = quickMessages[type] || '';
                this.humanIntervention();
            }

            autoLearnFromMessage(message, provider) {
                if (!this.learningEnabled || provider === 'system' || provider === 'human') return;

                const hasKeywords = this.autoLearnKeywords.some(k => message.includes(k));
                const isLongEnough = message.length > 150;

                if (hasKeywords || isLongEnough) {
                    const timestamp = new Date();
                    const learnId = `auto_${provider}_${timestamp.getTime()}`;
                    const importantPart = this.extractImportantPart(message, hasKeywords);
                    
                    if (importantPart.length > 20) {
                        this.knowledgeBase.set(learnId, {
                            topic: `${provider}ã®${this.entertainmentMode ? 'å‰µä½œ' : 'ç™ºè¨€'}ã‹ã‚‰ã®æ´å¯Ÿ (è‡ªå‹•)`, 
                            content: importantPart, 
                            timestamp,
                            source: `auto_learn_${provider}`, 
                            fullMessage: message,
                            mode: this.entertainmentMode ? 'entertainment' : 'discussion'
                        });
                        this.updateKnowledgeDisplay(); this.updateStats();
                    }
                }
            }

            extractImportantPart(message, hasKeywords) {
                const sentences = message.split(/[ã€‚ï¼ï¼ï¼Ÿ\n]+/).map(s => s.trim()).filter(s => s.length > 10);
                if (sentences.length === 0) return "";

                let targetSentences = [];
                if (hasKeywords) {
                    targetSentences = sentences.filter(s => this.autoLearnKeywords.some(k => s.includes(k)));
                }
                
                if (targetSentences.length === 0) {
                    const concludingKeywords = ['ã¤ã¾ã‚Š', 'ã—ãŸãŒã£ã¦', 'çµè«–ã¨ã—ã¦', 'è¦ã™ã‚‹ã«'];
                    const concludingSentence = sentences.find(s => concludingKeywords.some(k => s.startsWith(k)));
                    if (concludingSentence) targetSentences.push(concludingSentence);
                    else targetSentences.push(sentences[0]);
                    if (sentences.length > 1 && !concludingSentence) targetSentences.push(sentences[sentences.length -1]);
                }

                let extracted = targetSentences.slice(0, 2).join('ã€‚');
                if (extracted.length > 200) extracted = extracted.substring(0, 197) + "...";
                return extracted;
            }

            learnFromDialogue(topic, content) {
                const timestamp = new Date();
                const learnId = `event_${topic.replace(/\s+/g, '_')}_${timestamp.getTime()}`;
                this.knowledgeBase.set(learnId, { 
                    topic, 
                    content, 
                    timestamp, 
                    source: 'dialogue_event',
                    mode: this.entertainmentMode ? 'entertainment' : 'discussion'
                });
                this.updateKnowledgeDisplay(); this.updateStats();
            }

            updateKnowledgeDisplay() {
                const container = this.elements.knowledgeBase;
                container.innerHTML = '';
                const items = Array.from(this.knowledgeBase.values()).sort((a,b) => b.timestamp - a.timestamp);
                if (items.length === 0) {
                    container.innerHTML = '<div class="knowledge-item"><div class="knowledge-content">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>';
                    return;
                }
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'knowledge-item';
                    const modeIcon = item.mode === 'entertainment' ? 'ğŸ­' : 'ğŸ’¬';
                    div.innerHTML = `
                        <div class="knowledge-topic">${modeIcon} ${item.topic} (${item.source})</div>
                        <div class="knowledge-content" title="${item.content}">${item.content.substring(0,100)}${item.content.length > 100 ? '...' : ''}</div>
                        <div style="font-size:0.8em;color:#999;margin-top:5px;">${item.timestamp.toLocaleString()}</div>`;
                    container.appendChild(div);
                });
            }

            exportKnowledge() {
                if (this.knowledgeBase.size === 0) { this.showWarning("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
                const data = Array.from(this.knowledgeBase.entries()).map(([id, item]) => ({id, ...item, timestamp: item.timestamp.toISOString()}));
                const str = JSON.stringify(data, null, 2);
                const blob = new Blob([str], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `crossthink_v6_knowledge_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.addMessage('learning', `ğŸ“¤ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ ${data.length}ä»¶ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
            }

            importKnowledge() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (!Array.isArray(data)) throw new Error("JSONãƒ‡ãƒ¼ã‚¿ã¯é…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
                            let count = 0;
                            data.forEach(item => {
                                if (item.id && item.topic && item.content && item.timestamp && item.source) {
                                    this.knowledgeBase.set(item.id, {...item, timestamp: new Date(item.timestamp)});
                                    count++;
                                } else console.warn("ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å½¢å¼ä¸æ­£:", item);
                            });
                            this.updateKnowledgeDisplay(); this.updateStats();
                            this.addMessage('learning', `ğŸ“¥ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ ${count}ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
                        } catch (err) { this.showError("ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚¨ãƒ©ãƒ¼: " + err.message); console.error(err); }
                    };
                    reader.onerror = () => this.showError("ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼");
                    reader.readAsText(file);
                };
                input.click();
            }

            clearKnowledge() {
                if (confirm('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ãƒ‡ãƒ¼ã‚¿ä»¥å¤–ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    const initData = this.knowledgeBase.get('system_init');
                    this.knowledgeBase.clear();
                    if (initData) this.knowledgeBase.set('system_init', initData);
                    this.updateKnowledgeDisplay(); this.updateStats();
                    this.addMessage('learning', 'ğŸ—‘ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ (åˆæœŸåŒ–ãƒ‡ãƒ¼ã‚¿é™¤ã)');
                }
            }

            showLearningStats() {
                const total = this.knowledgeBase.size;
                const stats = {};
                const modeStats = { entertainment: 0, discussion: 0, other: 0 };
                
                this.knowledgeBase.forEach(item => { 
                    stats[item.source] = (stats[item.source] || 0) + 1;
                    if (item.mode === 'entertainment') modeStats.entertainment++;
                    else if (item.mode === 'discussion') modeStats.discussion++;
                    else modeStats.other++;
                });
                
                let text = `ğŸ“Š å­¦ç¿’çµ±è¨ˆ: ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${total}\n\nãƒ¢ãƒ¼ãƒ‰åˆ¥:\n`;
                text += `  ğŸ­ ã‚¨ãƒ³ã‚¿ãƒ¡: ${modeStats.entertainment}ä»¶\n`;
                text += `  ğŸ’¬ è­°è«–: ${modeStats.discussion}ä»¶\n`;
                text += `  ğŸ“ ãã®ä»–: ${modeStats.other}ä»¶\n\nã‚½ãƒ¼ã‚¹åˆ¥:\n`;
                for (const src in stats) text += `  â€¢ ${src}: ${stats[src]}ä»¶\n`;
                this.addMessage('learning', text);
            }

            pauseDialogue(triggeredBySystem = false) {
                if (!this.isRunning) return;
                this.isPaused = !this.isPaused;
                this.elements.pauseBtn.textContent = this.isPaused ? 'â–¶ï¸ å†é–‹' : 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                
                if (!triggeredBySystem || !this.isPaused) {
                    this.addMessage('system', this.isPaused ? 'â¸ï¸ å¯¾è©±ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ' : 'â–¶ï¸ å¯¾è©±ã‚’å†é–‹ã—ã¾ã™...');
                }

                if (!this.isPaused && this.isRunning) {
                    this.startTimer();
                    if (!this.waitingForIntervention && this.conversationHistory.length > 0) {
                        const lastEntry = this.conversationHistory[this.conversationHistory.length - 1];
                        if (lastEntry.provider === 'openai' || lastEntry.provider === 'gemini') {
                            setTimeout(() => {
                                if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                                    const nextRespondingAI = lastEntry.provider === 'openai' ? 'gemini' : 'openai';
                                    const resumePrompt = this.generateResumePrompt(lastEntry.message);
                                    this.sendMessage(nextRespondingAI, resumePrompt, false);
                                }
                            }, 500);
                        }
                    } else if (this.conversationHistory.length === 0) {
                        this.startDialogue();
                    }
                }
            }

            generateResumePrompt(lastMessageContent) {
                if (this.entertainmentMode) {
                    return `ç‰©èªã®å‰µä½œãŒä¸€æ™‚åœæ­¢ã‹ã‚‰å†é–‹ã•ã‚Œã¾ã—ãŸã€‚ç›´å‰ã®å†…å®¹ã¯ã€Œ${lastMessageContent.substring(0,100)}...ã€ã§ã—ãŸã€‚ã“ã®ç¶šãã‚’é­…åŠ›çš„ã«å±•é–‹ã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    return `å¯¾è©±ãŒä¸€æ™‚åœæ­¢ã‹ã‚‰å†é–‹ã•ã‚Œã¾ã—ãŸã€‚ç›´å‰ã®ç›¸æ‰‹ã®ç™ºè¨€ã¯ã€Œ${lastMessageContent.substring(0,100)}...ã€ã§ã—ãŸã€‚ã“ã®è­°è«–ã‚’å¼•ãç¶™ãã€ã‚ãªãŸã®æ„è¦‹ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚`;
                }
            }

            stopDialogue() {
                this.isRunning = false;
                this.isPaused = false;
                this.waitingForIntervention = false;
                this.entertainmentMode = false; // ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                this.elements.stopBtn.disabled = true;
                
                const finalStatsSummary = this.generateFinalStats();
                const sessionType = this.entertainmentMode ? 'ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³';
                
                this.addMessage('system', 
                    `ğŸ›‘ ${sessionType}çµ‚äº†\n\n` +
                    `ğŸ“Š æœ€çµ‚çµ±è¨ˆ:\n` +
                    `â€¢ ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° (AI+äººé–“): ${this.messageCount}\n` +
                    `â€¢ ChatGPTå¿œç­”: ${this.openaiCount}å›\n` +
                    `â€¢ Geminiå¿œç­”: ${this.geminiCount}å›\n` +
                    `â€¢ äººé–“ä»‹å…¥: ${this.humanCount}å›\n` +
                    `â€¢ åˆæ„å½¢æˆå›æ•°: ${this.consensusCount}å›\n` +
                    `â€¢ ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${this.entertainmentSessions}å›\n` +
                    `â€¢ å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ ç·æ•°: ${this.knowledgeBase.size}ä»¶\n` +
                    `â€¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}ç§’\n\n` +
                    `ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ã€Œå­¦ç¿’æ©Ÿèƒ½ã€ã‚¿ãƒ–ã§ç¢ºèªãƒ»ç®¡ç†ã§ãã¾ã™ã€‚\n` +
                    `ğŸ­ æ–°ã—ã„ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€Œã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ã€ã‚¿ãƒ–ã‹ã‚‰é–‹å§‹ã§ãã¾ã™ã€‚`
                );
                this.learnFromDialogue('ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†', `${sessionType}çµ‚äº†ã€‚${finalStatsSummary}`);
            }

            generateFinalStats() {
                return `ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${this.messageCount}, ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount}, äººé–“: ${this.humanCount}, åˆæ„: ${this.consensusCount}, ã‚¨ãƒ³ã‚¿ãƒ¡: ${this.entertainmentSessions}, å­¦ç¿’: ${this.knowledgeBase.size}`;
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo', messages: [{ role: 'user', content: prompt }],
                            max_tokens: 1500, temperature: this.entertainmentMode ? 0.8 : 0.7, top_p: 0.9
                        })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(()=>({}));
                        throw new Error(`OpenAI API ${response.status}: ${errData.error?.message || response.statusText}`);
                    }
                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || "OpenAIã‹ã‚‰ã®å¿œç­”ãŒç©ºã‹ä¸æ­£ã§ã™ã€‚";
                } catch (error) {
                    console.error("OpenAI API Error:", error);
                    this.showError(`OpenAI APIã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    return this.generateFallbackResponse(prompt, `OpenAI: ${error.message}`);
                }
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                const models = ['gemini-1.5-flash-latest', 'gemini-pro'];
                for (const model of models) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { 
                                    maxOutputTokens: 1500, 
                                    temperature: this.entertainmentMode ? 0.7 : 0.6, 
                                    topP: 0.8 
                                }
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text || `Gemini (${model}) ã‹ã‚‰ã®å¿œç­”ãŒç©ºã‹ä¸æ­£ã§ã™ã€‚`;
                        }
                        if (response.status === 429) {
                             this.showWarning(`Gemini API (${model}) ã®åˆ©ç”¨ä¸Šé™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
                             continue;
                        }
                        const errData = await response.json().catch(()=>({}));
                        console.warn(`Gemini API (${model}) Error ${response.status}: ${errData.error?.message || response.statusText}`);
                    } catch (error) { console.warn(`Gemini API (${model}) Call Failed:`, error); }
                }
                const geminiErrorMsg = `Gemini APIã®å…¨ãƒ¢ãƒ‡ãƒ«ã§å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`;
                this.showError(geminiErrorMsg);
                return this.generateFallbackResponse(prompt, geminiErrorMsg);
            }
            
            generateFallbackResponse(prompt, reason = "APIå‘¼ã³å‡ºã—å¤±æ•—") {
                console.error("Fallback response generated due to:", reason);
                return `AI (${reason.split(':')[0]}) ã‹ã‚‰ã®å¿œç­”å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(${reason}). ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                if (this.conversationHistory.length === 0) {
                    this.showError('è¦ç´„å¯¾è±¡ã®å¯¾è©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return;
                }
                
                const sessionType = this.entertainmentMode ? 'ã‚¨ãƒ³ã‚¿ãƒ¡ã‚»ãƒƒã‚·ãƒ§ãƒ³' : 'å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³';
                const modeInfo = this.entertainmentMode ? 
                    `ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰: ${this.getGenreLabel()}, é•·ã•: ${this.getContentLengthLabel()}, å‰µé€ æ€§: ${this.getCreativityLabel()}` :
                    `å¯¾è©±ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}`;
                
                let log = `ãƒˆãƒ”ãƒƒã‚¯: ã€Œ${topic}ã€\n${sessionType}: ${modeInfo}\n\n`;
                this.conversationHistory.forEach(e => {
                    log += `${e.provider === 'openai' ? 'ChatGPT' : e.provider === 'gemini' ? 'Gemini' : 'äººé–“'}:\n${e.message}\n\n`;
                });
                
                let knowledgeSummary = "\n--- å­¦ç¿’ã•ã‚ŒãŸä¸»ãªæ´å¯Ÿ ---\n";
                Array.from(this.knowledgeBase.values())
                    .filter(item => item.source !== 'system_init' && item.source !== 'dialogue_event')
                    .slice(0, 5)
                    .forEach(item => {
                        knowledgeSummary += `[${item.topic} (${item.source})]: ${item.content.substring(0,150)}...\n`;
                    });

                const analysisType = this.entertainmentMode ? 'å‰µä½œåˆ†æ' : 'å¯¾è©±åˆ†æ';
                const prompt = `ä»¥ä¸‹ã® Crossthink v6.0 ã§ã®${sessionType}ãƒ­ã‚°ã‚’åˆ†æã—ã€åŒ…æ‹¬çš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n` +
                               `ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã€‘\n` +
                               `- ç·AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.openaiCount + this.geminiCount} (ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount})\n` +
                               `- äººé–“ä»‹å…¥å›æ•°: ${this.humanCount}\n` +
                               `- åˆæ„å½¢æˆå›æ•°: ${this.consensusCount}\n` +
                               `- å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${this.knowledgeBase.size}\n` +
                               log + knowledgeSummary +
                               `\nã€${analysisType}ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæŒ‡ç¤ºã€‘\n` +
                               (this.entertainmentMode ? 
                                `1. å‰µä½œå…¨ä½“ã®ã‚ã‚‰ã™ã˜ã¨ç‰©èªã®å±•é–‹åˆ†æã€‚\n` +
                                `2. ChatGPTã¨Geminiã®å‰µä½œã‚¹ã‚¿ã‚¤ãƒ«ã€æƒ³åƒåŠ›ã€ç‰¹å¾´çš„ãªè¡¨ç¾ã®æ¯”è¼ƒã€‚\n` +
                                `3. äººé–“ä»‹å…¥ãŒç‰©èªã«ä¸ãˆãŸå½±éŸ¿ï¼ˆæ–¹å‘è»¢æ›ã€æ·±æ˜ã‚Šã€å‰µä½œæŒ‡å°ãªã©ï¼‰ã€‚\n` +
                                `4. è‡ªå‹•å­¦ç¿’ã•ã‚ŒãŸå‰µä½œè¦ç´ ã®è³ªã¨ã€ã‚¨ãƒ³ã‚¿ãƒ¡ä¾¡å€¤ã®è©•ä¾¡ã€‚\n` +
                                `5. ã“ã®å‰µä½œã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸæœ€çµ‚çš„ãªä½œå“ã‚„é‡è¦ãªå‰µä½œã‚¢ã‚¤ãƒ‡ã‚¢ã€‚\n` +
                                `6. ã‚¨ãƒ³ã‚¿ãƒ¡ç‰¹åŒ–AIã‚·ã‚¹ãƒ†ãƒ ã®å¼·ã¿ã€å¼±ã¿ã€ä»Šå¾Œã®æ”¹å–„ææ¡ˆã€‚\n` :
                                `1. å¯¾è©±å…¨ä½“ã®è¦ç´„ã¨ä¸»è¦ãªè«–ç‚¹ã®å¤‰é·ã€‚\n` +
                                `2. ChatGPTã¨Geminiã®è²¢çŒ®ã€è­°è«–ã‚¹ã‚¿ã‚¤ãƒ«ã€ç‰¹å¾´çš„ãªæ„è¦‹ã®æ¯”è¼ƒã€‚\n` +
                                `3. äººé–“ä»‹å…¥ãŒè­°è«–ã«ä¸ãˆãŸå½±éŸ¿ï¼ˆæ–¹å‘è»¢æ›ã€æ·±æ˜ã‚Šã€è£œè¶³ãªã©ï¼‰ã€‚\n` +
                                `4. åˆæ„å½¢æˆãƒ—ãƒ­ã‚»ã‚¹ã®åˆ†æã¨ã€AIã®åˆæ„æ¤œå‡ºç²¾åº¦ã®è©•ä¾¡ã€‚\n` +
                                `5. ã“ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæœ€çµ‚çš„ãªçµè«–ã‚„é‡è¦ãªç™ºè¦‹ã€‚\n` +
                                `6. åˆæ„å½¢æˆæ©Ÿèƒ½ä»˜ãAIã‚·ã‚¹ãƒ†ãƒ ã®å¼·ã¿ã€å¼±ã¿ã€ä»Šå¾Œã®æ”¹å–„ææ¡ˆã€‚\n`) +
                               `\nãƒ¬ãƒãƒ¼ãƒˆã¯æ§‹é€ åŒ–ã•ã‚Œã€å…·ä½“çš„ã§åˆ†æçš„ã§ã‚ã‚‹ã“ã¨ã€‚æ–‡å­—æ•°ã¯4000å­—ä»¥ä¸Šã‚’ç›®å®‰ã¨ã™ã‚‹ã€‚`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(prompt).then(() => {
                        this.addMessage('system', `ğŸ“‹ ${analysisType}ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (ç´„${prompt.length}å­—) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\né«˜æ€§èƒ½LLMã«è²¼ã‚Šä»˜ã‘ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`);
                    }).catch(err => { console.error('Clipboard copy failed:', err); this.showPromptWindow(prompt); });
                } else { this.showPromptWindow(prompt); }
            }

            showPromptWindow(promptText) {
                const win = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                if (win) {
                    win.document.write('<html><head><title>åˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</title><style>body{font-family:sans-serif;padding:1em;}textarea{width:98%;height:85vh;padding:0.5em;font-family:monospace;white-space:pre-wrap;}</style></head><body><h2>åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2><p>ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€é«˜æ€§èƒ½LLMã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p><textarea readonly>${promptText.replace(/</g, "&lt;")}</textarea></body></html>');
                    win.document.close();
                } else { this.showWarning('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚'); console.log(promptText); }
            }

            addMessage(provider, content, isThinking = false) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${provider}-message`;
                const time = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                let name, emoji, role = '';

                switch(provider) {
                    case 'openai': 
                        name='ChatGPT'; 
                        emoji='ğŸŸ¢'; 
                        role=` (${this.entertainmentMode ? this.getGenreLabel() : this.targetMode})`; 
                        this.currentSpeaker='openai'; 
                        break;
                    case 'gemini': 
                        name='Gemini'; 
                        emoji='ğŸ”·'; 
                        role=` (${this.entertainmentMode ? this.getGenreLabel() : this.targetMode})`; 
                        this.currentSpeaker='gemini'; 
                        break;
                    case 'human': name='ã‚ãªãŸ'; emoji='ğŸ‘¤'; break;
                    case 'learning': name='å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ '; emoji='ğŸ§ '; break;
                    case 'consensus': name='åˆæ„æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ '; emoji='ğŸ¤'; break;
                    default: name='Crossthink v6.0'; emoji='ğŸš€';
                }
                msgDiv.innerHTML = `<div class="message-header">${emoji} ${name}${role}<span class="message-time">${time}</span></div>` +
                                   `<div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>`;
                this.elements.chatContainer.appendChild(msgDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && (provider === 'openai' || provider === 'gemini' || provider === 'human')) {
                    this.messageCount++;
                }
            }

            removeLastMessage() {
                const msg = this.elements.chatContainer.lastElementChild;
                if (msg && msg.classList.contains('message')) msg.remove();
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0; this.openaiCount = 0; this.geminiCount = 0; this.humanCount = 0;
                this.conversationHistory = []; this.startTime = null;
                this.entertainmentMode = false; // ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
                this.elements.elapsed.textContent = '0';
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true; this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                this.elements.stopBtn.disabled = true;
                this.isRunning = false; this.isPaused = false; this.waitingForIntervention = false;
                this.updateStats(); this.showWelcomeMessage(); this.hideError(); this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.elements.warningDisplay.style.display = 'none';
            }

            hideError() { this.elements.errorDisplay.style.display = 'none'; }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `âš ï¸ è­¦å‘Š: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
                this.elements.errorDisplay.style.display = 'none';
            }

            hideWarning() { this.elements.warningDisplay.style.display = 'none'; }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
                this.elements.humanMessages.textContent = this.humanCount;
                this.elements.learningItems.textContent = this.knowledgeBase.size;
                this.elements.consensusCount.textContent = this.consensusCount;
                this.elements.entertainmentSessions.textContent = this.entertainmentSessions;
            }

            startTimer() {
                if (!this.isRunning || !this.startTime) return;
                
                const timerTick = () => {
                    if (this.isRunning && !this.isPaused && this.startTime) {
                        this.elements.elapsed.textContent = Math.floor((Date.now() - this.startTime) / 1000);
                        setTimeout(timerTick, 1000);
                    } else if (this.isRunning && this.isPaused) {
                        setTimeout(timerTick, 1000);
                    }
                };
                timerTick();
            }

            getTargetLabel() {
                const labels = {'practical':'ğŸ  å®Ÿç”¨çš„','business':'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹','philosophical':'ğŸ§  å“²å­¦çš„'};
                return labels[this.targetMode] || this.targetMode;
            }
            
            getGoalLabel() {
                const labels = {'ideation':'ğŸ’¡ æ¡ˆå‡ºã—','consensus':'ğŸ¤ åˆæ„å½¢æˆ','exploration':'ğŸ” æ¢ç´¢'};
                return labels[this.goalMode] || this.goalMode;
            }
            
            getInterventionLabel() {
                const labels = ['ãªã—','ç¨€','å°‘','ä¸­','å¤š','é »ç¹','éå¸¸ã«é »ç¹','å¸¸æ™‚','ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ','ã‚·ãƒ³ã‚¯ãƒ­','ãƒ•ãƒ«ä»‹å…¥'];
                return labels[this.interventionFrequency] || 'ä¸­ç¨‹åº¦';
            }

            getConsensusThresholdLabel() {
                const labels = ['å³æ ¼','ã‚„ã‚„å³æ ¼','æ¨™æº–','ã‚„ã‚„å¯›å®¹','å¯›å®¹'];
                return labels[this.consensusThreshold - 1] || 'æ¨™æº–';
            }

            getGenreLabel() {
                const labels = {
                    'novel': 'ğŸ“š å°èª¬',
                    'dialogue': 'ğŸ’¬ ãƒ‰ãƒ©ãƒå¯¾è©±',
                    'comedy': 'ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£',
                    'mystery': 'ğŸ” ãƒŸã‚¹ãƒ†ãƒªãƒ¼',
                    'scifi': 'ğŸš€ SF',
                    'fantasy': 'ğŸ§™ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼',
                    'romance': 'ğŸ’• ãƒ­ãƒãƒ³ã‚¹',
                    'adventure': 'âš”ï¸ ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼'
                };
                return labels[this.currentGenre] || 'ğŸ“š å°èª¬';
            }

            getContentLengthLabel() {
                const labels = ['çŸ­ç·¨','ã‚„ã‚„çŸ­ç·¨','ä¸­ç·¨','ã‚„ã‚„é•·ç·¨','é•·ç·¨'];
                return labels[this.contentLength - 1] || 'ä¸­ç·¨';
            }

            getCreativityLabel() {
                const labels = ['ãƒªã‚¢ãƒ«','ã‚„ã‚„ç¾å®Ÿçš„','ãƒãƒ©ãƒ³ã‚¹','ã‚„ã‚„å¹»æƒ³çš„','ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'];
                return labels[this.creativityLevel - 1] || 'ãƒãƒ©ãƒ³ã‚¹';
            }

            getEntertainmentTypeLabel() {
                const labels = {
                    'collaborative_story': 'ğŸ“š å”åŠ›å°èª¬å‰µä½œ',
                    'character_dialogue': 'ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±',
                    'world_building': 'ğŸŒ ä¸–ç•Œè¦³æ§‹ç¯‰',
                    'story_battle': 'âš”ï¸ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒãƒˆãƒ«',
                    'improvisation': 'ğŸª å³èˆˆåŠ‡å ´',
                    'riddle_game': 'ğŸ§© è¬è§£ãã‚²ãƒ¼ãƒ '
                };
                return labels[this.entertainmentType] || 'ğŸ­ è‡ªç”±å‰µä½œ';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => {
                if (tabName === 'autonomous' && b.textContent.includes('AIè‡ªå¾‹å¯¾è©±')) return true;
                if (tabName === 'entertainment' && b.textContent.includes('ã‚¨ãƒ³ã‚¿ãƒ¡ãƒ¢ãƒ¼ãƒ‰')) return true;
                if (tabName === 'intervention' && b.textContent.includes('äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰')) return true;
                if (tabName === 'learning' && b.textContent.includes('å­¦ç¿’æ©Ÿèƒ½')) return true;
                return false;
            });
            if (activeBtn) activeBtn.classList.add('active');
            const activeContent = document.getElementById(`${tabName}-tab`);
            if (activeContent) activeContent.classList.add('active');
            if (window.crossthinkSystem) window.crossthinkSystem.currentTab = tabName;
        }

        function continueAutonomously() {
            if (window.crossthinkSystem) {
                window.crossthinkSystem.waitingForIntervention = false;
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());
                if (window.crossthinkSystem.isPaused) {
                     window.crossthinkSystem.pauseDialogue(true);
                }
            }
        }

        function switchToInterventionTab() {
            const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.textContent.includes('äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰'));
            if(btn) btn.click(); else switchTab('intervention');
            if (window.crossthinkSystem) {
                 window.crossthinkSystem.elements.humanInput.focus();
            }
        }

        function humanIntervention() { if(window.crossthinkSystem) window.crossthinkSystem.humanIntervention(); }
        function requestDeepening() { if(window.crossthinkSystem) window.crossthinkSystem.requestDeepening(); }
        function redirectDialogue() { if(window.crossthinkSystem) window.crossthinkSystem.redirectDialogue(); }
        function saveInsight() { if(window.crossthinkSystem) window.crossthinkSystem.saveInsight(); }
        function triggerConsensusCheck() { if(window.crossthinkSystem) window.crossthinkSystem.triggerConsensusCheck(); }
        function quickIntervention(type) { if(window.crossthinkSystem) window.crossthinkSystem.quickIntervention(type); }
        function startEntertainmentMode(type) { if(window.crossthinkSystem) window.crossthinkSystem.startEntertainmentMode(type); }
        function exportKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.exportKnowledge(); }
        function importKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.importKnowledge(); }
        function clearKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.clearKnowledge(); }
        function showLearningStats() { if(window.crossthinkSystem) window.crossthinkSystem.showLearningStats(); }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.crossthinkSystem = new CrossthinkEnhanced();
                console.log('Crossthink v6.0 Enhanced Edition Initialized');
            } catch (e) {
                console.error('Initialization failed:', e);
                alert('System init failed. Check console.');
            }
        });

        window.addEventListener('error', e => {
            console.error('Global Error:', e.message, e.filename, e.lineno, e.colno, e.error);
            if(window.crossthinkSystem?.showError) window.crossthinkSystem.showError(`Unhandled: ${e.message}`);
        });
        
        window.addEventListener('unhandledrejection', e => {
            console.error('Unhandled Promise Rejection:', e.reason);
            if(window.crossthinkSystem?.showWarning) window.crossthinkSystem.showWarning(`Async error: ${e.reason?.message || e.reason}`);
        });
    </script>
</body>
</html>