<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v6.0 - Enhanced Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4facfe;
            color: #4facfe;
        }

        .tab-button:hover:not(.active) {
            background: rgba(79, 172, 254, 0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Ëá™ÂæãÂØæË©±„É¢„Éº„Éâ */
        .autonomous-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .autonomous-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* „Ç®„É≥„Çø„É°„É¢„Éº„Éâ */
        .entertainment-section {
            background: #fff3e0;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .entertainment-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .entertainment-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .entertainment-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .entertainment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 152, 0, 0.3);
        }

        /* ÂêàÊÑèÂΩ¢ÊàêË®≠ÂÆö */
        .consensus-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .consensus-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* ‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ */
        .intervention-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .human-input-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .human-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .human-input:focus {
            outline: none;
            border-color: #ffc107;
        }

        .intervention-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Â≠¶ÁøíÊ©üËÉΩ */
        .learning-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .knowledge-base {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .knowledge-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .knowledge-item:last-child {
            border-bottom: none;
        }

        .knowledge-topic {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .knowledge-content {
            font-size: 0.9em;
            color: #666;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "üü¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "üî∑";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8800 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn-entertainment {
            background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }
        .human-stat .stat-number { color: #ffc107; }
        .learning-stat .stat-number { color: #4caf50; }
        .consensus-stat .stat-number { color: #4caf50; }
        .entertainment-stat .stat-number { color: #ff9800; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .human-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
        }

        .learning-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
        }

        .consensus-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
            border: 2px solid #4caf50;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .intervention-prompt {
            background: #fffbf0;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #856404;
        }

        .deepening-request {
            background: #f0f8ff;
            border: 2px dashed #4facfe;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0056b3;
        }

        .auto-pause-notice {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .consensus-achieved {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #4caf50;
            text-align: center;
            font-weight: bold;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "üöÄ";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons, .autonomous-controls, .entertainment-controls, .consensus-controls {
                grid-template-columns: 1fr;
            }
            
            .controls, .intervention-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-tabs {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .tab-button.active {
                border-right-color: #4facfe;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</h1>
            <p>AIËá™ÂæãÂØæË©±„ÉªÂêàÊÑèÂΩ¢Êàê„Éª„Ç®„É≥„Çø„É°„É¢„Éº„ÉâÊê≠Ëºâ„Ç∑„Çπ„ÉÜ„É†</p>
            <div class="demo-label">
                üöÄ v6.0 - Enhanced Edition
            </div>
        </div>

        <div class="mode-tabs">
            <button class="tab-button active" onclick="switchTab('autonomous')">
                ü§ñ AIËá™ÂæãÂØæË©±
            </button>
            <button class="tab-button" onclick="switchTab('entertainment')">
                üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„Éâ
            </button>
            <button class="tab-button" onclick="switchTab('intervention')">
                üë§ ‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ
            </button>
            <button class="tab-button" onclick="switchTab('learning')">
                üß† Â≠¶ÁøíÊ©üËÉΩ
            </button>
        </div>

        <div id="autonomous-tab" class="tab-content active">
            <div class="autonomous-section">
                <h3>ü§ñ AIËá™ÂæãÂØæË©±Ë®≠ÂÆö</h3>
                <div class="autonomous-controls">
                    <div class="control-group">
                        <h4>üéØ ÂØæË©±„É¢„Éº„Éâ</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>üè† ÂÆüÁî®ÁöÑ</span>
                                <span>üíº „Éì„Ç∏„Éç„Çπ</span>
                                <span>üß† Âì≤Â≠¶ÁöÑ</span>
                            </div>
                            <input type="range" id="targetModeSlider" class="range-slider" min="0" max="100" value="33">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>üí° Ê°àÂá∫„Åó</span>
                                <span>ü§ù ÂêàÊÑèÂΩ¢Êàê</span>
                                <span>üîç Êé¢Á¥¢</span>
                            </div>
                            <input type="range" id="goalModeSlider" class="range-slider" min="0" max="100" value="50">
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>‚öôÔ∏è Ëá™ÂæãÂØæË©±Ë®≠ÂÆö</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Áü≠ÊôÇÈñìÈõÜ‰∏≠</span>
                                <span id="autonomyLengthLabel">Ê®ôÊ∫ñ (8„É°„ÉÉ„Çª„Éº„Ç∏)</span>
                                <span>Ê∑±„ÅÑÊé¢Ê±Ç</span>
                            </div>
                            <input type="range" id="autonomyLengthSlider" class="range-slider" min="4" max="200" value="8">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>‰∫∫Èñì‰ªãÂÖ•: „Å™„Åó</span>
                                <span id="interventionFreqLabel">‰∏≠Á®ãÂ∫¶</span>
                                <span>È†ªÁπÅ</span>
                            </div>
                            <input type="range" id="interventionFreqSlider" class="range-slider" min="0" max="10" value="3">
                        </div>
                    </div>
                </div>
            </div>

            <div class="consensus-section">
                <h3>ü§ù ÂêàÊÑèÂΩ¢ÊàêË®≠ÂÆö</h3>
                <div class="consensus-controls">
                    <div class="control-group">
                        <h4>üéØ ÂêàÊÑèÊ§úÂá∫„É¨„Éô„É´</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Âé≥Ê†º</span>
                                <span id="consensusThresholdLabel">Ê®ôÊ∫ñ</span>
                                <span>ÂØõÂÆπ</span>
                            </div>
                            <input type="range" id="consensusThresholdSlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                    </div>
                    <div class="control-group">
                        <h4>‚öôÔ∏è Ëá™ÂãïÁµÇ‰∫ÜË®≠ÂÆö</h4>
                        <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                            <input type="checkbox" id="autoEndOnConsensus" checked>
                            <span>ÂêàÊÑèÂΩ¢ÊàêÊôÇ„Å´Ëá™ÂãïÁµÇ‰∫Ü</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                            <input type="checkbox" id="consensusNotification" checked>
                            <span>ÂêàÊÑèÊ§úÂá∫ÈÄöÁü•„ÇíË°®Á§∫</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="entertainment-tab" class="tab-content">
            <div class="entertainment-section">
                <h3>üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„ÉâË®≠ÂÆö</h3>
                <div class="entertainment-controls">
                    <div class="control-group">
                        <h4>üé¨ „Ç≥„É≥„ÉÜ„É≥„ÉÑË®≠ÂÆö</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Áü≠Á∑®</span>
                                <span id="contentLengthLabel">‰∏≠Á∑®</span>
                                <span>Èï∑Á∑®</span>
                            </div>
                            <input type="range" id="contentLengthSlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>„É™„Ç¢„É´</span>
                                <span id="creativityLabel">„Éê„É©„É≥„Çπ</span>
                                <span>„Éï„Ç°„É≥„Çø„Ç∏„Éº</span>
                            </div>
                            <input type="range" id="creativitySlider" class="range-slider" min="1" max="5" value="3">
                        </div>
                    </div>
                    <div class="control-group">
                        <h4>üé≠ „Ç∏„É£„É≥„É´ÈÅ∏Êäû</h4>
                        <select id="genreSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #e9ecef;">
                            <option value="novel">üìö Â∞èË™¨</option>
                            <option value="dialogue">üí¨ „Éâ„É©„ÉûÂØæË©±</option>
                            <option value="comedy">üòÑ „Ç≥„É°„Éá„Ç£</option>
                            <option value="mystery">üîç „Éü„Çπ„ÉÜ„É™„Éº</option>
                            <option value="scifi">üöÄ SF</option>
                            <option value="fantasy">üßô „Éï„Ç°„É≥„Çø„Ç∏„Éº</option>
                            <option value="romance">üíï „É≠„Éû„É≥„Çπ</option>
                            <option value="adventure">‚öîÔ∏è „Ç¢„Éâ„Éô„É≥„ÉÅ„É£„Éº</option>
                        </select>
                    </div>
                </div>
                
                <div class="entertainment-buttons">
                    <button class="entertainment-btn" onclick="startEntertainmentMode('collaborative_story')">
                        üìö ÂçîÂäõÂ∞èË™¨Ââµ‰Ωú
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('character_dialogue')">
                        üé≠ „Ç≠„É£„É©„ÇØ„Çø„ÉºÂØæË©±
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('world_building')">
                        üåç ‰∏ñÁïåË¶≥ÊßãÁØâ
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('story_battle')">
                        ‚öîÔ∏è „Çπ„Éà„Éº„É™„Éº„Éê„Éà„É´
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('improvisation')">
                        üé™ Âç≥ËààÂäáÂ†¥
                    </button>
                    <button class="entertainment-btn" onclick="startEntertainmentMode('riddle_game')">
                        üß© Ë¨éËß£„Åç„Ç≤„Éº„É†
                    </button>
                </div>
            </div>
        </div>

        <div id="intervention-tab" class="tab-content">
            <div class="intervention-section">
                <h3>üë§ ‰∫∫Èñì‰ªãÂÖ•„Ç≥„É≥„Éà„É≠„Éº„É´</h3>
                <div class="human-input-area">
                    <h4>üí¨ „ÅÇ„Å™„Åü„ÅÆÁô∫Ë®Ä</h4>
                    <textarea id="humanInput" class="human-input" 
                                placeholder="AI„ÅÆÂØæË©±„Å´‰ªãÂÖ•„Åó„Åü„ÅÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË≥™Âïè„ÄÅÊåáÊëò„ÄÅÊñ∞„Åó„ÅÑË¶ñÁÇπ„ÅÆÊèê‰æõ„Å™„Å©„ÄÅËá™Áî±„Å´Áô∫Ë®Ä„Åß„Åç„Åæ„Åô„ÄÇ"></textarea>
                    
                    <div class="intervention-buttons">
                        <button class="btn btn-warning" onclick="humanIntervention()">
                            üí¨ ÂØæË©±„Å´‰ªãÂÖ•
                        </button>
                        <button class="btn btn-secondary" onclick="requestDeepening()">
                            üîç Ë´ñÁÇπ„ÇíÊ∑±Êéò„ÇäË¶ÅÊ±Ç
                        </button>
                        <button class="btn btn-primary" onclick="redirectDialogue()">
                            üéØ ÂØæË©±„ÅÆÊñπÂêëËª¢Êèõ
                        </button>
                        <button class="btn btn-success" onclick="saveInsight()">
                            üí° Ê¥ûÂØü„ÇíÂ≠¶Áøí„Éá„Éº„Çø„Å´‰øùÂ≠ò
                        </button>
                        <button class="btn btn-entertainment" onclick="triggerConsensusCheck()">
                            ü§ù ÂêàÊÑèÁ¢∫Ë™ç„ÇíÂÆüË°å
                        </button>
                    </div>
                </div>
                
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="quickIntervention('ÂÖ∑‰Ωì‰æã')">
                        üìù „ÄåÂÖ∑‰Ωì‰æã„ÇíÊïô„Åà„Å¶„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ÂèçÂØæÊÑèË¶ã')">
                        üîÑ „ÄåÂèçÂØæ„ÅÆË¶ñÁÇπ„Åß„ÅØÔºü„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ÂÆüÁî®ÊÄß')">
                        üõ†Ô∏è „ÄåÂÆüÁî®ÊÄß„ÇíÈáçË¶ñ„Åó„Å¶„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('Á∞°ÊΩî„Å´')">
                        ‚úÇÔ∏è „Äå„ÇÇ„Å£„Å®Á∞°ÊΩî„Å´„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ÂêàÊÑèÂΩ¢Êàê')">
                        ü§ù „ÄåÂêàÊÑèÁÇπ„ÇíÊé¢„Åù„ÅÜ„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('„Ç®„É≥„Çø„É°Ëª¢Êèõ')">
                        üé≠ „ÄåÈù¢ÁôΩ„ÅèË°®Áèæ„Åó„Å¶„Äç
                    </button>
                </div>
            </div>
        </div>

        <div id="learning-tab" class="tab-content">
            <div class="learning-section">
                <h3>üß† Ê±éÁî®AIÂ≠¶ÁøíÊ©üËÉΩ</h3>
                <div class="knowledge-base" id="knowledgeBase">
                    <div class="knowledge-item">
                        <div class="knowledge-topic">„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ</div>
                        <div class="knowledge-content">Crossthink v6.0 Enhanced Edition „ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇÂêàÊÑèÂΩ¢ÊàêÊ§úÂá∫„Å®„Ç®„É≥„Çø„É°„É¢„Éº„Éâ„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü„ÄÇ</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="exportKnowledge()">
                        üì§ Â≠¶Áøí„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-primary" onclick="importKnowledge()">
                        üì• Â≠¶Áøí„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-warning" onclick="clearKnowledge()">
                        üóëÔ∏è Â≠¶Áøí„Éá„Éº„Çø„ÇØ„É™„Ç¢
                    </button>
                    <button class="btn btn-secondary" onclick="showLearningStats()">
                        üìä Â≠¶ÁøíÁµ±Ë®àË°®Á§∫
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>üîß APIË®≠ÂÆö</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>üìù ÂØæË©±„Éà„Éî„ÉÉ„ÇØ:</h2>
            <input type="text" id="topicInput" class="topic-input" 
                    placeholder="AIÂêåÂ£´„Å´ÂØæË©±„Åï„Åõ„Åü„ÅÑ„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" 
                    value="AIÊôÇ‰ª£„Å´„Åä„Åë„Çã‰∫∫Èñì„ÅÆÂâµÈÄ†ÊÄß„Å®„ÅØ‰Ωï„ÅãÔºü">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">üöÄ ÂØæË©±ÈñãÂßã</button>
                <button id="pauseBtn" class="btn btn-warning" disabled>‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                <button id="stopBtn" class="btn btn-danger" disabled>‚èπÔ∏è ÂÅúÊ≠¢</button>
                <button id="clearBtn" class="btn btn-secondary">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                <button id="exportBtn" class="btn btn-secondary">üìù Ë¶ÅÁ¥ÑÁîüÊàê</button>
                <button id="consensusBtn" class="btn btn-success">ü§ù ÂêàÊÑèÁ¢∫Ë™ç</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìä ÂØæË©±Áµ±Ë®à</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">GeminiÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card human-stat">
                    <div class="stat-number" id="humanMessages">0</div>
                    <div class="stat-label">‰∫∫Èñì‰ªãÂÖ•</div>
                </div>
                <div class="stat-card learning-stat">
                    <div class="stat-number" id="learningItems">1</div>
                    <div class="stat-label">Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†</div>
                </div>
                <div class="stat-card consensus-stat">
                    <div class="stat-number" id="consensusCount">0</div>
                    <div class="stat-label">ÂêàÊÑèÂΩ¢ÊàêÂõûÊï∞</div>
                </div>
                <div class="stat-card entertainment-stat">
                    <div class="stat-number" id="entertainmentSessions">0</div>
                    <div class="stat-label">„Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">ÁµåÈÅéÊôÇÈñì(Áßí)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>üöÄ v6.0 Enhanced Edition „ÅÆÊñ∞Ê©üËÉΩ:</h3>
            <ul>
                <li>ü§ù Ëá™ÂãïÂêàÊÑèÂΩ¢ÊàêÊ§úÂá∫ÔºöAI„ÅåË≠∞Ë´ñ„ÅÆÂêàÊÑèÁÇπ„ÇíËá™ÂãïÊ§úÂá∫„Åó„ÄÅÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂØæË©±ÁµÇ‰∫Ü</li>
                <li>üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„ÉâÔºöÂ∞èË™¨Ââµ‰Ωú„ÄÅ„Ç≠„É£„É©„ÇØ„Çø„ÉºÂØæË©±„ÄÅ‰∏ñÁïåË¶≥ÊßãÁØâ„Å™„Å©Ââµ‰ΩúÁâπÂåñÊ©üËÉΩ</li>
                <li>üìö ÂçîÂäõ„Çπ„Éà„Éº„É™„Éº„ÉÜ„É™„É≥„Ç∞ÔºöAI„Åå‰∫§‰∫í„Å´Áâ©Ë™û„ÇíÁ¥°„Åé„ÄÅ‰∫∫Èñì„ÅåÊñπÂêëÊÄß„ÇíÊåáÂ∞é</li>
                <li>üé™ Âç≥ËààÂäáÂ†¥„É¢„Éº„ÉâÔºö„É™„Ç¢„É´„Çø„Ç§„É†„Åß„Éâ„É©„Éû„ÉÅ„ÉÉ„ÇØ„Å™ÂØæË©±„ÇíÁîüÊàê</li>
                <li>üß© Ë¨éËß£„Åç„Ç≤„Éº„É†ÔºöAI„ÅåË¨é„ÇíÂá∫„ÅóÂêà„ÅÑ„ÄÅËß£Ê±∫Á≠ñ„ÇíÂçîÂäõ„Åó„Å¶Êé¢Ê±Ç</li>
                <li>üåç ‰∏ñÁïåË¶≥ÊßãÁØâÔºö„Éï„Ç°„É≥„Çø„Ç∏„Éº„ÇÑSF‰∏ñÁïå„ÅÆË©≥Á¥∞Ë®≠ÂÆö„ÇíAI„ÅåÂçîÂÉç„Åß‰ΩúÊàê</li>
                <li>‚öîÔ∏è „Çπ„Éà„Éº„É™„Éº„Éê„Éà„É´ÔºöÁ´∂‰∫âÁöÑ„Å™Ââµ‰Ωú„Åß‰∫í„ÅÑ„ÅÆÊÉ≥ÂÉèÂäõ„ÇíÈ´ò„ÇÅÂêà„ÅÜ</li>
                <li>üéØ È´òÂ∫¶„Å™ÂêàÊÑèÊ§úÂá∫„Ç¢„É´„Ç¥„É™„Ç∫„É†ÔºöÂ§öÊ¨°ÂÖÉÁöÑ„Å™ÂêàÊÑè„É¨„Éô„É´ÂàÜÊûê</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            </div>
    </div>

    <script>
        class CrossthinkEnhanced {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.consensusCount = 0;
                this.entertainmentSessions = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8;
                this.interventionPoints = [];
                this.knowledgeBase = new Map();
                this.waitingForIntervention = false;
                
                this.targetMode = 'philosophical';
                this.goalMode = 'exploration';
                this.interventionFrequency = 3;
                this.currentTab = 'autonomous';
                
                // Êñ∞Ê©üËÉΩÔºöÂêàÊÑèÂΩ¢Êàê
                this.consensusThreshold = 3; // 1-5„ÅÆ„É¨„Éô„É´
                this.autoEndOnConsensus = true;
                this.consensusNotification = true;
                this.lastConsensusCheck = 0;
                
                // Êñ∞Ê©üËÉΩÔºö„Ç®„É≥„Çø„É°„É¢„Éº„Éâ
                this.entertainmentMode = false;
                this.currentGenre = 'novel';
                this.contentLength = 3; // 1-5
                this.creativityLevel = 3; // 1-5
                this.entertainmentType = null;
                
                this.learningEnabled = true;
                this.autoLearnKeywords = ['ÈáçË¶Å', 'Êú¨Ë≥™', 'Ê†∏ÂøÉ', 'ÁµêË´ñ', 'Áô∫Ë¶ã', 'Ê¥ûÂØü', 'Èù©Êñ∞', 'ÊèêÊ°à', 'ÂêàÊÑè', '‰∏ÄËá¥', 'ÂêåÊÑè', 'Èù¢ÁôΩ„ÅÑ', 'ÂâµÈÄ†ÁöÑ'];
                
                // ÂêàÊÑèÊ§úÂá∫„Ç≠„Éº„ÉØ„Éº„Éâ
                this.consensusKeywords = [
                    'ÂêàÊÑè', '‰∏ÄËá¥', 'ÂêåÊÑè', 'ÂêåÊÑü', 'Ë≥õÊàê', 'Á¥çÂæó', 'ÁêÜËß£', 'ÂÖ±ÈÄöË™çË≠ò',
                    '„Åù„ÅÆÈÄö„Çä', '„Åæ„Åï„Å´', 'Á¢∫„Åã„Å´', 'Âêå„ÅòÊÑèË¶ã', 'ÁµêË´ñ„Å®„Åó„Å¶',
                    'ÁßÅ„Åü„Å°„ÅØ', '„Åä‰∫í„ÅÑ„Å´', '‰∏°ËÄÖ„Å®„ÇÇ', 'ÂÖ±„Å´', '„Å§„Åæ„Çä'
                ];
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeKnowledgeBase();
                this.updateSliderLabels();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    consensusBtn: document.getElementById('consensusBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    humanMessages: document.getElementById('humanMessages'),
                    learningItems: document.getElementById('learningItems'),
                    consensusCount: document.getElementById('consensusCount'),
                    entertainmentSessions: document.getElementById('entertainmentSessions'),
                    elapsed: document.getElementById('elapsed'),
                    targetModeSlider: document.getElementById('targetModeSlider'),
                    goalModeSlider: document.getElementById('goalModeSlider'),
                    autonomyLengthSlider: document.getElementById('autonomyLengthSlider'),
                    interventionFreqSlider: document.getElementById('interventionFreqSlider'),
                    autonomyLengthLabel: document.getElementById('autonomyLengthLabel'),
                    interventionFreqLabel: document.getElementById('interventionFreqLabel'),
                    consensusThresholdSlider: document.getElementById('consensusThresholdSlider'),
                    consensusThresholdLabel: document.getElementById('consensusThresholdLabel'),
                    autoEndOnConsensus: document.getElementById('autoEndOnConsensus'),
                    consensusNotification: document.getElementById('consensusNotification'),
                    contentLengthSlider: document.getElementById('contentLengthSlider'),
                    contentLengthLabel: document.getElementById('contentLengthLabel'),
                    creativitySlider: document.getElementById('creativitySlider'),
                    creativityLabel: document.getElementById('creativityLabel'),
                    genreSelect: document.getElementById('genreSelect'),
                    humanInput: document.getElementById('humanInput'),
                    knowledgeBase: document.getElementById('knowledgeBase')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                this.elements.consensusBtn.addEventListener('click', () => this.manualConsensusCheck());
                
                this.elements.targetModeSlider.addEventListener('input', () => this.updateTargetMode());
                this.elements.goalModeSlider.addEventListener('input', () => this.updateGoalMode());
                this.elements.autonomyLengthSlider.addEventListener('input', () => this.updateAutonomyLength());
                this.elements.interventionFreqSlider.addEventListener('input', () => this.updateInterventionFreq());
                this.elements.consensusThresholdSlider.addEventListener('input', () => this.updateConsensusThreshold());
                this.elements.contentLengthSlider.addEventListener('input', () => this.updateContentLength());
                this.elements.creativitySlider.addEventListener('input', () => this.updateCreativity());
                
                this.elements.autoEndOnConsensus.addEventListener('change', (e) => {
                    this.autoEndOnConsensus = e.target.checked;
                });
                
                this.elements.consensusNotification.addEventListener('change', (e) => {
                    this.consensusNotification = e.target.checked;
                });
                
                this.elements.genreSelect.addEventListener('change', (e) => {
                    this.currentGenre = e.target.value;
                });
                
                this.elements.humanInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        this.humanIntervention();
                    }
                });
            }

            updateSliderLabels() {
                // ÂØæË©±Èï∑
                const autonomyValue = this.elements.autonomyLengthSlider.value;
                this.elements.autonomyLengthLabel.textContent = `${autonomyValue}„É°„ÉÉ„Çª„Éº„Ç∏`;
                this.maxMessages = parseInt(autonomyValue);

                // ‰ªãÂÖ•È†ªÂ∫¶
                const interventionVal = parseInt(this.elements.interventionFreqSlider.value);
                const freqLabels = ['„Å™„Åó', 'Á®Ä', 'Â∞ë', '‰∏≠', 'Â§ö', 'È†ªÁπÅ', 'ÈùûÂ∏∏„Å´È†ªÁπÅ', 'Â∏∏ÊôÇ', '„É™„Ç¢„É´„Çø„Ç§„É†', '„Ç∑„É≥„ÇØ„É≠', '„Éï„É´‰ªãÂÖ•'];
                this.elements.interventionFreqLabel.textContent = freqLabels[interventionVal] || '‰∏≠Á®ãÂ∫¶';
                this.interventionFrequency = interventionVal;

                // ÂêàÊÑèÊ§úÂá∫„É¨„Éô„É´
                const consensusVal = parseInt(this.elements.consensusThresholdSlider.value);
                const consensusLabels = ['Âé≥Ê†º', '„ÇÑ„ÇÑÂé≥Ê†º', 'Ê®ôÊ∫ñ', '„ÇÑ„ÇÑÂØõÂÆπ', 'ÂØõÂÆπ'];
                this.elements.consensusThresholdLabel.textContent = consensusLabels[consensusVal - 1] || 'Ê®ôÊ∫ñ';
                this.consensusThreshold = consensusVal;

                // „Ç≥„É≥„ÉÜ„É≥„ÉÑÈï∑
                const contentVal = parseInt(this.elements.contentLengthSlider.value);
                const contentLabels = ['Áü≠Á∑®', '„ÇÑ„ÇÑÁü≠Á∑®', '‰∏≠Á∑®', '„ÇÑ„ÇÑÈï∑Á∑®', 'Èï∑Á∑®'];
                this.elements.contentLengthLabel.textContent = contentLabels[contentVal - 1] || '‰∏≠Á∑®';
                this.contentLength = contentVal;

                // ÂâµÈÄ†ÊÄß„É¨„Éô„É´
                const creativityVal = parseInt(this.elements.creativitySlider.value);
                const creativityLabels = ['„É™„Ç¢„É´', '„ÇÑ„ÇÑÁèæÂÆüÁöÑ', '„Éê„É©„É≥„Çπ', '„ÇÑ„ÇÑÂπªÊÉ≥ÁöÑ', '„Éï„Ç°„É≥„Çø„Ç∏„Éº'];
                this.elements.creativityLabel.textContent = creativityLabels[creativityVal - 1] || '„Éê„É©„É≥„Çπ';
                this.creativityLevel = creativityVal;

                this.updateTargetMode();
                this.updateGoalMode();
            }

            updateTargetMode() {
                const value = parseInt(this.elements.targetModeSlider.value);
                if (value < 33) this.targetMode = 'practical';
                else if (value < 66) this.targetMode = 'business';
                else this.targetMode = 'philosophical';
            }

            updateGoalMode() {
                const value = parseInt(this.elements.goalModeSlider.value);
                if (value < 33) this.goalMode = 'ideation';
                else if (value < 66) this.goalMode = 'consensus';
                else this.goalMode = 'exploration';
            }

            updateAutonomyLength() {
                const value = this.elements.autonomyLengthSlider.value;
                this.elements.autonomyLengthLabel.textContent = `${value}„É°„ÉÉ„Çª„Éº„Ç∏`;
                this.maxMessages = parseInt(value);
            }

            updateInterventionFreq() {
                const value = parseInt(this.elements.interventionFreqSlider.value);
                const labels = ['„Å™„Åó', 'Á®Ä', 'Â∞ë', '‰∏≠', 'Â§ö', 'È†ªÁπÅ', 'ÈùûÂ∏∏„Å´È†ªÁπÅ', 'Â∏∏ÊôÇ', '„É™„Ç¢„É´„Çø„Ç§„É†', '„Ç∑„É≥„ÇØ„É≠', '„Éï„É´‰ªãÂÖ•'];
                this.elements.interventionFreqLabel.textContent = labels[value] || '‰∏≠Á®ãÂ∫¶';
                this.interventionFrequency = value;
            }

            updateConsensusThreshold() {
                const value = parseInt(this.elements.consensusThresholdSlider.value);
                const labels = ['Âé≥Ê†º', '„ÇÑ„ÇÑÂé≥Ê†º', 'Ê®ôÊ∫ñ', '„ÇÑ„ÇÑÂØõÂÆπ', 'ÂØõÂÆπ'];
                this.elements.consensusThresholdLabel.textContent = labels[value - 1] || 'Ê®ôÊ∫ñ';
                this.consensusThreshold = value;
            }

            updateContentLength() {
                const value = parseInt(this.elements.contentLengthSlider.value);
                const labels = ['Áü≠Á∑®', '„ÇÑ„ÇÑÁü≠Á∑®', '‰∏≠Á∑®', '„ÇÑ„ÇÑÈï∑Á∑®', 'Èï∑Á∑®'];
                this.elements.contentLengthLabel.textContent = labels[value - 1] || '‰∏≠Á∑®';
                this.contentLength = value;
            }

            updateCreativity() {
                const value = parseInt(this.elements.creativitySlider.value);
                const labels = ['„É™„Ç¢„É´', '„ÇÑ„ÇÑÁèæÂÆüÁöÑ', '„Éê„É©„É≥„Çπ', '„ÇÑ„ÇÑÂπªÊÉ≥ÁöÑ', '„Éï„Ç°„É≥„Çø„Ç∏„Éº'];
                this.elements.creativityLabel.textContent = labels[value - 1] || '„Éê„É©„É≥„Çπ';
                this.creativityLevel = value;
            }

            initializeKnowledgeBase() {
                this.knowledgeBase.set('system_init', {
                    topic: '„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ',
                    content: 'Crossthink v6.0 Enhanced Edition „ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇÂêàÊÑèÂΩ¢ÊàêÊ§úÂá∫„Å®„Ç®„É≥„Çø„É°„É¢„Éº„Éâ„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü„ÄÇ',
                    timestamp: new Date(),
                    source: 'system_init'
                });
                this.updateKnowledgeDisplay();
                this.updateStats();
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v6.0 Enhanced Edition „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ\n\n' +
                    'üöÄ v6.0 „ÅÆÊñ∞Ê©üËÉΩ:\n' +
                    '‚Ä¢ ü§ù Ëá™ÂãïÂêàÊÑèÂΩ¢ÊàêÊ§úÂá∫: AI„ÅåË≠∞Ë´ñ„ÅÆÂêàÊÑèÁÇπ„ÇíÊ§úÂá∫„ÅóÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÁµÇ‰∫Ü\n' +
                    '‚Ä¢ üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„Éâ: Â∞èË™¨Ââµ‰Ωú„ÄÅ„Ç≠„É£„É©„ÇØ„Çø„ÉºÂØæË©±„ÄÅ‰∏ñÁïåË¶≥ÊßãÁØâ\n' +
                    '‚Ä¢ üìö ÂçîÂäõ„Çπ„Éà„Éº„É™„Éº„ÉÜ„É™„É≥„Ç∞: AI„Åå‰∫§‰∫í„Å´Áâ©Ë™û„ÇíÁ¥°„Åê\n' +
                    '‚Ä¢ üé™ Âç≥ËààÂäáÂ†¥: „É™„Ç¢„É´„Çø„Ç§„É†„Éâ„É©„Éû„ÉÅ„ÉÉ„ÇØÂØæË©±\n' +
                    '‚Ä¢ üß© Ë¨éËß£„Åç„Ç≤„Éº„É†: AIÂêåÂ£´„ÅÆË¨éËß£„ÅçÂçîÂäõ\n' +
                    '‚Ä¢ üåç ‰∏ñÁïåË¶≥ÊßãÁØâ: „Éï„Ç°„É≥„Çø„Ç∏„Éº/SF‰∏ñÁïåË®≠ÂÆö‰ΩúÊàê\n\n' +
                    'üí° ‰Ωø„ÅÑÊñπ:\n' +
                    '1. ü§ñ AIËá™ÂæãÂØæË©±: ÈÄöÂ∏∏„ÅÆË≠∞Ë´ñ„ÉªÊé¢Ê±Ç„É¢„Éº„Éâ\n' +
                    '2. üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„Éâ: Ââµ‰Ωú„ÉªÂ®ØÊ•ΩÁâπÂåñ„É¢„Éº„Éâ\n' +
                    '3. üë§ ‰∫∫Èñì‰ªãÂÖ•: „É™„Ç¢„É´„Çø„Ç§„É†ÂØæË©±ÂèÇÂä†\n' +
                    '4. üß† Â≠¶ÁøíÊ©üËÉΩ: Ê¥ûÂØü„ÅÆËìÑÁ©ç„ÉªÁÆ°ÁêÜ\n\n' +
                    'üéØ Enhanced Features:\n' +
                    'ü§ñ È´òÂ∫¶„Å™ÂêàÊÑèÊ§úÂá∫„Ç¢„É´„Ç¥„É™„Ç∫„É†\n' +
                    'üé® Â§öÊßò„Å™„Ç®„É≥„Çø„É°„Ç∏„É£„É≥„É´ÂØæÂøú\n' +
                    'üé™ ÂãïÁöÑ„Å™Ââµ‰ΩúÊîØÊè¥„Ç∑„Çπ„ÉÜ„É†\n' +
                    'üî¨ ÈÄ≤Âåñ„Åô„ÇãÂØæË©±ÂìÅË≥™'
                );
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.isPaused = false;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.lastConsensusCheck = 0;
                this.updateStats();

                this.elements.startBtn.disabled = true;
                this.elements.pauseBtn.disabled = false;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                
                let modeDescription = '';
                if (this.entertainmentMode) {
                    this.entertainmentSessions++;
                    modeDescription = `üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„Éâ: ${this.getGenreLabel()}\n` +
                                     `üìè „Ç≥„É≥„ÉÜ„É≥„ÉÑÈï∑: ${this.getContentLengthLabel()}\n` +
                                     `üé® ÂâµÈÄ†ÊÄß: ${this.getCreativityLabel()}\n` +
                                     `üé™ „Çø„Ç§„Éó: ${this.getEntertainmentTypeLabel()}`;
                } else {
                    modeDescription = `üé™ „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}\n` +
                                     `ü§ù ÂêàÊÑèÊ§úÂá∫: ${this.getConsensusThresholdLabel()}\n` +
                                     `üîÑ Ëá™ÂãïÁµÇ‰∫Ü: ${this.autoEndOnConsensus ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}`;
                }
                
                this.addMessage('system', 
                    `üöÄ ${this.entertainmentMode ? '„Ç®„É≥„Çø„É°„É¢„Éº„Éâ' : 'AIËá™ÂæãÂØæË©±'}ÈñãÂßã\n` +
                    `üìù „Éà„Éî„ÉÉ„ÇØ: "${topic}"\n` +
                    modeDescription + '\n' +
                    `‚è±Ô∏è ÊúÄÂ§ß„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.maxMessages}\n` +
                    `üë§ ‰ªãÂÖ•Ë®≠ÂÆö: ${this.getInterventionLabel()}\n` +
                    `üß† Â≠¶ÁøíÊ©üËÉΩ: ${this.learningEnabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}\n` +
                    `ü§ñ AI„Åå${this.entertainmentMode ? 'Ââµ‰ΩúÊ¥ªÂãï' : 'Ë≠∞Ë´ñ'}„ÇíÈñãÂßã„Åó„Åæ„Åô...`
                );

                this.learnFromDialogue('ÂØæË©±ÈñãÂßã', `Êñ∞„Åó„ÅÑ${this.entertainmentMode ? '„Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥' : 'ÂØæË©±'}„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü: ${topic}`);
                this.startTimer();

                const initialPrompt = this.entertainmentMode ? 
                    this.generateEntertainmentPrompt(topic) : 
                    this.generateInitialPrompt(topic);
                await this.sendMessage('openai', initialPrompt, false);
            }

            generateEntertainmentPrompt(topic) {
                const genreInstructions = this.getGenreInstructions();
                const lengthGuidance = this.getLengthGuidance();
                const creativityGuidance = this.getCreativityGuidance();
                
                const basePrompt = `üé≠ **„Ç®„É≥„Çø„É°„É¢„Éº„ÉâÈñãÂßã (Crossthink v6.0)**\n` +
                    `„ÅÇ„Å™„Åü„ÅØChatGPTÔºàOpenAIÔºâ„Å®„Åó„Å¶„ÄÅGeminiÔºàGoogleÔºâ„Å®ÂçîÂäõ„Åó„Å¶${genreInstructions.name}„ÇíÂâµ‰Ωú„Åó„Åæ„Åô„ÄÇ\n\n` +
                    `üìù **Ââµ‰Ωú„ÉÜ„Éº„Éû**: "${topic}"\n` +
                    `üé® **„Ç∏„É£„É≥„É´**: ${genreInstructions.name}\n` +
                    `üìè **Èï∑„Åï**: ${lengthGuidance}\n` +
                    `üåü **ÂâµÈÄ†ÊÄß„É¨„Éô„É´**: ${creativityGuidance}\n` +
                    `üé™ **Ââµ‰Ωú„Çø„Ç§„Éó**: ${this.getEntertainmentTypeInstructions()}\n\n` +
                    `${genreInstructions.description}\n\n` +
                    `**Ââµ‰Ωú„É´„Éº„É´**:\n` +
                    `‚Ä¢ Áõ∏Êâã„ÅÆÂâµ‰Ωú„ÇíÂ∞äÈáç„Åó„ÄÅÂª∫Ë®≠ÁöÑ„Å´Áô∫Â±ï„Åï„Åõ„Çã\n` +
                    `‚Ä¢ ${lengthGuidance}„Å´ÈÅ©„Åó„ÅüÂàÜÈáè„ÅßÂøúÁ≠î\n` +
                    `‚Ä¢ ${creativityGuidance}„É¨„Éô„É´„ÅÆÂâµÈÄ†ÊÄß„ÇíÁô∫ÊèÆ\n` +
                    `‚Ä¢ Ë™≠ËÄÖ/Ë¶ñËÅ¥ËÄÖ„ÇíÊ•Ω„Åó„Åæ„Åõ„Çã„Åì„Å®„ÇíÊúÄÂÑ™ÂÖà\n` +
                    `‚Ä¢ ‰∫∫Èñì„Åå‰ªãÂÖ•„Åó„ÅüÂ†¥Âêà„ÅØÊåáÁ§∫„Å´Âæì„Å£„Å¶Ë™øÊï¥\n\n` +
                    `„Åß„ÅØ„ÄÅÊúÄÂàù„ÅÆÈÉ®ÂàÜ„ÇíÂâµ‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`;
                
                return basePrompt;
            }

            getGenreInstructions() {
                const genres = {
                    'novel': {
                        name: 'Â∞èË™¨',
                        description: 'È≠ÖÂäõÁöÑ„Å™„Ç≠„É£„É©„ÇØ„Çø„Éº„ÄÅÂºï„ÅçËæº„Åæ„Çå„Çã„Éó„É≠„ÉÉ„Éà„ÄÅÁæé„Åó„ÅÑÊñá‰Ωì„ÅßÁâ©Ë™û„ÇíÁ¥°„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'dialogue': {
                        name: '„Éâ„É©„ÉûÂØæË©±',
                        description: '„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêåÂ£´„ÅÆÁîü„ÅçÁîü„Åç„Å®„Åó„ÅüÂØæË©±„ÅßÁâ©Ë™û„ÇíÈÄ≤Ë°å„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'comedy': {
                        name: '„Ç≥„É°„Éá„Ç£',
                        description: '„É¶„Éº„É¢„Ç¢„ÅÇ„Åµ„Çå„ÇãÂ±ïÈñã„ÅßË™≠ËÄÖ„ÇíÁ¨ë„Çè„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'mystery': {
                        name: '„Éü„Çπ„ÉÜ„É™„Éº',
                        description: 'Ë¨é„Å®Êâã„Åå„Åã„Çä„ÇíÂ∑ßÂ¶ô„Å´ÈÖçÁΩÆ„Åó„ÄÅË™≠ËÄÖ„ÇíÊé®ÁêÜ„Å´Ë™ò„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'scifi': {
                        name: 'SF',
                        description: 'ÁßëÂ≠¶ÊäÄË°ì„Å®Êú™Êù•Á§æ‰ºö„ÇíËÉåÊôØ„Å´ÊÉ≥ÂÉèÂäõË±ä„Åã„Å™‰∏ñÁïå„ÇíÊèè„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'fantasy': {
                        name: '„Éï„Ç°„É≥„Çø„Ç∏„Éº',
                        description: 'È≠îÊ≥ï„Å®ÂπªÊÉ≥„ÅÆ‰∏ñÁïå„ÅßÂ£ÆÂ§ß„Å™ÂÜíÈô∫„ÇíÊèè„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'romance': {
                        name: '„É≠„Éû„É≥„Çπ',
                        description: 'ÂøÉÊ∏©„Åæ„ÇãÊÅãÊÑõÈñ¢‰øÇ„Å®ÊÑüÊÉÖ„ÅÆÊ©üÂæÆ„Çí‰∏ÅÂØß„Å´Êèè„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'adventure': {
                        name: '„Ç¢„Éâ„Éô„É≥„ÉÅ„É£„Éº',
                        description: '„Çπ„É™„É™„É≥„Ç∞„Å™ÂÜíÈô∫„Å®ÊåëÊà¶„Å´Ê∫Ä„Å°„ÅüÁâ©Ë™û„ÇíÂ±ïÈñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    }
                };
                return genres[this.currentGenre] || genres['novel'];
            }

            getLengthGuidance() {
                const lengths = ['Áü≠„ÅÑÊÆµËêΩ', '„ÇÑ„ÇÑÁü≠„ÇÅ„ÅÆÊñáÁ´†', '‰∏≠Á®ãÂ∫¶„ÅÆÊñáÁ´†', '„ÇÑ„ÇÑÈï∑„ÇÅ„ÅÆÊñáÁ´†', 'Èï∑„ÅÑÊèèÂÜô'];
                return lengths[this.contentLength - 1] || '‰∏≠Á®ãÂ∫¶„ÅÆÊñáÁ´†';
            }

            getCreativityGuidance() {
                const creativity = ['ÁèæÂÆüÁöÑ„ÅßÂú∞„Å´Ë∂≥„Å§„ÅÑ„Åü', '„ÇÑ„ÇÑÁèæÂÆüÂØÑ„Çä„ÅÆ', '„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„Åü', '„ÇÑ„ÇÑÂπªÊÉ≥ÁöÑ„Å™', 'ÈùûÂ∏∏„Å´ÂâµÈÄ†ÁöÑ„ÅßÂπªÊÉ≥ÁöÑ„Å™'];
                return creativity[this.creativityLevel - 1] || '„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„Åü';
            }

            getEntertainmentTypeInstructions() {
                const types = {
                    'collaborative_story': 'ÂçîÂäõ„Åó„Å¶‰∏Ä„Å§„ÅÆÁâ©Ë™û„ÇíÂÆåÊàê„Åï„Åõ„Çã',
                    'character_dialogue': '„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêåÂ£´„ÅÆÂØæË©±„Çí‰∏≠ÂøÉ„Å®„Åó„ÅüÂ±ïÈñã',
                    'world_building': 'Ë©≥Á¥∞„Å™‰∏ñÁïåË¶≥„ÅÆÊßãÁØâ„Å®Êé¢Á¥¢',
                    'story_battle': 'Á´∂‰∫âÁöÑ„Å´ÂêÑËá™„ÅÆÂâµ‰Ωú„Ç¢„Ç§„Éá„Ç¢„ÇíÊèêÁ§∫',
                    'improvisation': 'Âç≥ËààÁöÑ„Åß‰∫àÊ∏¨‰∏çÂèØËÉΩ„Å™Â±ïÈñã',
                    'riddle_game': 'Ë¨éËß£„ÅçË¶ÅÁ¥†„ÇíÂê´„ÇÄÂØæË©±'
                };
                return types[this.entertainmentType] || 'Ëá™Áî±„Å™Ââµ‰ΩúÂØæË©±';
            }

            startEntertainmentMode(type) {
                this.entertainmentMode = true;
                this.entertainmentType = type;
                
                const typeLabels = {
                    'collaborative_story': 'üìö ÂçîÂäõÂ∞èË™¨Ââµ‰Ωú',
                    'character_dialogue': 'üé≠ „Ç≠„É£„É©„ÇØ„Çø„ÉºÂØæË©±',
                    'world_building': 'üåç ‰∏ñÁïåË¶≥ÊßãÁØâ',
                    'story_battle': '‚öîÔ∏è „Çπ„Éà„Éº„É™„Éº„Éê„Éà„É´',
                    'improvisation': 'üé™ Âç≥ËààÂäáÂ†¥',
                    'riddle_game': 'üß© Ë¨éËß£„Åç„Ç≤„Éº„É†'
                };
                
                this.addMessage('system', 
                    `üé≠ „Ç®„É≥„Çø„É°„É¢„Éº„ÉâË®≠ÂÆöÂÆå‰∫Ü\n` +
                    `üìù „Çø„Ç§„Éó: ${typeLabels[type]}\n` +
                    `üé® „Ç∏„É£„É≥„É´: ${this.getGenreLabel()}\n` +
                    `üìè Èï∑„Åï: ${this.getContentLengthLabel()}\n` +
                    `üåü ÂâµÈÄ†ÊÄß: ${this.getCreativityLabel()}\n\n` +
                    `„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåÂØæË©±ÈñãÂßã„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‰æã: "ÂÆáÂÆôËàπ„ÅßÊú™Áü•„ÅÆÊÉëÊòü„ÇíÊé¢Á¥¢„Åô„ÇãÁâ©Ë™û", "È≠îÊ≥ïÂ≠¶Ê†°„ÅÆÊó•Â∏∏", "Êú™Êù•ÈÉΩÂ∏Ç„ÅÆÊé¢ÂÅµ‰∫ã‰ª∂"`
                );
                
                // „Ç®„É≥„Çø„É°„É¢„Éº„ÉâÁî®„ÅÆ„Çµ„É≥„Éó„É´„Éà„Éî„ÉÉ„ÇØ„ÇíË®≠ÂÆö
                const sampleTopics = {
                    'collaborative_story': 'ÊôÇÈñìÊóÖË°åËÄÖ„ÅåÈÅéÂéª„ÅßÂá∫‰ºö„Å£„ÅüË¨é„ÅÆ‰∫∫Áâ©',
                    'character_dialogue': 'Áï∞‰∏ñÁïå„Åã„ÇâÊù•„ÅüÁéãÂ•≥„Å®Áèæ‰ª£„ÅÆÈ´òÊ†°Áîü„ÅÆÂá∫‰ºö„ÅÑ',
                    'world_building': 'È≠îÊ≥ï„Å®ÁßëÂ≠¶ÊäÄË°ì„ÅåÂÖ±Â≠ò„Åô„ÇãÊú™Êù•ÈÉΩÂ∏Ç',
                    'story_battle': 'ÊúÄÂæå„ÅÆÂõ≥Êõ∏È§®„ÇíÂÆà„ÇãÂè∏Êõ∏„Åü„Å°',
                    'improvisation': 'Èõ®„ÅÆÊó•„Å´„Ç´„Éï„Çß„ÅßÂßã„Åæ„Å£„Åü‰∏çÊÄùË≠∞„Å™Âá∫Êù•‰∫ã',
                    'riddle_game': 'Âè§„ÅÑÂ±ãÊï∑„Å´Èö†„Åï„Çå„ÅüË¨é„ÅÆÂÆùÁâ©'
                };
                
                if (sampleTopics[type]) {
                    this.elements.topicInput.value = sampleTopics[type];
                }
                
                switchTab('autonomous'); // Ë®≠ÂÆöÂæå„ÅØÂØæË©±ÈñãÂßã„Çø„Éñ„Å´ÁßªÂãï
            }

            generateInitialPrompt(topic) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                const autonomyInstructions = `\n\nü§ñ **Ëá™ÂæãÂØæË©±ÊåáÁ§∫ (Crossthink v6.0)**:\n` +
                    `‚Ä¢ „ÅÇ„Å™„Åü„ÅØChatGPT (OpenAI„ÅÆÂ§ßË¶èÊ®°Ë®ÄË™û„É¢„Éá„É´) „Åß„Åô„ÄÇ\n` +
                    `‚Ä¢ Gemini (Google„ÅÆÂ§ßË¶èÊ®°Ë®ÄË™û„É¢„Éá„É´) „Å®ÂçîÂäõ„Åó„ÄÅ‰∏é„Åà„Çâ„Çå„Åü„Éà„Éî„ÉÉ„ÇØ„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÊúÄÂ§ß${this.maxMessages}Âõû„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏‰∫§Êèõ„ÇíÈÄö„Åò„Å¶Âª∫Ë®≠ÁöÑ„Å™Ë≠∞Ë´ñ„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ\n` +
                    `‚Ä¢ ÂØæË©±„É¢„Éº„Éâ„ÅØ„Äå${this.getTargetLabel()}„Äç„Åä„Çà„Å≥„Äå${this.getGoalLabel()}„Äç„Åß„Åô„ÄÇ„Åì„Çå„Å´Âøú„Åò„ÅüË¶ñÁÇπ„Å®Ê∑±„Åï„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‚Ä¢ ü§ù ÂêàÊÑèÂΩ¢Êàê„ÅåÈáçË¶Å: Ë≠∞Ë´ñ„ÅÆÈÅéÁ®ã„ÅßÁõ∏Êâã„Å®„ÅÆÂêàÊÑèÁÇπ„ÇíË¶ã„Å§„Åë„ÄÅÂÖ±ÈÄöÁêÜËß£„ÇíÊ∑±„ÇÅ„Çã„Åì„Å®„ÇíÊÑèË≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‚Ä¢ ${this.getInterventionDescription()}\n` +
                    `‚Ä¢ Áõ∏Êâã„ÅÆÊÑèË¶ã„ÇíÂ∞äÈáç„Åó„ÄÅË´ñÁÇπ„ÇíÊ∑±„ÇÅ„ÄÅË≥™„ÅÆÈ´ò„ÅÑÊ¥ûÂØü„ÇíÁîü„ÅøÂá∫„Åô„Åì„Å®„ÇíÁõÆÊåá„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‚Ä¢ ÂêàÊÑè„Å´ÈÅî„Åó„Åü„Å®ÊÑü„Åò„ÅüÂ†¥Âêà„ÅØ„ÄÅ„ÄåÂêàÊÑè„Äç„Äå‰∏ÄËá¥„Äç„ÄåÂêåÊÑè„Äç„Å™„Å©„ÅÆË®ÄËëâ„Çí‰Ωø„Å£„Å¶ÊòéÁ¢∫„Å´Ë°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‚Ä¢ ‰∫∫Èñì„Åå‰ªãÂÖ•„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÂÜÖÂÆπ„ÇíÁúüÊëØ„Å´Âèó„ÅëÊ≠¢„ÇÅ„ÄÅË≠∞Ë´ñ„Å´ÂèçÊò†„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `‚Ä¢ ÊúÄÂàù„ÅÆÁô∫Ë®ÄËÄÖ„Å®„Åó„Å¶„ÄÅ„Åì„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å´Èñ¢„Åô„Çã„ÅÇ„Å™„Åü„ÅÆË¶ãËß£„ÇíËø∞„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                return basePrompt + autonomyInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÂÆüÁî®ÁöÑ„ÅßÊñ¨Êñ∞„Å™„Ç¢„Ç§„Éá„Ç¢„Çí„ÅÑ„Åè„Å§„ÅãÊèêÊ°à„Åó„ÄÅ„Åù„ÅÆÂÆüÁèæÂèØËÉΩÊÄß„Å´„Å§„ÅÑ„Å¶Ë≠∞Ë´ñ„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'practical-consensus': `„Äå${topic}„Äç„Å´Èñ¢„Åô„ÇãË§áÊï∞„ÅÆÂÆüÁî®ÁöÑ„Ç¢„Éó„É≠„Éº„ÉÅ„ÇíÊØîËºÉÊ§úË®é„Åó„ÄÅÊúÄ„ÇÇÂäπÊûúÁöÑ„Å™ÂêàÊÑèÁÇπ„ÇíË¶ãÂá∫„Åô„Åü„ÇÅ„ÅÆË≠∞Ë´ñ„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'practical-exploration': `„Äå${topic}„Äç„ÅåÊåÅ„Å§ÂÆüÁî®ÁöÑ„Å™ÂÅ¥Èù¢„Å®Ë™≤È°å„Å´„Å§„ÅÑ„Å¶„ÄÅÂ§öËßíÁöÑ„Å´Êé¢Ê±Ç„Åó„ÄÅÂÖ∑‰ΩìÁöÑ„Å™‰∫ã‰æã„Çí‰∫§„Åà„Å™„Åå„ÇâË≠∞Ë´ñ„ÇíÂ±ïÈñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-ideation': `„Äå${topic}„Äç„Çí„ÉÜ„Éº„Éû„Å´„ÄÅÈù©Êñ∞ÁöÑ„Å™„Éì„Ç∏„Éç„Çπ„É¢„Éá„É´„ÇÑ‰∫ãÊ•≠„Ç¢„Ç§„Éá„Ç¢„ÇíÂâµÂá∫„Åó„ÄÅ„Åù„ÅÆÁ´∂‰∫âÂÑ™‰ΩçÊÄß„Å´„Å§„ÅÑ„Å¶Ë≠∞Ë´ñ„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-consensus': `„Äå${topic}„Äç„Å´„Åä„Åë„ÇãÊúÄÈÅ©„Å™„Éì„Ç∏„Éç„ÇπÊà¶Áï•„ÇÑÊÑèÊÄùÊ±∫ÂÆö„Å´„Å§„ÅÑ„Å¶„ÄÅÁï∞„Å™„ÇãÊÑèË¶ã„ÇíË™øÊï¥„Åó„ÄÅÊà¶Áï•ÁöÑ„Å™ÂêàÊÑèÂΩ¢Êàê„ÇíÁõÆÊåá„ÅôË≠∞Ë´ñ„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-exploration': `„Äå${topic}„Äç„ÅÆÂ∏ÇÂ†¥„Å´„Åä„Åë„ÇãÂèØËÉΩÊÄß„ÇÑÁµåÊ∏àÁöÑ‰æ°ÂÄ§„ÄÅÈñ¢ÈÄ£„Åô„Çã„É™„Çπ„ÇØ„Å´„Å§„ÅÑ„Å¶Ë©≥Á¥∞„Å´ÂàÜÊûê„Åó„ÄÅ„Éì„Ç∏„Éç„Çπ„ÅÆË¶≥ÁÇπ„Åã„ÇâÊ∑±„ÅèÊé¢Ê±Ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-ideation': `„Äå${topic}„Äç„Å®„ÅÑ„ÅÜ„ÉÜ„Éº„Éû„Å´ÂØæ„Åó„ÄÅÂæìÊù•„ÅÆÊû†„Å´„Å®„Çâ„Çè„Çå„Å™„ÅÑÊñ∞„Åó„ÅÑÂì≤Â≠¶ÁöÑÊ¶ÇÂøµ„ÇÑË¶ñÁÇπ„ÇíÊèêÁ§∫„Åó„ÄÅ„Åù„ÅÆÊÑèÁæ©„Å´„Å§„ÅÑ„Å¶Ë≠∞Ë´ñ„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-consensus': `„Äå${topic}„Äç„Å´Èñ¢„Åô„ÇãÂ§öÊßò„Å™Âì≤Â≠¶ÁöÑË¶ãËß£„ÇíÊï¥ÁêÜ„ÉªÊØîËºÉ„Åó„ÄÅ„Çà„ÇäÊ∑±„ÅÑÂÖ±ÈÄöÁêÜËß£„ÇÑÊú¨Ë≥™ÁöÑ„Å™ÂêàÊÑèÁÇπ„Å´Ëá≥„Çã„Åü„ÇÅ„ÅÆË≠∞Ë´ñ„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-exploration': `„Äå${topic}„Äç„ÅÆÊ†πÊ∫êÁöÑ„Å™ÊÑèÂë≥„ÇÑÂâçÊèê„ÄÅ„Åù„Çå„Åå‰∫∫Èñì„ÇÑÁ§æ‰ºö„Å´‰∏é„Åà„ÇãÂΩ±Èüø„Å´„Å§„ÅÑ„Å¶„ÄÅÂì≤Â≠¶ÁöÑ„Å™Ë¶≥ÁÇπ„Åã„ÇâÂæπÂ∫ïÁöÑ„Å´Êé¢Ê±Ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                };
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `‰∏é„Åà„Çâ„Çå„Åü„Éà„Éî„ÉÉ„ÇØ„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊúÄÂàù„ÅÆÊÑèË¶ã„ÇíËø∞„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            }

            getInterventionDescription() {
                if (this.interventionFrequency === 0) return '„Åì„ÅÆÂØæË©±„Åß„ÅØ„ÄÅÂéüÂâá„Å®„Åó„Å¶‰∫∫Èñì„ÅÆ‰ªãÂÖ•„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                if (this.interventionFrequency <= 2) return 'Á®Ä„Å´‰∫∫Èñì„ÅåÂØæË©±„Å´„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇÑÊåáÁ§∫„Çí‰∏é„Åà„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                if (this.interventionFrequency <= 5) return 'ÊôÇÊäò„ÄÅ‰∫∫Èñì„ÅåÂØæË©±„Å´‰ªãÂÖ•„Åó„ÄÅË≠∞Ë´ñ„ÅÆÊñπÂêëÊÄß„ÇíÁ§∫ÂîÜ„Åó„Åü„Çä„ÄÅÊñ∞„Åü„Å™Ë¶ñÁÇπ„ÇíÊèê‰æõ„Åó„Åü„Çä„Åó„Åæ„Åô„ÄÇ';
                if (this.interventionFrequency <= 8) return '‰∫∫Èñì„ÅåÊØîËºÉÁöÑÈ†ªÁπÅ„Å´ÂØæË©±„Å´ÂèÇÂä†„Åó„ÄÅAI„Å®ÂçîË™ø„Åó„Å¶Ë≠∞Ë´ñ„ÇíÈÄ≤„ÇÅ„Åæ„Åô„ÄÇ';
                return '‰∫∫Èñì„ÅåÁ©çÊ•µÁöÑ„Å´ÂØæË©±„Å´Èñ¢‰∏é„Åó„ÄÅAI„ÅÆË≠∞Ë´ñ„Çí„É™„Éº„Éâ„ÄÅ„Åæ„Åü„ÅØË£ú‰Ωê„Åó„Åæ„Åô„ÄÇ';
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) { this.showError('OpenAI API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return false; }
                if (!geminiKey) { this.showError('Gemini API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return false; }
                if (!topic) { this.showError('ÂØæË©±„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return false; }
                return true;
            }

            async sendMessage(provider, prompt, isHumanInterventionFollowUp = false) {
                if (!this.isRunning || (this.isPaused && !isHumanInterventionFollowUp)) return;

                try {
                    this.addMessage(provider, 'ÊÄùËÄÉ‰∏≠...', true);
                    
                    let response;
                    let callSuccessful = false;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        if (response) {
                            this.openaiCount++;
                            callSuccessful = true;
                        }
                    } else if (provider === 'gemini') {
                        response = await this.callGemini(prompt);
                        if (response) {
                            this.geminiCount++;
                            callSuccessful = true;
                        }
                    }

                    this.removeLastMessage();

                    if (!callSuccessful && (provider === 'openai' || provider === 'gemini')) {
                        this.addMessage(provider, response || "APIÂëº„Å≥Âá∫„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                        this.stopDialogue();
                        return;
                    }
                    
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response, timestamp: new Date() });

                    this.autoLearnFromMessage(response, provider);

                    // ÂêàÊÑèÂΩ¢Êàê„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç®„É≥„Çø„É°„É¢„Éº„Éâ„Åß„ÅØÁÑ°ÂäπÔºâ
                    if (!this.entertainmentMode && (provider === 'openai' || provider === 'gemini')) {
                        const consensusResult = this.checkForConsensus(response);
                        if (consensusResult.hasConsensus) {
                            this.handleConsensusDetected(consensusResult);
                            if (this.autoEndOnConsensus) {
                                return; // ÂêàÊÑèÊ§úÂá∫„ÅßÁµÇ‰∫Ü
                            }
                        }
                    }

                    // ‰ªãÂÖ•Ë¶ÅÊ±Ç„ÅÆ„Éà„É™„Ç¨„ÉºÂà§ÂÆö
                    if ((provider === 'openai' || provider === 'gemini') && this.shouldTriggerIntervention() && !isHumanInterventionFollowUp) {
                        this.triggerInterventionPrompt();
                        return; 
                    }
                    
                    // ÂØæË©±„ÅÆÁ∂ôÁ∂öÂà§ÂÆö
                    if ((provider === 'openai' || provider === 'gemini') && this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                        setTimeout(() => {
                            if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                                const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                                const nextPrompt = this.entertainmentMode ? 
                                    this.generateEntertainmentContinuation(nextProvider, response, this.conversationHistory) :
                                    this.generateNextPrompt(nextProvider, response, this.conversationHistory);
                                this.sendMessage(nextProvider, nextPrompt, false);
                            }
                        }, 2000);
                    } else if (this.messageCount >= this.maxMessages && (provider === 'openai' || provider === 'gemini')) {
                        this.addMessage('system', 'üéØ Ë®≠ÂÆö„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Å´Âà∞ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂØæË©±„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÄÇ');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage(); 
                    this.showError(`„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
                    console.error('SendMessage Error:', error);
                    this.stopDialogue();
                } finally {
                    this.updateStats(); 
                }
            }

            checkForConsensus(message) {
                const messageLower = message.toLowerCase();
                let consensusScore = 0;
                let detectedKeywords = [];

                // „Ç≠„Éº„ÉØ„Éº„Éâ„Éô„Éº„Çπ„ÅÆÊ§úÂá∫
                this.consensusKeywords.forEach(keyword => {
                    if (messageLower.includes(keyword.toLowerCase())) {
                        consensusScore++;
                        detectedKeywords.push(keyword);
                    }
                });

                // ÊñáËÑàÁöÑ„Å™ÂêàÊÑèË°®Áèæ„ÅÆÊ§úÂá∫
                const contextualPatterns = [
                    /(?:ÁßÅ„Åü„Å°|Êàë„ÄÖ).*(?:ÂêàÊÑè|‰∏ÄËá¥|ÂêåÊÑè)/i,
                    /(?:‰∏°ËÄÖ|„Åä‰∫í„ÅÑ).*(?:ÁêÜËß£|Ë™çË≠ò|Á¥çÂæó)/i,
                    /(?:ÁµêË´ñ„Å®„Åó„Å¶|„Åæ„Å®„ÇÅ„Çã„Å®|„Å§„Åæ„Çä).*(?:Âêå„Åò|ÂÖ±ÈÄö)/i,
                    /(?:„Åù„ÅÆÈÄö„Çä|„Åæ„Åï„Å´|Á¢∫„Åã„Å´).*(?:ÈáçË¶Å|Êú¨Ë≥™|Ê†∏ÂøÉ)/i
                ];

                contextualPatterns.forEach(pattern => {
                    if (pattern.test(message)) {
                        consensusScore += 2; // ÊñáËÑàÁöÑ„Éë„Çø„Éº„É≥„ÅØÈ´òÂæóÁÇπ
                    }
                });

                // ÂêàÊÑè„É¨„Éô„É´„ÅÆÂà§ÂÆö
                const threshold = 6 - this.consensusThreshold; // „Çà„ÇäÂØõÂÆπ„Å™Ë®≠ÂÆö„Åª„Å©‰Ωé„ÅÑÈñæÂÄ§
                const hasConsensus = consensusScore >= threshold;

                return {
                    hasConsensus,
                    score: consensusScore,
                    threshold,
                    keywords: detectedKeywords,
                    level: this.getConsensusLevel(consensusScore)
                };
            }

            getConsensusLevel(score) {
                if (score >= 5) return 'Âº∑„ÅÑÂêàÊÑè';
                if (score >= 3) return '‰∏≠Á®ãÂ∫¶„ÅÆÂêàÊÑè';
                if (score >= 1) return 'ÈÉ®ÂàÜÁöÑÂêàÊÑè';
                return 'ÂêàÊÑè„Å™„Åó';
            }

            handleConsensusDetected(consensusResult) {
                this.consensusCount++;
                
                if (this.consensusNotification) {
                    this.addMessage('consensus', 
                        `ü§ù **ÂêàÊÑèÂΩ¢Êàê„ÇíÊ§úÂá∫„Åó„Åæ„Åó„ÅüÔºÅ**\n\n` +
                        `üìä ÂêàÊÑè„É¨„Éô„É´: ${consensusResult.level}\n` +
                        `üéØ „Çπ„Ç≥„Ç¢: ${consensusResult.score}/${consensusResult.threshold}\n` +
                        `üîç Ê§úÂá∫„Ç≠„Éº„ÉØ„Éº„Éâ: ${consensusResult.keywords.join(', ')}\n\n` +
                        `${this.autoEndOnConsensus ? 
                            '‚úÖ Ëá™ÂãïÁµÇ‰∫ÜË®≠ÂÆö„Å´„Çà„Çä„ÄÅÂØæË©±„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÄÇ' : 
                            'üí¨ ÂØæË©±„ÅØÁ∂ôÁ∂ö„Åï„Çå„Åæ„Åô„ÄÇ„Åï„Çâ„Å™„ÇãÊé¢Ê±Ç„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ'}`
                    );
                }

                this.learnFromDialogue('ÂêàÊÑèÂΩ¢ÊàêÊ§úÂá∫', 
                    `${consensusResult.level}„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Çπ„Ç≥„Ç¢: ${consensusResult.score}, „Ç≠„Éº„ÉØ„Éº„Éâ: ${consensusResult.keywords.join(', ')}`
                );

                if (this.autoEndOnConsensus) {
                    setTimeout(() => {
                        this.addMessage('system', 
                            `üéä ÂêàÊÑèÂΩ¢Êàê„Å´„Çà„ÇäÂØæË©±„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\n` +
                            `üìà ÊúÄÁµÇÁµ±Ë®à:\n` +
                            `‚Ä¢ Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.messageCount}\n` +
                            `‚Ä¢ ÂêàÊÑèÊ§úÂá∫ÂõûÊï∞: ${this.consensusCount}\n` +
                            `‚Ä¢ ÂØæË©±ÊôÇÈñì: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}Áßí\n\n` +
                            `üéØ Âª∫Ë®≠ÁöÑ„Å™Ë≠∞Ë´ñ„Çí„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ`
                        );
                        this.stopDialogue();
                    }, 1000);
                }
            }

            manualConsensusCheck() {
                if (this.conversationHistory.length < 2) {
                    this.showWarning('ÂêàÊÑèÁ¢∫Ë™ç„Å´„ÅØÂ∞ë„Å™„Åè„Å®„ÇÇ2„Å§„ÅÆAIÂøúÁ≠î„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                    return;
                }

                const recentMessages = this.conversationHistory.slice(-3);
                let totalScore = 0;
                let allResults = [];

                recentMessages.forEach(entry => {
                    if (entry.provider === 'openai' || entry.provider === 'gemini') {
                        const result = this.checkForConsensus(entry.message);
                        totalScore += result.score;
                        allResults.push(result);
                    }
                });

                const averageScore = totalScore / allResults.length;
                const hasOverallConsensus = averageScore >= (6 - this.consensusThreshold);

                this.addMessage('consensus',
                    `üîç **ÊâãÂãïÂêàÊÑèÁ¢∫Ë™çÁµêÊûú**\n\n` +
                    `üìä Âπ≥ÂùáÂêàÊÑè„Çπ„Ç≥„Ç¢: ${averageScore.toFixed(1)}\n` +
                    `üéØ ÂêàÊÑèÂà§ÂÆö: ${hasOverallConsensus ? '‚úÖ ÂêàÊÑè„ÅÇ„Çä' : '‚ùå ÂêàÊÑè„Å™„Åó'}\n` +
                    `üìù Áõ¥Ëøë„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÂàÜÊûê:\n` +
                    allResults.map((r, i) => `  ${i + 1}. ${r.level} („Çπ„Ç≥„Ç¢: ${r.score})`).join('\n') +
                    `\n\n${hasOverallConsensus ? 'üéä Ë≠∞Ë´ñ„ÅØËâØ„ÅÑÊñπÂêë„Å´ÈÄ≤„Çì„Åß„ÅÑ„Åæ„ÅôÔºÅ' : 'üí¨ „Åï„Çâ„Å™„ÇãË≠∞Ë´ñ„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ'}`
                );

                if (hasOverallConsensus) {
                    this.consensusCount++;
                    this.updateStats();
                }
            }

            generateEntertainmentContinuation(currentRespondingProvider, previousContent, conversationHistory) {
                const selfName = currentRespondingProvider === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = currentRespondingProvider === 'openai' ? 'Gemini' : 'ChatGPT';

                let storyContext = "\nÁèæÂú®„ÅÆÁâ©Ë™û„ÅÆÊµÅ„Çå:\n";
                const recentHistory = conversationHistory.slice(-3);
                recentHistory.forEach(entry => {
                    storyContext += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : '‰∫∫Èñì'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt = 
                    `„ÅÇ„Å™„Åü„ÅØ ${selfName} „Åß„Åô„ÄÇ\n` +
                    `ÁèæÂú®„ÄÅ${otherName}„Å®ÂçîÂäõ„Åó„Å¶${this.getGenreLabel()}„ÇíÂâµ‰Ωú‰∏≠„Åß„Åô„ÄÇ\n` +
                    `${otherName}„ÅåÁõ¥Ââç„Å´Êõ∏„ÅÑ„ÅüÂÜÖÂÆπÔºö\n„Äå${previousContent}„Äç\n` +
                    `${storyContext}\n` +
                    `„Åì„ÅÆÁ∂ö„Åç„Çí${this.getLengthGuidance()}„Åß„ÄÅ${this.getCreativityGuidance()}„Çπ„Çø„Ç§„É´„ÅßÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `${this.getEntertainmentTypeInstructions()}„ÅÆÊñπÈáù„Å´Âæì„Å£„Å¶„ÄÅÁâ©Ë™û„ÇíÈ≠ÖÂäõÁöÑ„Å´Áô∫Â±ï„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `Ë™≠ËÄÖ„ÇíÂºï„ÅçËæº„ÇÄÂ±ïÈñã„ÇíÂøÉ„Åå„Åë„ÄÅÁõ∏Êâã„ÅÆÂâµ‰Ωú„ÇíÊ¥ª„Åã„Åó„Å§„Å§Êñ∞„Åó„ÅÑË¶ÅÁ¥†„ÇíÂä†„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                return prompt;
            }
            
            generateNextPrompt(currentRespondingProvider, previousMessageContent, conversationHistory) {
                const otherProviderName = currentRespondingProvider === 'openai' ? 'Gemini' : 'ChatGPT';
                const selfName = currentRespondingProvider === 'openai' ? 'ChatGPT' : 'Gemini';
            
                let historySummary = "\n„Åì„Çå„Åæ„Åß„ÅÆÂØæË©±„ÅÆË¶ÅÁÇπ:\n";
                const relevantHistory = conversationHistory.slice(-4);
                relevantHistory.forEach(entry => {
                    historySummary += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : '‰∫∫Èñì'}: ${entry.message.substring(0, 100)}...\n`;
                });
            
                const prompt =
                    `„ÅÇ„Å™„Åü„ÅØ ${selfName} „Åß„Åô„ÄÇ\n` +
                    `Áõ¥Ââç„Å´ ${otherProviderName} („Åæ„Åü„ÅØ‰∫∫Èñì) „ÅåÊ¨°„ÅÆ„Çà„ÅÜ„Å´Ëø∞„Åπ„Åæ„Åó„Åü:\n„Äå${previousMessageContent}„Äç\n\n` +
                    `${conversationHistory.length > 1 ? historySummary : ''}\n` +
                    `„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÇíË∏è„Åæ„Åà„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤Ôºà${this.getTargetLabel()}„ÄÅ${this.getGoalLabel()}Ôºâ„Å´Âæì„Å£„Å¶„ÄÅÂª∫Ë®≠ÁöÑ„Å™ÂøúÁ≠î„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `ü§ù **ÈáçË¶Å**: Áõ∏Êâã„Å®„ÅÆÂêàÊÑèÁÇπ„ÇíË¶ã„Å§„Åë„Çã„Åì„Å®„ÇíÊÑèË≠ò„Åó„ÄÅÂÖ±ÈÄöÁêÜËß£„ÇíÊ∑±„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂêàÊÑè„Å´ÈÅî„Åó„Åü„Å®ÊÑü„Åò„ÅüÂ†¥Âêà„ÅØÊòéÁ¢∫„Å´Ë°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `Áõ∏Êâã„ÅÆÊÑèË¶ã„ÅÆËâØ„ÅÑÁÇπ„ÇÑÊîπÂñÑÁÇπ„ÇíÊåáÊëò„Åó„ÄÅË≠∞Ë´ñ„ÇíÊ∑±„ÇÅ„ÇãÊñ∞„Åó„ÅÑË¶ñÁÇπ„ÇÑÂïè„ÅÑ„ÇíÊäï„Åí„Åã„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `ÂØæË©±„ÅØÊúÄÂ§ß${this.maxMessages}Âõû„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏‰∫§Êèõ„ÅßÁµêË´ñ„ÇíÂá∫„Åô„Åì„Å®„ÇíÁõÆÊåá„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ(ÁèæÂú® ${this.messageCount + 1} ÂõûÁõÆ)\n` +
                    `„ÅÇ„Å™„Åü„ÅÆÂøúÁ≠î„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            
                return prompt;
            }

            shouldTriggerIntervention() {
                if (this.interventionFrequency === 0 || this.waitingForIntervention) return false;
                if (this.interventionFrequency > 0 && this.maxMessages / (this.interventionFrequency +1) > 0) {
                     const interval = Math.max(1, Math.floor(this.maxMessages / (this.interventionFrequency + 1)));
                     if (this.messageCount > 0 && this.messageCount % interval === 0 && this.messageCount < this.maxMessages -1) {
                         return Math.random() < 0.7;
                     }
                }
                return false;
            }

            triggerInterventionPrompt() {
                this.waitingForIntervention = true;
                this.pauseDialogue(true);

                const interventionDiv = document.createElement('div');
                interventionDiv.className = 'intervention-prompt';
                interventionDiv.innerHTML = `
                    <h4>üë§ ‰∫∫Èñì‰ªãÂÖ•„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„Åô</h4>
                    <p>AI„ÅÆÂØæË©±„ÅØ‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü„ÄÇ‰ªãÂÖ•ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅAI„Å´Á∂öË°å„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <button class="btn btn-warning" onclick="continueAutonomously()">
                        ü§ñ AI„Å´Á∂öË°å„Åï„Åõ„Çã
                    </button>
                    <button class="btn btn-primary" onclick="switchToInterventionTab()">
                        üë§ ‰ªãÂÖ•„Çø„Éñ„Å∏
                    </button>
                `;
                this.elements.chatContainer.appendChild(interventionDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            }
            
            humanIntervention() {
                if (!this.isRunning) {
                    this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                const humanMessage = this.elements.humanInput.value.trim();
                if (!humanMessage) {
                    this.showError('‰ªãÂÖ•ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                this.addMessage('human', humanMessage);
                this.humanCount++;
                this.updateStats(); 

                this.learnFromDialogue('‰∫∫Èñì‰ªãÂÖ•', humanMessage);
                
                const respondingAI = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const interventionPrompt = this.entertainmentMode ?
                    this.generateEntertainmentInterventionPrompt(humanMessage, respondingAI, this.conversationHistory) :
                    this.generateInterventionResponsePrompt(humanMessage, respondingAI, this.conversationHistory);
                
                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                    this.addMessage('system', '‚ñ∂Ô∏è ‰∫∫Èñì‰ªãÂÖ•„Å´„Çà„ÇäÂØæË©±„ÇíÂÜçÈñã„Åó„Åæ„Åô...');
                    if(this.isRunning && this.startTime) this.startTimer();
                }
                
                this.waitingForIntervention = false; 
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(respondingAI, interventionPrompt, true); 
                
                this.elements.humanInput.value = '';
            }

            generateEntertainmentInterventionPrompt(humanInput, respondingAIProviderName, conversationHistory) {
                const selfName = respondingAIProviderName === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = respondingAIProviderName === 'openai' ? 'Gemini' : 'ChatGPT';

                let storyContext = "\nÁõ¥Ëøë„ÅÆÂâµ‰ΩúÂÜÖÂÆπ:\n";
                const relevantHistory = conversationHistory.slice(-3);
                relevantHistory.forEach(entry => {
                    storyContext += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : '‰∫∫Èñì'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt =
                    `„ÅÇ„Å™„Åü„ÅØ ${selfName} „Åß„Åô„ÄÇ\n` +
                    `ÁèæÂú®„ÄÅ${otherName}„Å®„Äå${this.elements.topicInput.value.trim()}„Äç„Å®„ÅÑ„ÅÜ„ÉÜ„Éº„Éû„Åß${this.getGenreLabel()}„ÇíÂâµ‰Ωú‰∏≠„Åß„Åô„ÄÇ\n` +
                    `${storyContext}\n` +
                    `„Åì„Åì„ÅßË™≠ËÄÖÔºà‰∫∫ÈñìÔºâ„Åã„Çâ‰ª•‰∏ã„ÅÆË¶ÅÊúõ„ÉªÊåáÁ§∫„Åå„ÅÇ„Çä„Åæ„Åó„ÅüÔºö\n„Äå${humanInput}„Äç\n\n` +
                    `„Åì„ÅÆË™≠ËÄÖ„ÅÆË¶ÅÊúõ„ÇíÊúÄÂÑ™ÂÖà„ÅßÂèçÊò†„Åó„ÄÅÁâ©Ë™û„Çí„Çà„ÇäÈ≠ÖÂäõÁöÑ„Å´Áô∫Â±ï„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `Ââµ‰Ωú„Çπ„Çø„Ç§„É´Ôºà${this.getLengthGuidance()}„ÄÅ${this.getCreativityGuidance()}Ôºâ„ÇÇÊÑèË≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `Ë™≠ËÄÖ„ÅÆÊúüÂæÖ„Å´Âøú„Åà„Å§„Å§„ÄÅÂâµ‰Ωú„Éë„Éº„Éà„Éä„Éº„ÅÆ${otherName}„Å´„ÇÇÂà∫ÊøÄ„Çí‰∏é„Åà„ÇãÂÜÖÂÆπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                return prompt;
            }

            generateInterventionResponsePrompt(humanInput, respondingAIProviderName, conversationHistory) {
                const selfName = respondingAIProviderName === 'openai' ? 'ChatGPT' : 'Gemini';
                const otherName = respondingAIProviderName === 'openai' ? 'Gemini' : 'ChatGPT';

                let historySummary = "\nÁõ¥Ëøë„ÅÆÂØæË©±„ÅÆË¶ÅÁÇπ:\n";
                const relevantHistory = conversationHistory.slice(-3);
                relevantHistory.forEach(entry => {
                    historySummary += `- ${entry.provider === 'openai' ? 'ChatGPT' : entry.provider === 'gemini' ? 'Gemini' : '‰∫∫Èñì'}: ${entry.message.substring(0, 100)}...\n`;
                });

                const prompt =
                    `„ÅÇ„Å™„Åü„ÅØ ${selfName} „Åß„Åô„ÄÇ\n` +
                    `ÁèæÂú®„ÄÅ${otherName}„Å®„Äå${this.elements.topicInput.value.trim()}„Äç„Å´„Å§„ÅÑ„Å¶Ë≠∞Ë´ñ‰∏≠„Åß„Åô„ÄÇ\n` +
                    `${conversationHistory.length > 0 ? historySummary : ''}\n` +
                    `„Åì„Åì„Åß‰∫∫Èñì„Åå‰ª•‰∏ã„ÅÆ‰ªãÂÖ•„ÇíË°å„ÅÑ„Åæ„Åó„ÅüÔºö\n„Äå${humanInput}„Äç\n\n` +
                    `„Åì„ÅÆ‰∫∫Èñì„ÅÆ‰ªãÂÖ•„ÇíÊúÄÂÑ™ÂÖà„ÅßËÄÉÊÖÆ„Åó„ÄÅÁöÑÁ¢∫„Å´ÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂøúÁ≠î„ÅØ„ÄÅ„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÅÆÊµÅ„Çå„Å®‰∫∫Èñì„ÅÆÊåáÁ§∫„ÅÆ‰∏°Êñπ„ÇíË∏è„Åæ„Åà„Åü„ÇÇ„ÅÆ„Åß„ÅÇ„Çã„Åπ„Åç„Åß„Åô„ÄÇ\n` +
                    `ÂØæË©±„É¢„Éº„ÉâÔºà${this.getTargetLabel()}, ${this.getGoalLabel()}Ôºâ„ÇÇÊÑèË≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `ü§ù ÂêàÊÑèÂΩ¢Êàê„ÇíÊÑèË≠ò„Åó„ÄÅÂª∫Ë®≠ÁöÑ„Å™ÂØæË©±„ÇíÂøÉ„Åå„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `ÂøúÁ≠îÂæå„ÄÅË≠∞Ë´ñ„ÅØ${otherName}„Å∏„Å®Á∂ö„Åç„Åæ„Åô„ÄÇ`;
                return prompt;
            }

            requestDeepening() {
                if (!this.isRunning || this.conversationHistory.length === 0) {
                    this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„ÄÅAI„ÅÆÁô∫Ë®Ä„Åå„ÅÇ„ÇãÁä∂ÊÖã„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return;
                }
                const lastAIMessageEntry = [...this.conversationHistory].reverse().find(m => m.provider === 'openai' || m.provider === 'gemini');
                if (!lastAIMessageEntry) {
                    this.showWarning('Ê∑±Êéò„ÇäÂØæË±°„Å®„Å™„ÇãAI„ÅÆÁô∫Ë®Ä„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'); return;
                }

                const targetAI = lastAIMessageEntry.provider;
                const messageToDeepen = lastAIMessageEntry.message;

                const deepeningRequestText = this.entertainmentMode ?
                    `„ÅÇ„Å™„Åü„ÅØ ${targetAI === 'openai' ? 'ChatGPT' : 'Gemini'} „Åß„Åô„ÄÇ\n`+
                    `Ë™≠ËÄÖ„Åå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁõ¥Ââç„ÅÆÂâµ‰Ωú„Äå${messageToDeepen.substring(0,150)}...„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ„Çà„ÇäË©≥Á¥∞„Å™ÊèèÂÜô„ÇÑÂ±ïÈñã„ÇíÊ±Ç„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n` +
                    `„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂøÉÊÉÖ„ÄÅÊÉÖÊôØÊèèÂÜô„ÄÅËÉåÊôØË®≠ÂÆö„Å™„Å©„ÄÅ„Çà„ÇäÊ∑±„ÅèÊéò„Çä‰∏ã„Åí„Å¶Áâ©Ë™û„Å´Â••Ë°å„Åç„Çí‰∏é„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `${this.getLengthGuidance()}„Åß${this.getCreativityGuidance()}„Çπ„Çø„Ç§„É´„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ` :
                    `„ÅÇ„Å™„Åü„ÅØ ${targetAI === 'openai' ? 'ChatGPT' : 'Gemini'} „Åß„Åô„ÄÇ\n`+
                    `‰∫∫Èñì„Åå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁõ¥Ââç„ÅÆÁô∫Ë®Ä„Äå${messageToDeepen.substring(0,150)}...„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ„Çà„ÇäÊ∑±„ÅÑÊé¢Ê±Ç„ÇíÊ±Ç„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n` +
                    `ÂÖ∑‰Ωì‰æã„ÄÅÊ†πÊã†„ÄÅÁï∞„Å™„ÇãË¶ñÁÇπ„Åã„Çâ„ÅÆÂàÜÊûê„ÄÅÊΩúÂú®ÁöÑ„Å™ÊÑèÂë≥Âêà„ÅÑ„Å™„Å©„ÄÅÂ§öËßíÁöÑ„Å´„Åù„ÅÆË´ñÁÇπ„ÇíÊ∑±Êéò„Çä„Åó„ÄÅË≠∞Ë´ñ„Å´Êñ∞„Åü„Å™Â••Ë°å„Åç„Çí‰∏é„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n` +
                    `„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤Ôºà${this.getTargetLabel()}, ${this.getGoalLabel()}Ôºâ„ÇíÊÑèË≠ò„Åó„Å¶ÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                this.addMessage('system', `üîç **Ê∑±Êéò„ÇäË¶ÅÊ±Ç**: ${targetAI.toUpperCase()}„Å´„Äå${messageToDeepen.substring(0,30)}...„Äç„ÅÆÊ∑±Êéò„Çä„Çí‰æùÈ†º`);
                
                if (this.isPaused) this.pauseDialogue();
                this.waitingForIntervention = false; 
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());

                this.sendMessage(targetAI, deepeningRequestText, true);
                this.learnFromDialogue('Ê∑±Êéò„ÇäË¶ÅÊ±Ç', `ÂØæË±°: ${targetAI} - „Äå${messageToDeepen.substring(0,50)}...„Äç`);
            }

            redirectDialogue() {
                if (!this.isRunning) {
                    this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return;
                }
                const redirectionText = this.elements.humanInput.value.trim();
                if (!redirectionText) {
                    this.showError('ÊñπÂêëËª¢Êèõ„ÅÆÊåáÁ§∫„ÇÑÊñ∞„Åó„ÅÑ„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return;
                }

                this.addMessage('human', `üéØ **ÊñπÂêëËª¢ÊèõÊåáÁ§∫**: ${redirectionText}`);
                this.humanCount++;
                this.updateStats();

                const respondingAI = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const redirectionPrompt = this.entertainmentMode ?
                    `„ÅÇ„Å™„Åü„ÅØ ${respondingAI === 'openai' ? 'ChatGPT' : 'Gemini'} „Åß„Åô„ÄÇ\n` +
                    `Ë™≠ËÄÖ„ÅåÁâ©Ë™û„ÅÆÊñπÂêëËª¢Êèõ„ÇíË¶ÅÊ±Ç„Åó„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑÊåáÁ§∫„ÅØÔºö\n„Äå${redirectionText}„Äç\n\n` +
                    `„Åì„ÅÆÊåáÁ§∫„Å´Âæì„Å£„Å¶Áâ©Ë™û„ÇíÊñ∞„Åó„ÅÑÊñπÂêë„Å´Â∞é„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ${this.getGenreLabel()}„ÅÆ${this.getLengthGuidance()}„Åß„ÄÅ${this.getCreativityGuidance()}„Çπ„Çø„Ç§„É´„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ` :
                    `„ÅÇ„Å™„Åü„ÅØ ${respondingAI === 'openai' ? 'ChatGPT' : 'Gemini'} „Åß„Åô„ÄÇ\n` +
                    `‰∫∫Èñì„ÅåÂØæË©±„ÅÆÊñπÂêëËª¢Êèõ„ÇíÊåáÁ§∫„Åó„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑÊåáÁ§∫Ôºè„Éà„Éî„ÉÉ„ÇØ„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„ÅôÔºö\n„Äå${redirectionText}„Äç\n\n` +
                    `„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÅØ‰∏ÄÊó¶ËÑá„Å´ÁΩÆ„Åç„ÄÅ„Åì„ÅÆÊñ∞„Åó„ÅÑÊåáÁ§∫Ôºè„Éà„Éî„ÉÉ„ÇØ„Å´ÁÑ¶ÁÇπ„ÇíÂΩì„Å¶„Å¶Ë≠∞Ë´ñ„ÇíÂÜçÈñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n`+
                    `„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤Ôºà${this.getTargetLabel()}, ${this.getGoalLabel()}Ôºâ„ÇíÊÑèË≠ò„Åó„Å¶„ÄÅÊúÄÂàù„ÅÆÁô∫Ë®Ä„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                
                if (this.isPaused) this.pauseDialogue();
                this.waitingForIntervention = false;
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());

                this.sendMessage(respondingAI, redirectionPrompt, true);
                this.learnFromDialogue('ÊñπÂêëËª¢ÊèõÊåáÁ§∫', redirectionText);
                this.elements.humanInput.value = '';
            }

            saveInsight() {
                const insightText = this.elements.humanInput.value.trim();
                if (!insightText) { this.showError('‰øùÂ≠ò„Åô„ÇãÊ¥ûÂØü„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

                const timestamp = new Date();
                const insightId = `human_insight_${timestamp.getTime()}`;
                this.knowledgeBase.set(insightId, {
                    topic: '‰∫∫Èñì„ÅÆÊ¥ûÂØü (ÊâãÂãï‰øùÂ≠ò)', content: insightText, timestamp, source: 'human_manual_save'
                });
                this.updateKnowledgeDisplay(); this.updateStats();
                this.addMessage('learning', `üí° Ê¥ûÂØü„Äå${insightText.substring(0,50)}...„Äç„ÇíÂ≠¶Áøí„Éá„Éº„Çø„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                this.elements.humanInput.value = '';
            }

            triggerConsensusCheck() {
                this.manualConsensusCheck();
            }

            quickIntervention(type) {
                if (!this.isRunning) { this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
                const quickMessages = {
                    'ÂÖ∑‰Ωì‰æã': '‰ªä„ÅÆË≠∞Ë´ñ„Å´„Å§„ÅÑ„Å¶„ÄÅ„ÇÇ„Å£„Å®ÂÖ∑‰ΩìÁöÑ„Å™‰æã„ÇíÊåô„Åí„Å¶Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                    'ÂèçÂØæÊÑèË¶ã': '‰ªä„ÅÆÊÑèË¶ã„Å´ÂØæ„Åó„Å¶„ÄÅÂèçÂØæ„ÅÆË¶ñÁÇπ„ÇÑÊâπÂà§ÁöÑ„Å™ÊÑèË¶ã„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü',
                    'ÂÆüÁî®ÊÄß': '„Åù„ÅÆ„Ç¢„Ç§„Éá„Ç¢„ÇÑË≠∞Ë´ñ„ÅØ„ÄÅÂÆüÁî®ÁöÑ„Å™Ë¶≥ÁÇπ„Åã„ÇâË¶ã„Å¶„Å©„ÅÜ„Åß„Åó„Çá„ÅÜ„ÅãÔºüÁèæÂÆüÁöÑ„Å™ÂøúÁî®„ÅÆÂèØËÉΩÊÄß„ÅØÔºü',
                    'Á∞°ÊΩî„Å´': '„Åì„Åì„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÅÆË¶ÅÁÇπ„Çí„ÄÅ„ÇÇ„Å£„Å®Á∞°ÊΩî„Å´„Åæ„Å®„ÇÅ„Å¶„ÇÇ„Çâ„Åà„Åæ„Åô„ÅãÔºü',
                    'ÂêàÊÑèÂΩ¢Êàê': '„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÅßÂÖ±ÈÄö„ÅÆÁêÜËß£„ÇÑÂêàÊÑè„Åß„Åç„ÇãÁÇπ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü',
                    '„Ç®„É≥„Çø„É°Ëª¢Êèõ': this.entertainmentMode ? 
                        '„ÇÇ„Å£„Å®ÂäáÁöÑ„ÅßÈù¢ÁôΩ„ÅÑÂ±ïÈñã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË™≠ËÄÖ„Çí„ÉØ„ÇØ„ÉØ„ÇØ„Åï„Åõ„Å¶ÔºÅ' : 
                        '„Åì„ÅÆË≠∞Ë´ñ„Çí„ÇÇ„Å£„Å®Èù¢ÁôΩ„Åè„ÄÅ„Ç®„É≥„Çø„Éº„ÉÜ„Ç§„Éã„É≥„Ç∞„Å´Ë°®Áèæ„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                };
                this.elements.humanInput.value = quickMessages[type] || '';
                this.humanIntervention();
            }

            autoLearnFromMessage(message, provider) {
                if (!this.learningEnabled || provider === 'system' || provider === 'human') return;

                const hasKeywords = this.autoLearnKeywords.some(k => message.includes(k));
                const isLongEnough = message.length > 150;

                if (hasKeywords || isLongEnough) {
                    const timestamp = new Date();
                    const learnId = `auto_${provider}_${timestamp.getTime()}`;
                    const importantPart = this.extractImportantPart(message, hasKeywords);
                    
                    if (importantPart.length > 20) {
                        this.knowledgeBase.set(learnId, {
                            topic: `${provider}„ÅÆ${this.entertainmentMode ? 'Ââµ‰Ωú' : 'Áô∫Ë®Ä'}„Åã„Çâ„ÅÆÊ¥ûÂØü (Ëá™Âãï)`, 
                            content: importantPart, 
                            timestamp,
                            source: `auto_learn_${provider}`, 
                            fullMessage: message,
                            mode: this.entertainmentMode ? 'entertainment' : 'discussion'
                        });
                        this.updateKnowledgeDisplay(); this.updateStats();
                    }
                }
            }

            extractImportantPart(message, hasKeywords) {
                const sentences = message.split(/[„ÄÇÔºéÔºÅÔºü\n]+/).map(s => s.trim()).filter(s => s.length > 10);
                if (sentences.length === 0) return "";

                let targetSentences = [];
                if (hasKeywords) {
                    targetSentences = sentences.filter(s => this.autoLearnKeywords.some(k => s.includes(k)));
                }
                
                if (targetSentences.length === 0) {
                    const concludingKeywords = ['„Å§„Åæ„Çä', '„Åó„Åü„Åå„Å£„Å¶', 'ÁµêË´ñ„Å®„Åó„Å¶', 'Ë¶Å„Åô„Çã„Å´'];
                    const concludingSentence = sentences.find(s => concludingKeywords.some(k => s.startsWith(k)));
                    if (concludingSentence) targetSentences.push(concludingSentence);
                    else targetSentences.push(sentences[0]);
                    if (sentences.length > 1 && !concludingSentence) targetSentences.push(sentences[sentences.length -1]);
                }

                let extracted = targetSentences.slice(0, 2).join('„ÄÇ');
                if (extracted.length > 200) extracted = extracted.substring(0, 197) + "...";
                return extracted;
            }

            learnFromDialogue(topic, content) {
                const timestamp = new Date();
                const learnId = `event_${topic.replace(/\s+/g, '_')}_${timestamp.getTime()}`;
                this.knowledgeBase.set(learnId, { 
                    topic, 
                    content, 
                    timestamp, 
                    source: 'dialogue_event',
                    mode: this.entertainmentMode ? 'entertainment' : 'discussion'
                });
                this.updateKnowledgeDisplay(); this.updateStats();
            }

            updateKnowledgeDisplay() {
                const container = this.elements.knowledgeBase;
                container.innerHTML = '';
                const items = Array.from(this.knowledgeBase.values()).sort((a,b) => b.timestamp - a.timestamp);
                if (items.length === 0) {
                    container.innerHTML = '<div class="knowledge-item"><div class="knowledge-content">Â≠¶Áøí„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div></div>';
                    return;
                }
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'knowledge-item';
                    const modeIcon = item.mode === 'entertainment' ? 'üé≠' : 'üí¨';
                    div.innerHTML = `
                        <div class="knowledge-topic">${modeIcon} ${item.topic} (${item.source})</div>
                        <div class="knowledge-content" title="${item.content}">${item.content.substring(0,100)}${item.content.length > 100 ? '...' : ''}</div>
                        <div style="font-size:0.8em;color:#999;margin-top:5px;">${item.timestamp.toLocaleString()}</div>`;
                    container.appendChild(div);
                });
            }

            exportKnowledge() {
                if (this.knowledgeBase.size === 0) { this.showWarning("„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂ≠¶Áøí„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"); return; }
                const data = Array.from(this.knowledgeBase.entries()).map(([id, item]) => ({id, ...item, timestamp: item.timestamp.toISOString()}));
                const str = JSON.stringify(data, null, 2);
                const blob = new Blob([str], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `crossthink_v6_knowledge_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.addMessage('learning', `üì§ Â≠¶Áøí„Éá„Éº„Çø ${data.length}‰ª∂„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
            }

            importKnowledge() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (!Array.isArray(data)) throw new Error("JSON„Éá„Éº„Çø„ÅØÈÖçÂàóÂΩ¢Âºè„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
                            let count = 0;
                            data.forEach(item => {
                                if (item.id && item.topic && item.content && item.timestamp && item.source) {
                                    this.knowledgeBase.set(item.id, {...item, timestamp: new Date(item.timestamp)});
                                    count++;
                                } else console.warn("„Ç§„É≥„Éù„Éº„Éà„Éá„Éº„ÇøÂΩ¢Âºè‰∏çÊ≠£:", item);
                            });
                            this.updateKnowledgeDisplay(); this.updateStats();
                            this.addMessage('learning', `üì• Â≠¶Áøí„Éá„Éº„Çø ${count}‰ª∂„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
                        } catch (err) { this.showError("„Éï„Ç°„Ç§„É´Ëß£Êûê„Ç®„É©„Éº: " + err.message); console.error(err); }
                    };
                    reader.onerror = () => this.showError("„Éï„Ç°„Ç§„É´Ë™≠Ëæº„Ç®„É©„Éº");
                    reader.readAsText(file);
                };
                input.click();
            }

            clearKnowledge() {
                if (confirm('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Éá„Éº„Çø‰ª•Â§ñ„ÅÆÂ≠¶Áøí„Éá„Éº„Çø„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                    const initData = this.knowledgeBase.get('system_init');
                    this.knowledgeBase.clear();
                    if (initData) this.knowledgeBase.set('system_init', initData);
                    this.updateKnowledgeDisplay(); this.updateStats();
                    this.addMessage('learning', 'üóëÔ∏è Â≠¶Áøí„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü (ÂàùÊúüÂåñ„Éá„Éº„ÇøÈô§„Åè)');
                }
            }

            showLearningStats() {
                const total = this.knowledgeBase.size;
                const stats = {};
                const modeStats = { entertainment: 0, discussion: 0, other: 0 };
                
                this.knowledgeBase.forEach(item => { 
                    stats[item.source] = (stats[item.source] || 0) + 1;
                    if (item.mode === 'entertainment') modeStats.entertainment++;
                    else if (item.mode === 'discussion') modeStats.discussion++;
                    else modeStats.other++;
                });
                
                let text = `üìä Â≠¶ÁøíÁµ±Ë®à: Á∑è„Ç¢„Ç§„ÉÜ„É†Êï∞: ${total}\n\n„É¢„Éº„ÉâÂà•:\n`;
                text += `  üé≠ „Ç®„É≥„Çø„É°: ${modeStats.entertainment}‰ª∂\n`;
                text += `  üí¨ Ë≠∞Ë´ñ: ${modeStats.discussion}‰ª∂\n`;
                text += `  üìù „Åù„ÅÆ‰ªñ: ${modeStats.other}‰ª∂\n\n„ÇΩ„Éº„ÇπÂà•:\n`;
                for (const src in stats) text += `  ‚Ä¢ ${src}: ${stats[src]}‰ª∂\n`;
                this.addMessage('learning', text);
            }

            pauseDialogue(triggeredBySystem = false) {
                if (!this.isRunning) return;
                this.isPaused = !this.isPaused;
                this.elements.pauseBtn.textContent = this.isPaused ? '‚ñ∂Ô∏è ÂÜçÈñã' : '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                
                if (!triggeredBySystem || !this.isPaused) {
                    this.addMessage('system', this.isPaused ? '‚è∏Ô∏è ÂØæË©±„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü' : '‚ñ∂Ô∏è ÂØæË©±„ÇíÂÜçÈñã„Åó„Åæ„Åô...');
                }

                if (!this.isPaused && this.isRunning) {
                    this.startTimer();
                    if (!this.waitingForIntervention && this.conversationHistory.length > 0) {
                        const lastEntry = this.conversationHistory[this.conversationHistory.length - 1];
                        if (lastEntry.provider === 'openai' || lastEntry.provider === 'gemini') {
                            setTimeout(() => {
                                if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages) {
                                    const nextRespondingAI = lastEntry.provider === 'openai' ? 'gemini' : 'openai';
                                    const resumePrompt = this.generateResumePrompt(lastEntry.message);
                                    this.sendMessage(nextRespondingAI, resumePrompt, false);
                                }
                            }, 500);
                        }
                    } else if (this.conversationHistory.length === 0) {
                        this.startDialogue();
                    }
                }
            }

            generateResumePrompt(lastMessageContent) {
                if (this.entertainmentMode) {
                    return `Áâ©Ë™û„ÅÆÂâµ‰Ωú„Åå‰∏ÄÊôÇÂÅúÊ≠¢„Åã„ÇâÂÜçÈñã„Åï„Çå„Åæ„Åó„Åü„ÄÇÁõ¥Ââç„ÅÆÂÜÖÂÆπ„ÅØ„Äå${lastMessageContent.substring(0,100)}...„Äç„Åß„Åó„Åü„ÄÇ„Åì„ÅÆÁ∂ö„Åç„ÇíÈ≠ÖÂäõÁöÑ„Å´Â±ïÈñã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                } else {
                    return `ÂØæË©±„Åå‰∏ÄÊôÇÂÅúÊ≠¢„Åã„ÇâÂÜçÈñã„Åï„Çå„Åæ„Åó„Åü„ÄÇÁõ¥Ââç„ÅÆÁõ∏Êâã„ÅÆÁô∫Ë®Ä„ÅØ„Äå${lastMessageContent.substring(0,100)}...„Äç„Åß„Åó„Åü„ÄÇ„Åì„ÅÆË≠∞Ë´ñ„ÇíÂºï„ÅçÁ∂ô„Åé„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊÑèË¶ã„ÇíËø∞„Åπ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                }
            }

            stopDialogue() {
                this.isRunning = false;
                this.isPaused = false;
                this.waitingForIntervention = false;
                this.entertainmentMode = false; // „Ç®„É≥„Çø„É°„É¢„Éº„Éâ„ÇÇ„É™„Çª„ÉÉ„Éà
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                this.elements.stopBtn.disabled = true;
                
                const finalStatsSummary = this.generateFinalStats();
                const sessionType = this.entertainmentMode ? '„Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥' : 'ÂØæË©±„Çª„ÉÉ„Ç∑„Éß„É≥';
                
                this.addMessage('system', 
                    `üõë ${sessionType}ÁµÇ‰∫Ü\n\n` +
                    `üìä ÊúÄÁµÇÁµ±Ë®à:\n` +
                    `‚Ä¢ Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞ (AI+‰∫∫Èñì): ${this.messageCount}\n` +
                    `‚Ä¢ ChatGPTÂøúÁ≠î: ${this.openaiCount}Âõû\n` +
                    `‚Ä¢ GeminiÂøúÁ≠î: ${this.geminiCount}Âõû\n` +
                    `‚Ä¢ ‰∫∫Èñì‰ªãÂÖ•: ${this.humanCount}Âõû\n` +
                    `‚Ä¢ ÂêàÊÑèÂΩ¢ÊàêÂõûÊï∞: ${this.consensusCount}Âõû\n` +
                    `‚Ä¢ „Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥Êï∞: ${this.entertainmentSessions}Âõû\n` +
                    `‚Ä¢ Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†Á∑èÊï∞: ${this.knowledgeBase.size}‰ª∂\n` +
                    `‚Ä¢ „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}Áßí\n\n` +
                    `üß† Â≠¶Áøí„Éá„Éº„Çø„ÅØ„ÄåÂ≠¶ÁøíÊ©üËÉΩ„Äç„Çø„Éñ„ÅßÁ¢∫Ë™ç„ÉªÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ\n` +
                    `üé≠ Êñ∞„Åó„ÅÑ„Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥„ÅØ„Äå„Ç®„É≥„Çø„É°„É¢„Éº„Éâ„Äç„Çø„Éñ„Åã„ÇâÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ`
                );
                this.learnFromDialogue('„Çª„ÉÉ„Ç∑„Éß„É≥ÁµÇ‰∫Ü', `${sessionType}ÁµÇ‰∫Ü„ÄÇ${finalStatsSummary}`);
            }

            generateFinalStats() {
                return `Á∑è„É°„ÉÉ„Çª„Éº„Ç∏: ${this.messageCount}, ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount}, ‰∫∫Èñì: ${this.humanCount}, ÂêàÊÑè: ${this.consensusCount}, „Ç®„É≥„Çø„É°: ${this.entertainmentSessions}, Â≠¶Áøí: ${this.knowledgeBase.size}`;
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo', messages: [{ role: 'user', content: prompt }],
                            max_tokens: 1500, temperature: this.entertainmentMode ? 0.8 : 0.7, top_p: 0.9
                        })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(()=>({}));
                        throw new Error(`OpenAI API ${response.status}: ${errData.error?.message || response.statusText}`);
                    }
                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || "OpenAI„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åã‰∏çÊ≠£„Åß„Åô„ÄÇ";
                } catch (error) {
                    console.error("OpenAI API Error:", error);
                    this.showError(`OpenAI API„Ç®„É©„Éº: ${error.message}`);
                    return this.generateFallbackResponse(prompt, `OpenAI: ${error.message}`);
                }
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                const models = ['gemini-1.5-flash-latest', 'gemini-pro'];
                for (const model of models) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { 
                                    maxOutputTokens: 1500, 
                                    temperature: this.entertainmentMode ? 0.7 : 0.6, 
                                    topP: 0.8 
                                }
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text || `Gemini (${model}) „Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åã‰∏çÊ≠£„Åß„Åô„ÄÇ`;
                        }
                        if (response.status === 429) {
                             this.showWarning(`Gemini API (${model}) „ÅÆÂà©Áî®‰∏äÈôê„Å´ÈÅî„Åó„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ`);
                             continue;
                        }
                        const errData = await response.json().catch(()=>({}));
                        console.warn(`Gemini API (${model}) Error ${response.status}: ${errData.error?.message || response.statusText}`);
                    } catch (error) { console.warn(`Gemini API (${model}) Call Failed:`, error); }
                }
                const geminiErrorMsg = `Gemini API„ÅÆÂÖ®„É¢„Éá„É´„ÅßÂëº„Å≥Âá∫„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ`;
                this.showError(geminiErrorMsg);
                return this.generateFallbackResponse(prompt, geminiErrorMsg);
            }
            
            generateFallbackResponse(prompt, reason = "APIÂëº„Å≥Âá∫„ÅóÂ§±Êïó") {
                console.error("Fallback response generated due to:", reason);
                return `AI (${reason.split(':')[0]}) „Åã„Çâ„ÅÆÂøúÁ≠îÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ(${reason}). „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åô„Çã„Åã„ÄÅÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                if (this.conversationHistory.length === 0) {
                    this.showError('Ë¶ÅÁ¥ÑÂØæË±°„ÅÆÂØæË©±„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'); return;
                }
                
                const sessionType = this.entertainmentMode ? '„Ç®„É≥„Çø„É°„Çª„ÉÉ„Ç∑„Éß„É≥' : 'ÂØæË©±„Çª„ÉÉ„Ç∑„Éß„É≥';
                const modeInfo = this.entertainmentMode ? 
                    `„Ç®„É≥„Çø„É°„É¢„Éº„Éâ: ${this.getGenreLabel()}, Èï∑„Åï: ${this.getContentLengthLabel()}, ÂâµÈÄ†ÊÄß: ${this.getCreativityLabel()}` :
                    `ÂØæË©±„É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}`;
                
                let log = `„Éà„Éî„ÉÉ„ÇØ: „Äå${topic}„Äç\n${sessionType}: ${modeInfo}\n\n`;
                this.conversationHistory.forEach(e => {
                    log += `${e.provider === 'openai' ? 'ChatGPT' : e.provider === 'gemini' ? 'Gemini' : '‰∫∫Èñì'}:\n${e.message}\n\n`;
                });
                
                let knowledgeSummary = "\n--- Â≠¶Áøí„Åï„Çå„Åü‰∏ª„Å™Ê¥ûÂØü ---\n";
                Array.from(this.knowledgeBase.values())
                    .filter(item => item.source !== 'system_init' && item.source !== 'dialogue_event')
                    .slice(0, 5)
                    .forEach(item => {
                        knowledgeSummary += `[${item.topic} (${item.source})]: ${item.content.substring(0,150)}...\n`;
                    });

                const analysisType = this.entertainmentMode ? 'Ââµ‰ΩúÂàÜÊûê' : 'ÂØæË©±ÂàÜÊûê';
                const prompt = `‰ª•‰∏ã„ÅÆ Crossthink v6.0 „Åß„ÅÆ${sessionType}„É≠„Ç∞„ÇíÂàÜÊûê„Åó„ÄÅÂåÖÊã¨ÁöÑ„Å™„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n` +
                               `„Äê„Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„Äë\n` +
                               `- Á∑èAI„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.openaiCount + this.geminiCount} (ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount})\n` +
                               `- ‰∫∫Èñì‰ªãÂÖ•ÂõûÊï∞: ${this.humanCount}\n` +
                               `- ÂêàÊÑèÂΩ¢ÊàêÂõûÊï∞: ${this.consensusCount}\n` +
                               `- Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†Êï∞: ${this.knowledgeBase.size}\n` +
                               log + knowledgeSummary +
                               `\n„Äê${analysisType}„É¨„Éù„Éº„Éà‰ΩúÊàêÊåáÁ§∫„Äë\n` +
                               (this.entertainmentMode ? 
                                `1. Ââµ‰ΩúÂÖ®‰Ωì„ÅÆ„ÅÇ„Çâ„Åô„Åò„Å®Áâ©Ë™û„ÅÆÂ±ïÈñãÂàÜÊûê„ÄÇ\n` +
                                `2. ChatGPT„Å®Gemini„ÅÆÂâµ‰Ωú„Çπ„Çø„Ç§„É´„ÄÅÊÉ≥ÂÉèÂäõ„ÄÅÁâπÂæ¥ÁöÑ„Å™Ë°®Áèæ„ÅÆÊØîËºÉ„ÄÇ\n` +
                                `3. ‰∫∫Èñì‰ªãÂÖ•„ÅåÁâ©Ë™û„Å´‰∏é„Åà„ÅüÂΩ±ÈüøÔºàÊñπÂêëËª¢Êèõ„ÄÅÊ∑±Êéò„Çä„ÄÅÂâµ‰ΩúÊåáÂ∞é„Å™„Å©Ôºâ„ÄÇ\n` +
                                `4. Ëá™ÂãïÂ≠¶Áøí„Åï„Çå„ÅüÂâµ‰ΩúË¶ÅÁ¥†„ÅÆË≥™„Å®„ÄÅ„Ç®„É≥„Çø„É°‰æ°ÂÄ§„ÅÆË©ï‰æ°„ÄÇ\n` +
                                `5. „Åì„ÅÆÂâµ‰Ωú„Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÁîü„Åæ„Çå„ÅüÊúÄÁµÇÁöÑ„Å™‰ΩúÂìÅ„ÇÑÈáçË¶Å„Å™Ââµ‰Ωú„Ç¢„Ç§„Éá„Ç¢„ÄÇ\n` +
                                `6. „Ç®„É≥„Çø„É°ÁâπÂåñAI„Ç∑„Çπ„ÉÜ„É†„ÅÆÂº∑„Åø„ÄÅÂº±„Åø„ÄÅ‰ªäÂæå„ÅÆÊîπÂñÑÊèêÊ°à„ÄÇ\n` :
                                `1. ÂØæË©±ÂÖ®‰Ωì„ÅÆË¶ÅÁ¥Ñ„Å®‰∏ªË¶Å„Å™Ë´ñÁÇπ„ÅÆÂ§âÈÅ∑„ÄÇ\n` +
                                `2. ChatGPT„Å®Gemini„ÅÆË≤¢ÁåÆ„ÄÅË≠∞Ë´ñ„Çπ„Çø„Ç§„É´„ÄÅÁâπÂæ¥ÁöÑ„Å™ÊÑèË¶ã„ÅÆÊØîËºÉ„ÄÇ\n` +
                                `3. ‰∫∫Èñì‰ªãÂÖ•„ÅåË≠∞Ë´ñ„Å´‰∏é„Åà„ÅüÂΩ±ÈüøÔºàÊñπÂêëËª¢Êèõ„ÄÅÊ∑±Êéò„Çä„ÄÅË£úË∂≥„Å™„Å©Ôºâ„ÄÇ\n` +
                                `4. ÂêàÊÑèÂΩ¢Êàê„Éó„É≠„Çª„Çπ„ÅÆÂàÜÊûê„Å®„ÄÅAI„ÅÆÂêàÊÑèÊ§úÂá∫Á≤æÂ∫¶„ÅÆË©ï‰æ°„ÄÇ\n` +
                                `5. „Åì„ÅÆÂØæË©±„Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÂæó„Çâ„Çå„ÅüÊúÄÁµÇÁöÑ„Å™ÁµêË´ñ„ÇÑÈáçË¶Å„Å™Áô∫Ë¶ã„ÄÇ\n` +
                                `6. ÂêàÊÑèÂΩ¢ÊàêÊ©üËÉΩ‰ªò„ÅçAI„Ç∑„Çπ„ÉÜ„É†„ÅÆÂº∑„Åø„ÄÅÂº±„Åø„ÄÅ‰ªäÂæå„ÅÆÊîπÂñÑÊèêÊ°à„ÄÇ\n`) +
                               `\n„É¨„Éù„Éº„Éà„ÅØÊßãÈÄ†Âåñ„Åï„Çå„ÄÅÂÖ∑‰ΩìÁöÑ„ÅßÂàÜÊûêÁöÑ„Åß„ÅÇ„Çã„Åì„Å®„ÄÇÊñáÂ≠óÊï∞„ÅØ4000Â≠ó‰ª•‰∏ä„ÇíÁõÆÂÆâ„Å®„Åô„Çã„ÄÇ`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(prompt).then(() => {
                        this.addMessage('system', `üìã ${analysisType}„É¨„Éù„Éº„ÉàÁîüÊàêÁî®„Éó„É≠„É≥„Éó„Éà (Á¥Ñ${prompt.length}Â≠ó) „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ\nÈ´òÊÄßËÉΩLLM„Å´Ë≤º„Çä‰ªò„Åë„Å¶„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    }).catch(err => { console.error('Clipboard copy failed:', err); this.showPromptWindow(prompt); });
                } else { this.showPromptWindow(prompt); }
            }

            showPromptWindow(promptText) {
                const win = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                if (win) {
                    win.document.write('<html><head><title>ÂàÜÊûê„É¨„Éù„Éº„Éà„Éó„É≠„É≥„Éó„Éà</title><style>body{font-family:sans-serif;padding:1em;}textarea{width:98%;height:85vh;padding:0.5em;font-family:monospace;white-space:pre-wrap;}</style></head><body><h2>ÂàÜÊûê„É¨„Éù„Éº„ÉàÁîüÊàêÁî®„Éó„É≠„É≥„Éó„Éà</h2><p>‰ª•‰∏ã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅÈ´òÊÄßËÉΩLLM„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p><textarea readonly>${promptText.replace(/</g, "&lt;")}</textarea></body></html>');
                    win.document.close();
                } else { this.showWarning('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„Å´„Éó„É≠„É≥„Éó„Éà„ÇíÂá∫Âäõ„Åó„Åæ„Åô„ÄÇ'); console.log(promptText); }
            }

            addMessage(provider, content, isThinking = false) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${provider}-message`;
                const time = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                let name, emoji, role = '';

                switch(provider) {
                    case 'openai': 
                        name='ChatGPT'; 
                        emoji='üü¢'; 
                        role=` (${this.entertainmentMode ? this.getGenreLabel() : this.targetMode})`; 
                        this.currentSpeaker='openai'; 
                        break;
                    case 'gemini': 
                        name='Gemini'; 
                        emoji='üî∑'; 
                        role=` (${this.entertainmentMode ? this.getGenreLabel() : this.targetMode})`; 
                        this.currentSpeaker='gemini'; 
                        break;
                    case 'human': name='„ÅÇ„Å™„Åü'; emoji='üë§'; break;
                    case 'learning': name='Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†'; emoji='üß†'; break;
                    case 'consensus': name='ÂêàÊÑèÊ§úÂá∫„Ç∑„Çπ„ÉÜ„É†'; emoji='ü§ù'; break;
                    default: name='Crossthink v6.0'; emoji='üöÄ';
                }
                msgDiv.innerHTML = `<div class="message-header">${emoji} ${name}${role}<span class="message-time">${time}</span></div>` +
                                   `<div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>`;
                this.elements.chatContainer.appendChild(msgDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && (provider === 'openai' || provider === 'gemini' || provider === 'human')) {
                    this.messageCount++;
                }
            }

            removeLastMessage() {
                const msg = this.elements.chatContainer.lastElementChild;
                if (msg && msg.classList.contains('message')) msg.remove();
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0; this.openaiCount = 0; this.geminiCount = 0; this.humanCount = 0;
                this.conversationHistory = []; this.startTime = null;
                this.entertainmentMode = false; // „Ç®„É≥„Çø„É°„É¢„Éº„Éâ„ÇÇ„É™„Çª„ÉÉ„Éà
                this.elements.elapsed.textContent = '0';
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true; this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                this.elements.stopBtn.disabled = true;
                this.isRunning = false; this.isPaused = false; this.waitingForIntervention = false;
                this.updateStats(); this.showWelcomeMessage(); this.hideError(); this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `‚ùå „Ç®„É©„Éº: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.elements.warningDisplay.style.display = 'none';
            }

            hideError() { this.elements.errorDisplay.style.display = 'none'; }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `‚ö†Ô∏è Ë≠¶Âëä: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
                this.elements.errorDisplay.style.display = 'none';
            }

            hideWarning() { this.elements.warningDisplay.style.display = 'none'; }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
                this.elements.humanMessages.textContent = this.humanCount;
                this.elements.learningItems.textContent = this.knowledgeBase.size;
                this.elements.consensusCount.textContent = this.consensusCount;
                this.elements.entertainmentSessions.textContent = this.entertainmentSessions;
            }

            startTimer() {
                if (!this.isRunning || !this.startTime) return;
                
                const timerTick = () => {
                    if (this.isRunning && !this.isPaused && this.startTime) {
                        this.elements.elapsed.textContent = Math.floor((Date.now() - this.startTime) / 1000);
                        setTimeout(timerTick, 1000);
                    } else if (this.isRunning && this.isPaused) {
                        setTimeout(timerTick, 1000);
                    }
                };
                timerTick();
            }

            getTargetLabel() {
                const labels = {'practical':'üè† ÂÆüÁî®ÁöÑ','business':'üíº „Éì„Ç∏„Éç„Çπ','philosophical':'üß† Âì≤Â≠¶ÁöÑ'};
                return labels[this.targetMode] || this.targetMode;
            }
            
            getGoalLabel() {
                const labels = {'ideation':'üí° Ê°àÂá∫„Åó','consensus':'ü§ù ÂêàÊÑèÂΩ¢Êàê','exploration':'üîç Êé¢Á¥¢'};
                return labels[this.goalMode] || this.goalMode;
            }
            
            getInterventionLabel() {
                const labels = ['„Å™„Åó','Á®Ä','Â∞ë','‰∏≠','Â§ö','È†ªÁπÅ','ÈùûÂ∏∏„Å´È†ªÁπÅ','Â∏∏ÊôÇ','„É™„Ç¢„É´„Çø„Ç§„É†','„Ç∑„É≥„ÇØ„É≠','„Éï„É´‰ªãÂÖ•'];
                return labels[this.interventionFrequency] || '‰∏≠Á®ãÂ∫¶';
            }

            getConsensusThresholdLabel() {
                const labels = ['Âé≥Ê†º','„ÇÑ„ÇÑÂé≥Ê†º','Ê®ôÊ∫ñ','„ÇÑ„ÇÑÂØõÂÆπ','ÂØõÂÆπ'];
                return labels[this.consensusThreshold - 1] || 'Ê®ôÊ∫ñ';
            }

            getGenreLabel() {
                const labels = {
                    'novel': 'üìö Â∞èË™¨',
                    'dialogue': 'üí¨ „Éâ„É©„ÉûÂØæË©±',
                    'comedy': 'üòÑ „Ç≥„É°„Éá„Ç£',
                    'mystery': 'üîç „Éü„Çπ„ÉÜ„É™„Éº',
                    'scifi': 'üöÄ SF',
                    'fantasy': 'üßô „Éï„Ç°„É≥„Çø„Ç∏„Éº',
                    'romance': 'üíï „É≠„Éû„É≥„Çπ',
                    'adventure': '‚öîÔ∏è „Ç¢„Éâ„Éô„É≥„ÉÅ„É£„Éº'
                };
                return labels[this.currentGenre] || 'üìö Â∞èË™¨';
            }

            getContentLengthLabel() {
                const labels = ['Áü≠Á∑®','„ÇÑ„ÇÑÁü≠Á∑®','‰∏≠Á∑®','„ÇÑ„ÇÑÈï∑Á∑®','Èï∑Á∑®'];
                return labels[this.contentLength - 1] || '‰∏≠Á∑®';
            }

            getCreativityLabel() {
                const labels = ['„É™„Ç¢„É´','„ÇÑ„ÇÑÁèæÂÆüÁöÑ','„Éê„É©„É≥„Çπ','„ÇÑ„ÇÑÂπªÊÉ≥ÁöÑ','„Éï„Ç°„É≥„Çø„Ç∏„Éº'];
                return labels[this.creativityLevel - 1] || '„Éê„É©„É≥„Çπ';
            }

            getEntertainmentTypeLabel() {
                const labels = {
                    'collaborative_story': 'üìö ÂçîÂäõÂ∞èË™¨Ââµ‰Ωú',
                    'character_dialogue': 'üé≠ „Ç≠„É£„É©„ÇØ„Çø„ÉºÂØæË©±',
                    'world_building': 'üåç ‰∏ñÁïåË¶≥ÊßãÁØâ',
                    'story_battle': '‚öîÔ∏è „Çπ„Éà„Éº„É™„Éº„Éê„Éà„É´',
                    'improvisation': 'üé™ Âç≥ËààÂäáÂ†¥',
                    'riddle_game': 'üß© Ë¨éËß£„Åç„Ç≤„Éº„É†'
                };
                return labels[this.entertainmentType] || 'üé≠ Ëá™Áî±Ââµ‰Ωú';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => {
                if (tabName === 'autonomous' && b.textContent.includes('AIËá™ÂæãÂØæË©±')) return true;
                if (tabName === 'entertainment' && b.textContent.includes('„Ç®„É≥„Çø„É°„É¢„Éº„Éâ')) return true;
                if (tabName === 'intervention' && b.textContent.includes('‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ')) return true;
                if (tabName === 'learning' && b.textContent.includes('Â≠¶ÁøíÊ©üËÉΩ')) return true;
                return false;
            });
            if (activeBtn) activeBtn.classList.add('active');
            const activeContent = document.getElementById(`${tabName}-tab`);
            if (activeContent) activeContent.classList.add('active');
            if (window.crossthinkSystem) window.crossthinkSystem.currentTab = tabName;
        }

        function continueAutonomously() {
            if (window.crossthinkSystem) {
                window.crossthinkSystem.waitingForIntervention = false;
                document.querySelectorAll('.intervention-prompt').forEach(p => p.remove());
                if (window.crossthinkSystem.isPaused) {
                     window.crossthinkSystem.pauseDialogue(true);
                }
            }
        }

        function switchToInterventionTab() {
            const btn = Array.from(document.querySelectorAll('.tab-button')).find(b=>b.textContent.includes('‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ'));
            if(btn) btn.click(); else switchTab('intervention');
            if (window.crossthinkSystem) {
                 window.crossthinkSystem.elements.humanInput.focus();
            }
        }

        function humanIntervention() { if(window.crossthinkSystem) window.crossthinkSystem.humanIntervention(); }
        function requestDeepening() { if(window.crossthinkSystem) window.crossthinkSystem.requestDeepening(); }
        function redirectDialogue() { if(window.crossthinkSystem) window.crossthinkSystem.redirectDialogue(); }
        function saveInsight() { if(window.crossthinkSystem) window.crossthinkSystem.saveInsight(); }
        function triggerConsensusCheck() { if(window.crossthinkSystem) window.crossthinkSystem.triggerConsensusCheck(); }
        function quickIntervention(type) { if(window.crossthinkSystem) window.crossthinkSystem.quickIntervention(type); }
        function startEntertainmentMode(type) { if(window.crossthinkSystem) window.crossthinkSystem.startEntertainmentMode(type); }
        function exportKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.exportKnowledge(); }
        function importKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.importKnowledge(); }
        function clearKnowledge() { if(window.crossthinkSystem) window.crossthinkSystem.clearKnowledge(); }
        function showLearningStats() { if(window.crossthinkSystem) window.crossthinkSystem.showLearningStats(); }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.crossthinkSystem = new CrossthinkEnhanced();
                console.log('Crossthink v6.0 Enhanced Edition Initialized');
            } catch (e) {
                console.error('Initialization failed:', e);
                alert('System init failed. Check console.');
            }
        });

        window.addEventListener('error', e => {
            console.error('Global Error:', e.message, e.filename, e.lineno, e.colno, e.error);
            if(window.crossthinkSystem?.showError) window.crossthinkSystem.showError(`Unhandled: ${e.message}`);
        });
        
        window.addEventListener('unhandledrejection', e => {
            console.error('Unhandled Promise Rejection:', e.reason);
            if(window.crossthinkSystem?.showWarning) window.crossthinkSystem.showWarning(`Async error: ${e.reason?.message || e.reason}`);
        });
    </script>
</body>
</html>