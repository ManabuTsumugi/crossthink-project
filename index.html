<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v5.0 - AIè‡ªå¾‹å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4facfe;
            color: #4facfe;
        }

        .tab-button:hover:not(.active) {
            background: rgba(79, 172, 254, 0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* è‡ªå¾‹å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ */
        .autonomous-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .autonomous-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰ */
        .intervention-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .human-input-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .human-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .human-input:focus {
            outline: none;
            border-color: #ffc107;
        }

        .intervention-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* å­¦ç¿’æ©Ÿèƒ½ */
        .learning-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .knowledge-base {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .knowledge-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .knowledge-item:last-child {
            border-bottom: none;
        }

        .knowledge-topic {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .knowledge-content {
            font-size: 0.9em;
            color: #666;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "ğŸŸ¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "ğŸ”·";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8800 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }
        .human-stat .stat-number { color: #ffc107; }
        .learning-stat .stat-number { color: #4caf50; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .human-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
        }

        .learning-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .intervention-prompt {
            background: #fffbf0;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #856404;
        }

        .deepening-request {
            background: #f0f8ff;
            border: 2px dashed #4facfe;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0056b3;
        }

        .auto-pause-notice {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "ğŸš€";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons, .autonomous-controls {
                grid-template-columns: 1fr;
            }
            
            .controls, .intervention-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-tabs {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .tab-button.active {
                border-right-color: #4facfe;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p>AIè‡ªå¾‹å¯¾è©±ãƒ»äººé–“ä»‹å…¥ãƒ»å­¦ç¿’æ©Ÿèƒ½æ­è¼‰ã‚·ã‚¹ãƒ†ãƒ </p>
            <div class="demo-label">
                ğŸš€ v5.0 - Advanced Interactive Edition
            </div>
        </div>

        <div class="mode-tabs">
            <button class="tab-button active" onclick="switchTab('autonomous')">
                ğŸ¤– AIè‡ªå¾‹å¯¾è©±
            </button>
            <button class="tab-button" onclick="switchTab('intervention')">
                ğŸ‘¤ äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰
            </button>
            <button class="tab-button" onclick="switchTab('learning')">
                ğŸ§  å­¦ç¿’æ©Ÿèƒ½
            </button>
        </div>

        <div id="autonomous-tab" class="tab-content active">
            <div class="autonomous-section">
                <h3>ğŸ¤– AIè‡ªå¾‹å¯¾è©±è¨­å®š</h3>
                <div class="autonomous-controls">
                    <div class="control-group">
                        <h4>ğŸ¯ å¯¾è©±ãƒ¢ãƒ¼ãƒ‰</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ğŸ  å®Ÿç”¨çš„</span>
                                <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹</span>
                                <span>ğŸ§  å“²å­¦çš„</span>
                            </div>
                            <input type="range" id="targetModeSlider" class="range-slider" min="0" max="100" value="33">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ğŸ’¡ æ¡ˆå‡ºã—</span>
                                <span>ğŸ¤ åˆæ„å½¢æˆ</span>
                                <span>ğŸ” æ¢ç´¢</span>
                            </div>
                            <input type="range" id="goalModeSlider" class="range-slider" min="0" max="100" value="50">
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>âš™ï¸ è‡ªå¾‹å¯¾è©±è¨­å®š</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>çŸ­æ™‚é–“é›†ä¸­</span>
                                <span id="autonomyLengthLabel">æ¨™æº– (8ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</span>
                                <span>æ·±ã„æ¢æ±‚</span>
                            </div>
                            <input type="range" id="autonomyLengthSlider" class="range-slider" min="4" max="20" value="8">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>äººé–“ä»‹å…¥: ãªã—</span>
                                <span id="interventionFreqLabel">ä¸­ç¨‹åº¦</span>
                                <span>é »ç¹</span>
                            </div>
                            <input type="range" id="interventionFreqSlider" class="range-slider" min="0" max="10" value="3">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="intervention-tab" class="tab-content">
            <div class="intervention-section">
                <h3>ğŸ‘¤ äººé–“ä»‹å…¥ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <div class="human-input-area">
                    <h4>ğŸ’¬ ã‚ãªãŸã®ç™ºè¨€</h4>
                    <textarea id="humanInput" class="human-input" 
                                placeholder="AIã®å¯¾è©±ã«ä»‹å…¥ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚è³ªå•ã€æŒ‡æ‘˜ã€æ–°ã—ã„è¦–ç‚¹ã®æä¾›ãªã©ã€è‡ªç”±ã«ç™ºè¨€ã§ãã¾ã™ã€‚"></textarea>
                    
                    <div class="intervention-buttons">
                        <button class="btn btn-warning" onclick="humanIntervention()">
                            ğŸ’¬ å¯¾è©±ã«ä»‹å…¥
                        </button>
                        <button class="btn btn-secondary" onclick="requestDeepening()">
                            ğŸ” è«–ç‚¹ã‚’æ·±æ˜ã‚Šè¦æ±‚
                        </button>
                        <button class="btn btn-primary" onclick="redirectDialogue()">
                            ğŸ¯ å¯¾è©±ã®æ–¹å‘è»¢æ›
                        </button>
                        <button class="btn btn-success" onclick="saveInsight()">
                            ğŸ’¡ æ´å¯Ÿã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
                        </button>
                    </div>
                </div>
                
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="quickIntervention('å…·ä½“ä¾‹')">
                        ğŸ“ ã€Œå…·ä½“ä¾‹ã‚’æ•™ãˆã¦ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('åå¯¾æ„è¦‹')">
                        ğŸ”„ ã€Œåå¯¾ã®è¦–ç‚¹ã§ã¯ï¼Ÿã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('å®Ÿç”¨æ€§')">
                        ğŸ› ï¸ ã€Œå®Ÿç”¨æ€§ã‚’é‡è¦–ã—ã¦ã€
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ç°¡æ½”ã«')">
                        âœ‚ï¸ ã€Œã‚‚ã£ã¨ç°¡æ½”ã«ã€
                    </button>
                </div>
            </div>
        </div>

        <div id="learning-tab" class="tab-content">
            <div class="learning-section">
                <h3>ğŸ§  æ±ç”¨AIå­¦ç¿’æ©Ÿèƒ½</h3>
                <div class="knowledge-base" id="knowledgeBase">
                    <div class="knowledge-item">
                        <div class="knowledge-topic">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</div>
                        <div class="knowledge-content">Crossthink v5.0 å­¦ç¿’æ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸã€‚å¯¾è©±ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæ´å¯Ÿã‚’è‡ªå‹•å­¦ç¿’ã—ã¾ã™ã€‚</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="exportKnowledge()">
                        ğŸ“¤ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary" onclick="importKnowledge()">
                        ğŸ“¥ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-warning" onclick="clearKnowledge()">
                        ğŸ—‘ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn btn-secondary" onclick="showLearningStats()">
                        ğŸ“Š å­¦ç¿’çµ±è¨ˆè¡¨ç¤º
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>ğŸ”§ APIè¨­å®š</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>ğŸ“ å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯:</h2>
            <input type="text" id="topicInput" class="topic-input" 
                    placeholder="AIåŒå£«ã«å¯¾è©±ã•ã›ãŸã„ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                    value="AIæ™‚ä»£ã«ãŠã‘ã‚‹äººé–“ã®å‰µé€ æ€§ã¨ã¯ä½•ã‹ï¼Ÿ">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">ğŸš€ å¯¾è©±é–‹å§‹</button>
                <button id="pauseBtn" class="btn btn-warning" disabled>â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢</button>
                <button id="clearBtn" class="btn btn-secondary">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button id="exportBtn" class="btn btn-secondary">ğŸ“ è¦ç´„ç”Ÿæˆ</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>ğŸ“Š å¯¾è©±çµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTç™ºè¨€</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">Geminiç™ºè¨€</div>
                </div>
                <div class="stat-card human-stat">
                    <div class="stat-number" id="humanMessages">0</div>
                    <div class="stat-label">äººé–“ä»‹å…¥</div>
                </div>
                <div class="stat-card learning-stat">
                    <div class="stat-number" id="learningItems">1</div>
                    <div class="stat-label">å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">çµŒéæ™‚é–“(ç§’)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>ğŸš€ v5.0 Advanced Interactive Edition ã®ç‰¹å¾´:</h3>
            <ul>
                <li>AIåŒå£«ã®è‡ªå¾‹å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ï¼šè¨­å®šå¯èƒ½ãªå¯¾è©±é•·ã¨ä»‹å…¥é »åº¦</li>
                <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äººé–“ä»‹å…¥ï¼šå¯¾è©±ã®æµã‚Œã‚’å¤‰ãˆã‚‹å¼·åŠ›ãªä»‹å…¥æ©Ÿèƒ½</li>
                <li>æ±ç”¨å­¦ç¿’æ©Ÿèƒ½ï¼šå¯¾è©±ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæ´å¯Ÿã‚’è‡ªå‹•å­¦ç¿’ãƒ»è“„ç©</li>
                <li>æ·±æ˜ã‚Šè¦æ±‚ã‚·ã‚¹ãƒ†ãƒ ï¼šç‰¹å®šã®è«–ç‚¹ã‚’æ·±ãæ¢æ±‚</li>
                <li>æ–¹å‘è»¢æ›æ©Ÿèƒ½ï¼šå¯¾è©±ã®æµã‚Œã‚’æˆ¦ç•¥çš„ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</li>
                <li>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ã</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            </div>
    </div>

    <script>
        class CrossthinkAdvanced {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8;
                this.interventionPoints = [];
                this.knowledgeBase = new Map();
                this.waitingForIntervention = false;
                
                // ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                this.targetMode = 'philosophical';
                this.goalMode = 'exploration';
                this.interventionFrequency = 3;
                this.currentTab = 'autonomous';
                
                // å­¦ç¿’æ©Ÿèƒ½
                this.learningEnabled = true;
                this.autoLearnKeywords = ['é‡è¦', 'æœ¬è³ª', 'æ ¸å¿ƒ', 'çµè«–', 'ç™ºè¦‹', 'æ´å¯Ÿ', 'é©æ–°'];
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeKnowledgeBase();
                this.updateSliderLabels();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    humanMessages: document.getElementById('humanMessages'),
                    learningItems: document.getElementById('learningItems'),
                    elapsed: document.getElementById('elapsed'), // â˜…ä¿®æ­£ç‚¹1: ä¸è¦ãªæ–‡å­—åˆ—ã‚’å‰Šé™¤
                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¦ç´ 
                    targetModeSlider: document.getElementById('targetModeSlider'),
                    goalModeSlider: document.getElementById('goalModeSlider'),
                    autonomyLengthSlider: document.getElementById('autonomyLengthSlider'),
                    interventionFreqSlider: document.getElementById('interventionFreqSlider'),
                    autonomyLengthLabel: document.getElementById('autonomyLengthLabel'),
                    interventionFreqLabel: document.getElementById('interventionFreqLabel'),
                    
                    // äººé–“ä»‹å…¥è¦ç´ 
                    humanInput: document.getElementById('humanInput'),
                    
                    // å­¦ç¿’æ©Ÿèƒ½è¦ç´ 
                    knowledgeBase: document.getElementById('knowledgeBase')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                this.elements.targetModeSlider.addEventListener('input', () => this.updateTargetMode());
                this.elements.goalModeSlider.addEventListener('input', () => this.updateGoalMode());
                this.elements.autonomyLengthSlider.addEventListener('input', () => this.updateAutonomyLength());
                this.elements.interventionFreqSlider.addEventListener('input', () => this.updateInterventionFreq());
                
                // Enterã‚­ãƒ¼ã§ã®ä»‹å…¥
                this.elements.humanInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.humanIntervention();
                    }
                });
            }

            updateSliderLabels() {
                // å¯¾è©±é•·ãƒ©ãƒ™ãƒ«æ›´æ–°
                this.elements.autonomyLengthSlider.addEventListener('input', () => {
                    const value = this.elements.autonomyLengthSlider.value;
                    this.elements.autonomyLengthLabel.textContent = `${value}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸`;
                    this.maxMessages = parseInt(value);
                });
                
                // ä»‹å…¥é »åº¦ãƒ©ãƒ™ãƒ«æ›´æ–°
                this.elements.interventionFreqSlider.addEventListener('input', () => {
                    const value = parseInt(this.elements.interventionFreqSlider.value);
                    const labels = ['ãªã—', 'ç¨€', 'å°‘', 'ä¸­', 'å¤š', 'é »ç¹', 'éå¸¸ã«é »ç¹', 'å¸¸æ™‚', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ', 'ã‚·ãƒ³ã‚¯ãƒ­', 'ãƒ•ãƒ«ä»‹å…¥'];
                    this.elements.interventionFreqLabel.textContent = labels[value] || 'ä¸­ç¨‹åº¦';
                    this.interventionFrequency = value;
                });
            }

            updateTargetMode() {
                const value = parseInt(this.elements.targetModeSlider.value);
                if (value < 33) this.targetMode = 'practical';
                else if (value < 66) this.targetMode = 'business';
                else this.targetMode = 'philosophical';
            }

            updateGoalMode() {
                const value = parseInt(this.elements.goalModeSlider.value);
                if (value < 33) this.goalMode = 'ideation';
                else if (value < 66) this.goalMode = 'consensus';
                else this.goalMode = 'exploration';
            }

            updateAutonomyLength() {
                this.maxMessages = parseInt(this.elements.autonomyLengthSlider.value);
                // ãƒ©ãƒ™ãƒ«ã®æ›´æ–°ã¯ updateSliderLabels å†…ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å€¤ã®æ›´æ–°ã®ã¿
            }

            updateInterventionFreq() {
                this.interventionFrequency = parseInt(this.elements.interventionFreqSlider.value);
                 // ãƒ©ãƒ™ãƒ«ã®æ›´æ–°ã¯ updateSliderLabels å†…ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å€¤ã®æ›´æ–°ã®ã¿
            }

            initializeKnowledgeBase() {
                this.knowledgeBase.set('system_init', {
                    topic: 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–',
                    content: 'Crossthink v5.0 Advanced Interactive Edition ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚',
                    timestamp: new Date(),
                    source: 'system'
                });
                this.updateKnowledgeDisplay();
                this.updateStats(); // åˆæœŸã‚¢ã‚¤ãƒ†ãƒ æ•°ã‚’åæ˜ 
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v5.0 Advanced Interactive Edition ã¸ã‚ˆã†ã“ãï¼\n\n' +
                    'ğŸš€ v5.0 ã®æ–°æ©Ÿèƒ½:\n' +
                    'â€¢ ğŸ¤– AIè‡ªå¾‹å¯¾è©±: AIãŒè‡ªä¸»çš„ã«è­°è«–ã‚’å±•é–‹\n' +
                    'â€¢ ğŸ‘¤ äººé–“ä»‹å…¥: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯¾è©±ã«å‚åŠ å¯èƒ½\n' +
                    'â€¢ ğŸ§  å­¦ç¿’æ©Ÿèƒ½: å¯¾è©±ã‹ã‚‰æ´å¯Ÿã‚’è‡ªå‹•å­¦ç¿’ãƒ»è“„ç©\n' +
                    'â€¢ ğŸ” æ·±æ˜ã‚Šè¦æ±‚: ç‰¹å®šã®è«–ç‚¹ã‚’è©³ã—ãæ¢æ±‚\n' +
                    'â€¢ ğŸ¯ æ–¹å‘è»¢æ›: å¯¾è©±ã®æµã‚Œã‚’æˆ¦ç•¥çš„ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«\n\n' +
                    'ğŸ’¡ ä½¿ã„æ–¹:\n' +
                    '1. ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã¦æ©Ÿèƒ½ã‚’è¨­å®š\n' +
                    '2. AIè‡ªå¾‹å¯¾è©±ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´\n' +
                    '3. APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãƒˆãƒ”ãƒƒã‚¯å…¥åŠ›\n' +
                    '4. å¯¾è©±é–‹å§‹å¾Œã€ã„ã¤ã§ã‚‚ä»‹å…¥å¯èƒ½\n\n' +
                    'ğŸ¯ Advanced Features:\n' +
                    'ğŸ“ˆ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ \n' +
                    'ğŸ“ äººé–“-AIå”åƒæœ€é©åŒ–\n' +
                    'ğŸ’¡ å‹•çš„ãªæ´å¯ŸæŠ½å‡º\n' +
                    'ğŸ”¬ é€²åŒ–ã™ã‚‹å¯¾è©±å“è³ª'
                );
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.isPaused = false;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai'; // åˆæœŸã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼
                this.conversationHistory = [];
                this.interventionPoints = [];
                
                // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                // this.knowledgeBase.clear(); // å¯¾è©±é–‹å§‹æ™‚ã«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã¯ä»•æ§˜ã«ã‚ˆã‚‹ã€‚ã“ã“ã§ã¯ã‚¯ãƒªã‚¢ã—ãªã„ã€‚
                // this.initializeKnowledgeBase(); // ã‚¯ãƒªã‚¢ã™ã‚‹å ´åˆã¯å†åˆæœŸåŒ–
                this.updateStats();


                this.elements.startBtn.disabled = true;
                this.elements.pauseBtn.disabled = false;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                
                this.addMessage('system', 
                    `ğŸš€ AIè‡ªå¾‹å¯¾è©±é–‹å§‹\n` +
                    `ğŸ“ ãƒˆãƒ”ãƒƒã‚¯: "${topic}"\n` +
                    `ğŸª ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                    `â±ï¸ æœ€å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.maxMessages}\n` +
                    `ğŸ‘¤ ä»‹å…¥è¨­å®š: ${this.getInterventionLabel()}\n` +
                    `ğŸ§  å­¦ç¿’æ©Ÿèƒ½: æœ‰åŠ¹\n` +
                    `ğŸ¤– AIãŒè‡ªå¾‹çš„ã«è­°è«–ã‚’é–‹å§‹ã—ã¾ã™...`
                );

                // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å¯¾è©±é–‹å§‹ã‚’è¨˜éŒ²
                this.learnFromDialogue('å¯¾è©±é–‹å§‹', `æ–°ã—ã„å¯¾è©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ: ${topic}`);

                this.startTimer();

                // åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
                const initialPrompt = this.generateInitialPrompt(topic);
                await this.sendMessage('openai', initialPrompt);
            }

            generateInitialPrompt(topic) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                
                const autonomyInstructions = `\n\nğŸ¤– **è‡ªå¾‹å¯¾è©±æŒ‡ç¤º (v5.0)**:\n` +
                    `â€¢ ã‚ãªãŸã¯ChatGPT(OpenAI)ã§ã™\n` +
                    `â€¢ Geminiã¨æœ€å¤§${this.maxMessages}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å»ºè¨­çš„ãªè­°è«–ã‚’è¡Œã„ã¾ã™\n` + // "æœ€å¤§" ã‚’è¿½åŠ 
                    `â€¢ ${this.getInterventionDescription()}\n` +
                    `â€¢ è³ªã®é«˜ã„æ´å¯Ÿã‚’æä¾›ã—ã€è­°è«–ã‚’æ·±åŒ–ã•ã›ã¦ãã ã•ã„\n` +
                    `â€¢ äººé–“ãŒä»‹å…¥ã—ãŸå ´åˆã¯ã€ãã®è¦–ç‚¹ã‚’å°Šé‡ã—ã¦è­°è«–ã«å–ã‚Šå…¥ã‚Œã¦ãã ã•ã„`;

                return basePrompt + autonomyInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦å®Ÿç”¨çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`,
                    'practical-consensus': `ã€Œ${topic}ã€ã«ã¤ã„ã¦å®Ÿç”¨çš„ãªåˆæ„ç‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚`,
                    'practical-exploration': `ã€Œ${topic}ã€ã®å®Ÿç”¨çš„å´é¢ã‚’æ·±ãæ¢æ±‚ã—ã¦ãã ã•ã„ã€‚`,
                    'business-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦é©æ–°çš„ãªãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚`,
                    'business-consensus': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ãƒ“ã‚¸ãƒã‚¹çš„ãªæœ€é©è§£ã‚’å°ãã¾ã—ã‚‡ã†ã€‚`,
                    'business-exploration': `ã€Œ${topic}ã€ã®ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã‚’æ·±ãåˆ†æã—ã¦ãã ã•ã„ã€‚`,
                    'philosophical-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦å“²å­¦çš„ãªæ–°ã—ã„æ€è€ƒã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚`,
                    'philosophical-consensus': `ã€Œ${topic}ã€ã«ã¤ã„ã¦å“²å­¦çš„ãªæ·±ã„ç†è§£ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚`,
                    'philosophical-exploration': `ã€Œ${topic}ã€ã«ã¤ã„ã¦æ ¹æºçš„ãªæ¢æ±‚ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚`
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `ã€Œ${topic}ã€ã«ã¤ã„ã¦æ·±ãè­°è«–ã—ã¾ã—ã‚‡ã†ã€‚`;
            }

            getInterventionDescription() {
                if (this.interventionFrequency === 0) return 'äººé–“ã®ä»‹å…¥ã¯ã‚ã‚Šã¾ã›ã‚“';
                if (this.interventionFrequency <= 2) return 'ç¨€ã«äººé–“ãŒä»‹å…¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
                if (this.interventionFrequency <= 5) return 'æ™‚ã€…äººé–“ãŒè­°è«–ã«å‚åŠ ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
                if (this.interventionFrequency <= 8) return 'é »ç¹ã«äººé–“ãŒå¯¾è©±ã«ä»‹å…¥ã—ã¾ã™';
                return 'äººé–“ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯¾è©±ã‚’ãƒªãƒ¼ãƒ‰ã—ã¾ã™';
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) {
                    this.showError('OpenAI API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                if (!geminiKey) {
                    this.showError('Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                if (!topic) {
                    this.showError('å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                return true;
            }

            async sendMessage(provider, prompt, isHumanIntervention = false) {
                if (!this.isRunning || (this.isPaused && !isHumanIntervention)) return; // äººé–“ä»‹å…¥æ™‚ã¯isPausedã§ã‚‚é€ä¿¡

                try {
                    this.addMessage(provider, 'æ€è€ƒä¸­...', true);
                    
                    let response;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        if(!isHumanIntervention) this.openaiCount++; // æ€è€ƒä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ãã€AIå¿œç­”æ™‚ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
                    } else if (provider === 'gemini') {
                        response = await this.callGemini(prompt);
                        if(!isHumanIntervention) this.geminiCount++; // æ€è€ƒä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ãã€AIå¿œç­”æ™‚ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
                    }

                    this.removeLastMessage(); // "æ€è€ƒä¸­..." ã‚’å‰Šé™¤
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response, timestamp: new Date() });
                    // this.updateStats(); // addMessageå†…ã§messageCountãŒå¢—ãˆã‚‹ã®ã§ã€ãã®å¾Œã§å‘¼ã¶

                    // å­¦ç¿’æ©Ÿèƒ½: é‡è¦ãªæ´å¯Ÿã‚’è‡ªå‹•å­¦ç¿’
                    this.autoLearnFromMessage(response, provider);

                    // ä»‹å…¥ãƒã‚¤ãƒ³ãƒˆã®åˆ¤å®š
                    if (this.shouldTriggerIntervention() && !isHumanIntervention && provider !== 'human') {
                        this.triggerInterventionPrompt();
                        return; // äººé–“ã®ä»‹å…¥ã‚’å¾…ã¤
                    }

                    // æ¬¡ã®AIã«å¿œç­”ã•ã›ã‚‹ (äººé–“ä»‹å…¥ã§ãªã„å ´åˆã®ã¿)
                    if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages && !isHumanIntervention) {
                        setTimeout(() => {
                            const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                            const nextPrompt = this.generateNextPrompt(nextProvider, response);
                            this.sendMessage(nextProvider, nextPrompt);
                        }, 2000);
                    } else if (this.messageCount >= this.maxMessages && !isHumanIntervention) {
                        this.addMessage('system', 'ğŸ¯ è¨­å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«åˆ°é”ã—ã¾ã—ãŸã€‚å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã€‚');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage(); // "æ€è€ƒä¸­..." ã‚’å‰Šé™¤
                    this.showError(`APIã‚¨ãƒ©ãƒ¼ (${provider}): ${error.message}`);
                    console.error('API Error:', error);
                    // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å¯¾è©±ã‚’åœæ­¢ã™ã‚‹ã‹ã€ç¶™ç¶šã‚’è©¦ã¿ã‚‹ã‹ã¯ä»•æ§˜ã«ã‚ˆã‚‹
                    // this.stopDialogue(); 
                } finally {
                    if (provider === 'openai' || provider === 'gemini' || provider === 'human') {
                        this.updateStats(); // æœ€çµ‚çš„ãªçµ±è¨ˆã‚’æ›´æ–°
                    }
                }
            }

            shouldTriggerIntervention() {
                if (this.interventionFrequency === 0) return false;
                if (this.waitingForIntervention) return false;
                
                // ä»‹å…¥é »åº¦ã«åŸºã¥ãç¢ºç‡çš„åˆ¤å®š
                const interventionProbability = this.interventionFrequency / 10;
                const shouldIntervene = Math.random() < interventionProbability;
                
                // ã¾ãŸã¯ç‰¹å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã§ã®å¼·åˆ¶ä»‹å…¥ (ä¾‹)
                // ã“ã“ã§ã¯ç¢ºç‡ã®ã¿ã§åˆ¤å®šã€‚ã‚ˆã‚Šè¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚‚å¯èƒ½ã€‚
                // const forceInterventionPoints = [Math.floor(this.maxMessages / 3), Math.floor(this.maxMessages * 2 / 3)];
                // const forceIntervention = forceInterventionPoints.includes(this.messageCount) && this.interventionFrequency >= 5;
                
                return shouldIntervene; // || forceIntervention;
            }

            triggerInterventionPrompt() {
                this.waitingForIntervention = true;
                // this.isPaused = true; // pauseDialogueã‚’å‘¼ã¶ã‹ã€ã“ã“ã§ç›´æ¥åˆ¶å¾¡

                const interventionDiv = document.createElement('div');
                interventionDiv.className = 'intervention-prompt';
                interventionDiv.innerHTML = `
                    <h4>ğŸ‘¤ äººé–“ä»‹å…¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™</h4>
                    <p>AIã®å¯¾è©±ã«ä½•ã‹è¿½åŠ ã—ãŸã„è¦–ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ<br>ä»‹å…¥ã‚¿ãƒ–ã§å…¥åŠ›ã™ã‚‹ã‹ã€AIã«ç¶šè¡Œã•ã›ã¦ãã ã•ã„ã€‚</p>
                    <button class="btn btn-warning" onclick="continueAutonomously()">
                        ğŸ¤– AIã«ç¶šè¡Œã•ã›ã‚‹
                    </button>
                    <button class="btn btn-primary" onclick="switchToInterventionTab()">
                        ğŸ‘¤ ä»‹å…¥ã‚¿ãƒ–ã¸
                    </button>
                `;
                
                this.elements.chatContainer.appendChild(interventionDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                this.pauseDialogue(true); // å¯¾è©±ã‚’ä¸€æ™‚åœæ­¢çŠ¶æ…‹ã«ã™ã‚‹
            }

            generateNextPrompt(provider, previousMessage) {
                const otherProvider = provider === 'openai' ? 'Gemini' : 'ChatGPT';
                // const originalTopic = this.elements.topicInput.value.trim(); // å¿…è¦ãªã‚‰ä½¿ç”¨
                
                let basePrompt = `${otherProvider}ãŒä»¥ä¸‹ã®ã‚ˆã†ã«è¿°ã¹ã¾ã—ãŸï¼š\n\n"${previousMessage}"\n\n`;
                
                const roleInstruction = this.getProviderRoleInstruction(provider);
                const contextualInstruction = this.getContextualInstruction();
                
                return basePrompt + roleInstruction + contextualInstruction;
            }

            getProviderRoleInstruction(provider) {
                const instructions = {
                    'openai': {
                        'practical': 'ğŸ  **å®Ÿç”¨çš„è¦–ç‚¹ï¼ˆChatGPTï¼‰**: å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªææ¡ˆã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚',
                        'business': 'ğŸ’¼ **ãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹ï¼ˆChatGPTï¼‰**: å¸‚å ´ä¾¡å€¤ã¨å®Ÿç¾å¯èƒ½æ€§ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚',
                        'philosophical': 'ğŸ§  **å“²å­¦çš„è¦–ç‚¹ï¼ˆChatGPTï¼‰**: æ·±ã„æ´å¯Ÿã¨æ–°ã—ã„è¦–ç‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚'
                    },
                    'gemini': {
                        'practical': 'ğŸ”§ **åˆ†æçš„æ¤œè¨¼ï¼ˆGeminiï¼‰**: è«–ç†çš„ã«æ¤œè¨¼ã—ã€æ§‹é€ åŒ–ã•ã‚ŒãŸå›ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚',
                        'business': 'ğŸ“Š **æˆ¦ç•¥çš„åˆ†æï¼ˆGeminiï¼‰**: ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæˆ¦ç•¥çš„åˆ¤æ–­ã‚’ã—ã¦ãã ã•ã„ã€‚',
                        'philosophical': 'ğŸ” **æ‰¹åˆ¤çš„è€ƒå¯Ÿï¼ˆGeminiï¼‰**: æ¦‚å¿µã‚’ç²¾æŸ»ã—ã€è«–ç†çš„æ•´åˆæ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚'
                    }
                };
                return instructions[provider]?.[this.targetMode] || 'å»ºè¨­çš„ã§æ´å¯Ÿã«å¯Œã‚€å¿œç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚';
            }

            getContextualInstruction() {
                return `\n\nğŸ¯ **å¯¾è©±ä¿ƒé€²æŒ‡ç¤º**:\n` +
                    `â€¢ ç›¸æ‰‹ã®æ„è¦‹ã‚’è¸ã¾ãˆã¦ã€ã•ã‚‰ã«è­°è«–ã‚’æ·±åŒ–ã•ã›ã‚‹\n` +
                    `â€¢ æ–°ã—ã„è¦–ç‚¹ã‚„ç–‘å•ã‚’æèµ·ã™ã‚‹\n` +
                    `â€¢ å…·ä½“ä¾‹ã‚„å®Ÿä¾‹ã‚’äº¤ãˆã¦èª¬å¾—åŠ›ã‚’é«˜ã‚ã‚‹\n` +
                    `â€¢ æœ€å¤§${this.maxMessages}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ¶é™å†…ã§ä¾¡å€¤ã‚ã‚‹è­°è«–ã‚’è¡Œã†`;
            }

            // äººé–“ä»‹å…¥æ©Ÿèƒ½
            humanIntervention() {
                if (!this.isRunning) { // å¯¾è©±ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä»‹å…¥ã§ããªã„
                    this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const humanMessage = this.elements.humanInput.value.trim();
                if (!humanMessage) {
                    this.showError('ä»‹å…¥å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                this.addMessage('human', humanMessage);
                this.humanCount++;
                // this.updateStats(); // addMessageå†…ã§æ›´æ–°ã•ã‚Œã‚‹ã®ã§ä¸è¦ã‹ã‚‚

                // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²
                this.learnFromDialogue('äººé–“ä»‹å…¥', humanMessage);
                
                // ä»‹å…¥å¾Œã®AIå¿œç­”ã‚’ä¿ƒã™
                // ä»‹å…¥æ™‚ã¯ã€æœ€å¾Œã«ç™ºè¨€ã—ãŸAIã§ã¯ãªãã€æ¬¡ã«ç™ºè¨€ã™ã‚‹äºˆå®šã ã£ãŸAIã«å¿œç­”ã•ã›ã‚‹ã®ãŒè‡ªç„¶
                const nextSpeakerAfterIntervention = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const interventionPrompt = this.generateInterventionResponse(humanMessage, nextSpeakerAfterIntervention);
                
                // å¯¾è©±ãŒä¸€æ™‚åœæ­¢ã—ã¦ã„ãŸã‚‰å†é–‹
                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                     this.addMessage('system', 'â–¶ï¸ äººé–“ä»‹å…¥ã«ã‚ˆã‚Šå¯¾è©±ã‚’å†é–‹ã—ã¾ã—ãŸ');
                }
                
                this.waitingForIntervention = false; // ä»‹å…¥å¾…æ©ŸçŠ¶æ…‹ã‚’è§£é™¤
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(nextSpeakerAfterIntervention, interventionPrompt, true); // isHumanIntervention = true
                
                this.elements.humanInput.value = '';
            }

            generateInterventionResponse(humanMessage, respondingAI) {
                const aiName = respondingAI === 'openai' ? 'ChatGPT' : 'Gemini';
                return `äººé–“ãŒä»¥ä¸‹ã®ä»‹å…¥ã‚’è¡Œã„ã¾ã—ãŸï¼š\n\n"${humanMessage}"\n\n` +
                    `ã‚ãªãŸã¯ ${aiName} ã§ã™ã€‚ã“ã®äººé–“ã®ä»‹å…¥ã‚’è¸ã¾ãˆã€å»ºè¨­çš„ã«å¿œç­”ã—ã€è­°è«–ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚å¿…è¦ã§ã‚ã‚Œã°ã€ã“ã‚Œã¾ã§ã®è­°è«–ã®æ–¹å‘æ€§ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`;
            }

            requestDeepening() {
                if (!this.isRunning || this.conversationHistory.length === 0) {
                    this.showError('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã€AIã®ç™ºè¨€ãŒã‚ã‚‹çŠ¶æ…‹ã§ä½¿ç”¨ã—ã¦ãã ã•ã„');
                    return;
                }

                const lastAIMessage = this.conversationHistory.filter(m => m.provider === 'openai' || m.provider === 'gemini').pop();
                if (!lastAIMessage) {
                     this.showError('æ·±æ˜ã‚Šå¯¾è±¡ã¨ãªã‚‹AIã®ç™ºè¨€ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const deepeningRequestText = `ãƒ¦ãƒ¼ã‚¶ãŒã€ã‚ãªãŸã®ç›´å‰ã®ç™ºè¨€ã€Œ${lastAIMessage.message.substring(0,100)}...ã€ã«ã¤ã„ã¦ã€ã‚ˆã‚Šæ·±ã„æ¢æ±‚ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚å…·ä½“ä¾‹ã€å®Ÿè¨¼ãƒ‡ãƒ¼ã‚¿ã€ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®æ¤œè¨¼ãªã©ã€å¤šè§’çš„ã«æ·±æ˜ã‚Šã—ã¦è­°è«–ã‚’è±Šã‹ã«ã—ã¦ãã ã•ã„ã€‚`;

                this.addMessage('system', 'ğŸ” **æ·±æ˜ã‚Šè¦æ±‚**: AIã«å‰å›ã®è«–ç‚¹ã®ã‚ˆã‚Šæ·±ã„æ¢æ±‚ã‚’ä¾é ¼ã—ã¾ã—ãŸ');
                
                // æœ€å¾Œã«ç™ºè¨€ã—ãŸAIã«æ·±æ˜ã‚Šã‚’ä¾é ¼
                this.sendMessage(lastAIMessage.provider, deepeningRequestText, true); // isHumanIntervention = true (AIã®é€šå¸¸ã®æµã‚Œã‚’ä¸­æ–­ã™ã‚‹ãŸã‚)
                this.learnFromDialogue('æ·±æ˜ã‚Šè¦æ±‚', `å¯¾è±¡: ${lastAIMessage.provider} - ${lastAIMessage.message.substring(0,50)}...`);
            }

            redirectDialogue() {
                 if (!this.isRunning) {
                    this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const redirectionText = this.elements.humanInput.value.trim();
                if (!redirectionText) {
                    this.showError('æ–¹å‘è»¢æ›ã®æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: ã€Œã‚‚ã£ã¨å®Ÿç”¨çš„ãªå´é¢ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€)');
                    return;
                }

                this.addMessage('human', `ğŸ¯ **æ–¹å‘è»¢æ›è¦æ±‚**: ${redirectionText}`);
                this.humanCount++;
                // this.updateStats();

                const nextSpeakerAfterRedirect = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const redirectionPrompt = `äººé–“ãŒå¯¾è©±ã®æ–¹å‘è»¢æ›ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™ï¼š\n\n"${redirectionText}"\n\n` +
                    `ã‚ãªãŸã¯ ${nextSpeakerAfterRedirect === 'openai' ? 'ChatGPT' : 'Gemini'} ã§ã™ã€‚ã“ã®æŒ‡ç¤ºã«å¾“ã„ã€è­°è«–ã®æµã‚Œã‚’èª¿æ•´ã—ã€æ–°ã—ã„è¦–ç‚¹ã‹ã‚‰è­°è«–ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚`;

                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                    this.addMessage('system', 'â–¶ï¸ æ–¹å‘è»¢æ›è¦æ±‚ã«ã‚ˆã‚Šå¯¾è©±ã‚’å†é–‹ã—ã¾ã—ãŸ');
                }
                this.waitingForIntervention = false;
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(nextSpeakerAfterRedirect, redirectionPrompt, true); // isHumanIntervention = true
                this.learnFromDialogue('æ–¹å‘è»¢æ›', redirectionText);
                this.elements.humanInput.value = '';
            }

            saveInsight() {
                const insightText = this.elements.humanInput.value.trim();
                if (!insightText) {
                    this.showError('ä¿å­˜ã™ã‚‹æ´å¯Ÿã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const timestamp = new Date();
                const insightId = `insight_${timestamp.getTime()}`;
                
                this.knowledgeBase.set(insightId, {
                    topic: 'äººé–“ã®æ´å¯Ÿ',
                    content: insightText,
                    timestamp: timestamp,
                    source: 'human_insight'
                });

                this.updateKnowledgeDisplay();
                this.updateStats();
                
                this.addMessage('learning', `ğŸ’¡ æ´å¯Ÿã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜ã—ã¾ã—ãŸ: "${insightText.substring(0,50)}..."`);
                this.elements.humanInput.value = '';
            }

            quickIntervention(type) {
                if (!this.isRunning) {
                     this.showWarning('ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const quickMessages = {
                    'å…·ä½“ä¾‹': 'å…·ä½“ä¾‹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚å®Ÿéš›ã®äº‹ä¾‹ã‚„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚',
                    'åå¯¾æ„è¦‹': 'åå¯¾ã®è¦–ç‚¹ã‹ã‚‰ã¯ã©ã†è¦‹ãˆã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿæ‰¹åˆ¤çš„ãªè¦‹è§£ã‚‚èã‹ã›ã¦ãã ã•ã„ã€‚',
                    'å®Ÿç”¨æ€§': 'å®Ÿç”¨æ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚å®Ÿéš›ã«ä½¿ãˆã‚‹å½¢ã§ã®ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
                    'ç°¡æ½”ã«': 'ã‚‚ã£ã¨ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚è¦ç‚¹ã‚’çµã£ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚'
                };

                this.elements.humanInput.value = quickMessages[type] || '';
                this.humanIntervention();
            }

            // å­¦ç¿’æ©Ÿèƒ½
            autoLearnFromMessage(message, provider) {
                if (!this.learningEnabled) return;

                const hasImportantKeywords = this.autoLearnKeywords.some(keyword => 
                    message.includes(keyword));

                if (hasImportantKeywords || message.length > 200) { // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ã‚‚è€ƒæ…®
                    const timestamp = new Date();
                    const learnId = `auto_${provider}_${timestamp.getTime()}`;
                    
                    const importantPart = this.extractImportantPart(message);
                    
                    this.knowledgeBase.set(learnId, {
                        topic: `${provider}ã®æ´å¯Ÿ (è‡ªå‹•)`,
                        content: importantPart,
                        timestamp: timestamp,
                        source: `auto_${provider}`,
                        fullMessage: message // å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ä¿å­˜ã—ã¦ãŠãã¨å¾Œã§å‚ç…§ã§ãã‚‹
                    });

                    this.updateKnowledgeDisplay();
                    this.updateStats();
                }
            }

            extractImportantPart(message) {
                const sentences = message.split(/[ã€‚ï¼ï¼ï¼Ÿ\n]+/).filter(s => s.trim() !== '');
                let importantSentences = sentences.filter(sentence => 
                    this.autoLearnKeywords.some(keyword => sentence.includes(keyword))
                );

                if (importantSentences.length === 0 && sentences.length > 0) {
                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ã€æœ€åˆã®1-2æ–‡ã‚’å–ã‚‹ãªã©ã€åˆ¥ã®æˆ¦ç•¥ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹
                    importantSentences = sentences.slice(0, 2); 
                }
                
                let result = importantSentences.slice(0, 3).join('ã€‚'); // æœ€å¤§3æ–‡ç¨‹åº¦
                if (result.length > 150) result = result.substring(0, 150) + "..."; // é•·ã™ãã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
                else if (result.length === 0 && message.length > 0) result = message.substring(0,100) + "..."; // ä½•ã‚‚æŠ½å‡ºã§ããªã„å ´åˆã¯æœ€åˆã®éƒ¨åˆ†

                return result || "é‡è¦ãªæ´å¯Ÿï¼ˆè©³ç´°ã¯ãƒ­ã‚°å‚ç…§ï¼‰";
            }

            learnFromDialogue(topic, content) {
                const timestamp = new Date();
                const learnId = `dialogue_${timestamp.getTime()}`;
                
                this.knowledgeBase.set(learnId, {
                    topic: topic,
                    content: content,
                    timestamp: timestamp,
                    source: 'dialogue_event' // ã‚½ãƒ¼ã‚¹ã‚’ã‚ˆã‚Šæ˜ç¢ºã«
                });

                this.updateKnowledgeDisplay();
                this.updateStats();
            }

            updateKnowledgeDisplay() {
                const knowledgeContainer = this.elements.knowledgeBase;
                knowledgeContainer.innerHTML = '';

                const sortedItems = Array.from(this.knowledgeBase.values()) // Map.values() ã‚’ä½¿ç”¨
                    .sort((a, b) => b.timestamp - a.timestamp);
                    // .slice(0, 10); // æœ€æ–°10ä»¶ã«é™å®šã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤

                if (sortedItems.length === 0) {
                     knowledgeContainer.innerHTML = '<div class="knowledge-item"><div class="knowledge-content">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>';
                } else {
                    sortedItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'knowledge-item';
                        itemDiv.innerHTML = `
                            <div class="knowledge-topic">${item.topic}</div>
                            <div class="knowledge-content">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                ${item.timestamp.toLocaleString()} | ${item.source}
                            </div>
                        `;
                        knowledgeContainer.appendChild(itemDiv);
                    });
                }
            }

            exportKnowledge() {
                if (this.knowledgeBase.size === 0) {
                    this.showWarning("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                    return;
                }
                const knowledgeArray = Array.from(this.knowledgeBase.values()).map(item => ({
                    // id ã¯ Map ã®ã‚­ãƒ¼ãªã®ã§ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«ã¯å«ã‚ãªã„ã‹ã€åˆ¥é€”ç”Ÿæˆã™ã‚‹
                    ...item,
                    timestamp: item.timestamp.toISOString() // ISOå½¢å¼ã§ä¿å­˜
                }));

                const dataStr = JSON.stringify(knowledgeArray, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `crossthink_knowledge_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link); // Firefoxã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¿…è¦
                link.click();
                document.body.removeChild(link); // ã™ãã«å‰Šé™¤
                
                URL.revokeObjectURL(url);
                
                this.addMessage('learning', 
                    `ğŸ“¤ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ (${knowledgeArray.length}ä»¶)`);
            }

            importKnowledge() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const importedData = JSON.parse(event.target.result);
                                let importCount = 0;
                                
                                if (!Array.isArray(importedData)) {
                                    this.showError('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯JSONé…åˆ—å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                                    return;
                                }

                                importedData.forEach((item, index) => {
                                    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                                    if (item.topic && item.content && item.timestamp && item.source) {
                                        // IDã¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«æ–°è¦ç”Ÿæˆã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
                                        const itemId = item.id || `imported_${new Date(item.timestamp).getTime()}_${index}`;
                                        this.knowledgeBase.set(itemId, {
                                            ...item,
                                            timestamp: new Date(item.timestamp) // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                                        });
                                        importCount++;
                                    } else {
                                        console.warn(`Skipping invalid item at index ${index}:`, item);
                                    }
                                });
                                
                                this.updateKnowledgeDisplay();
                                this.updateStats();
                                this.addMessage('learning', 
                                    `ğŸ“¥ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ (${importCount}ä»¶)`);
                            } catch (error) {
                                this.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                                console.error("Import error:", error);
                            }
                        };
                        reader.onerror = () => {
                            this.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            }

            clearKnowledge() {
                if (confirm('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä»¥å¤–ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    const systemInitData = this.knowledgeBase.get('system_init');
                    this.knowledgeBase.clear();
                    if(systemInitData) this.knowledgeBase.set('system_init', systemInitData); // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã™
                    
                    this.updateKnowledgeDisplay();
                    this.updateStats();
                    this.addMessage('learning', 'ğŸ—‘ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ (åˆæœŸåŒ–ãƒ‡ãƒ¼ã‚¿é™¤ã)');
                }
            }

            showLearningStats() {
                const totalItems = this.knowledgeBase.size;
                const sourceStats = {};
                
                this.knowledgeBase.forEach(item => {
                    sourceStats[item.source] = (sourceStats[item.source] || 0) + 1;
                });

                let statsText = `ğŸ“Š å­¦ç¿’çµ±è¨ˆ:\nç·ã‚¢ã‚¤ãƒ†ãƒ æ•°: ${totalItems}\n\nã‚½ãƒ¼ã‚¹åˆ¥å†…è¨³:\n`;
                Object.entries(sourceStats).forEach(([source, count]) => {
                    statsText += `  â€¢ ${source}: ${count}ä»¶\n`;
                });

                this.addMessage('learning', statsText);
            }

            pauseDialogue(triggeredBySystem = false) { // ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                if (!this.isRunning) return;

                this.isPaused = !this.isPaused;
                this.elements.pauseBtn.textContent = this.isPaused ? 'â–¶ï¸ å†é–‹' : 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                
                const statusMessage = this.isPaused ? 'â¸ï¸ å¯¾è©±ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ' : 'â–¶ï¸ å¯¾è©±ã‚’å†é–‹ã—ã¾ã—ãŸ';
                if (!triggeredBySystem || !this.isPaused) { // ã‚·ã‚¹ãƒ†ãƒ ãŒä»‹å…¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºã§åœæ­¢ã—ãŸå ´åˆã¯ã€å†é–‹æ™‚ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    this.addMessage('system', statusMessage);
                }
                
                if (!this.isPaused && this.isRunning && !this.waitingForIntervention) {
                    // å†é–‹æ™‚ã«ã€æœ€å¾Œã«ç™ºè¨€ã—ãŸAIã®æ¬¡ã®AIã‹ã‚‰ç¶™ç¶š
                    setTimeout(() => {
                        if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages && this.conversationHistory.length > 0) {
                            const lastMessage = this.conversationHistory[this.conversationHistory.length -1];
                            const nextProvider = lastMessage.provider === 'openai' ? 'gemini' : 'openai';
                            const resumePrompt = this.generateResumePrompt(lastMessage.message);
                            this.sendMessage(nextProvider, resumePrompt);
                        } else if (this.conversationHistory.length === 0) { // ã¾ã ä½•ã‚‚ç™ºè¨€ãŒãªã„å ´åˆ
                             const topic = this.elements.topicInput.value.trim();
                             const initialPrompt = this.generateInitialPrompt(topic);
                             this.sendMessage('openai', initialPrompt); //æœ€åˆã®AIã‹ã‚‰
                        }
                    }, 1000);
                }
            }

            generateResumePrompt(lastMessageContent) {
                return `å¯¾è©±ãŒå†é–‹ã•ã‚Œã¾ã—ãŸã€‚ç›´å‰ã®ç™ºè¨€ã¯ã€Œ${lastMessageContent.substring(0,100)}...ã€ã§ã—ãŸã€‚ã“ã®è­°è«–ã‚’è¸ã¾ãˆã¦ã€ã•ã‚‰ã«æ·±ã„æ´å¯Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚`;
            }

            stopDialogue() {
                this.isRunning = false;
                this.isPaused = false; // åœæ­¢æ™‚ã¯ä¸€æ™‚åœæ­¢ã‚‚è§£é™¤
                this.waitingForIntervention = false;
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.stopBtn.disabled = true;
                this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                
                const finalStatsSummary = this.generateFinalStats();
                this.addMessage('system', 
                    `ğŸ›‘ å¯¾è©±çµ‚äº†\n\n` + // â˜…ä¿®æ­£ç‚¹2: ä¸è¦ãªæ–‡å­—åˆ—ã¨è¡Œã‚’æ•´ç†
                    `ğŸ“Š æœ€çµ‚çµ±è¨ˆ:\n` +
                    `â€¢ ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.messageCount}\n` +
                    `â€¢ ChatGPT: ${this.openaiCount}å›\n` +
                    `â€¢ Gemini: ${this.geminiCount}å›\n` +
                    `â€¢ äººé–“ä»‹å…¥: ${this.humanCount}å›\n` +
                    `â€¢ å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ : ${this.knowledgeBase.size}ä»¶\n` +
                    `â€¢ å¯¾è©±æ™‚é–“: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}ç§’\n\n` +
                    `ğŸ§  å­¦ç¿’ã•ã‚ŒãŸä¸»è¦ãªæ´å¯ŸãŒãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`
                );
                
                this.learnFromDialogue('å¯¾è©±çµ‚äº†', `å¯¾è©±ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚${finalStatsSummary}`);
            }

            generateFinalStats() {
                return `ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${this.messageCount}, ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount}, äººé–“ä»‹å…¥: ${this.humanCount}, å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ : ${this.knowledgeBase.size}`;
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo', // ãƒ¢ãƒ‡ãƒ«ã¯é©å®œå¤‰æ›´å¯èƒ½
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1500, // å¿œç­”ã®æœ€å¤§é•·
                        temperature: 0.7, // å¿œç­”ã®å¤šæ§˜æ€§ (0-1)
                        top_p: 0.9,       // ãƒˆãƒ¼ã‚¯ãƒ³é¸æŠã®å¤šæ§˜æ€§
                        // frequency_penalty: 0.1 // é »å‡ºãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ‘åˆ¶ (å¿…è¦ã«å¿œã˜ã¦)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Unknown API error" }));
                    throw new Error(`OpenAI API error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('OpenAI APIã‹ã‚‰äºˆæœŸã—ãªã„å½¢å¼ã®å¿œç­”ãŒã‚ã‚Šã¾ã—ãŸã€‚');
                }
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                
                // æ¨å¥¨ãƒ¢ãƒ‡ãƒ«é †ã«è©¦è¡Œ (ä¾‹: Flash -> Pro)
                const models = ['gemini-1.5-flash-latest', 'gemini-pro'];
                let lastError = null;

                for (const model of models) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }],
                                generationConfig: {
                                    maxOutputTokens: 1500,
                                    temperature: 0.6,
                                    topP: 0.8,
                                    // topK: 40 // å¿…è¦ã«å¿œã˜ã¦
                                }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                                return data.candidates[0].content.parts[0].text;
                            } else {
                                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒä¸æ­£ãªå ´åˆã‚‚ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
                                lastError = new Error(`Gemini API (${model}) ã‹ã‚‰äºˆæœŸã—ãªã„å½¢å¼ã®å¿œç­”ãŒã‚ã‚Šã¾ã—ãŸã€‚`);
                                continue; // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦è¡Œ
                            }
                        } else {
                             const errorData = await response.json().catch(() => ({ message: "Unknown API error" }));
                             lastError = new Error(`Gemini API error (${model}): ${response.status} - ${errorData.error?.message || response.statusText}`);
                             if (response.status === 429) { // Rate limit ã®å ´åˆã¯ã™ãã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                                 console.warn(`Gemini API (${model}) rate limit exceeded.`);
                                 break;
                             }
                             // ä»–ã®ã‚¨ãƒ©ãƒ¼ãªã‚‰æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™
                        }
                    } catch (error) {
                        lastError = error; // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©
                        console.error(`Error calling Gemini API (${model}):`, error);
                    }
                }
                // ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§å¤±æ•—ã—ãŸå ´åˆ
                console.warn("All Gemini models failed. Using fallback response.", lastError);
                return this.generateFallbackResponse(prompt, lastError ? lastError.message : "APIå‘¼ã³å‡ºã—ã«å¤±æ•—");
            }

            generateFallbackResponse(prompt, reason = "APIå‘¼ã³å‡ºã—ã«å¤±æ•—") {
                return `ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€æŠ€è¡“çš„ãªå•é¡Œã«ã‚ˆã‚ŠAIã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚(ç†ç”±: ${reason})\n` +
                        "æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚\n" +
                        "â€»ã“ã‚Œã¯ä»£æ›¿å¿œç­”ã§ã™ã€‚";
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                
                if (this.conversationHistory.length === 0) {
                    this.showError('è¦ç´„å¯¾è±¡ã®å¯¾è©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                let conversationLog = '';
                let humanInterventionsLog = ''; // äººé–“ä»‹å…¥ã®ã¿ã‚’æŠ½å‡º
                let learningInsightsLog = '';   // å­¦ç¿’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’æŠ½å‡º

                this.conversationHistory.forEach(entry => {
                    const formattedMessage = `${entry.provider.toUpperCase()}: ${entry.message}\n`;
                    conversationLog += formattedMessage;
                    if(entry.provider === 'human') {
                        humanInterventionsLog += `${entry.message}\n\n`;
                    }
                });
                
                this.elements.chatContainer.querySelectorAll('.learning-message div:not(.message-header)').forEach(el => {
                    learningInsightsLog += el.textContent.trim() + '\n\n';
                });


                let knowledgeBaseSummary = 'ä¸»ãªå­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ :\n';
                let count = 0;
                for (const item of this.knowledgeBase.values()) {
                    if (item.source !== 'system_init' && item.source !== 'dialogue_event' && count < 5) { // ä¸»è¦ãªã‚‚ã®ã‚’5ä»¶ç¨‹åº¦
                        knowledgeBaseSummary += `  - [${item.source}] ${item.topic}: ${item.content.substring(0, 80)}...\n`;
                        count++;
                    }
                }
                if (count === 0) knowledgeBaseSummary = "å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ ã¯ã¾ã å°‘ãªã„ã§ã™ã€‚\n";


                const summaryPrompt = `Crossthink v5.0 Advanced Interactive Edition ã§è¡Œã‚ã‚ŒãŸä»¥ä¸‹ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç·åˆçš„ã«åˆ†æã—ã€ãƒˆãƒ”ãƒƒã‚¯ã€Œ${topic}ã€ã«ã¤ã„ã¦åŒ…æ‹¬çš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦ã€‘
- å¯¾è©±ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}
- ç·AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.openaiCount + this.geminiCount} (ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount})
- äººé–“ä»‹å…¥å›æ•°: ${this.humanCount}
- è‡ªå‹•å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ æ•° (æŠœç²‹): ${Math.min(count, 5)} / ${this.knowledgeBase.size -1} (åˆæœŸåŒ–ãƒ‡ãƒ¼ã‚¿é™¤ã)

ã€v5.0 Advanced Interactive Edition ã®ç‰¹å¾´ã‚’è€ƒæ…®ã—ãŸåˆ†æè¦æ±‚ã€‘
1.  **AIè‡ªå¾‹å¯¾è©±ã®å“è³ªè©•ä¾¡**:
    * ChatGPTã¨GeminiãŒãã‚Œãã‚Œã©ã®ã‚ˆã†ãªè²¢çŒ®ã‚’ã—ãŸã‹ã€‚
    * AIé–“ã®è­°è«–ã¯å»ºè¨­çš„ã§ã€ãƒˆãƒ”ãƒƒã‚¯ã®æ¢æ±‚ã«æ·±ã¿ã‚’ã‚‚ãŸã‚‰ã—ãŸã‹ã€‚
2.  **äººé–“ä»‹å…¥ã®åŠ¹æœåˆ†æ**:
    * äººé–“ä»‹å…¥ã¯è­°è«–ã®æ–¹å‘æ€§ã‚„è³ªã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆãŸã‹ã€‚
    * AIã¨äººé–“ã®å”åƒã¯åŠ¹æœçš„ã ã£ãŸã‹ã€‚
3.  **è‡ªå‹•å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®æˆæœ**:
    * è‡ªå‹•å­¦ç¿’æ©Ÿèƒ½ã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ãªé‡è¦ãªæ´å¯ŸãŒæŠ½å‡ºã•ã‚ŒãŸã‹ï¼ˆä¸Šè¨˜ã€Œä¸»ãªå­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ ã€å‚ç…§ï¼‰ã€‚
    * ã“ã®å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã¯å¯¾è©±å†…å®¹ã®ä¾¡å€¤ã‚’æ‰ãˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€‚
4.  **ç·åˆçš„çµè«–ã¨æè¨€**:
    * ã“ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸæœ€ã‚‚é‡è¦ãªç™ºè¦‹ã‚„çµè«–ã¯ä½•ã‹ã€‚
    * Crossthink v5.0 ã®ã‚ˆã†ãªçµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆè‡ªå¾‹å¯¾è©±ãƒ»äººé–“ä»‹å…¥ãƒ»å­¦ç¿’ï¼‰ã®æ½œåœ¨çš„ãªä¾¡å€¤ã‚„æ”¹å–„ç‚¹ã¯ä½•ã‹ã€‚

ã€å¯¾è©±ãƒ­ã‚°å…¨æ–‡ã€‘
${conversationLog}
${humanInterventionsLog ? "\nã€ä¸»ãªäººé–“ä»‹å…¥å†…å®¹ã€‘\n" + humanInterventionsLog : ""}
${learningInsightsLog ? "\nã€å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®é€šçŸ¥ã€‘\n" + learningInsightsLog : ""}
${knowledgeBaseSummary}

ã€ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆæ¡ˆã€‘
1.  ã¯ã˜ã‚ã« (ãƒˆãƒ”ãƒƒã‚¯ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦)
2.  AIè‡ªå¾‹å¯¾è©±ã®åˆ†æ (å„AIã®è²¢çŒ®ã€ç›¸äº’ä½œç”¨)
3.  äººé–“ä»‹å…¥ã®å½±éŸ¿ã¨AI-äººé–“å”åƒã®è©•ä¾¡
4.  å­¦ç¿’æ©Ÿèƒ½ã«ã‚ˆã‚‹æ´å¯ŸæŠ½å‡ºã®è©•ä¾¡
5.  ç·åˆçš„çµè«–ã¨ä»Šå¾Œã®å±•æœ›/æè¨€

ãƒ¬ãƒãƒ¼ãƒˆã¯è©³ç´°ã‹ã¤å…·ä½“çš„ã§ã€4000ï½5000å­—ç¨‹åº¦ã‚’ç›®å®‰ã¨ã—ã¦ãã ã•ã„ã€‚Crossthink v5.0ã®å„æ©Ÿèƒ½ãŒã©ã®ã‚ˆã†ã«é€£æºã—ã€ã©ã®ã‚ˆã†ãªä¾¡å€¤ã‚’ç”Ÿã¿å‡ºã—ãŸã‹ã‚’æ˜ç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(summaryPrompt).then(() => {
                        this.addMessage('system', 
                            'ğŸ“‹ Crossthink v5.0 Advanced Interactive Edition è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n' +
                            'ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é«˜æ€§èƒ½ãªLLM (ä¾‹: GPT-4, Claude 3 Opus, Gemini Advancedãªã©) ã«å…¥åŠ›ã—ã¦ã€è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n' +
                            `ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—æ•°: ${summaryPrompt.length}æ–‡å­—`
                        );
                    }).catch(err => {
                        console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                        this.showPromptWindow(summaryPrompt); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    });
                } else {
                    this.showPromptWindow(summaryPrompt); // HTTPSã§ãªã„å ´åˆãªã©
                }
            }

            showPromptWindow(summaryPrompt) {
                const summaryWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
                if (summaryWindow) {
                    summaryWindow.document.write(`
                        <html>
                            <head>
                                <title>Crossthink v5.0 è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</title>
                                <style>
                                    body { font-family: system-ui, sans-serif; margin: 0; padding: 1em; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                                    .container { background-color: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 90%; max-width: 800px; }
                                    h2 { margin-top: 0; color: #333; }
                                    textarea { width: 100%; height: 60vh; margin-bottom: 1em; padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 0.9em; box-sizing: border-box; }
                                    button { padding: 0.8em 1.5em; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 0.5em; }
                                    .copy-btn { background-color: #4CAF50; color: white; }
                                    .close-btn { background-color: #f44336; color: white; }
                                    .stats { font-size: 0.9em; background-color: #e7f3fe; padding: 0.8em; border-radius: 4px; margin-bottom: 1em; border-left: 4px solid #2196F3;}
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>ğŸš€ Crossthink v5.0 è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2>
                                    <div class="stats">
                                      <strong>æƒ…å ±:</strong> ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é«˜æ€§èƒ½LLMã«è²¼ã‚Šä»˜ã‘ã¦ã€å¯¾è©±ã®åŒ…æ‹¬çš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚<br>
                                      æ–‡å­—æ•°: ${summaryPrompt.length}
                                    </div>
                                    <textarea id="promptArea" readonly>${summaryPrompt.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</textarea>
                                    <button class="copy-btn" onclick="document.getElementById('promptArea').select(); document.execCommand('copy'); alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                                    <button class="close-btn" onclick="window.close();">âŒ é–‰ã˜ã‚‹</button>
                                </div>
                            </body>
                        </html>
                    `);
                    summaryWindow.document.close(); // é‡è¦
                } else {
                    this.addMessage('system', 
                        'âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' +
                        'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚'
                    );
                    console.log("è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:\n", summaryPrompt);
                }
            }

            addMessage(provider, content, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${provider}-message`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit'});

                let providerName, emoji, roleDesc = '';
                switch (provider) {
                    case 'openai':
                        providerName = 'ChatGPT'; emoji = 'ğŸŸ¢'; roleDesc = ` (${this.targetMode})`;
                        this.currentSpeaker = 'openai'; // æœ€å¾Œã«ç™ºè¨€ã—ãŸAIã‚’è¨˜éŒ²
                        break;
                    case 'gemini':
                        providerName = 'Gemini'; emoji = 'ğŸ”·'; roleDesc = ` (${this.targetMode})`;
                        this.currentSpeaker = 'gemini'; // æœ€å¾Œã«ç™ºè¨€ã—ãŸAIã‚’è¨˜éŒ²
                        break;
                    case 'human':
                        providerName = 'ã‚ãªãŸ'; emoji = 'ğŸ‘¤';
                        break;
                    case 'learning':
                        providerName = 'å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ '; emoji = 'ğŸ§ ';
                        break;
                    case 'system': default:
                        providerName = 'Crossthink v5.0'; emoji = 'ğŸš€';
                        break;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${emoji} ${providerName}${roleDesc}
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>
                `;

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && (provider === 'openai' || provider === 'gemini' || provider === 'human')) {
                    this.messageCount++; // AIã¨äººé–“ã®å¿œç­”ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
                    // this.updateStats(); // sendMessage ã® finally ã§ã¾ã¨ã‚ã¦æ›´æ–°
                }
            }

            removeLastMessage() {
                const messages = this.elements.chatContainer.querySelectorAll('.message');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.conversationHistory = [];
                this.interventionPoints = [];
                if (this.startTime) this.startTime = null; // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                this.elements.elapsed.textContent = '0';

                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.pauseBtn.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢';
                this.elements.stopBtn.disabled = true;
                this.isPaused = false;
                this.isRunning = false;


                this.updateStats(); // çµ±è¨ˆè¡¨ç¤ºã‚’0ã«
                this.showWelcomeMessage();
                this.hideError();
                this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.elements.warningDisplay.style.display = 'none'; // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ™‚ã¯è­¦å‘Šã‚’éš ã™
            }

            hideError() {
                this.elements.errorDisplay.style.display = 'none';
            }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `âš ï¸ è­¦å‘Š: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
                 this.elements.errorDisplay.style.display = 'none'; // è­¦å‘Šè¡¨ç¤ºæ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’éš ã™
            }

            hideWarning() {
                this.elements.warningDisplay.style.display = 'none';
            }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
                this.elements.humanMessages.textContent = this.humanCount;
                this.elements.learningItems.textContent = this.knowledgeBase.size;
            }

            startTimer() {
                const updateTimerDisplay = () => {
                    if (this.isRunning && !this.isPaused && this.startTime) { // å®Ÿè¡Œä¸­ã§ä¸€æ™‚åœæ­¢ä¸­ã§ãªã„å ´åˆã®ã¿æ›´æ–°
                        const elapsedSeconds = Math.floor((Date.now() - this.startTime) / 1000);
                        this.elements.elapsed.textContent = elapsedSeconds;
                    }
                    if (this.isRunning) { // isRunningã®é–“ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’å‘¼ã³å‡ºã—ç¶šã‘ã‚‹
                        setTimeout(updateTimerDisplay, 1000);
                    }
                };
                if (this.isRunning) {
                    updateTimerDisplay();
                }
            }

            getTargetLabel() {
                const labels = { 'practical': 'ğŸ  å®Ÿç”¨çš„', 'business': 'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹', 'philosophical': 'ğŸ§  å“²å­¦çš„' };
                return labels[this.targetMode] || this.targetMode;
            }

            getGoalLabel() {
                const labels = { 'ideation': 'ğŸ’¡ æ¡ˆå‡ºã—', 'consensus': 'ğŸ¤ åˆæ„å½¢æˆ', 'exploration': 'ğŸ” æ¢ç´¢' };
                return labels[this.goalMode] || this.goalMode;
            }

            getInterventionLabel() {
                const labels = ['ãªã—', 'ç¨€', 'å°‘', 'ä¸­', 'å¤š', 'é »ç¹', 'éå¸¸ã«é »ç¹', 'å¸¸æ™‚', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ', 'ã‚·ãƒ³ã‚¯ãƒ­', 'ãƒ•ãƒ«ä»‹å…¥'];
                return labels[this.interventionFrequency] || 'ä¸­ç¨‹åº¦';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // event.target ãŒ button è¦ç´ ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ (button è¦ç´ ã« onclick ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚)
            const clickedButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.textContent.trim().includes(
                tabName === 'autonomous' ? 'AIè‡ªå¾‹å¯¾è©±' :
                tabName === 'intervention' ? 'äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰' :
                'å­¦ç¿’æ©Ÿèƒ½'
            ));

            if (clickedButton) {
                 clickedButton.classList.add('active');
            }
           
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (window.crossthinkSystem) {
                window.crossthinkSystem.currentTab = tabName;
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆä»‹å…¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ãªã©ï¼‰
        function continueAutonomously() {
            if (window.crossthinkSystem) {
                window.crossthinkSystem.waitingForIntervention = false;
                
                const interventionPrompts = document.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());
                
                // å¯¾è©±ã‚’å†é–‹ï¼ˆpauseDialogueãŒå†…éƒ¨ã§isPausedã‚’åè»¢ã•ã›ã‚‹ã®ã§ã€falseã‚’æ¸¡ã—ã¦å†é–‹ã•ã›ã‚‹ï¼‰
                window.crossthinkSystem.pauseDialogue(true); // ã‚·ã‚¹ãƒ†ãƒ ãŒä»‹å…¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰å†é–‹ã—ãŸã“ã¨ã‚’ç¤ºã™
            }
        }

        function switchToInterventionTab() {
            // `event.target` ã‚’ä½¿ã‚ãšã«ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ç‰¹å®šã—ã¦ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹ã‹ã€ç›´æ¥ `switchTab` ã‚’å‘¼ã¶
            const interventionButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.textContent.trim().includes('äººé–“ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰'));
            if (interventionButton) {
                 interventionButton.click(); // ã“ã‚Œã§ switchTab('intervention') ãŒå‘¼ã°ã‚Œã‚‹
            } else {
                 switchTab('intervention'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
            
            if (window.crossthinkSystem) {
                window.crossthinkSystem.addMessage('system', 'ğŸ‘¤ äººé–“ä»‹å…¥ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸã€‚ä»‹å…¥å†…å®¹ã‚’å…¥åŠ›ã—ã€ã€Œå¯¾è©±ã«ä»‹å…¥ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                window.crossthinkSystem.elements.humanInput.focus();
            }
        }

        // HTMLã®onclickå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ç¾¤
        function humanIntervention() { if (window.crossthinkSystem) window.crossthinkSystem.humanIntervention(); }
        function requestDeepening() { if (window.crossthinkSystem) window.crossthinkSystem.requestDeepening(); }
        function redirectDialogue() { if (window.crossthinkSystem) window.crossthinkSystem.redirectDialogue(); }
        function saveInsight() { if (window.crossthinkSystem) window.crossthinkSystem.saveInsight(); }
        function quickIntervention(type) { if (window.crossthinkSystem) window.crossthinkSystem.quickIntervention(type); }
        function exportKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.exportKnowledge(); }
        function importKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.importKnowledge(); }
        function clearKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.clearKnowledge(); }
        function showLearningStats() { if (window.crossthinkSystem) window.crossthinkSystem.showLearningStats(); }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.crossthinkSystem = new CrossthinkAdvanced();
                console.log('Crossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v5.0 Advanced Interactive Edition åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã‹ã€é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('error', (event) => {
            console.error('æœªå‡¦ç†ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error, 'Message:', event.message, 'File:', event.filename, 'Line:', event.lineno);
            if (window.crossthinkSystem && window.crossthinkSystem.showError) {
                window.crossthinkSystem.showError(`äºˆæœŸã›ã¬ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${event.message}`);
            } else {
                // alert(`äºˆæœŸã›ã¬ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n${event.message}`);
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
            if (window.crossthinkSystem && window.crossthinkSystem.showWarning) {
                let message = 'éåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (event.reason && event.reason.message) {
                    message += ` ${event.reason.message}`;
                } else if (typeof event.reason === 'string') {
                    message += ` ${event.reason}`;
                }
                window.crossthinkSystem.showWarning(message);
            } else {
                // alert('éåŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });
    </script>
</body>
</html>