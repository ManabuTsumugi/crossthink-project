<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v4.0 - AIå¯¾è©±ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-selection {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .quick-access {
            margin-bottom: 30px;
        }

        .quick-access h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .mode-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .mode-selector h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .mode-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .mode-slider {
            flex: 1;
            margin: 0 20px;
            position: relative;
        }

        .slider-track {
            height: 8px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            border-radius: 4px;
            position: relative;
        }

        .slider-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            position: absolute;
            top: -6px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .slider-thumb:hover {
            transform: scale(1.2);
        }

        .mode-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .selected-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }

        .optimization-notice {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 15px;
            margin: 20px 30px;
            border-radius: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .optimization-notice h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .expected-length {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #4caf50;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "ğŸŸ¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "ğŸ”·";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .topic-suggestions {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .topic-suggestions h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .topic-suggestions ul {
            list-style: none;
            padding: 0;
        }

        .topic-suggestions li {
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .topic-suggestions li:hover {
            color: #4facfe;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .consensus-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "ğŸ’°";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-row {
                flex-direction: column;
                gap: 10px;
            }

            .mode-slider {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p>AIå”åƒã«ã‚ˆã‚‹æ€è€ƒã®æ˜Ÿåº§ - æœ€é©åŒ–ã•ã‚ŒãŸå¯¾è©±ä½“é¨“</p>
            <div class="demo-label">
                ğŸš€ v4.0 - åŠ¹ç‡åŒ–é‡è¦–ç‰ˆ
            </div>
        </div>

        <div class="optimization-notice">
            <h3>âš¡ v4.0 æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
            <ul>
                <li><strong>åˆæ„å½¢æˆåŠ¹ç‡åŒ–:</strong> 6ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ 2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§çµè«–</li>
                <li><strong>ãƒ†ãƒ¼ãƒé©åˆæ€§ãƒã‚§ãƒƒã‚¯:</strong> AIã®çŸ¥è­˜ç¯„å›²ã¨ä¸€è‡´ã™ã‚‹ã‹äº‹å‰åˆ¤å®š</li>
                <li><strong>æ˜ç¢ºãªçµ‚äº†æ¡ä»¶:</strong> æŠ½è±¡è«–ã‚’é¿ã‘ã€å…·ä½“çš„çµè«–ã¸èª˜å°</li>
                <li><strong>æƒ…å ±ä¸è¶³æ¤œå‡º:</strong> æ—©æœŸã«æƒ…å ±ä¸è¶³ã‚’æŒ‡æ‘˜ã—ã€æ–¹å‘è»¢æ›</li>
            </ul>
            <div class="expected-length" id="expectedLength">
                ğŸ¯ äºˆæƒ³å¯¾è©±é•·: ãƒ†ãƒ¼ãƒé¸æŠå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
        </div>

        <div class="mode-selection">
            <div class="quick-access">
                <h3>ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæœ€é©åŒ–æ¸ˆã¿ãƒ†ãƒ¼ãƒï¼‰</h3>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="startQuickDialogue('ä»Šæ—¥ã®æ™©å¾¡é£¯')">
                        ğŸ½ï¸ ä»Šæ—¥ã®æ™©å¾¡é£¯
                        <br><small>å®Ÿç”¨çš„ãƒ»åˆæ„å½¢æˆ (2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('å‰¯æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢')">
                        ğŸ’¼ å‰¯æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢
                        <br><small>ãƒ“ã‚¸ãƒã‚¹ãƒ»æ¡ˆå‡ºã— (3-4ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('é€±æœ«ã®éã”ã—æ–¹')">
                        ğŸŒ… é€±æœ«ã®éã”ã—æ–¹
                        <br><small>å®Ÿç”¨çš„ãƒ»åˆæ„å½¢æˆ (2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('AIæ™‚ä»£ã®åƒãæ–¹')">
                        ğŸ¤” AIæ™‚ä»£ã®åƒãæ–¹
                        <br><small>å“²å­¦çš„ãƒ»æ¢ç´¢ (4-5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)</small>
                    </button>
                </div>
            </div>

            <div class="mode-selector">
                <h3>ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ å¯¾è©±è¨­å®š</h3>
                
                <div class="mode-row">
                    <span><strong>ã©ã‚“ãªå¯¾è©±ï¼Ÿ</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="targetSlider" style="left: 33%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>ğŸ  å®Ÿç”¨çš„</span>
                            <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹</span>
                            <span>ğŸ§  å“²å­¦çš„</span>
                        </div>
                    </div>
                </div>

                <div class="mode-row">
                    <span><strong>ä½•ãŒç›®æ¨™ï¼Ÿ</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="goalSlider" style="left: 50%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>ğŸ’¡ æ¡ˆå‡ºã—</span>
                            <span>ğŸ¤ åˆæ„å½¢æˆ</span>
                            <span>ğŸ” æ¢ç´¢</span>
                        </div>
                    </div>
                </div>

                <div class="selected-mode" id="selectedMode">
                    ğŸ¯ é¸æŠä¸­: å®Ÿç”¨çš„ Ã— åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>ğŸ”§ APIè¨­å®š</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>ğŸ“ å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯:</h2>
            
            <div class="topic-suggestions" id="topicSuggestions">
                <h4>ğŸ’¡ æ¨å¥¨ãƒ†ãƒ¼ãƒï¼ˆAIãŒè©³ã—ã„åˆ†é‡ï¼‰:</h4>
                <ul id="suggestedTopics">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </ul>
            </div>

            <input type="text" id="topicInput" class="topic-input" 
                   placeholder="è‡ªç”±ã«ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                   value="">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">ğŸš€ å¯¾è©±é–‹å§‹</button>
                <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢</button>
                <button id="clearBtn" class="btn btn-secondary">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button id="exportBtn" class="btn btn-secondary">ğŸ“ è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>ğŸ“Š å¯¾è©±çµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTç™ºè¨€</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">Geminiç™ºè¨€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">çµŒéæ™‚é–“(ç§’)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>ğŸŒŸ v4.0 åŠ¹ç‡åŒ–ã®ç‰¹å¾´:</h3>
            <ul>
                <li>å¯¾è©±é•·æœ€é©åŒ–: ç„¡é§„ãªå¾€å¾©ã‚’å‰Šæ¸›ã€å®Ÿè³ªçš„çµè«–ã‚’ä¿ƒé€²</li>
                <li>ãƒ†ãƒ¼ãƒé©åˆæ€§åˆ¤å®š: AIã®å¾—æ„åˆ†é‡ã¨ã®ãƒãƒƒãƒãƒ³ã‚°å‘ä¸Š</li>
                <li>æ—©æœŸçµ‚äº†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : æƒ…å ±ä¸è¶³ã‚„æŠ½è±¡è«–ã®æ—©æœŸç™ºè¦‹</li>
                <li>å…·ä½“æ€§å¼·åˆ¶ãƒ¢ãƒ¼ãƒ‰: ä¸€èˆ¬è«–å›é¿ã€è¡Œå‹•å¯èƒ½ãªææ¡ˆé‡è¦–</li>
                <li>ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š: æœŸå¾…å€¤ç®¡ç†ã¨æ˜ç¢ºãªã‚´ãƒ¼ãƒ«è¨­å®š</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- å¯¾è©±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        class CrossthinkOptimized {
            constructor() {
                this.isRunning = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8; // å¤§å¹…çŸ­ç¸®
                this.consensusTargets = [3, 5]; // åˆæ„å½¢æˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
                this.earlyTerminationChecks = [2, 4]; // æ—©æœŸçµ‚äº†åˆ¤å®š
                
                // ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                this.targetMode = 'practical';
                this.goalMode = 'consensus';
                
                // ãƒ†ãƒ¼ãƒé©åˆæ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                this.topicDatabase = {
                    practical: {
                        consensus: [
                            { topic: "ä»Šæ—¥ã®æ™©å¾¡é£¯ã‚’æ±ºã‚ã‚‹ï¼ˆå†·è”µåº«ã®æ®‹ã‚Šç‰©æ´»ç”¨ï¼‰", expected: 2 },
                            { topic: "ä»Šé€±æœ«ã®äºˆå®šã‚’æ±ºã‚ã‚‹ï¼ˆäºˆç®—2ä¸‡å††ä»¥å†…ï¼‰", expected: 3 },
                            { topic: "éƒ¨å±‹ã®æ¨¡æ§˜æ›¿ãˆãƒ—ãƒ©ãƒ³ï¼ˆ6ç•³ãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ ï¼‰", expected: 3 },
                            { topic: "å¥åº·çš„ãªæœã®ç¿’æ…£ã‚’æ±ºã‚ã‚‹ï¼ˆå¹³æ—¥30åˆ†ä»¥å†…ï¼‰", expected: 2 }
                        ],
                        ideation: [
                            { topic: "ç¯€ç´„ã§ãã‚‹å®¶äº‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯", expected: 3 },
                            { topic: "åœ¨å®…å‹¤å‹™ã®ç’°å¢ƒæ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢", expected: 4 },
                            { topic: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆé¸ã³ã®ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªæ–¹æ³•", expected: 3 }
                        ],
                        exploration: [
                            { topic: "ãƒ©ã‚¤ãƒ•ãƒ¯ãƒ¼ã‚¯ãƒãƒ©ãƒ³ã‚¹ã®æœ¬è³ªçš„ãªèª²é¡Œ", expected: 4 },
                            { topic: "æŒç¶šå¯èƒ½ãªãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«è¨­è¨ˆ", expected: 5 }
                        ]
                    },
                    business: {
                        consensus: [
                            { topic: "ä¸­å°ä¼æ¥­ã®DXæ¨é€²æˆ¦ç•¥ï¼ˆè£½é€ æ¥­ï¼‰", expected: 4 },
                            { topic: "ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ ã®ç”Ÿç”£æ€§å‘ä¸Š", expected: 3 },
                            { topic: "æ–°è¦äº‹æ¥­ã®å¸‚å ´å‚å…¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¤æ–­", expected: 4 }
                        ],
                        ideation: [
                            { topic: "å‰¯æ¥­ã¨ã—ã¦ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢", expected: 4 },
                            { topic: "åœ°æ–¹å‰µç”ŸÃ—ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®å¯èƒ½æ€§", expected: 5 },
                            { topic: "ã‚µã‚¹ãƒ†ãƒŠãƒ–ãƒ«çµŒå–¶ã®é©æ–°çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ", expected: 4 }
                        ],
                        exploration: [
                            { topic: "AIæ™‚ä»£ã®ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«å¤‰é©", expected: 5 },
                            { topic: "åƒãæ–¹ã®æœªæ¥ã¨çµ„ç¹”ã®é€²åŒ–", expected: 5 }
                        ]
                    },
                    philosophical: {
                        consensus: [
                            { topic: "AIæ™‚ä»£ã«ãŠã‘ã‚‹äººé–“ã®ä¾¡å€¤ã¨ã¯", expected: 4 },
                            { topic: "å¹¸ç¦ã®å®šç¾©ã¨æ¸¬å®šæ–¹æ³•", expected: 4 }
                        ],
                        ideation: [
                            { topic: "æ•™è‚²ã®æœ¬è³ªçš„ãªç›®çš„ã®å†å®šç¾©", expected: 5 },
                            { topic: "ãƒ‡ã‚¸ã‚¿ãƒ«ç¤¾ä¼šã®å€«ç†çš„èª²é¡Œ", expected: 5 }
                        ],
                        exploration: [
                            { topic: "æ„è­˜ã¨ã¯ä½•ã‹ - å“²å­¦ã¨ç§‘å­¦ã®å¢ƒç•Œ", expected: 6 },
                            { topic: "æ­»ç”Ÿè¦³ã¨ç¾ä»£ç¤¾ä¼šã®é–¢ä¿‚æ€§", expected: 5 },
                            { topic: "ç¾ã¨ã¯ä½•ã‹ - ä¸»è¦³æ€§ã¨æ™®éæ€§", expected: 6 }
                        ]
                    }
                };
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeModeSliders();
                this.updateTopicSuggestions();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    elapsed: document.getElementById('elapsed'),
                    selectedMode: document.getElementById('selectedMode'),
                    targetSlider: document.getElementById('targetSlider'),
                    goalSlider: document.getElementById('goalSlider'),
                    expectedLength: document.getElementById('expectedLength'),
                    suggestedTopics: document.getElementById('suggestedTopics')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                this.elements.topicInput.addEventListener('input', () => this.updateExpectedLength());
            }

            updateTopicSuggestions() {
                const topics = this.topicDatabase[this.targetMode]?.[this.goalMode] || [];
                this.elements.suggestedTopics.innerHTML = '';
                
                topics.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.topic} (${item.expected}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äºˆæƒ³)`;
                    li.onclick = () => {
                        this.elements.topicInput.value = item.topic;
                        this.updateExpectedLength();
                    };
                    this.elements.suggestedTopics.appendChild(li);
                });
            }

            updateExpectedLength() {
                const topic = this.elements.topicInput.value.trim();
                const expectedMessages = this.estimateMessageCount(topic);
                
                let warning = '';
                if (expectedMessages > 5) {
                    warning = ' âš ï¸ é•·æœŸåŒ–ã®å¯èƒ½æ€§ã‚ã‚Š';
                } else if (expectedMessages <= 2) {
                    warning = ' âœ… åŠ¹ç‡çš„ãªå¯¾è©±ã‚’æœŸå¾…';
                }
                
                this.elements.expectedLength.innerHTML = 
                    `ğŸ¯ äºˆæƒ³å¯¾è©±é•·: ${expectedMessages}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸${warning}`;
            }

            estimateMessageCount(topic) {
                // ç°¡æ˜“çš„ãªæ¨å®šãƒ­ã‚¸ãƒƒã‚¯
                const topics = this.topicDatabase[this.targetMode]?.[this.goalMode] || [];
                
                // å®Œå…¨ä¸€è‡´ãƒã‚§ãƒƒã‚¯
                const exactMatch = topics.find(item => 
                    item.topic.toLowerCase().includes(topic.toLowerCase()) ||
                    topic.toLowerCase().includes(item.topic.toLowerCase())
                );
                
                if (exactMatch) return exactMatch.expected;
                
                // ãƒ¢ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®æ¨å®š
                const baseCounts = {
                    'practical-consensus': 2,
                    'practical-ideation': 3,
                    'practical-exploration': 4,
                    'business-consensus': 3,
                    'business-ideation': 4,
                    'business-exploration': 5,
                    'philosophical-consensus': 4,
                    'philosophical-ideation': 5,
                    'philosophical-exploration': 6
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                let baseCount = baseCounts[key] || 4;
                
                // ç‰¹å®šä¼æ¥­/è£½å“åãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰è­¦å‘Š
                const specificTerms = ['æ ªå¼ä¼šç¤¾', 'ä¼šç¤¾', 'è£½å“', 'è£…ç½®', 'æ©Ÿå™¨', 'ã‚·ã‚¹ãƒ†ãƒ '];
                const hasSpecificTerms = specificTerms.some(term => topic.includes(term));
                
                if (hasSpecificTerms) {
                    baseCount += 2; // æƒ…å ±ä¸è¶³ã§é•·æœŸåŒ–ã®å¯èƒ½æ€§
                }
                
                return Math.min(baseCount, 6); // æœ€å¤§6ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            }

            initializeModeSliders() {
                this.initializeSlider('targetSlider', (value) => {
                    if (value < 33) this.targetMode = 'practical';
                    else if (value < 66) this.targetMode = 'business';
                    else this.targetMode = 'philosophical';
                    this.updateSelectedMode();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                });

                this.initializeSlider('goalSlider', (value) => {
                    if (value < 33) this.goalMode = 'ideation';
                    else if (value < 66) this.goalMode = 'consensus';
                    else this.goalMode = 'exploration';
                    this.updateSelectedMode();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                });

                this.updateSelectedMode();
            }

            initializeSlider(sliderId, callback) {
                const slider = this.elements[sliderId];
                const track = slider.parentElement;
                let isDragging = false;

                slider.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const rect = track.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                    
                    slider.style.left = percentage + '%';
                    callback(percentage);
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            updateSelectedMode() {
                const targetLabels = {
                    'practical': 'ğŸ  å®Ÿç”¨çš„',
                    'business': 'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹',
                    'philosophical': 'ğŸ§  å“²å­¦çš„'
                };

                const goalLabels = {
                    'ideation': 'ğŸ’¡ æ¡ˆå‡ºã—',
                    'consensus': 'ğŸ¤ åˆæ„å½¢æˆ',
                    'exploration': 'ğŸ” æ¢ç´¢'
                };

                this.elements.selectedMode.textContent = 
                    `ğŸ¯ é¸æŠä¸­: ${targetLabels[this.targetMode]} Ã— ${goalLabels[this.goalMode]}ãƒ¢ãƒ¼ãƒ‰`;
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v4.0 ã¸ã‚ˆã†ã“ãï¼\n\n' +
                    'âš¡ v4.0 åŠ¹ç‡åŒ–ã®ç‰¹å¾´:\n' +
                    'â€¢ ğŸƒâ€â™‚ï¸ åˆæ„å½¢æˆ: 6ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ 2-3ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çŸ­ç¸®\n' +
                    'â€¢ ğŸ¯ ãƒ†ãƒ¼ãƒãƒãƒƒãƒãƒ³ã‚°: AIã®å¾—æ„åˆ†é‡ã‚’äº‹å‰åˆ¤å®š\n' +
                    'â€¢ ğŸš¨ æ—©æœŸè­¦å‘Š: æƒ…å ±ä¸è¶³ã‚„æŠ½è±¡è«–ã‚’å³åº§ã«æ¤œå‡º\n' +
                    'â€¢ âœ… å…·ä½“æ€§é‡è¦–: è¡Œå‹•å¯èƒ½ãªçµè«–ã‚’å¼·åˆ¶èª˜å°\n\n' +
                    'ğŸ’¡ ä½¿ã„æ–¹:\n' +
                    '1. æ¨å¥¨ãƒ†ãƒ¼ãƒã‹ã‚‰é¸æŠï¼ˆæœ€é©åŒ–æ¸ˆã¿ï¼‰\n' +
                    '2. äºˆæƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’ç¢ºèª\n' +
                    '3. API ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦å³é–‹å§‹\n\n' +
                    'ğŸ¯ åŠ¹ç‡åŒ–ã®ãƒ¡ãƒªãƒƒãƒˆ:\n' +
                    'ğŸ“ˆ é–‹ç™ºã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼ˆçŸ­æ™‚é–“ã§çµè«–ï¼‰\n' +
                    'ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦å‘ä¸Šï¼ˆæ˜ç¢ºãªæˆæœï¼‰\n' +
                    'ğŸ’¡ å®Ÿç”¨æ€§é‡è¦–ï¼ˆè¡Œå‹•ã«ã¤ãªãŒã‚‹ææ¡ˆï¼‰\n' +
                    'ğŸ”¬ å“è³ªä¿è¨¼ï¼ˆæœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰'
                );
            }

            startQuickDialogue(template) {
                const quickModes = {
                    'ä»Šæ—¥ã®æ™©å¾¡é£¯': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: 'ä»Šæ—¥ã®æ™©å¾¡é£¯ã‚’æ±ºã‚ã‚‹ï¼ˆå†·è”µåº«ã®æ®‹ã‚Šç‰©æ´»ç”¨ã€äºˆç®—1000å††ä»¥å†…ï¼‰'
                    },
                    'å‰¯æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢': {
                        target: 'business',
                        goal: 'ideation',
                        topic: 'å‰¯æ¥­ã¨ã—ã¦ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äº‹æ¥­ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆåˆæœŸæŠ•è³‡10ä¸‡å††ä»¥å†…ï¼‰'
                    },
                    'é€±æœ«ã®éã”ã—æ–¹': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: 'ä»Šé€±æœ«ã®éã”ã—æ–¹ã‚’æ±ºã‚ã‚‹ï¼ˆäºˆç®—2ä¸‡å††ä»¥å†…ã€éƒ½å†…ï¼‰'
                    },
                    'AIæ™‚ä»£ã®åƒãæ–¹': {
                        target: 'philosophical',
                        goal: 'exploration',
                        topic: 'AIæ™‚ä»£ã«ãŠã‘ã‚‹äººé–“ã®åƒãæ–¹ã¨ä¾¡å€¤å‰µé€ '
                    }
                };

                const mode = quickModes[template];
                if (mode) {
                    this.targetMode = mode.target;
                    this.goalMode = mode.goal;
                    this.elements.topicInput.value = mode.topic;
                    this.updateSelectedMode();
                    this.updateSliderPositions();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                    
                    this.addMessage('system', 
                        `ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: "${template}"\n` +
                        `ğŸ¯ ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                        `ğŸ“ æœ€é©åŒ–æ¸ˆã¿ãƒˆãƒ”ãƒƒã‚¯è¨­å®šå®Œäº†\n` +
                        `â±ï¸ äºˆæƒ³å¯¾è©±æ™‚é–“: ${this.estimateMessageCount(mode.topic) * 45}ç§’`
                    );
                }
            }

            updateSliderPositions() {
                const targetPositions = { 'practical': 16, 'business': 50, 'philosophical': 83 };
                const goalPositions = { 'ideation': 16, 'consensus': 50, 'exploration': 83 };
                
                this.elements.targetSlider.style.left = targetPositions[this.targetMode] + '%';
                this.elements.goalSlider.style.left = goalPositions[this.goalMode] + '%';
            }

            getTargetLabel() {
                const labels = {
                    'practical': 'ğŸ  å®Ÿç”¨çš„',
                    'business': 'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹',
                    'philosophical': 'ğŸ§  å“²å­¦çš„'
                };
                return labels[this.targetMode];
            }

            getGoalLabel() {
                const labels = {
                    'ideation': 'ğŸ’¡ æ¡ˆå‡ºã—',
                    'consensus': 'ğŸ¤ åˆæ„å½¢æˆ',
                    'exploration': 'ğŸ” æ¢ç´¢'
                };
                return labels[this.goalMode];
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                
                this.elements.startBtn.disabled = true;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                const expectedMessages = this.estimateMessageCount(topic);
                
                this.addMessage('system', 
                    `ğŸ¯ åŠ¹ç‡åŒ–å¯¾è©±é–‹å§‹\n` +
                    `ğŸ“ ãƒˆãƒ”ãƒƒã‚¯: "${topic}"\n` +
                    `ğŸª ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                    `â±ï¸ äºˆæƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${expectedMessages}\n` +
                    `ğŸš€ æœ€é©åŒ–AIãŒåŠ¹ç‡çš„ã«çµè«–ã‚’å°ãã¾ã™ï¼`
                );

                this.startTimer();

                // æœ€é©åŒ–ã•ã‚ŒãŸåˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                const initialPrompt = this.generateOptimizedPrompt(topic, 1);
                await this.sendMessage('openai', initialPrompt);
            }

            generateOptimizedPrompt(topic, messageNumber) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                
                // åŠ¹ç‡åŒ–æŒ‡ç¤ºã‚’è¿½åŠ 
                let optimizationInstructions = '';
                
                if (this.goalMode === 'consensus' && messageNumber === 1) {
                    optimizationInstructions = `\n\nğŸ¯ **åŠ¹ç‡åŒ–æŒ‡ç¤ºï¼ˆv4.0ï¼‰**:\n` +
                        `â€¢ æŠ½è±¡è«–ã¯é¿ã‘ã€å…·ä½“çš„ãªææ¡ˆã«é›†ä¸­\n` +
                        `â€¢ æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ç‡ç›´ã«æŒ‡æ‘˜\n` +
                        `â€¢ æ¬¡å›ã§åˆæ„å½¢æˆã‚’ç›®æŒ‡ã™ã‚ˆã†æ„è­˜\n` +
                        `â€¢ è¡Œå‹•å¯èƒ½ãªé¸æŠè‚¢ã‚’3ã¤ä»¥å†…ã§æç¤º`;
                } else if (messageNumber === 2 && this.goalMode === 'consensus') {
                    optimizationInstructions = `\n\nğŸ¯ **åˆæ„å½¢æˆãƒ•ã‚§ãƒ¼ã‚º**:\n` +
                        `â€¢ å‰å›ã®ææ¡ˆã‚’è¸ã¾ãˆã€æœ€é©è§£ã‚’1ã¤é¸æŠ\n` +
                        `â€¢ å…·ä½“çš„ãªå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’æç¤º\n` +
                        `â€¢ ã€Œçµè«–: â—‹â—‹ã‚’æ¨å¥¨ã€ã®å½¢ã§æ˜ç¢ºã«å›ç­”`;
                } else if (this.earlyTerminationChecks.includes(messageNumber)) {
                    optimizationInstructions = `\n\nâš¡ **æ—©æœŸçµ‚äº†åˆ¤å®š**:\n` +
                        `â€¢ ååˆ†ãªæƒ…å ±ãŒã‚ã‚Œã°çµè«–ã‚’å‡ºã™\n` +
                        `â€¢ æƒ…å ±ä¸è¶³ãªã‚‰ã€Œã•ã‚‰ãªã‚‹æƒ…å ±ãŒå¿…è¦ã€ã¨æ˜è¨˜\n` +
                        `â€¢ æŠ½è±¡çš„ãªè­°è«–ã®ç¹°ã‚Šè¿”ã—ã¯é¿ã‘ã‚‹`;
                }

                return basePrompt + optimizationInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `å®Ÿç”¨çš„ãªè§£æ±ºç­–ã‚’3ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€å…·ä½“çš„ã§å®Ÿè¡Œã—ã‚„ã™ã„é¸æŠè‚¢ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
                    'practical-consensus': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€æœ€ã‚‚ç¾å®Ÿçš„ã§å®Ÿè¡Œå¯èƒ½ãªè§£æ±ºç­–ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ã€‚åˆ¶ç´„æ¡ä»¶ã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚`,
                    'practical-exploration': `ã€Œ${topic}ã€ã®å®Ÿç”¨çš„ãªå´é¢ã«ã¤ã„ã¦ã€éš ã‚ŒãŸèª²é¡Œã‚„æ©Ÿä¼šã‚‚å«ã‚ã¦æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`,
                    
                    'business-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã‚’ç”Ÿã‚€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’3-4ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚`,
                    'business-consensus': `ã€Œ${topic}ã€ã«é–¢ã—ã¦ã€ROIã¨å®Ÿç¾å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸæœ€é©ãªæˆ¦ç•¥ã‚’æ±ºå®šã—ã¾ã—ã‚‡ã†ã€‚`,
                    'business-exploration': `ã€Œ${topic}ã€ã®ãƒ“ã‚¸ãƒã‚¹çš„å¯èƒ½æ€§ã«ã¤ã„ã¦ã€å¸‚å ´å‹•å‘ã‚‚å«ã‚ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚`,
                    
                    'philosophical-ideation': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€æ–°ã—ã„æ€è€ƒã®æ çµ„ã¿ã‚„æ ¹æœ¬çš„ãªå•ã„ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚`,
                    'philosophical-consensus': `ã€Œ${topic}ã€ã®æœ¬è³ªã«ã¤ã„ã¦ã€è«–ç†çš„æ¤œè¨ã‚’é€šã˜ã¦æ·±ã„ç†è§£ã«åˆ°é”ã—ã¾ã—ã‚‡ã†ã€‚`,
                    'philosophical-exploration': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€æ—¢å­˜ã®å‰æã‚’ç–‘ã„ã€æ ¹æºçš„ãªæ¢ç©¶ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚`
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `ã€Œ${topic}ã€ã«ã¤ã„ã¦åŠ¹ç‡çš„ã«è­°è«–ã—ã¾ã—ã‚‡ã†ã€‚`;
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) {
                    this.showError('OpenAI API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                if (!geminiKey) {
                    this.showError('Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                if (!topic) {
                    this.showError('å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return false;
                }

                // ç‰¹å®šä¼æ¥­/è£½å“ã®è­¦å‘Š
                const specificTerms = ['æ ªå¼ä¼šç¤¾', 'ä¼šç¤¾', 'è£½å“', 'è£…ç½®', 'æ©Ÿå™¨'];
                const hasSpecificTerms = specificTerms.some(term => topic.includes(term));
                
                if (hasSpecificTerms) {
                    this.showWarning('ç‰¹å®šä¼æ¥­ãƒ»è£½å“ã®ãƒ†ãƒ¼ãƒã¯æƒ…å ±ä¸è¶³ã«ã‚ˆã‚Šé•·æœŸåŒ–ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                }

                return true;
            }

            async sendMessage(provider, prompt) {
                if (!this.isRunning) return;

                try {
                    this.addMessage(provider, 'æ€è€ƒä¸­...', true);
                    
                    let response;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        this.openaiCount++;
                    } else {
                        response = await this.callGemini(prompt);
                        this.geminiCount++;
                    }

                    this.removeLastMessage();
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response });
                    this.updateStats();

                    // æ—©æœŸçµ‚äº†ãƒã‚§ãƒƒã‚¯
                    if (this.shouldTerminateEarly(response)) {
                        this.addMessage('system', 'âœ… åŠ¹ç‡åŒ–æˆåŠŸï¼å…·ä½“çš„ãªçµè«–ã«åˆ°é”ã—ã¾ã—ãŸã€‚');
                        this.stopDialogue();
                        return;
                    }

                    // åˆæ„å½¢æˆãƒã‚§ãƒƒã‚¯
                    if (this.goalMode === 'consensus' && this.consensusTargets.includes(this.messageCount)) {
                        if (this.hasReachedConsensus(response)) {
                            this.addMessage('system', 'ğŸ¤ åˆæ„å½¢æˆå®Œäº†ï¼æœ€é©åŒ–ã•ã‚ŒãŸçµè«–ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚');
                            this.stopDialogue();
                            return;
                        }
                    }

                    // æƒ…å ±ä¸è¶³è­¦å‘Š
                    if (this.detectInformationLack(response) && this.messageCount >= 2) {
                        this.addMessage('system', 
                            'âš ï¸ æƒ…å ±ä¸è¶³æ¤œå‡º: æŠ½è±¡çš„ãªè­°è«–ãŒç¶šã„ã¦ã„ã¾ã™ã€‚\n' +
                            'å…·ä½“çš„ãªæƒ…å ±æä¾›ã¾ãŸã¯ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’æ¨å¥¨ã—ã¾ã™ã€‚'
                        );
                    }

                    // æ¬¡ã®AIã«å¿œç­”ã•ã›ã‚‹
                    if (this.isRunning && this.messageCount < this.maxMessages) {
                        setTimeout(() => {
                            const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                            const nextPrompt = this.generateNextOptimizedPrompt(nextProvider, response);
                            this.sendMessage(nextProvider, nextPrompt);
                        }, 2000); // çŸ­ç¸®
                    } else if (this.messageCount >= this.maxMessages) {
                        this.addMessage('system', 'â° å¯¾è©±æ™‚é–“çµ‚äº†ã€‚åŠ¹ç‡åŒ–ã«ã‚ˆã‚ŠçŸ­æ™‚é–“ã§å¤šãã®æ´å¯ŸãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage();
                    this.showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                    console.error('API Error:', error);
                }
            }

            shouldTerminateEarly(response) {
                // æ˜ç¢ºãªçµè«–ã®æ¤œå‡º
                const conclusionKeywords = [
                    'çµè«–:', 'æ¨å¥¨:', 'æœ€çµ‚çš„ã«', 'æ±ºå®š:', 'ç­”ãˆ:', 
                    'ãŠã™ã™ã‚ã¯', 'æœ€é©è§£ã¯', 'é¸æŠã™ã¹ãã¯'
                ];
                
                return conclusionKeywords.some(keyword => 
                    response.includes(keyword)
                );
            }

            hasReachedConsensus(response) {
                // åˆæ„ã«é”ã—ãŸã‹ã®åˆ¤å®š
                const consensusKeywords = [
                    'åˆæ„', 'ä¸€è‡´', 'æ±ºå®š', 'çµè«–', 'æœ€çµ‚çš„',
                    'æ¨å¥¨', 'æœ€é©', 'é¸æŠã™ã¹ã', 'ãƒ™ã‚¹ãƒˆ'
                ];
                
                const wordCount = response.split('').length;
                const hasKeywords = consensusKeywords.some(keyword => 
                    response.includes(keyword)
                );
                
                return hasKeywords && wordCount > 100; // ä¸€å®šã®è©³ç´°åº¦ã‚‚è¦æ±‚
            }

            detectInformationLack(response) {
                // æƒ…å ±ä¸è¶³ã®æ¤œå‡º
                const lackKeywords = [
                    'ä¸€èˆ¬çš„ã«', 'é€šå¸¸', 'ä¸€èˆ¬è«–ã¨ã—ã¦', 'æŠ½è±¡çš„',
                    'è©³ç´°ãªæƒ…å ±ãŒå¿…è¦', 'å…·ä½“çš„ãª', 'ã‚ˆã‚Šè©³ã—ã„',
                    'ã•ã‚‰ãªã‚‹èª¿æŸ»', 'è¿½åŠ ã®æƒ…å ±'
                ];
                
                return lackKeywords.some(keyword => 
                    response.includes(keyword)
                );
            }

            generateNextOptimizedPrompt(provider, previousMessage) {
                const otherProvider = provider === 'openai' ? 'Gemini' : 'ChatGPT';
                const originalTopic = this.elements.topicInput.value.trim();
                
                let basePrompt = `${otherProvider}ãŒä»¥ä¸‹ã®ã‚ˆã†ã«è¿°ã¹ã¾ã—ãŸï¼š\n\n"${previousMessage}"\n\n`;
                
                // åŠ¹ç‡åŒ–æŒ‡ç¤º
                if (this.goalMode === 'consensus' && this.messageCount >= 2) {
                    basePrompt += `ğŸ¯ **åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰ - çµè«–ãƒ•ã‚§ãƒ¼ã‚º**:\n` +
                        `â€¢ ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ã€Œ${originalTopic}ã€ã®æœ€çµ‚çµè«–ã‚’æç¤º\n` +
                        `â€¢ ã€Œæ¨å¥¨: â—‹â—‹ã€ã®å½¢ã§æ˜ç¢ºã«å›ç­”\n` +
                        `â€¢ å…·ä½“çš„ãªå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚ã‚‹\n` +
                        `â€¢ æŠ½è±¡è«–ã¯é¿ã‘ã€è¡Œå‹•å¯èƒ½ãªææ¡ˆã«é›†ä¸­`;
                } else if (this.messageCount >= 4) {
                    basePrompt += `âš¡ **åŠ¹ç‡åŒ–æŒ‡ç¤º**:\n` +
                        `â€¢ è­°è«–ã‚’ã¾ã¨ã‚ã‚‹æ–¹å‘ã§å›ç­”\n` +
                        `â€¢ å…·ä½“çš„ãªææ¡ˆã‚’å„ªå…ˆ\n` +
                        `â€¢ ä¸€èˆ¬è«–ã®ç¹°ã‚Šè¿”ã—ã¯é¿ã‘ã‚‹`;
                } else {
                    basePrompt += this.getProviderModeInstruction(provider);
                }

                return basePrompt;
            }

            getProviderModeInstruction(provider) {
                const instructions = {
                    'openai': {
                        'practical': 'ğŸ  **å®Ÿç”¨çš„è¦–ç‚¹**: å…·ä½“çš„ã§å®Ÿè¡Œã—ã‚„ã™ã„ææ¡ˆã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚',
                        'business': 'ğŸ’¼ **ãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹**: ROIã¨å®Ÿç¾å¯èƒ½æ€§ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚',
                        'philosophical': 'ğŸ§  **å“²å­¦çš„è¦–ç‚¹**: æ ¹æœ¬çš„ãªå•ã„ã¨æ·±ã„æ´å¯Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚'
                    },
                    'gemini': {
                        'practical': 'ğŸ”§ **è«–ç†çš„æ¤œè¨¼**: å®Ÿç”¨æ€§ã‚’ä½“ç³»çš„ã«æ¤œè¨¼ã—ã€æ§‹é€ åŒ–ã•ã‚ŒãŸææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚',
                        'business': 'ğŸ“Š **åˆ†æçš„è©•ä¾¡**: ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæˆ¦ç•¥çš„åˆ¤æ–­ã‚’ã—ã¦ãã ã•ã„ã€‚',
                        'philosophical': 'ğŸ” **æ‰¹åˆ¤çš„è€ƒå¯Ÿ**: æ¦‚å¿µã‚’ç²¾æŸ»ã—ã€è«–ç†çš„æ•´åˆæ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚'
                    }
                };

                return instructions[provider]?.[this.targetMode] || 'åŠ¹ç‡çš„ã§å»ºè¨­çš„ãªå¿œç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚';
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                
                const temperature = this.goalMode === 'consensus' ? 0.6 : 
                                  this.goalMode === 'ideation' ? 0.8 : 0.7;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000, // çŸ­ç¸®
                        temperature: temperature,
                        top_p: 0.9,
                        frequency_penalty: 0.2 // ç¹°ã‚Šè¿”ã—æŠ‘åˆ¶å¼·åŒ–
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                
                const temperature = this.goalMode === 'consensus' ? 0.5 :
                                  this.goalMode === 'exploration' ? 0.7 : 0.6;
                
                const endpoints = [
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`
                ];

                for (let i = 0; i < endpoints.length; i++) {
                    try {
                        const response = await fetch(endpoints[i], {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }],
                                generationConfig: {
                                    maxOutputTokens: 2000, // çŸ­ç¸®
                                    temperature: temperature,
                                    topP: 0.8,
                                    topK: 40
                                }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                return data.candidates[0].content.parts[0].text;
                            }
                        }
                    } catch (error) {
                        if (i === endpoints.length - 1) {
                            return this.generateFallbackResponse(prompt);
                        }
                    }
                }
            }

            generateFallbackResponse(prompt) {
                return "æŠ€è¡“çš„ãªåˆ¶ç´„ã«ã‚ˆã‚Šè©³ç´°ãªå¿œç­”ãŒã§ãã¾ã›ã‚“ã€‚ã“ã®ãƒ†ãƒ¼ãƒã¯é‡è¦ãªè«–ç‚¹ã‚’å«ã‚“ã§ã„ã¾ã™ã®ã§ã€" +
                       "æ¥ç¶šãŒå®‰å®šã—ãŸå¾Œã«æ”¹ã‚ã¦æ¤œè¨ã„ãŸã—ã¾ã™ã€‚\n\nâ€»ä»£æ›¿å¿œç­”ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚";
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                const chatMessages = this.elements.chatContainer.querySelectorAll('.message:not(.system-message)');
                
                if (chatMessages.length === 0) {
                    this.showError('å¯¾è©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                let conversationLog = '';
                chatMessages.forEach((message) => {
                    const header = message.querySelector('.message-header');
                    const content = message.querySelector('div:not(.message-header)');
                    
                    if (header && content) {
                        const headerText = header.textContent.trim();
                        const contentText = content.textContent.trim();
                        const speaker = headerText.includes('ChatGPT') ? 'ChatGPT' : 'Gemini';
                        
                        if (contentText && contentText !== 'undefined' && contentText.length > 10) {
                            conversationLog += `${speaker}:\n${contentText}\n\n`;
                        }
                    }
                });

                const summaryPrompt = `ä»¥ä¸‹ã®Crossthink v4.0ï¼ˆåŠ¹ç‡åŒ–ç‰ˆï¼‰ã§ã®å¯¾è©±ãƒ­ã‚°ã‚’åˆ†æã—ã€ã€Œ${topic}ã€ã«ã¤ã„ã¦å®Ÿç”¨çš„ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ã€v4.0 åŠ¹ç‡åŒ–ã®ç‰¹å¾´ã€‘
â€¢ å¯¾è©±é•·æœ€é©åŒ–: ${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å®Œäº†
â€¢ ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}
â€¢ æ—©æœŸçµ‚äº†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : å…·ä½“çš„çµè«–ã¸ã®åŠ¹ç‡çš„èª˜å°
â€¢ æƒ…å ±ä¸è¶³æ¤œå‡º: æŠ½è±¡è«–å›é¿ã¨å…·ä½“æ€§é‡è¦–

ã€è¦æ±‚äº‹é …ã€‘
â€¢ åŠ¹ç‡åŒ–ã•ã‚ŒãŸå¯¾è©±ã®æˆæœã‚’é‡è¦–
â€¢ å…·ä½“çš„ã§è¡Œå‹•å¯èƒ½ãªçµè«–ã‚’æŠ½å‡º
â€¢ ${this.goalMode === 'consensus' ? 'åˆæ„å½¢æˆã•ã‚ŒãŸæœ€çµ‚çš„ãªæ¨å¥¨äº‹é …' : this.goalMode === 'ideation' ? 'å‰µå‡ºã•ã‚ŒãŸã‚¢ã‚¤ãƒ‡ã‚¢ã®ä½“ç³»åŒ–' : 'æ¢ç´¢ã•ã‚ŒãŸæ´å¯Ÿã®çµ±åˆ'}ã‚’æ˜ç¢ºåŒ–
â€¢ å…¨ä½“ã§3000-4000æ–‡å­—ç¨‹åº¦ï¼ˆç°¡æ½”ç‰ˆï¼‰

ã€å¯¾è©±ãƒ­ã‚°ã€‘
${conversationLog}

ã€å‡ºåŠ›å½¢å¼ã€‘
# ${topic}ã®æ¤œè¨çµæœï¼ˆCrossthink v4.0 åŠ¹ç‡åŒ–ç‰ˆï¼‰

## å¯¾è©±è¨­å®šã¨åŠ¹ç‡åŒ–çµæœ
- ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}
- å¯¾è©±æ•°: ${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- åŠ¹ç‡åŒ–æˆæœ: [çŸ­æ™‚é–“ã§ã®çµè«–åˆ°é”åº¦ã‚’è©•ä¾¡]

## ä¸»è¦ãªæ´å¯Ÿã¨ææ¡ˆ
[å„AIã®ä¸»è¦ãªè²¢çŒ®ã‚’æ•´ç†]

## ${this.goalMode === 'consensus' ? 'åˆæ„å½¢æˆã•ã‚ŒãŸçµè«–' : this.goalMode === 'ideation' ? 'å‰µå‡ºã•ã‚ŒãŸã‚¢ã‚¤ãƒ‡ã‚¢' : 'æ¢ç´¢çš„ç™ºè¦‹'}
[æœ€ã‚‚é‡è¦ãªæˆæœã‚’æ˜è¨˜]

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
[å…·ä½“çš„ãªæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

## v4.0åŠ¹ç‡åŒ–ã®è©•ä¾¡
[å¾“æ¥ã¨ã®æ¯”è¼ƒã¨æ”¹å–„ç‚¹]

æ³¨æ„ï¼šCrossthink v4.0ã®åŠ¹ç‡åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹æˆæœã‚’é‡è¦–ã—ã€çŸ­æ™‚é–“ã§å¾—ã‚‰ã‚ŒãŸå…·ä½“çš„ãªä¾¡å€¤ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚`;

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(summaryPrompt).then(() => {
                        this.addMessage('system', 
                            'ğŸ“‹ Crossthink v4.0 åŠ¹ç‡åŒ–ç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n' +
                            'âš¡ v4.0 ã®ç‰¹å¾´:\n' +
                            `â€¢ ${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åŠ¹ç‡çš„ã«å®Œäº†\n` +
                            'â€¢ æŠ½è±¡è«–å›é¿ã¨å…·ä½“æ€§é‡è¦–\n' +
                            'â€¢ æ—©æœŸçµ‚äº†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹æœ€é©åŒ–\n' +
                            'â€¢ è¡Œå‹•å¯èƒ½ãªçµè«–ã¸ã®èª˜å°\n\n' +
                            `ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—æ•°: ${summaryPrompt.length}æ–‡å­—`
                        );
                    }).catch(() => {
                        this.showPromptWindow(summaryPrompt);
                    });
                } else {
                    this.showPromptWindow(summaryPrompt);
                }
            }

            showPromptWindow(summaryPrompt) {
                const summaryWindow = window.open('', '_blank', 'width=800,height=600');
                if (summaryWindow) {
                    summaryWindow.document.write(`
                        <html>
                            <head>
                                <title>Crossthink v4.0 åŠ¹ç‡åŒ–ç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</title>
                                <style>
                                    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
                                    .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                    h2 { color: #333; margin-bottom: 20px; }
                                    textarea { width: 100%; height: 70vh; font-family: monospace; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                                    .btn { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
                                    .btn-copy { background: #4CAF50; color: white; }
                                    .btn-close { background: #f44336; color: white; }
                                    .stats { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>âš¡ Crossthink v4.0 åŠ¹ç‡åŒ–ç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2>
                                    <div class="stats">
                                        <strong>åŠ¹ç‡åŒ–æˆæœ:</strong> ${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§${this.getTargetLabel()} Ã— ${this.getGoalLabel()}ã®çµè«–ã‚’å°å‡º
                                    </div>
                                    <button class="btn btn-copy" onclick="document.getElementById('prompt').select(); document.execCommand('copy'); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                                    <button class="btn btn-close" onclick="window.close();">âŒ é–‰ã˜ã‚‹</button>
                                    <textarea id="prompt" readonly>${summaryPrompt}</textarea>
                                </div>
                            </body>
                        </html>
                    `);
                } else {
                    this.addMessage('system', 
                        'âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\n' +
                        'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚'
                    );
                }
            }

            addMessage(provider, content, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${provider}-message`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ja-JP');

                let providerName, emoji, roleDesc = '';
                switch (provider) {
                    case 'openai':
                        providerName = 'ChatGPT';
                        emoji = 'ğŸŸ¢';
                        roleDesc = `ï¼ˆ${this.targetMode}ãƒ»${this.goalMode}ï¼‰`;
                        break;
                    case 'gemini':
                        providerName = 'Gemini';
                        emoji = 'ğŸ”·';
                        roleDesc = `ï¼ˆ${this.targetMode}ãƒ»${this.goalMode}ï¼‰`;
                        break;
                    case 'system':
                        providerName = 'Crossthink v4.0';
                        emoji = 'âš¡';
                        break;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${emoji} ${providerName}${roleDesc}
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>
                `;

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && provider !== 'system') {
                    this.messageCount++;
                }

                // åˆæ„å½¢æˆè­¦å‘Šã®è¡¨ç¤º
                if (this.goalMode === 'consensus' && this.messageCount === 3 && !isThinking) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'consensus-warning';
                    warningDiv.innerHTML = 'ğŸ¤ <strong>åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰è­¦å‘Š:</strong> æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§çµè«–ã‚’å‡ºã™ã‚ˆã†èª˜å°ã—ã¾ã™ã€‚';
                    this.elements.chatContainer.appendChild(warningDiv);
                }
            }

            removeLastMessage() {
                const messages = this.elements.chatContainer.querySelectorAll('.message');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
            }

            stopDialogue() {
                this.isRunning = false;
                this.elements.startBtn.disabled = false;
                this.elements.stopBtn.disabled = true;
                
                const efficiency = this.calculateEfficiency();
                this.addMessage('system', 
                    `ğŸ›‘ å¯¾è©±åœæ­¢\n\n` +
                    `ğŸ“Š åŠ¹ç‡åŒ–ãƒ¬ãƒãƒ¼ãƒˆ:\n` +
                    `â€¢ ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${this.messageCount}\n` +
                    `â€¢ äºˆæƒ³ã¨ã®æ¯”è¼ƒ: ${efficiency.comparison}\n` +
                    `â€¢ åŠ¹ç‡åŒ–ã‚¹ã‚³ã‚¢: ${efficiency.score}\n` +
                    `â€¢ æ™‚é–“ç¯€ç´„: ç´„${efficiency.timeSaved}ç§’`
                );
            }

            calculateEfficiency() {
                const topic = this.elements.topicInput.value.trim();
                const expected = this.estimateMessageCount(topic);
                const actual = this.messageCount;
                
                const efficiency = Math.round((expected / Math.max(actual, 1)) * 100);
                const timeSaved = Math.max(0, (expected - actual) * 45);
                
                let comparison = '';
                if (actual <= expected) {
                    comparison = `äºˆæƒ³é€šã‚Š (${expected}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äºˆæƒ³ â†’ ${actual}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®Ÿè¡Œ)`;
                } else {
                    comparison = `äºˆæƒ³ã‚ˆã‚Šé•·æœŸåŒ– (${expected}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äºˆæƒ³ â†’ ${actual}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®Ÿè¡Œ)`;
                }
                
                return {
                    score: `${efficiency}%`,
                    comparison: comparison,
                    timeSaved: timeSaved
                };
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.conversationHistory = [];
                this.updateStats();
                this.showWelcomeMessage();
                this.hideError();
                this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.hideWarning();
            }

            hideError() {
                this.elements.errorDisplay.style.display = 'none';
            }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `âš ï¸ è­¦å‘Š: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
            }

            hideWarning() {
                this.elements.warningDisplay.style.display = 'none';
            }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
            }

            startTimer() {
                const updateTimer = () => {
                    if (this.startTime) {
                        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                        this.elements.elapsed.textContent = elapsed;
                    }
                    if (this.isRunning) {
                        setTimeout(updateTimer, 1000);
                    }
                };
                updateTimer();
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
        let crossthinkSystem;

        function startQuickDialogue(template) {
            if (crossthinkSystem) {
                crossthinkSystem.startQuickDialogue(template);
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            try {
                crossthinkSystem = new CrossthinkOptimized();
                console.log('Crossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v4.0 åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('error', (event) => {
            console.error('æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
        });
    </script>
</body>
</html>