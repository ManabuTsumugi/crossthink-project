<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v4.0 - AIÂØæË©±„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-selection {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .quick-access {
            margin-bottom: 30px;
        }

        .quick-access h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .mode-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .mode-selector h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .mode-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .mode-slider {
            flex: 1;
            margin: 0 20px;
            position: relative;
        }

        .slider-track {
            height: 8px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            border-radius: 4px;
            position: relative;
        }

        .slider-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            position: absolute;
            top: -6px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .slider-thumb:hover {
            transform: scale(1.2);
        }

        .mode-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .selected-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }

        .optimization-notice {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 15px;
            margin: 20px 30px;
            border-radius: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .optimization-notice h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .expected-length {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #4caf50;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "üü¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "üî∑";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .topic-suggestions {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .topic-suggestions h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .topic-suggestions ul {
            list-style: none;
            padding: 0;
        }

        .topic-suggestions li {
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .topic-suggestions li:hover {
            color: #4facfe;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .consensus-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "üí∞";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-row {
                flex-direction: column;
                gap: 10px;
            }

            .mode-slider {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</h1>
            <p>AIÂçîÂÉç„Å´„Çà„ÇãÊÄùËÄÉ„ÅÆÊòüÂ∫ß - ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÂØæË©±‰ΩìÈ®ì</p>
            <div class="demo-label">
                üöÄ v4.0 - ÂäπÁéáÂåñÈáçË¶ñÁâà
            </div>
        </div>

        <div class="optimization-notice">
            <h3>‚ö° v4.0 ÊúÄÈÅ©Âåñ„ÅÆ„Éù„Ç§„É≥„Éà</h3>
            <ul>
                <li><strong>ÂêàÊÑèÂΩ¢ÊàêÂäπÁéáÂåñ:</strong> 6„É°„ÉÉ„Çª„Éº„Ç∏ ‚Üí 2-3„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÁµêË´ñ</li>
                <li><strong>„ÉÜ„Éº„ÉûÈÅ©ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ:</strong> AI„ÅÆÁü•Ë≠òÁØÑÂõ≤„Å®‰∏ÄËá¥„Åô„Çã„Åã‰∫ãÂâçÂà§ÂÆö</li>
                <li><strong>ÊòéÁ¢∫„Å™ÁµÇ‰∫ÜÊù°‰ª∂:</strong> ÊäΩË±°Ë´ñ„ÇíÈÅø„Åë„ÄÅÂÖ∑‰ΩìÁöÑÁµêË´ñ„Å∏Ë™òÂ∞é</li>
                <li><strong>ÊÉÖÂ†±‰∏çË∂≥Ê§úÂá∫:</strong> Êó©Êúü„Å´ÊÉÖÂ†±‰∏çË∂≥„ÇíÊåáÊëò„Åó„ÄÅÊñπÂêëËª¢Êèõ</li>
            </ul>
            <div class="expected-length" id="expectedLength">
                üéØ ‰∫àÊÉ≥ÂØæË©±Èï∑: „ÉÜ„Éº„ÉûÈÅ∏ÊäûÂæå„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
            </div>
        </div>

        <div class="mode-selection">
            <div class="quick-access">
                <h3>üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„ÇπÔºàÊúÄÈÅ©ÂåñÊ∏à„Åø„ÉÜ„Éº„ÉûÔºâ</h3>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="startQuickDialogue('‰ªäÊó•„ÅÆÊô©Âæ°È£Ø')">
                        üçΩÔ∏è ‰ªäÊó•„ÅÆÊô©Âæ°È£Ø
                        <br><small>ÂÆüÁî®ÁöÑ„ÉªÂêàÊÑèÂΩ¢Êàê (2-3„É°„ÉÉ„Çª„Éº„Ç∏)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('ÂâØÊ•≠„Ç¢„Ç§„Éá„Ç¢')">
                        üíº ÂâØÊ•≠„Ç¢„Ç§„Éá„Ç¢
                        <br><small>„Éì„Ç∏„Éç„Çπ„ÉªÊ°àÂá∫„Åó (3-4„É°„ÉÉ„Çª„Éº„Ç∏)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('ÈÄ±Êú´„ÅÆÈÅé„Åî„ÅóÊñπ')">
                        üåÖ ÈÄ±Êú´„ÅÆÈÅé„Åî„ÅóÊñπ
                        <br><small>ÂÆüÁî®ÁöÑ„ÉªÂêàÊÑèÂΩ¢Êàê (2-3„É°„ÉÉ„Çª„Éº„Ç∏)</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('AIÊôÇ‰ª£„ÅÆÂÉç„ÅçÊñπ')">
                        ü§î AIÊôÇ‰ª£„ÅÆÂÉç„ÅçÊñπ
                        <br><small>Âì≤Â≠¶ÁöÑ„ÉªÊé¢Á¥¢ (4-5„É°„ÉÉ„Çª„Éº„Ç∏)</small>
                    </button>
                </div>
            </div>

            <div class="mode-selector">
                <h3>üéØ „Ç´„Çπ„Çø„É†ÂØæË©±Ë®≠ÂÆö</h3>
                
                <div class="mode-row">
                    <span><strong>„Å©„Çì„Å™ÂØæË©±Ôºü</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="targetSlider" style="left: 33%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>üè† ÂÆüÁî®ÁöÑ</span>
                            <span>üíº „Éì„Ç∏„Éç„Çπ</span>
                            <span>üß† Âì≤Â≠¶ÁöÑ</span>
                        </div>
                    </div>
                </div>

                <div class="mode-row">
                    <span><strong>‰Ωï„ÅåÁõÆÊ®ôÔºü</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="goalSlider" style="left: 50%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>üí° Ê°àÂá∫„Åó</span>
                            <span>ü§ù ÂêàÊÑèÂΩ¢Êàê</span>
                            <span>üîç Êé¢Á¥¢</span>
                        </div>
                    </div>
                </div>

                <div class="selected-mode" id="selectedMode">
                    üéØ ÈÅ∏Êäû‰∏≠: ÂÆüÁî®ÁöÑ √ó ÂêàÊÑèÂΩ¢Êàê„É¢„Éº„Éâ
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>üîß APIË®≠ÂÆö</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>üìù ÂØæË©±„Éà„Éî„ÉÉ„ÇØ:</h2>
            
            <div class="topic-suggestions" id="topicSuggestions">
                <h4>üí° Êé®Â•®„ÉÜ„Éº„ÉûÔºàAI„ÅåË©≥„Åó„ÅÑÂàÜÈáéÔºâ:</h4>
                <ul id="suggestedTopics">
                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                </ul>
            </div>

            <input type="text" id="topicInput" class="topic-input" 
                   placeholder="Ëá™Áî±„Å´„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" 
                   value="">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">üöÄ ÂØæË©±ÈñãÂßã</button>
                <button id="stopBtn" class="btn btn-danger" disabled>‚èπÔ∏è ÂÅúÊ≠¢</button>
                <button id="clearBtn" class="btn btn-secondary">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                <button id="exportBtn" class="btn btn-secondary">üìù Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„ÉàÁîüÊàê</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìä ÂØæË©±Áµ±Ë®à</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">GeminiÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">ÁµåÈÅéÊôÇÈñì(Áßí)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>üåü v4.0 ÂäπÁéáÂåñ„ÅÆÁâπÂæ¥:</h3>
            <ul>
                <li>ÂØæË©±Èï∑ÊúÄÈÅ©Âåñ: ÁÑ°ÈßÑ„Å™ÂæÄÂæ©„ÇíÂâäÊ∏õ„ÄÅÂÆüË≥™ÁöÑÁµêË´ñ„Çí‰øÉÈÄ≤</li>
                <li>„ÉÜ„Éº„ÉûÈÅ©ÂêàÊÄßÂà§ÂÆö: AI„ÅÆÂæóÊÑèÂàÜÈáé„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Âêë‰∏ä</li>
                <li>Êó©ÊúüÁµÇ‰∫Ü„Ç¢„É´„Ç¥„É™„Ç∫„É†: ÊÉÖÂ†±‰∏çË∂≥„ÇÑÊäΩË±°Ë´ñ„ÅÆÊó©ÊúüÁô∫Ë¶ã</li>
                <li>ÂÖ∑‰ΩìÊÄßÂº∑Âà∂„É¢„Éº„Éâ: ‰∏ÄËà¨Ë´ñÂõûÈÅø„ÄÅË°åÂãïÂèØËÉΩ„Å™ÊèêÊ°àÈáçË¶ñ</li>
                <li>„É¶„Éº„Ç∂„Éì„É™„ÉÜ„Ç£Âêë‰∏ä: ÊúüÂæÖÂÄ§ÁÆ°ÁêÜ„Å®ÊòéÁ¢∫„Å™„Ç¥„Éº„É´Ë®≠ÂÆö</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- ÂØæË©±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
        </div>
    </div>

    <script>
        class CrossthinkOptimized {
            constructor() {
                this.isRunning = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8; // Â§ßÂπÖÁü≠Á∏Æ
                this.consensusTargets = [3, 5]; // ÂêàÊÑèÂΩ¢Êàê„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà
                this.earlyTerminationChecks = [2, 4]; // Êó©ÊúüÁµÇ‰∫ÜÂà§ÂÆö
                
                // „É¢„Éº„ÉâË®≠ÂÆö
                this.targetMode = 'practical';
                this.goalMode = 'consensus';
                
                // „ÉÜ„Éº„ÉûÈÅ©ÂêàÊÄß„Éá„Éº„Çø„Éô„Éº„Çπ
                this.topicDatabase = {
                    practical: {
                        consensus: [
                            { topic: "‰ªäÊó•„ÅÆÊô©Âæ°È£Ø„ÇíÊ±∫„ÇÅ„ÇãÔºàÂÜ∑ËîµÂ∫´„ÅÆÊÆã„ÇäÁâ©Ê¥ªÁî®Ôºâ", expected: 2 },
                            { topic: "‰ªäÈÄ±Êú´„ÅÆ‰∫àÂÆö„ÇíÊ±∫„ÇÅ„ÇãÔºà‰∫àÁÆó2‰∏áÂÜÜ‰ª•ÂÜÖÔºâ", expected: 3 },
                            { topic: "ÈÉ®Â±ã„ÅÆÊ®°ÊßòÊõø„Åà„Éó„É©„É≥Ôºà6Áï≥„ÉØ„É≥„É´„Éº„É†Ôºâ", expected: 3 },
                            { topic: "ÂÅ•Â∫∑ÁöÑ„Å™Êúù„ÅÆÁøíÊÖ£„ÇíÊ±∫„ÇÅ„ÇãÔºàÂπ≥Êó•30ÂàÜ‰ª•ÂÜÖÔºâ", expected: 2 }
                        ],
                        ideation: [
                            { topic: "ÁØÄÁ¥Ñ„Åß„Åç„ÇãÂÆ∂‰∫ã„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ", expected: 3 },
                            { topic: "Âú®ÂÆÖÂã§Âãô„ÅÆÁí∞Â¢ÉÊîπÂñÑ„Ç¢„Ç§„Éá„Ç¢", expected: 4 },
                            { topic: "„Éó„É¨„Çº„É≥„ÉàÈÅ∏„Å≥„ÅÆ„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éñ„Å™ÊñπÊ≥ï", expected: 3 }
                        ],
                        exploration: [
                            { topic: "„É©„Ç§„Éï„ÉØ„Éº„ÇØ„Éê„É©„É≥„Çπ„ÅÆÊú¨Ë≥™ÁöÑ„Å™Ë™≤È°å", expected: 4 },
                            { topic: "ÊåÅÁ∂öÂèØËÉΩ„Å™„É©„Ç§„Éï„Çπ„Çø„Ç§„É´Ë®≠Ë®à", expected: 5 }
                        ]
                    },
                    business: {
                        consensus: [
                            { topic: "‰∏≠Â∞è‰ºÅÊ•≠„ÅÆDXÊé®ÈÄ≤Êà¶Áï•ÔºàË£ΩÈÄ†Ê•≠Ôºâ", expected: 4 },
                            { topic: "„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØ„ÉÅ„Éº„É†„ÅÆÁîüÁî£ÊÄßÂêë‰∏ä", expected: 3 },
                            { topic: "Êñ∞Ë¶è‰∫ãÊ•≠„ÅÆÂ∏ÇÂ†¥ÂèÇÂÖ•„Çø„Ç§„Éü„É≥„Ç∞Âà§Êñ≠", expected: 4 }
                        ],
                        ideation: [
                            { topic: "ÂâØÊ•≠„Å®„Åó„Å¶„ÅÆ„Ç™„É≥„É©„Ç§„É≥‰∫ãÊ•≠„Ç¢„Ç§„Éá„Ç¢", expected: 4 },
                            { topic: "Âú∞ÊñπÂâµÁîü√ó„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅÆÂèØËÉΩÊÄß", expected: 5 },
                            { topic: "„Çµ„Çπ„ÉÜ„Éä„Éñ„É´ÁµåÂñ∂„ÅÆÈù©Êñ∞ÁöÑ„Ç¢„Éó„É≠„Éº„ÉÅ", expected: 4 }
                        ],
                        exploration: [
                            { topic: "AIÊôÇ‰ª£„ÅÆ„Éì„Ç∏„Éç„Çπ„É¢„Éá„É´Â§âÈù©", expected: 5 },
                            { topic: "ÂÉç„ÅçÊñπ„ÅÆÊú™Êù•„Å®ÁµÑÁπî„ÅÆÈÄ≤Âåñ", expected: 5 }
                        ]
                    },
                    philosophical: {
                        consensus: [
                            { topic: "AIÊôÇ‰ª£„Å´„Åä„Åë„Çã‰∫∫Èñì„ÅÆ‰æ°ÂÄ§„Å®„ÅØ", expected: 4 },
                            { topic: "Âπ∏Á¶è„ÅÆÂÆöÁæ©„Å®Ê∏¨ÂÆöÊñπÊ≥ï", expected: 4 }
                        ],
                        ideation: [
                            { topic: "ÊïôËÇ≤„ÅÆÊú¨Ë≥™ÁöÑ„Å™ÁõÆÁöÑ„ÅÆÂÜçÂÆöÁæ©", expected: 5 },
                            { topic: "„Éá„Ç∏„Çø„É´Á§æ‰ºö„ÅÆÂÄ´ÁêÜÁöÑË™≤È°å", expected: 5 }
                        ],
                        exploration: [
                            { topic: "ÊÑèË≠ò„Å®„ÅØ‰Ωï„Åã - Âì≤Â≠¶„Å®ÁßëÂ≠¶„ÅÆÂ¢ÉÁïå", expected: 6 },
                            { topic: "Ê≠ªÁîüË¶≥„Å®Áèæ‰ª£Á§æ‰ºö„ÅÆÈñ¢‰øÇÊÄß", expected: 5 },
                            { topic: "Áæé„Å®„ÅØ‰Ωï„Åã - ‰∏ªË¶≥ÊÄß„Å®ÊôÆÈÅçÊÄß", expected: 6 }
                        ]
                    }
                };
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeModeSliders();
                this.updateTopicSuggestions();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    elapsed: document.getElementById('elapsed'),
                    selectedMode: document.getElementById('selectedMode'),
                    targetSlider: document.getElementById('targetSlider'),
                    goalSlider: document.getElementById('goalSlider'),
                    expectedLength: document.getElementById('expectedLength'),
                    suggestedTopics: document.getElementById('suggestedTopics')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                this.elements.topicInput.addEventListener('input', () => this.updateExpectedLength());
            }

            updateTopicSuggestions() {
                const topics = this.topicDatabase[this.targetMode]?.[this.goalMode] || [];
                this.elements.suggestedTopics.innerHTML = '';
                
                topics.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.topic} (${item.expected}„É°„ÉÉ„Çª„Éº„Ç∏‰∫àÊÉ≥)`;
                    li.onclick = () => {
                        this.elements.topicInput.value = item.topic;
                        this.updateExpectedLength();
                    };
                    this.elements.suggestedTopics.appendChild(li);
                });
            }

            updateExpectedLength() {
                const topic = this.elements.topicInput.value.trim();
                const expectedMessages = this.estimateMessageCount(topic);
                
                let warning = '';
                if (expectedMessages > 5) {
                    warning = ' ‚ö†Ô∏è Èï∑ÊúüÂåñ„ÅÆÂèØËÉΩÊÄß„ÅÇ„Çä';
                } else if (expectedMessages <= 2) {
                    warning = ' ‚úÖ ÂäπÁéáÁöÑ„Å™ÂØæË©±„ÇíÊúüÂæÖ';
                }
                
                this.elements.expectedLength.innerHTML = 
                    `üéØ ‰∫àÊÉ≥ÂØæË©±Èï∑: ${expectedMessages}„É°„ÉÉ„Çª„Éº„Ç∏${warning}`;
            }

            estimateMessageCount(topic) {
                // Á∞°ÊòìÁöÑ„Å™Êé®ÂÆö„É≠„Ç∏„ÉÉ„ÇØ
                const topics = this.topicDatabase[this.targetMode]?.[this.goalMode] || [];
                
                // ÂÆåÂÖ®‰∏ÄËá¥„ÉÅ„Çß„ÉÉ„ÇØ
                const exactMatch = topics.find(item => 
                    item.topic.toLowerCase().includes(topic.toLowerCase()) ||
                    topic.toLowerCase().includes(item.topic.toLowerCase())
                );
                
                if (exactMatch) return exactMatch.expected;
                
                // „É¢„Éº„Éâ„Éô„Éº„Çπ„ÅÆÊé®ÂÆö
                const baseCounts = {
                    'practical-consensus': 2,
                    'practical-ideation': 3,
                    'practical-exploration': 4,
                    'business-consensus': 3,
                    'business-ideation': 4,
                    'business-exploration': 5,
                    'philosophical-consensus': 4,
                    'philosophical-ideation': 5,
                    'philosophical-exploration': 6
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                let baseCount = baseCounts[key] || 4;
                
                // ÁâπÂÆö‰ºÅÊ•≠/Ë£ΩÂìÅÂêç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åü„ÇâË≠¶Âëä
                const specificTerms = ['Ê†™Âºè‰ºöÁ§æ', '‰ºöÁ§æ', 'Ë£ΩÂìÅ', 'Ë£ÖÁΩÆ', 'Ê©üÂô®', '„Ç∑„Çπ„ÉÜ„É†'];
                const hasSpecificTerms = specificTerms.some(term => topic.includes(term));
                
                if (hasSpecificTerms) {
                    baseCount += 2; // ÊÉÖÂ†±‰∏çË∂≥„ÅßÈï∑ÊúüÂåñ„ÅÆÂèØËÉΩÊÄß
                }
                
                return Math.min(baseCount, 6); // ÊúÄÂ§ß6„É°„ÉÉ„Çª„Éº„Ç∏
            }

            initializeModeSliders() {
                this.initializeSlider('targetSlider', (value) => {
                    if (value < 33) this.targetMode = 'practical';
                    else if (value < 66) this.targetMode = 'business';
                    else this.targetMode = 'philosophical';
                    this.updateSelectedMode();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                });

                this.initializeSlider('goalSlider', (value) => {
                    if (value < 33) this.goalMode = 'ideation';
                    else if (value < 66) this.goalMode = 'consensus';
                    else this.goalMode = 'exploration';
                    this.updateSelectedMode();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                });

                this.updateSelectedMode();
            }

            initializeSlider(sliderId, callback) {
                const slider = this.elements[sliderId];
                const track = slider.parentElement;
                let isDragging = false;

                slider.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const rect = track.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                    
                    slider.style.left = percentage + '%';
                    callback(percentage);
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            updateSelectedMode() {
                const targetLabels = {
                    'practical': 'üè† ÂÆüÁî®ÁöÑ',
                    'business': 'üíº „Éì„Ç∏„Éç„Çπ',
                    'philosophical': 'üß† Âì≤Â≠¶ÁöÑ'
                };

                const goalLabels = {
                    'ideation': 'üí° Ê°àÂá∫„Åó',
                    'consensus': 'ü§ù ÂêàÊÑèÂΩ¢Êàê',
                    'exploration': 'üîç Êé¢Á¥¢'
                };

                this.elements.selectedMode.textContent = 
                    `üéØ ÈÅ∏Êäû‰∏≠: ${targetLabels[this.targetMode]} √ó ${goalLabels[this.goalMode]}„É¢„Éº„Éâ`;
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v4.0 „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ\n\n' +
                    '‚ö° v4.0 ÂäπÁéáÂåñ„ÅÆÁâπÂæ¥:\n' +
                    '‚Ä¢ üèÉ‚Äç‚ôÇÔ∏è ÂêàÊÑèÂΩ¢Êàê: 6„É°„ÉÉ„Çª„Éº„Ç∏ ‚Üí 2-3„É°„ÉÉ„Çª„Éº„Ç∏„Å´Áü≠Á∏Æ\n' +
                    '‚Ä¢ üéØ „ÉÜ„Éº„Éû„Éû„ÉÉ„ÉÅ„É≥„Ç∞: AI„ÅÆÂæóÊÑèÂàÜÈáé„Çí‰∫ãÂâçÂà§ÂÆö\n' +
                    '‚Ä¢ üö® Êó©ÊúüË≠¶Âëä: ÊÉÖÂ†±‰∏çË∂≥„ÇÑÊäΩË±°Ë´ñ„ÇíÂç≥Â∫ß„Å´Ê§úÂá∫\n' +
                    '‚Ä¢ ‚úÖ ÂÖ∑‰ΩìÊÄßÈáçË¶ñ: Ë°åÂãïÂèØËÉΩ„Å™ÁµêË´ñ„ÇíÂº∑Âà∂Ë™òÂ∞é\n\n' +
                    'üí° ‰Ωø„ÅÑÊñπ:\n' +
                    '1. Êé®Â•®„ÉÜ„Éº„Éû„Åã„ÇâÈÅ∏ÊäûÔºàÊúÄÈÅ©ÂåñÊ∏à„ÅøÔºâ\n' +
                    '2. ‰∫àÊÉ≥„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„ÇíÁ¢∫Ë™ç\n' +
                    '3. API „Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶Âç≥ÈñãÂßã\n\n' +
                    'üéØ ÂäπÁéáÂåñ„ÅÆ„É°„É™„ÉÉ„Éà:\n' +
                    'üìà ÈñãÁô∫„Ç≥„Çπ„ÉàÂâäÊ∏õÔºàÁü≠ÊôÇÈñì„ÅßÁµêË´ñÔºâ\n' +
                    'üéì „É¶„Éº„Ç∂„ÉºÊ∫ÄË∂≥Â∫¶Âêë‰∏äÔºàÊòéÁ¢∫„Å™ÊàêÊûúÔºâ\n' +
                    'üí° ÂÆüÁî®ÊÄßÈáçË¶ñÔºàË°åÂãï„Å´„Å§„Å™„Åå„ÇãÊèêÊ°àÔºâ\n' +
                    'üî¨ ÂìÅË≥™‰øùË®ºÔºàÊúÄÈÅ©Âåñ„Åï„Çå„Åü„Éó„É≠„É≥„Éó„ÉàÔºâ'
                );
            }

            startQuickDialogue(template) {
                const quickModes = {
                    '‰ªäÊó•„ÅÆÊô©Âæ°È£Ø': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: '‰ªäÊó•„ÅÆÊô©Âæ°È£Ø„ÇíÊ±∫„ÇÅ„ÇãÔºàÂÜ∑ËîµÂ∫´„ÅÆÊÆã„ÇäÁâ©Ê¥ªÁî®„ÄÅ‰∫àÁÆó1000ÂÜÜ‰ª•ÂÜÖÔºâ'
                    },
                    'ÂâØÊ•≠„Ç¢„Ç§„Éá„Ç¢': {
                        target: 'business',
                        goal: 'ideation',
                        topic: 'ÂâØÊ•≠„Å®„Åó„Å¶„ÅÆ„Ç™„É≥„É©„Ç§„É≥‰∫ãÊ•≠„Ç¢„Ç§„Éá„Ç¢ÔºàÂàùÊúüÊäïË≥á10‰∏áÂÜÜ‰ª•ÂÜÖÔºâ'
                    },
                    'ÈÄ±Êú´„ÅÆÈÅé„Åî„ÅóÊñπ': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: '‰ªäÈÄ±Êú´„ÅÆÈÅé„Åî„ÅóÊñπ„ÇíÊ±∫„ÇÅ„ÇãÔºà‰∫àÁÆó2‰∏áÂÜÜ‰ª•ÂÜÖ„ÄÅÈÉΩÂÜÖÔºâ'
                    },
                    'AIÊôÇ‰ª£„ÅÆÂÉç„ÅçÊñπ': {
                        target: 'philosophical',
                        goal: 'exploration',
                        topic: 'AIÊôÇ‰ª£„Å´„Åä„Åë„Çã‰∫∫Èñì„ÅÆÂÉç„ÅçÊñπ„Å®‰æ°ÂÄ§ÂâµÈÄ†'
                    }
                };

                const mode = quickModes[template];
                if (mode) {
                    this.targetMode = mode.target;
                    this.goalMode = mode.goal;
                    this.elements.topicInput.value = mode.topic;
                    this.updateSelectedMode();
                    this.updateSliderPositions();
                    this.updateTopicSuggestions();
                    this.updateExpectedLength();
                    
                    this.addMessage('system', 
                        `üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„Çπ: "${template}"\n` +
                        `üéØ „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}\n` +
                        `üìù ÊúÄÈÅ©ÂåñÊ∏à„Åø„Éà„Éî„ÉÉ„ÇØË®≠ÂÆöÂÆå‰∫Ü\n` +
                        `‚è±Ô∏è ‰∫àÊÉ≥ÂØæË©±ÊôÇÈñì: ${this.estimateMessageCount(mode.topic) * 45}Áßí`
                    );
                }
            }

            updateSliderPositions() {
                const targetPositions = { 'practical': 16, 'business': 50, 'philosophical': 83 };
                const goalPositions = { 'ideation': 16, 'consensus': 50, 'exploration': 83 };
                
                this.elements.targetSlider.style.left = targetPositions[this.targetMode] + '%';
                this.elements.goalSlider.style.left = goalPositions[this.goalMode] + '%';
            }

            getTargetLabel() {
                const labels = {
                    'practical': 'üè† ÂÆüÁî®ÁöÑ',
                    'business': 'üíº „Éì„Ç∏„Éç„Çπ',
                    'philosophical': 'üß† Âì≤Â≠¶ÁöÑ'
                };
                return labels[this.targetMode];
            }

            getGoalLabel() {
                const labels = {
                    'ideation': 'üí° Ê°àÂá∫„Åó',
                    'consensus': 'ü§ù ÂêàÊÑèÂΩ¢Êàê',
                    'exploration': 'üîç Êé¢Á¥¢'
                };
                return labels[this.goalMode];
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                
                this.elements.startBtn.disabled = true;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                const expectedMessages = this.estimateMessageCount(topic);
                
                this.addMessage('system', 
                    `üéØ ÂäπÁéáÂåñÂØæË©±ÈñãÂßã\n` +
                    `üìù „Éà„Éî„ÉÉ„ÇØ: "${topic}"\n` +
                    `üé™ „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}\n` +
                    `‚è±Ô∏è ‰∫àÊÉ≥„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${expectedMessages}\n` +
                    `üöÄ ÊúÄÈÅ©ÂåñAI„ÅåÂäπÁéáÁöÑ„Å´ÁµêË´ñ„ÇíÂ∞é„Åç„Åæ„ÅôÔºÅ`
                );

                this.startTimer();

                // ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÂàùÊúü„Éó„É≠„É≥„Éó„Éà
                const initialPrompt = this.generateOptimizedPrompt(topic, 1);
                await this.sendMessage('openai', initialPrompt);
            }

            generateOptimizedPrompt(topic, messageNumber) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                
                // ÂäπÁéáÂåñÊåáÁ§∫„ÇíËøΩÂä†
                let optimizationInstructions = '';
                
                if (this.goalMode === 'consensus' && messageNumber === 1) {
                    optimizationInstructions = `\n\nüéØ **ÂäπÁéáÂåñÊåáÁ§∫Ôºàv4.0Ôºâ**:\n` +
                        `‚Ä¢ ÊäΩË±°Ë´ñ„ÅØÈÅø„Åë„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÊèêÊ°à„Å´ÈõÜ‰∏≠\n` +
                        `‚Ä¢ ÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁéáÁõ¥„Å´ÊåáÊëò\n` +
                        `‚Ä¢ Ê¨°Âõû„ÅßÂêàÊÑèÂΩ¢Êàê„ÇíÁõÆÊåá„Åô„Çà„ÅÜÊÑèË≠ò\n` +
                        `‚Ä¢ Ë°åÂãïÂèØËÉΩ„Å™ÈÅ∏ÊäûËÇ¢„Çí3„Å§‰ª•ÂÜÖ„ÅßÊèêÁ§∫`;
                } else if (messageNumber === 2 && this.goalMode === 'consensus') {
                    optimizationInstructions = `\n\nüéØ **ÂêàÊÑèÂΩ¢Êàê„Éï„Çß„Éº„Ç∫**:\n` +
                        `‚Ä¢ ÂâçÂõû„ÅÆÊèêÊ°à„ÇíË∏è„Åæ„Åà„ÄÅÊúÄÈÅ©Ëß£„Çí1„Å§ÈÅ∏Êäû\n` +
                        `‚Ä¢ ÂÖ∑‰ΩìÁöÑ„Å™ÂÆüË°å„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊèêÁ§∫\n` +
                        `‚Ä¢ „ÄåÁµêË´ñ: ‚óã‚óã„ÇíÊé®Â•®„Äç„ÅÆÂΩ¢„ÅßÊòéÁ¢∫„Å´ÂõûÁ≠î`;
                } else if (this.earlyTerminationChecks.includes(messageNumber)) {
                    optimizationInstructions = `\n\n‚ö° **Êó©ÊúüÁµÇ‰∫ÜÂà§ÂÆö**:\n` +
                        `‚Ä¢ ÂçÅÂàÜ„Å™ÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞ÁµêË´ñ„ÇíÂá∫„Åô\n` +
                        `‚Ä¢ ÊÉÖÂ†±‰∏çË∂≥„Å™„Çâ„Äå„Åï„Çâ„Å™„ÇãÊÉÖÂ†±„ÅåÂøÖË¶Å„Äç„Å®ÊòéË®ò\n` +
                        `‚Ä¢ ÊäΩË±°ÁöÑ„Å™Ë≠∞Ë´ñ„ÅÆÁπ∞„ÇäËøî„Åó„ÅØÈÅø„Åë„Çã`;
                }

                return basePrompt + optimizationInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `ÂÆüÁî®ÁöÑ„Å™Ëß£Ê±∫Á≠ñ„Çí3„Å§ÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË°å„Åó„ÇÑ„Åô„ÅÑÈÅ∏ÊäûËÇ¢„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ`,
                    'practical-consensus': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÊúÄ„ÇÇÁèæÂÆüÁöÑ„ÅßÂÆüË°åÂèØËÉΩ„Å™Ëß£Ê±∫Á≠ñ„ÇíÊ±∫„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇÂà∂Á¥ÑÊù°‰ª∂„ÇÇËÄÉÊÖÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'practical-exploration': `„Äå${topic}„Äç„ÅÆÂÆüÁî®ÁöÑ„Å™ÂÅ¥Èù¢„Å´„Å§„ÅÑ„Å¶„ÄÅÈö†„Çå„ÅüË™≤È°å„ÇÑÊ©ü‰ºö„ÇÇÂê´„ÇÅ„Å¶Ê§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    
                    'business-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÂÖ∑‰ΩìÁöÑ„Å™„Éì„Ç∏„Éç„Çπ‰æ°ÂÄ§„ÇíÁîü„ÇÄ„Ç¢„Ç§„Éá„Ç¢„Çí3-4„Å§ÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-consensus': `„Äå${topic}„Äç„Å´Èñ¢„Åó„Å¶„ÄÅROI„Å®ÂÆüÁèæÂèØËÉΩÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊúÄÈÅ©„Å™Êà¶Áï•„ÇíÊ±∫ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                    'business-exploration': `„Äå${topic}„Äç„ÅÆ„Éì„Ç∏„Éç„ÇπÁöÑÂèØËÉΩÊÄß„Å´„Å§„ÅÑ„Å¶„ÄÅÂ∏ÇÂ†¥ÂãïÂêë„ÇÇÂê´„ÇÅ„Å¶ÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    
                    'philosophical-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÊñ∞„Åó„ÅÑÊÄùËÄÉ„ÅÆÊû†ÁµÑ„Åø„ÇÑÊ†πÊú¨ÁöÑ„Å™Âïè„ÅÑ„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-consensus': `„Äå${topic}„Äç„ÅÆÊú¨Ë≥™„Å´„Å§„ÅÑ„Å¶„ÄÅË´ñÁêÜÁöÑÊ§úË®é„ÇíÈÄö„Åò„Å¶Ê∑±„ÅÑÁêÜËß£„Å´Âà∞ÈÅî„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                    'philosophical-exploration': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅÊó¢Â≠ò„ÅÆÂâçÊèê„ÇíÁñë„ÅÑ„ÄÅÊ†πÊ∫êÁöÑ„Å™Êé¢Á©∂„ÇíË°å„ÅÑ„Åæ„Åó„Çá„ÅÜ„ÄÇ`
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶ÂäπÁéáÁöÑ„Å´Ë≠∞Ë´ñ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) {
                    this.showError('OpenAI API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                if (!geminiKey) {
                    this.showError('Gemini API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                if (!topic) {
                    this.showError('ÂØæË©±„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                // ÁâπÂÆö‰ºÅÊ•≠/Ë£ΩÂìÅ„ÅÆË≠¶Âëä
                const specificTerms = ['Ê†™Âºè‰ºöÁ§æ', '‰ºöÁ§æ', 'Ë£ΩÂìÅ', 'Ë£ÖÁΩÆ', 'Ê©üÂô®'];
                const hasSpecificTerms = specificTerms.some(term => topic.includes(term));
                
                if (hasSpecificTerms) {
                    this.showWarning('ÁâπÂÆö‰ºÅÊ•≠„ÉªË£ΩÂìÅ„ÅÆ„ÉÜ„Éº„Éû„ÅØÊÉÖÂ†±‰∏çË∂≥„Å´„Çà„ÇäÈï∑ÊúüÂåñ„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô');
                }

                return true;
            }

            async sendMessage(provider, prompt) {
                if (!this.isRunning) return;

                try {
                    this.addMessage(provider, 'ÊÄùËÄÉ‰∏≠...', true);
                    
                    let response;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        this.openaiCount++;
                    } else {
                        response = await this.callGemini(prompt);
                        this.geminiCount++;
                    }

                    this.removeLastMessage();
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response });
                    this.updateStats();

                    // Êó©ÊúüÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.shouldTerminateEarly(response)) {
                        this.addMessage('system', '‚úÖ ÂäπÁéáÂåñÊàêÂäüÔºÅÂÖ∑‰ΩìÁöÑ„Å™ÁµêË´ñ„Å´Âà∞ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ');
                        this.stopDialogue();
                        return;
                    }

                    // ÂêàÊÑèÂΩ¢Êàê„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.goalMode === 'consensus' && this.consensusTargets.includes(this.messageCount)) {
                        if (this.hasReachedConsensus(response)) {
                            this.addMessage('system', 'ü§ù ÂêàÊÑèÂΩ¢ÊàêÂÆå‰∫ÜÔºÅÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁµêË´ñ„ÅåÂæó„Çâ„Çå„Åæ„Åó„Åü„ÄÇ');
                            this.stopDialogue();
                            return;
                        }
                    }

                    // ÊÉÖÂ†±‰∏çË∂≥Ë≠¶Âëä
                    if (this.detectInformationLack(response) && this.messageCount >= 2) {
                        this.addMessage('system', 
                            '‚ö†Ô∏è ÊÉÖÂ†±‰∏çË∂≥Ê§úÂá∫: ÊäΩË±°ÁöÑ„Å™Ë≠∞Ë´ñ„ÅåÁ∂ö„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n' +
                            'ÂÖ∑‰ΩìÁöÑ„Å™ÊÉÖÂ†±Êèê‰æõ„Åæ„Åü„ÅØ„ÉÜ„Éº„ÉûÂ§âÊõ¥„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ'
                        );
                    }

                    // Ê¨°„ÅÆAI„Å´ÂøúÁ≠î„Åï„Åõ„Çã
                    if (this.isRunning && this.messageCount < this.maxMessages) {
                        setTimeout(() => {
                            const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                            const nextPrompt = this.generateNextOptimizedPrompt(nextProvider, response);
                            this.sendMessage(nextProvider, nextPrompt);
                        }, 2000); // Áü≠Á∏Æ
                    } else if (this.messageCount >= this.maxMessages) {
                        this.addMessage('system', '‚è∞ ÂØæË©±ÊôÇÈñìÁµÇ‰∫Ü„ÄÇÂäπÁéáÂåñ„Å´„Çà„ÇäÁü≠ÊôÇÈñì„ÅßÂ§ö„Åè„ÅÆÊ¥ûÂØü„ÅåÂæó„Çâ„Çå„Åæ„Åó„Åü„ÄÇ');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage();
                    this.showError(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
                    console.error('API Error:', error);
                }
            }

            shouldTerminateEarly(response) {
                // ÊòéÁ¢∫„Å™ÁµêË´ñ„ÅÆÊ§úÂá∫
                const conclusionKeywords = [
                    'ÁµêË´ñ:', 'Êé®Â•®:', 'ÊúÄÁµÇÁöÑ„Å´', 'Ê±∫ÂÆö:', 'Á≠î„Åà:', 
                    '„Åä„Åô„Åô„ÇÅ„ÅØ', 'ÊúÄÈÅ©Ëß£„ÅØ', 'ÈÅ∏Êäû„Åô„Åπ„Åç„ÅØ'
                ];
                
                return conclusionKeywords.some(keyword => 
                    response.includes(keyword)
                );
            }

            hasReachedConsensus(response) {
                // ÂêàÊÑè„Å´ÈÅî„Åó„Åü„Åã„ÅÆÂà§ÂÆö
                const consensusKeywords = [
                    'ÂêàÊÑè', '‰∏ÄËá¥', 'Ê±∫ÂÆö', 'ÁµêË´ñ', 'ÊúÄÁµÇÁöÑ',
                    'Êé®Â•®', 'ÊúÄÈÅ©', 'ÈÅ∏Êäû„Åô„Åπ„Åç', '„Éô„Çπ„Éà'
                ];
                
                const wordCount = response.split('').length;
                const hasKeywords = consensusKeywords.some(keyword => 
                    response.includes(keyword)
                );
                
                return hasKeywords && wordCount > 100; // ‰∏ÄÂÆö„ÅÆË©≥Á¥∞Â∫¶„ÇÇË¶ÅÊ±Ç
            }

            detectInformationLack(response) {
                // ÊÉÖÂ†±‰∏çË∂≥„ÅÆÊ§úÂá∫
                const lackKeywords = [
                    '‰∏ÄËà¨ÁöÑ„Å´', 'ÈÄöÂ∏∏', '‰∏ÄËà¨Ë´ñ„Å®„Åó„Å¶', 'ÊäΩË±°ÁöÑ',
                    'Ë©≥Á¥∞„Å™ÊÉÖÂ†±„ÅåÂøÖË¶Å', 'ÂÖ∑‰ΩìÁöÑ„Å™', '„Çà„ÇäË©≥„Åó„ÅÑ',
                    '„Åï„Çâ„Å™„ÇãË™øÊüª', 'ËøΩÂä†„ÅÆÊÉÖÂ†±'
                ];
                
                return lackKeywords.some(keyword => 
                    response.includes(keyword)
                );
            }

            generateNextOptimizedPrompt(provider, previousMessage) {
                const otherProvider = provider === 'openai' ? 'Gemini' : 'ChatGPT';
                const originalTopic = this.elements.topicInput.value.trim();
                
                let basePrompt = `${otherProvider}„Åå‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´Ëø∞„Åπ„Åæ„Åó„ÅüÔºö\n\n"${previousMessage}"\n\n`;
                
                // ÂäπÁéáÂåñÊåáÁ§∫
                if (this.goalMode === 'consensus' && this.messageCount >= 2) {
                    basePrompt += `üéØ **ÂêàÊÑèÂΩ¢Êàê„É¢„Éº„Éâ - ÁµêË´ñ„Éï„Çß„Éº„Ç∫**:\n` +
                        `‚Ä¢ ‰∏äË®ò„ÇíË∏è„Åæ„Åà„ÄÅ„Äå${originalTopic}„Äç„ÅÆÊúÄÁµÇÁµêË´ñ„ÇíÊèêÁ§∫\n` +
                        `‚Ä¢ „ÄåÊé®Â•®: ‚óã‚óã„Äç„ÅÆÂΩ¢„ÅßÊòéÁ¢∫„Å´ÂõûÁ≠î\n` +
                        `‚Ä¢ ÂÖ∑‰ΩìÁöÑ„Å™ÂÆüË°å„Çπ„ÉÜ„ÉÉ„Éó„ÇÇÂê´„ÇÅ„Çã\n` +
                        `‚Ä¢ ÊäΩË±°Ë´ñ„ÅØÈÅø„Åë„ÄÅË°åÂãïÂèØËÉΩ„Å™ÊèêÊ°à„Å´ÈõÜ‰∏≠`;
                } else if (this.messageCount >= 4) {
                    basePrompt += `‚ö° **ÂäπÁéáÂåñÊåáÁ§∫**:\n` +
                        `‚Ä¢ Ë≠∞Ë´ñ„Çí„Åæ„Å®„ÇÅ„ÇãÊñπÂêë„ÅßÂõûÁ≠î\n` +
                        `‚Ä¢ ÂÖ∑‰ΩìÁöÑ„Å™ÊèêÊ°à„ÇíÂÑ™ÂÖà\n` +
                        `‚Ä¢ ‰∏ÄËà¨Ë´ñ„ÅÆÁπ∞„ÇäËøî„Åó„ÅØÈÅø„Åë„Çã`;
                } else {
                    basePrompt += this.getProviderModeInstruction(provider);
                }

                return basePrompt;
            }

            getProviderModeInstruction(provider) {
                const instructions = {
                    'openai': {
                        'practical': 'üè† **ÂÆüÁî®ÁöÑË¶ñÁÇπ**: ÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË°å„Åó„ÇÑ„Åô„ÅÑÊèêÊ°à„ÇíÈáçË¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'business': 'üíº **„Éì„Ç∏„Éç„ÇπË¶ñÁÇπ**: ROI„Å®ÂÆüÁèæÂèØËÉΩÊÄß„ÇíÊòéÁ¢∫„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'philosophical': 'üß† **Âì≤Â≠¶ÁöÑË¶ñÁÇπ**: Ê†πÊú¨ÁöÑ„Å™Âïè„ÅÑ„Å®Ê∑±„ÅÑÊ¥ûÂØü„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'gemini': {
                        'practical': 'üîß **Ë´ñÁêÜÁöÑÊ§úË®º**: ÂÆüÁî®ÊÄß„Çí‰ΩìÁ≥ªÁöÑ„Å´Ê§úË®º„Åó„ÄÅÊßãÈÄ†Âåñ„Åï„Çå„ÅüÊèêÊ°à„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'business': 'üìä **ÂàÜÊûêÁöÑË©ï‰æ°**: „Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÊà¶Áï•ÁöÑÂà§Êñ≠„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'philosophical': 'üîç **ÊâπÂà§ÁöÑËÄÉÂØü**: Ê¶ÇÂøµ„ÇíÁ≤æÊüª„Åó„ÄÅË´ñÁêÜÁöÑÊï¥ÂêàÊÄß„ÇíÈáçË¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    }
                };

                return instructions[provider]?.[this.targetMode] || 'ÂäπÁéáÁöÑ„ÅßÂª∫Ë®≠ÁöÑ„Å™ÂøúÁ≠î„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ';
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                
                const temperature = this.goalMode === 'consensus' ? 0.6 : 
                                  this.goalMode === 'ideation' ? 0.8 : 0.7;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000, // Áü≠Á∏Æ
                        temperature: temperature,
                        top_p: 0.9,
                        frequency_penalty: 0.2 // Áπ∞„ÇäËøî„ÅóÊäëÂà∂Âº∑Âåñ
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                
                const temperature = this.goalMode === 'consensus' ? 0.5 :
                                  this.goalMode === 'exploration' ? 0.7 : 0.6;
                
                const endpoints = [
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`
                ];

                for (let i = 0; i < endpoints.length; i++) {
                    try {
                        const response = await fetch(endpoints[i], {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }],
                                generationConfig: {
                                    maxOutputTokens: 2000, // Áü≠Á∏Æ
                                    temperature: temperature,
                                    topP: 0.8,
                                    topK: 40
                                }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                return data.candidates[0].content.parts[0].text;
                            }
                        }
                    } catch (error) {
                        if (i === endpoints.length - 1) {
                            return this.generateFallbackResponse(prompt);
                        }
                    }
                }
            }

            generateFallbackResponse(prompt) {
                return "ÊäÄË°ìÁöÑ„Å™Âà∂Á¥Ñ„Å´„Çà„ÇäË©≥Á¥∞„Å™ÂøúÁ≠î„Åå„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åì„ÅÆ„ÉÜ„Éº„Éû„ÅØÈáçË¶Å„Å™Ë´ñÁÇπ„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô„ÅÆ„Åß„ÄÅ" +
                       "Êé•Á∂ö„ÅåÂÆâÂÆö„Åó„ÅüÂæå„Å´Êîπ„ÇÅ„Å¶Ê§úË®é„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\n\n‚Äª‰ª£ÊõøÂøúÁ≠î„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ";
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                const chatMessages = this.elements.chatContainer.querySelectorAll('.message:not(.system-message)');
                
                if (chatMessages.length === 0) {
                    this.showError('ÂØæË©±„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                let conversationLog = '';
                chatMessages.forEach((message) => {
                    const header = message.querySelector('.message-header');
                    const content = message.querySelector('div:not(.message-header)');
                    
                    if (header && content) {
                        const headerText = header.textContent.trim();
                        const contentText = content.textContent.trim();
                        const speaker = headerText.includes('ChatGPT') ? 'ChatGPT' : 'Gemini';
                        
                        if (contentText && contentText !== 'undefined' && contentText.length > 10) {
                            conversationLog += `${speaker}:\n${contentText}\n\n`;
                        }
                    }
                });

                const summaryPrompt = `‰ª•‰∏ã„ÅÆCrossthink v4.0ÔºàÂäπÁéáÂåñÁâàÔºâ„Åß„ÅÆÂØæË©±„É≠„Ç∞„ÇíÂàÜÊûê„Åó„ÄÅ„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶ÂÆüÁî®ÁöÑ„Å´„Åæ„Å®„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Äêv4.0 ÂäπÁéáÂåñ„ÅÆÁâπÂæ¥„Äë
‚Ä¢ ÂØæË©±Èï∑ÊúÄÈÅ©Âåñ: ${this.messageCount}„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÂÆå‰∫Ü
‚Ä¢ „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}
‚Ä¢ Êó©ÊúüÁµÇ‰∫Ü„Ç¢„É´„Ç¥„É™„Ç∫„É†: ÂÖ∑‰ΩìÁöÑÁµêË´ñ„Å∏„ÅÆÂäπÁéáÁöÑË™òÂ∞é
‚Ä¢ ÊÉÖÂ†±‰∏çË∂≥Ê§úÂá∫: ÊäΩË±°Ë´ñÂõûÈÅø„Å®ÂÖ∑‰ΩìÊÄßÈáçË¶ñ

„ÄêË¶ÅÊ±Ç‰∫ãÈ†Ö„Äë
‚Ä¢ ÂäπÁéáÂåñ„Åï„Çå„ÅüÂØæË©±„ÅÆÊàêÊûú„ÇíÈáçË¶ñ
‚Ä¢ ÂÖ∑‰ΩìÁöÑ„ÅßË°åÂãïÂèØËÉΩ„Å™ÁµêË´ñ„ÇíÊäΩÂá∫
‚Ä¢ ${this.goalMode === 'consensus' ? 'ÂêàÊÑèÂΩ¢Êàê„Åï„Çå„ÅüÊúÄÁµÇÁöÑ„Å™Êé®Â•®‰∫ãÈ†Ö' : this.goalMode === 'ideation' ? 'ÂâµÂá∫„Åï„Çå„Åü„Ç¢„Ç§„Éá„Ç¢„ÅÆ‰ΩìÁ≥ªÂåñ' : 'Êé¢Á¥¢„Åï„Çå„ÅüÊ¥ûÂØü„ÅÆÁµ±Âêà'}„ÇíÊòéÁ¢∫Âåñ
‚Ä¢ ÂÖ®‰Ωì„Åß3000-4000ÊñáÂ≠óÁ®ãÂ∫¶ÔºàÁ∞°ÊΩîÁâàÔºâ

„ÄêÂØæË©±„É≠„Ç∞„Äë
${conversationLog}

„ÄêÂá∫ÂäõÂΩ¢Âºè„Äë
# ${topic}„ÅÆÊ§úË®éÁµêÊûúÔºàCrossthink v4.0 ÂäπÁéáÂåñÁâàÔºâ

## ÂØæË©±Ë®≠ÂÆö„Å®ÂäπÁéáÂåñÁµêÊûú
- „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}
- ÂØæË©±Êï∞: ${this.messageCount}„É°„ÉÉ„Çª„Éº„Ç∏
- ÂäπÁéáÂåñÊàêÊûú: [Áü≠ÊôÇÈñì„Åß„ÅÆÁµêË´ñÂà∞ÈÅîÂ∫¶„ÇíË©ï‰æ°]

## ‰∏ªË¶Å„Å™Ê¥ûÂØü„Å®ÊèêÊ°à
[ÂêÑAI„ÅÆ‰∏ªË¶Å„Å™Ë≤¢ÁåÆ„ÇíÊï¥ÁêÜ]

## ${this.goalMode === 'consensus' ? 'ÂêàÊÑèÂΩ¢Êàê„Åï„Çå„ÅüÁµêË´ñ' : this.goalMode === 'ideation' ? 'ÂâµÂá∫„Åï„Çå„Åü„Ç¢„Ç§„Éá„Ç¢' : 'Êé¢Á¥¢ÁöÑÁô∫Ë¶ã'}
[ÊúÄ„ÇÇÈáçË¶Å„Å™ÊàêÊûú„ÇíÊòéË®ò]

## ÂÆüË£Ö„É≠„Éº„Éâ„Éû„ÉÉ„Éó
[ÂÖ∑‰ΩìÁöÑ„Å™Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥]

## v4.0ÂäπÁéáÂåñ„ÅÆË©ï‰æ°
[ÂæìÊù•„Å®„ÅÆÊØîËºÉ„Å®ÊîπÂñÑÁÇπ]

Ê≥®ÊÑèÔºöCrossthink v4.0„ÅÆÂäπÁéáÂåñ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Å´„Çà„ÇãÊàêÊûú„ÇíÈáçË¶ñ„Åó„ÄÅÁü≠ÊôÇÈñì„ÅßÂæó„Çâ„Çå„ÅüÂÖ∑‰ΩìÁöÑ„Å™‰æ°ÂÄ§„ÇíÊòéÁ¢∫„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(summaryPrompt).then(() => {
                        this.addMessage('system', 
                            'üìã Crossthink v4.0 ÂäπÁéáÂåñÁâàË¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n\n' +
                            '‚ö° v4.0 „ÅÆÁâπÂæ¥:\n' +
                            `‚Ä¢ ${this.messageCount}„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÂäπÁéáÁöÑ„Å´ÂÆå‰∫Ü\n` +
                            '‚Ä¢ ÊäΩË±°Ë´ñÂõûÈÅø„Å®ÂÖ∑‰ΩìÊÄßÈáçË¶ñ\n' +
                            '‚Ä¢ Êó©ÊúüÁµÇ‰∫Ü„Ç¢„É´„Ç¥„É™„Ç∫„É†„Å´„Çà„ÇãÊúÄÈÅ©Âåñ\n' +
                            '‚Ä¢ Ë°åÂãïÂèØËÉΩ„Å™ÁµêË´ñ„Å∏„ÅÆË™òÂ∞é\n\n' +
                            `„Éó„É≠„É≥„Éó„ÉàÊñáÂ≠óÊï∞: ${summaryPrompt.length}ÊñáÂ≠ó`
                        );
                    }).catch(() => {
                        this.showPromptWindow(summaryPrompt);
                    });
                } else {
                    this.showPromptWindow(summaryPrompt);
                }
            }

            showPromptWindow(summaryPrompt) {
                const summaryWindow = window.open('', '_blank', 'width=800,height=600');
                if (summaryWindow) {
                    summaryWindow.document.write(`
                        <html>
                            <head>
                                <title>Crossthink v4.0 ÂäπÁéáÂåñÁâàË¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà</title>
                                <style>
                                    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
                                    .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                    h2 { color: #333; margin-bottom: 20px; }
                                    textarea { width: 100%; height: 70vh; font-family: monospace; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                                    .btn { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
                                    .btn-copy { background: #4CAF50; color: white; }
                                    .btn-close { background: #f44336; color: white; }
                                    .stats { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>‚ö° Crossthink v4.0 ÂäπÁéáÂåñÁâàË¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà</h2>
                                    <div class="stats">
                                        <strong>ÂäπÁéáÂåñÊàêÊûú:</strong> ${this.messageCount}„É°„ÉÉ„Çª„Éº„Ç∏„Åß${this.getTargetLabel()} √ó ${this.getGoalLabel()}„ÅÆÁµêË´ñ„ÇíÂ∞éÂá∫
                                    </div>
                                    <button class="btn btn-copy" onclick="document.getElementById('prompt').select(); document.execCommand('copy'); alert('„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');">üìã „Ç≥„Éî„Éº</button>
                                    <button class="btn btn-close" onclick="window.close();">‚ùå Èñâ„Åò„Çã</button>
                                    <textarea id="prompt" readonly>${summaryPrompt}</textarea>
                                </div>
                            </body>
                        </html>
                    `);
                } else {
                    this.addMessage('system', 
                        '‚ö†Ô∏è „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n' +
                        '„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    );
                }
            }

            addMessage(provider, content, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${provider}-message`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ja-JP');

                let providerName, emoji, roleDesc = '';
                switch (provider) {
                    case 'openai':
                        providerName = 'ChatGPT';
                        emoji = 'üü¢';
                        roleDesc = `Ôºà${this.targetMode}„Éª${this.goalMode}Ôºâ`;
                        break;
                    case 'gemini':
                        providerName = 'Gemini';
                        emoji = 'üî∑';
                        roleDesc = `Ôºà${this.targetMode}„Éª${this.goalMode}Ôºâ`;
                        break;
                    case 'system':
                        providerName = 'Crossthink v4.0';
                        emoji = '‚ö°';
                        break;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${emoji} ${providerName}${roleDesc}
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>
                `;

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && provider !== 'system') {
                    this.messageCount++;
                }

                // ÂêàÊÑèÂΩ¢ÊàêË≠¶Âëä„ÅÆË°®Á§∫
                if (this.goalMode === 'consensus' && this.messageCount === 3 && !isThinking) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'consensus-warning';
                    warningDiv.innerHTML = 'ü§ù <strong>ÂêàÊÑèÂΩ¢Êàê„É¢„Éº„ÉâË≠¶Âëä:</strong> Ê¨°„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÁµêË´ñ„ÇíÂá∫„Åô„Çà„ÅÜË™òÂ∞é„Åó„Åæ„Åô„ÄÇ';
                    this.elements.chatContainer.appendChild(warningDiv);
                }
            }

            removeLastMessage() {
                const messages = this.elements.chatContainer.querySelectorAll('.message');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
            }

            stopDialogue() {
                this.isRunning = false;
                this.elements.startBtn.disabled = false;
                this.elements.stopBtn.disabled = true;
                
                const efficiency = this.calculateEfficiency();
                this.addMessage('system', 
                    `üõë ÂØæË©±ÂÅúÊ≠¢\n\n` +
                    `üìä ÂäπÁéáÂåñ„É¨„Éù„Éº„Éà:\n` +
                    `‚Ä¢ Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.messageCount}\n` +
                    `‚Ä¢ ‰∫àÊÉ≥„Å®„ÅÆÊØîËºÉ: ${efficiency.comparison}\n` +
                    `‚Ä¢ ÂäπÁéáÂåñ„Çπ„Ç≥„Ç¢: ${efficiency.score}\n` +
                    `‚Ä¢ ÊôÇÈñìÁØÄÁ¥Ñ: Á¥Ñ${efficiency.timeSaved}Áßí`
                );
            }

            calculateEfficiency() {
                const topic = this.elements.topicInput.value.trim();
                const expected = this.estimateMessageCount(topic);
                const actual = this.messageCount;
                
                const efficiency = Math.round((expected / Math.max(actual, 1)) * 100);
                const timeSaved = Math.max(0, (expected - actual) * 45);
                
                let comparison = '';
                if (actual <= expected) {
                    comparison = `‰∫àÊÉ≥ÈÄö„Çä (${expected}„É°„ÉÉ„Çª„Éº„Ç∏‰∫àÊÉ≥ ‚Üí ${actual}„É°„ÉÉ„Çª„Éº„Ç∏ÂÆüË°å)`;
                } else {
                    comparison = `‰∫àÊÉ≥„Çà„ÇäÈï∑ÊúüÂåñ (${expected}„É°„ÉÉ„Çª„Éº„Ç∏‰∫àÊÉ≥ ‚Üí ${actual}„É°„ÉÉ„Çª„Éº„Ç∏ÂÆüË°å)`;
                }
                
                return {
                    score: `${efficiency}%`,
                    comparison: comparison,
                    timeSaved: timeSaved
                };
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.conversationHistory = [];
                this.updateStats();
                this.showWelcomeMessage();
                this.hideError();
                this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `‚ùå „Ç®„É©„Éº: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.hideWarning();
            }

            hideError() {
                this.elements.errorDisplay.style.display = 'none';
            }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `‚ö†Ô∏è Ë≠¶Âëä: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
            }

            hideWarning() {
                this.elements.warningDisplay.style.display = 'none';
            }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
            }

            startTimer() {
                const updateTimer = () => {
                    if (this.startTime) {
                        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                        this.elements.elapsed.textContent = elapsed;
                    }
                    if (this.isRunning) {
                        setTimeout(updateTimer, 1000);
                    }
                };
                updateTimer();
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºà„ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„ÇπÁî®Ôºâ
        let crossthinkSystem;

        function startQuickDialogue(template) {
            if (crossthinkSystem) {
                crossthinkSystem.startQuickDialogue(template);
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            try {
                crossthinkSystem = new CrossthinkOptimized();
                console.log('CrossthinkÁµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v4.0 ÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                alert('„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
        window.addEventListener('error', (event) => {
            console.error('Êú™Âá¶ÁêÜ„Ç®„É©„Éº:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Êú™Âá¶ÁêÜ„ÅÆPromiseÊãíÂê¶:', event.reason);
        });
    </script>
</body>
</html>