<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  - AIå¯¾è©±ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        /* æ–°æ©Ÿèƒ½: ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .mode-selection {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .quick-access {
            margin-bottom: 30px;
        }

        .quick-access h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .mode-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .mode-selector h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .mode-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .mode-slider {
            flex: 1;
            margin: 0 20px;
            position: relative;
        }

        .slider-track {
            height: 8px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            border-radius: 4px;
            position: relative;
        }

        .slider-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            position: absolute;
            top: -6px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .slider-thumb:hover {
            transform: scale(1.2);
        }

        .mode-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .selected-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "ğŸŸ¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "ğŸ”·";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "ğŸ’°";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-row {
                flex-direction: column;
                gap: 10px;
            }

            .mode-slider {
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p>AIå”åƒã«ã‚ˆã‚‹æ€è€ƒã®æ˜Ÿåº§ - å®Ÿç”¨ã‹ã‚‰å“²å­¦ã¾ã§</p>
            <div class="demo-label">
                ğŸš€ çµ±åˆç‰ˆ v3.0 - å…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
            </div>
        </div>

        <!-- æ–°æ©Ÿèƒ½: ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="mode-selection">
            <div class="quick-access">
                <h3>ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚ˆãä½¿ã†å¯¾è©±ï¼‰</h3>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="startQuickDialogue('ä»Šæ—¥ã®æ™©å¾¡é£¯')">
                        ğŸ½ï¸ ä»Šæ—¥ã®æ™©å¾¡é£¯
                        <br><small>å®Ÿç”¨çš„ãƒ»åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('ä»•äº‹ã®ç›¸è«‡')">
                        ğŸ’¼ ä»•äº‹ã®ç›¸è«‡
                        <br><small>ãƒ“ã‚¸ãƒã‚¹ãƒ»æ¡ˆå‡ºã—ãƒ¢ãƒ¼ãƒ‰</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('è²·ã„ç‰©ãƒªã‚¹ãƒˆ')">
                        ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ
                        <br><small>å®Ÿç”¨çš„ãƒ»åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰</small>
                    </button>
                    <button class="quick-btn" onclick="startQuickDialogue('äººç”Ÿã«ã¤ã„ã¦')">
                        ğŸ¤” äººç”Ÿã«ã¤ã„ã¦
                        <br><small>å“²å­¦çš„ãƒ»æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰</small>
                    </button>
                </div>
            </div>

            <div class="mode-selector">
                <h3>ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ å¯¾è©±è¨­å®š</h3>
                
                <div class="mode-row">
                    <span><strong>ã©ã‚“ãªå¯¾è©±ï¼Ÿ</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="targetSlider" style="left: 33%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>ğŸ  å®Ÿç”¨çš„</span>
                            <span>ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹</span>
                            <span>ğŸ§  å“²å­¦çš„</span>
                        </div>
                    </div>
                </div>

                <div class="mode-row">
                    <span><strong>ä½•ãŒç›®æ¨™ï¼Ÿ</strong></span>
                    <div class="mode-slider">
                        <div class="slider-track">
                            <div class="slider-thumb" id="goalSlider" style="left: 50%;"></div>
                        </div>
                        <div class="mode-labels">
                            <span>ğŸ’¡ æ¡ˆå‡ºã—</span>
                            <span>ğŸ¤ åˆæ„å½¢æˆ</span>
                            <span>ğŸ” æ¢ç´¢</span>
                        </div>
                    </div>
                </div>

                <div class="selected-mode" id="selectedMode">
                    ğŸ¯ é¸æŠä¸­: å®Ÿç”¨çš„ Ã— åˆæ„å½¢æˆãƒ¢ãƒ¼ãƒ‰
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>ğŸ”§ APIè¨­å®š</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>ğŸ“ å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯:</h2>
            <input type="text" id="topicInput" class="topic-input" 
                   placeholder="è‡ªç”±ã«ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" 
                   value="">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">ğŸš€ å¯¾è©±é–‹å§‹</button>
                <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢</button>
                <button id="clearBtn" class="btn btn-secondary">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                <button id="exportBtn" class="btn btn-secondary">ğŸ“ è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>ğŸ“Š å¯¾è©±çµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTç™ºè¨€</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">Geminiç™ºè¨€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">çµŒéæ™‚é–“(ç§’)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>ğŸŒŸ Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ç‰¹å¾´:</h3>
            <ul>
                <li>çµ±ä¸€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: 1ã¤ã®ã‚¢ãƒ—ãƒªã§å…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ</li>
                <li>é©å¿œå‹AI: æ–‡è„ˆã«å¿œã˜ãŸæœ€é©ãªå¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«</li>
                <li>å­¦ç¿’æ©Ÿèƒ½: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã‚’è‡ªå‹•åˆ¤å®š</li>
                <li>ã‚¯ãƒ­ã‚¹ã‚»ãƒ«åŠ¹æœ: å®Ÿç”¨â†’å“²å­¦â†’ãƒ“ã‚¸ãƒã‚¹ã®è‡ªç„¶ãªæµã‚Œ</li>
                <li>ãƒ‡ãƒ¼ã‚¿çµ±åˆ: å…¨ãƒ¢ãƒ¼ãƒ‰ã§ã®å­¦ç¿’åŠ¹æœæœ€å¤§åŒ–</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- å¯¾è©±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        class CrossthinkUnified {
            constructor() {
                this.isRunning = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 20;
                this.interventionPoints = [6, 12, 18];
                
                // ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                this.targetMode = 'practical'; // practical, business, philosophical
                this.goalMode = 'consensus';   // ideation, consensus, exploration
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeModeSliders();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    elapsed: document.getElementById('elapsed'),
                    selectedMode: document.getElementById('selectedMode'),
                    targetSlider: document.getElementById('targetSlider'),
                    goalSlider: document.getElementById('goalSlider')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
            }

            initializeModeSliders() {
                this.initializeSlider('targetSlider', (value) => {
                    if (value < 33) this.targetMode = 'practical';
                    else if (value < 66) this.targetMode = 'business';
                    else this.targetMode = 'philosophical';
                    this.updateSelectedMode();
                });

                this.initializeSlider('goalSlider', (value) => {
                    if (value < 33) this.goalMode = 'ideation';
                    else if (value < 66) this.goalMode = 'consensus';
                    else this.goalMode = 'exploration';
                    this.updateSelectedMode();
                });

                this.updateSelectedMode();
            }

            initializeSlider(sliderId, callback) {
                const slider = this.elements[sliderId];
                const track = slider.parentElement;
                let isDragging = false;

                slider.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const rect = track.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                    
                    slider.style.left = percentage + '%';
                    callback(percentage);
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            updateSelectedMode() {
                const targetLabels = {
                    'practical': 'ğŸ  å®Ÿç”¨çš„',
                    'business': 'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹',
                    'philosophical': 'ğŸ§  å“²å­¦çš„'
                };

                const goalLabels = {
                    'ideation': 'ğŸ’¡ æ¡ˆå‡ºã—',
                    'consensus': 'ğŸ¤ åˆæ„å½¢æˆ',
                    'exploration': 'ğŸ” æ¢ç´¢'
                };

                this.elements.selectedMode.textContent = 
                    `ğŸ¯ é¸æŠä¸­: ${targetLabels[this.targetMode]} Ã— ${goalLabels[this.goalMode]}ãƒ¢ãƒ¼ãƒ‰`;
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã‚ˆã†ã“ãï¼\n\n' +
                    'ğŸŒŸ æ–°æ©Ÿèƒ½:\n' +
                    'â€¢ ğŸ“± ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: ã‚ˆãä½¿ã†å¯¾è©±ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯\n' +
                    'â€¢ ğŸ¯ ãƒ¢ãƒ¼ãƒ‰é¸æŠ: å®Ÿç”¨çš„ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ»å“²å­¦çš„\n' +
                    'â€¢ ğŸª ã‚´ãƒ¼ãƒ«è¨­å®š: æ¡ˆå‡ºã—ãƒ»åˆæ„å½¢æˆãƒ»æ¢ç´¢\n' +
                    'â€¢ ğŸ§  é©å¿œå‹AI: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¿œã˜ãŸæœ€é©åŒ–\n\n' +
                    'ğŸ’¡ ä½¿ã„æ–¹:\n' +
                    '1. ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§å³åº§ã«é–‹å§‹ã€ã¾ãŸã¯\n' +
                    '2. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º\n' +
                    '3. ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦å¯¾è©±é–‹å§‹\n\n' +
                    'ğŸ¯ ãƒãƒã‚¿ã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ:\n' +
                    'ğŸ“ˆ çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã‚‹é–‹ç™ºåŠ¹ç‡åŒ–\n' +
                    'ğŸ“ ã‚¯ãƒ­ã‚¹ã‚»ãƒ«ã«ã‚ˆã‚‹åç›Šæœ€å¤§åŒ–\n' +
                    'ğŸ’¡ å…¨ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®æ±ç”¨æ€§\n' +
                    'ğŸ”¬ çµ±åˆãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹å­¦ç¿’åŠ¹æœæœ€å¤§åŒ–'
                );
            }

            startQuickDialogue(template) {
                const quickModes = {
                    'ä»Šæ—¥ã®æ™©å¾¡é£¯': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: 'ä»Šæ—¥ã®æ™©å¾¡é£¯ã«ã¤ã„ã¦ã€å†·è”µåº«ã«ã‚ã‚‹é£Ÿæã‚„äºˆç®—ã‚’è€ƒæ…®ã—ã¦æ±ºã‚ãŸã„'
                    },
                    'ä»•äº‹ã®ç›¸è«‡': {
                        target: 'business',
                        goal: 'ideation',
                        topic: 'ä»•äº‹ä¸Šã®èª²é¡Œã«ã¤ã„ã¦åŠ¹æœçš„ãªè§£æ±ºç­–ã‚’ãƒ–ãƒ¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°ã—ãŸã„'
                    },
                    'è²·ã„ç‰©ãƒªã‚¹ãƒˆ': {
                        target: 'practical',
                        goal: 'consensus',
                        topic: 'å¿…è¦ãªè²·ã„ç‰©ãƒªã‚¹ãƒˆã‚’æ•´ç†ã—ã¦å„ªå…ˆé †ä½ã‚’ã¤ã‘ãŸã„'
                    },
                    'äººç”Ÿã«ã¤ã„ã¦': {
                        target: 'philosophical',
                        goal: 'exploration',
                        topic: 'äººç”Ÿã®æ„å‘³ã‚„è‡ªåˆ†ã®ä¾¡å€¤è¦³ã«ã¤ã„ã¦æ·±ãè€ƒãˆã¦ã¿ãŸã„'
                    }
                };

                const mode = quickModes[template];
                if (mode) {
                    this.targetMode = mode.target;
                    this.goalMode = mode.goal;
                    this.elements.topicInput.value = mode.topic;
                    this.updateSelectedMode();
                    
                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä½ç½®ã‚‚æ›´æ–°
                    this.updateSliderPositions();
                    
                    this.addMessage('system', 
                        `ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹: "${template}"\n` +
                        `ğŸ¯ ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                        `ğŸ“ æ¨å¥¨ãƒˆãƒ”ãƒƒã‚¯è¨­å®šå®Œäº†`
                    );
                }
            }

            updateSliderPositions() {
                const targetPositions = { 'practical': 16, 'business': 50, 'philosophical': 83 };
                const goalPositions = { 'ideation': 16, 'consensus': 50, 'exploration': 83 };
                
                this.elements.targetSlider.style.left = targetPositions[this.targetMode] + '%';
                this.elements.goalSlider.style.left = goalPositions[this.goalMode] + '%';
            }

            getTargetLabel() {
                const labels = {
                    'practical': 'ğŸ  å®Ÿç”¨çš„',
                    'business': 'ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹',
                    'philosophical': 'ğŸ§  å“²å­¦çš„'
                };
                return labels[this.targetMode];
            }

            getGoalLabel() {
                const labels = {
                    'ideation': 'ğŸ’¡ æ¡ˆå‡ºã—',
                    'consensus': 'ğŸ¤ åˆæ„å½¢æˆ',
                    'exploration': 'ğŸ” æ¢ç´¢'
                };
                return labels[this.goalMode];
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                
                this.elements.startBtn.disabled = true;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                this.addMessage('system', 
                    `ğŸ¯ å¯¾è©±é–‹å§‹\n` +
                    `ğŸ“ ãƒˆãƒ”ãƒƒã‚¯: "${topic}"\n` +
                    `ğŸª ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}\n` +
                    `ğŸš€ é©å¿œå‹AIãŒæœ€é©ãªå¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ã§é€²è¡Œã—ã¾ã™ï¼`
                );

                this.startTimer();

                // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸåˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                const initialPrompt = this.generateModeSpecificPrompt(topic);
                await this.sendMessage('openai', initialPrompt);
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `å®Ÿç”¨çš„ãªè§£æ±ºç­–ã®ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€å…·ä½“çš„ã§å®Ÿè¡Œã—ã‚„ã™ã„è¤‡æ•°ã®é¸æŠè‚¢ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚`,
                    'practical-consensus': `ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€ç¾å®Ÿçš„ã§å®Ÿè¡Œå¯èƒ½ãªæœ€é©è§£ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®è­°è«–ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚åˆ¶ç´„æ¡ä»¶ã‚‚è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚`,
                    'practical-exploration': `ã€Œ${topic}ã€ã®å®Ÿç”¨çš„ãªå´é¢ã«ã¤ã„ã¦ã€æ§˜ã€…ãªè§’åº¦ã‹ã‚‰æ¤œè¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚éš ã‚ŒãŸèª²é¡Œã‚„æ©Ÿä¼šã‚‚æ¢ã£ã¦ãã ã•ã„ã€‚`,
                    
                    'business-ideation': `ãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹ã‹ã‚‰ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€é©æ–°çš„ã§ä¾¡å€¤å‰µé€ ã«ã¤ãªãŒã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ãƒ–ãƒ¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°ã—ã¾ã—ã‚‡ã†ã€‚`,
                    'business-consensus': `ã€Œ${topic}ã€ã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ã«ã¤ã„ã¦ã€ROIã‚„å®Ÿç¾å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ãŸæœ€é©è§£ã‚’å°ãå‡ºã—ã¾ã—ã‚‡ã†ã€‚`,
                    'business-exploration': `ã€Œ${topic}ã€ã®ãƒ“ã‚¸ãƒã‚¹çš„ãªå¯èƒ½æ€§ã«ã¤ã„ã¦ã€å¸‚å ´å‹•å‘ã‚„ç«¶åˆåˆ†æã‚‚å«ã‚ã¦å¤šè§’çš„ã«æ¢ç©¶ã—ã¾ã—ã‚‡ã†ã€‚`,
                    
                    'philosophical-ideation': `ã€Œ${å†è©¦è¡ŒMç¶šã‘ã‚‹ç·¨é›†topic}ã€ã«ã¤ã„ã¦ã€å“²å­¦çš„ãªè¦–ç‚¹ã‹ã‚‰æ ¹æœ¬çš„ãªå•ã„ã‚„æ–°ã—ã„æ€è€ƒã®æ çµ„ã¿ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚,                     'philosophical-consensus': ã€Œ${topic}ã€ã®æœ¬è³ªã«ã¤ã„ã¦ã€è«–ç†çš„ãªæ¤œè¨ã‚’é€šã˜ã¦æ·±ã„ç†è§£ã«åˆ°é”ã—ã¾ã—ã‚‡ã†ã€‚,                     'philosophical-exploration': ã€Œ${topic}ã€ã«ã¤ã„ã¦ã€æ—¢å­˜ã®å‰æã‚’ç–‘ã„ã€æ ¹æºçš„ãªæ¢ç©¶ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚äººé–“å­˜åœ¨ã‚„ä¾¡å€¤è¦³ã®è¦³ç‚¹ã‹ã‚‰ã‚‚è€ƒå¯Ÿã—ã¦ãã ã•ã„ã€‚`
};
            const key = `${this.targetMode}-${this.goalMode}`;
            return modePrompts[key] || `ã€Œ${topic}ã€ã«ã¤ã„ã¦å¯¾è©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚`;
        }

        validateInputs() {
            const openaiKey = this.elements.openaiKey.value.trim();
            const geminiKey = this.elements.geminiKey.value.trim();
            const topic = this.elements.topicInput.value.trim();

            if (!openaiKey) {
                this.showError('OpenAI API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }

            if (!geminiKey) {
                this.showError('Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }

            if (!topic) {
                this.showError('å¯¾è©±ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }

            return true;
        }

        async sendMessage(provider, prompt) {
            if (!this.isRunning) return;

            try {
                this.addMessage(provider, 'æ€è€ƒä¸­...', true);
                
                let response;
                if (provider === 'openai') {
                    response = await this.callOpenAI(prompt);
                    this.openaiCount++;
                } else {
                    response = await this.callGemini(prompt);
                    this.geminiCount++;
                }

                this.removeLastMessage();
                this.addMessage(provider, response);
                this.conversationHistory.push({ provider, message: response });
                this.updateStats();

                // ã‚·ã‚¹ãƒ†ãƒ ä»‹å…¥ãƒã‚§ãƒƒã‚¯
                if (this.interventionPoints.includes(this.messageCount)) {
                    this.addSystemIntervention();
                }

                // æ¬¡ã®AIã«å¿œç­”ã•ã›ã‚‹
                if (this.isRunning && this.messageCount < this.maxMessages) {
                    setTimeout(() => {
                        const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                        const nextPrompt = this.generateNextPrompt(nextProvider, response);
                        this.sendMessage(nextProvider, nextPrompt);
                    }, 2500);
                } else if (this.messageCount >= this.maxMessages) {
                    this.addMessage('system', 'ğŸ‰ å¯¾è©±ãŒå®Œäº†ã—ã¾ã—ãŸï¼æœ€å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«é”ã—ãŸãŸã‚çµ‚äº†ã—ã¾ã™ã€‚');
                    this.stopDialogue();
                }

            } catch (error) {
                this.removeLastMessage();
                this.showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                console.error('API Error:', error);
            }
        }

        addSystemIntervention() {
            const originalTopic = this.elements.topicInput.value.trim();
            let interventionMessage = '';

            const modeContext = `ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}`;

            switch (this.messageCount) {
                case 6:
                    interventionMessage = `ğŸ¯ **ç¬¬1æ®µéšä»‹å…¥** (${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›®)\n\n` +
                        `${modeContext}\n` +
                        `å…ƒã®ãƒˆãƒ”ãƒƒã‚¯: "${originalTopic}"\n\n` +
                        this.getModeSpecificIntervention(1);
                    break;
                case 12:
                    interventionMessage = `ğŸ”„ **ç¬¬2æ®µéšä»‹å…¥** (${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›®)\n\n` +
                        `${modeContext}\n\n` +
                        this.getModeSpecificIntervention(2);
                    break;
                case 18:
                    interventionMessage = `ğŸ **æœ€çµ‚æ®µéšä»‹å…¥** (${this.messageCount}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›®)\n\n` +
                        `${modeContext}\n\n` +
                        this.getModeSpecificIntervention(3) +
                        `\nâ€¢ å…ƒã®ãƒ†ãƒ¼ãƒã€Œ${originalTopic}ã€ã¸ã®æœ€çµ‚çš„ãªç­”ãˆ`;
                    break;
            }

            this.addMessage('system', interventionMessage);
        }

        getModeSpecificIntervention(stage) {
            const interventions = {
                'practical': {
                    1: 'ğŸ’¡ **å®Ÿç”¨æ€§é‡è¦–ã®ç¢ºèª:**\nâ€¢ å…·ä½“çš„ãªå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’æ˜ç¢ºã«ã™ã‚‹\nâ€¢ å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚„æ™‚é–“ã‚’è€ƒæ…®ã™ã‚‹\nâ€¢ ç¾å®Ÿçš„ãªåˆ¶ç´„æ¡ä»¶ã‚’ç¢ºèªã™ã‚‹',
                    2: 'ğŸ“‹ **å®Ÿè£…å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯:**\nâ€¢ å®Ÿéš›ã®è¡Œå‹•è¨ˆç”»ã«è½ã¨ã—è¾¼ã‚€\nâ€¢ ã‚³ã‚¹ãƒˆã¨åŠ¹æœã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ¤œè¨\nâ€¢ ã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç‰¹å®šã™ã‚‹',
                    3: 'âœ… **å®Ÿç”¨çš„ã¾ã¨ã‚æº–å‚™:**\nâ€¢ å…·ä½“çš„ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æç¤º\nâ€¢ å„ªå…ˆé †ä½ä»˜ãã®å®Ÿè¡Œãƒªã‚¹ãƒˆ\nâ€¢ æœŸå¾…ã•ã‚Œã‚‹æˆæœã¨è©•ä¾¡æ–¹æ³•'
                },
                'business': {
                    1: 'ğŸ’¼ **ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã®æ˜ç¢ºåŒ–:**\nâ€¢ ROIã‚„æŠ•è³‡å¯¾åŠ¹æœã‚’æ•°å€¤åŒ–\nâ€¢ ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã¸ã®å½±éŸ¿åˆ†æ\nâ€¢ ç«¶åˆå„ªä½æ€§ã®ç¢ºèª',
                    2: 'ğŸ“Š **æˆ¦ç•¥çš„å®Ÿè¡Œè¨ˆç”»:**\nâ€¢ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¨ KPI ã®è¨­å®š\nâ€¢ ãƒªã‚¹ã‚¯è¦å› ã¨å¯¾ç­–ã®æ¤œè¨\nâ€¢ ãƒªã‚½ãƒ¼ã‚¹é…åˆ†ã®æœ€é©åŒ–',
                    3: 'ğŸ¯ **ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥ã¾ã¨ã‚:**\nâ€¢ æ¨å¥¨ã™ã‚‹æˆ¦ç•¥çš„æ–¹å‘æ€§\nâ€¢ å…·ä½“çš„ãªå®Ÿè¡Œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—\nâ€¢ æˆåŠŸæŒ‡æ¨™ã¨è©•ä¾¡åŸºæº–'
                },
                'philosophical': {
                    1: 'ğŸ§  **å“²å­¦çš„æ·±åŒ–:**\nâ€¢ æ ¹æœ¬çš„ãªå‰æã®å†æ¤œè¨\nâ€¢ ä¾¡å€¤è¦³ã‚„ä¸–ç•Œè¦³ã¨ã®æ•´åˆæ€§\nâ€¢ ã‚ˆã‚Šæ·±ã„æœ¬è³ªçš„å•ã„ã®æèµ·',
                    2: 'ğŸ” **æ¦‚å¿µçš„ç²¾ç·»åŒ–:**\nâ€¢ æ›–æ˜§ãªæ¦‚å¿µã®æ˜ç¢ºåŒ–\nâ€¢ è«–ç†çš„ä¸€è²«æ€§ã®ç¢ºèª\nâ€¢ ç•°ãªã‚‹æ€æƒ³çš„ä¼çµ±ã¨ã®å¯¾è©±',
                    3: 'ğŸ’­ **å“²å­¦çš„çµ±åˆ:**\nâ€¢ æ¢ç©¶ã®æˆæœã¨æ®‹ã•ã‚ŒãŸå•ã„\nâ€¢ ã‚ˆã‚Šå¤§ããªæ–‡è„ˆã§ã®ä½ç½®ã¥ã‘\nâ€¢ å€‹äººãƒ»ç¤¾ä¼šã¸ã®ç¤ºå”†'
                }
            };

            return interventions[this.targetMode]?.[stage] || 'â€¢ è­°è«–ã®è¦ç‚¹ã‚’æ•´ç†ã™ã‚‹\nâ€¢ ã‚ˆã‚Šæ·±ã„æ´å¯Ÿã‚’æä¾›ã™ã‚‹\nâ€¢ å»ºè¨­çš„ãªæ–¹å‘æ€§ã‚’ç¤ºã™';
        }

        async callOpenAI(prompt) {
            const apiKey = this.elements.openaiKey.value.trim();
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸtemperatureèª¿æ•´
            const temperature = this.goalMode === 'ideation' ? 0.9 : 
                              this.goalMode === 'exploration' ? 0.8 : 0.7;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 800,
                    temperature: temperature,
                    top_p: 0.9,
                    frequency_penalty: 0.1
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        async callGemini(prompt) {
            const apiKey = this.elements.geminiKey.value.trim();
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸtemperatureèª¿æ•´
            const temperature = this.goalMode === 'consensus' ? 0.6 :
                              this.goalMode === 'exploration' ? 0.7 : 0.8;
            
            const endpoints = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`
            ];

            for (let i = 0; i < endpoints.length; i++) {
                try {
                    const response = await fetch(endpoints[i], {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }],
                            generationConfig: {
                                maxOutputTokens: 800,
                                temperature: temperature,
                                topP: 0.8,
                                topK: 40
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            return data.candidates[0].content.parts[0].text;
                        }
                    }
                } catch (error) {
                    if (i === endpoints.length - 1) {
                        return this.generateFallbackResponse(prompt);
                    }
                }
            }
        }

        generateFallbackResponse(prompt) {
            const responses = [
                "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ç¾åœ¨æŠ€è¡“çš„ãªåˆ¶ç´„ã«ã‚ˆã‚Šé©åˆ‡ãªå¿œç­”ãŒã§ãã¾ã›ã‚“ã€‚èˆˆå‘³æ·±ã„ãƒˆãƒ”ãƒƒã‚¯ã§ã™ã®ã§ã€å®‰å®šã—ãŸæ¥ç¶šå¾Œã«æ”¹ã‚ã¦è­°è«–ã•ã›ã¦ã„ãŸã ããŸã„ã¨æ€ã„ã¾ã™ã€‚",
                "ã‚·ã‚¹ãƒ†ãƒ ã®å•é¡Œã«ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒã§ãã¾ã›ã‚“ãŒã€ã“ã®ãƒ†ãƒ¼ãƒã¯é‡è¦ãªè«–ç‚¹ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚æŠ€è¡“çš„å•é¡ŒãŒè§£æ±ºæ¬¡ç¬¬ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæ¤œè¨¼ã‚’è¡Œã„ãŸã„ã¨æ€ã„ã¾ã™ã€‚",
                "ç¾åœ¨ã®ç’°å¢ƒã§ã¯ååˆ†ãªæ¤œè¨ãŒã§ãã¾ã›ã‚“ãŒã€ã“ã®ã‚ˆã†ãªå­¦è¡“çš„è­°è«–ã«ã¯æœ¬æ¥ã‚‚ã£ã¨è©³ç´°ãªåˆ†æãŒå¿…è¦ã§ã™ã€‚å¾Œã»ã©æ”¹ã‚ã¦å–ã‚Šçµ„ã¾ã›ã¦ã„ãŸã ãã¾ã™ã€‚"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)] + 
                   "\n\nâ€»æŠ€è¡“çš„åˆ¶ç´„ã«ã‚ˆã‚Šä»£æ›¿å¿œç­”ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚";
        }

        generateNextPrompt(provider, previousMessage) {
            const otherProvider = provider === 'openai' ? 'Gemini' : 'ChatGPT';
            const originalTopic = this.elements.topicInput.value.trim();
            
            let basePrompt = `${otherProvider}ãŒä»¥ä¸‹ã®ã‚ˆã†ã«è¿°ã¹ã¾ã—ãŸï¼š\n\n"${previousMessage}"\n\n`;
            
            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´
            basePrompt += this.getProviderModeInstruction(provider);
            basePrompt += `\n\nå…ƒã®ãƒ†ãƒ¼ãƒã€Œ${originalTopic}ã€ã‚’è¸ã¾ãˆã€${this.getGoalLabel()}ã®è¦³ç‚¹ã‹ã‚‰å»ºè¨­çš„ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚`;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã«å¿œã˜ãŸè¿½åŠ æŒ‡ç¤º
            if (this.messageCount > 16) {
                basePrompt += `\n\nğŸ **é‡è¦**: å¯¾è©±ãŒã¾ã‚‚ãªãçµ‚äº†ã—ã¾ã™ã€‚è­°è«–ã®ã¾ã¨ã‚ã«å‘ã‘ãŸå»ºè¨­çš„ãªå¿œç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            } else if (this.messageCount > 8) {
                basePrompt += `\n\nğŸ’¡ **é‡è¦**: ã‚ˆã‚Šå…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;
            }

            return basePrompt;
        }

        getProviderModeInstruction(provider) {
            const instructions = {
                'openai': {
                    'practical': 'ğŸ  **å®Ÿç”¨çš„ãªè¦–ç‚¹**ã§ã€å…·ä½“çš„ã§å®Ÿè¡Œã—ã‚„ã™ã„ææ¡ˆã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚',
                    'business': 'ğŸ’¼ **ãƒ“ã‚¸ãƒã‚¹è¦–ç‚¹**ã§ã€ä¾¡å€¤å‰µé€ ã¨å®Ÿç¾å¯èƒ½æ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚',
                    'philosophical': 'ğŸ§  **å“²å­¦çš„ãªè¦–ç‚¹**ã§ã€æ ¹æœ¬çš„ãªå•ã„ã¨æ·±ã„æ´å¯Ÿã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚'
                },
                'gemini': {
                    'practical': 'ğŸ”§ **è«–ç†çš„ãƒ»ä½“ç³»çš„**ã«å®Ÿç”¨æ€§ã‚’æ¤œè¨¼ã—ã€æ§‹é€ åŒ–ã•ã‚ŒãŸææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚',
                    'business': 'ğŸ“Š **åˆ†æçš„ãƒ»æˆ¦ç•¥çš„**ã«ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã‚’è©•ä¾¡ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸåˆ¤æ–­ã‚’ã—ã¦ãã ã•ã„ã€‚',
                    'philosophical': 'ğŸ” **æ‰¹åˆ¤çš„ãƒ»æ¢ç©¶çš„**ã«æ¦‚å¿µã‚’ç²¾æŸ»ã—ã€è«–ç†çš„æ•´åˆæ€§ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚'
                }
            };

            return instructions[provider]?.[this.targetMode] || 'å»ºè¨­çš„ã§æœ‰ç›Šãªå¿œç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚';
        }

        generateSummaryPrompt() {
            const topic = this.elements.topicInput.value.trim();
            const chatMessages = this.elements.chatContainer.querySelectorAll('.message:not(.system-message)');
            
            if (chatMessages.length === 0) {
                this.showError('å¯¾è©±ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            let conversationLog = '';
            chatMessages.forEach((message) => {
                const header = message.querySelector('.message-header');
                const content = message.querySelector('div:not(.message-header)');
                
                if (header && content) {
                    const headerText = header.textContent.trim();
                    const contentText = content.textContent.trim();
                    const speaker = headerText.includes('ChatGPT') ? 'ChatGPT' : 'Gemini';
                    
                    if (contentText && contentText !== 'undefined' && contentText.length > 10) {
                        conversationLog += `${speaker}:\n${contentText}\n\n`;
                    }
                }
            });

            const summaryPrompt = `ä»¥ä¸‹ã®Crossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã®å¯¾è©±ãƒ­ã‚°ã‚’åˆ†æã—ã€ã€Œ${topic}ã€ã«ã¤ã„ã¦å®Ÿå‹™ã§æ´»ç”¨ã§ãã‚‹å½¢ã§æ•´ç†ã—ã¦ãã ã•ã„ã€‚
ã€å¯¾è©±ã®è¨­å®šã€‘

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰: ${this.getTargetLabel()}
ã‚´ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ‰: ${this.getGoalLabel()}
é©å¿œå‹AI: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæœ€é©åŒ–ã«ã‚ˆã‚‹å¯¾è©±

ã€è¦æ±‚äº‹é …ã€‘

ãƒ¢ãƒ¼ãƒ‰ç‰¹æ€§ã‚’åæ˜ ã—ãŸæ•´ç†ï¼ˆthis.targetModeçš„è¦–ç‚¹ã¨{this.targetMode}çš„è¦–ç‚¹ã¨
this.targetModeçš„è¦–ç‚¹ã¨{this.goalMode}çš„æˆæœï¼‰

ç« ç«‹ã¦æ§‹æˆã§ä½“ç³»åŒ–ï¼ˆåºç« ãƒ»ç¬¬1ç« ãƒ»ç¬¬2ç« ...ãƒ»çµè«–ï¼‰
å®Ÿè£…å¯èƒ½ãªå…·ä½“ç­–ã‚’å„ªå…ˆçš„ã«æŠ½å‡º
ãƒ¢ãƒ¼ãƒ‰æ¨ªæ–­çš„ãªä¾¡å€¤ã‚‚è€ƒæ…®
å…¨ä½“ã§6000-8000æ–‡å­—ç¨‹åº¦ã«åã‚ã‚‹

ã€å¯¾è©±ãƒ­ã‚°ã€‘
${conversationLog}
ã€å‡ºåŠ›å½¢å¼ã€‘
${topic}ã®æ¤œè¨çµæœï¼ˆCrossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰
åºç« ï¼šå¯¾è©±è¨­å®šã¨å•é¡Œèªè­˜
[${this.getTargetLabel()} Ã— ${this.getGoalLabel()}ãƒ¢ãƒ¼ãƒ‰ã§ã®å–ã‚Šçµ„ã¿æ¦‚è¦]
ç¬¬1ç« ï¼š${this.targetMode === 'practical' ? 'å®Ÿç”¨çš„è§£æ±ºç­–' : this.targetMode === 'business' ? 'ãƒ“ã‚¸ãƒã‚¹æˆ¦ç•¥' : 'å“²å­¦çš„è€ƒå¯Ÿ'}
[ä¸»è¦ãªææ¡ˆã¨æ´å¯Ÿã®æ•´ç†]
ç¬¬2ç« ï¼š${this.goalMode === 'ideation' ? 'ã‚¢ã‚¤ãƒ‡ã‚¢çµ±åˆ' : this.goalMode === 'consensus' ? 'åˆæ„å½¢æˆçµæœ' : 'æ¢ç´¢çš„ç™ºè¦‹'}
[ã‚´ãƒ¼ãƒ«ã«æ²¿ã£ãŸæˆæœã®ä½“ç³»åŒ–]
ç¬¬3ç« ï¼šçµ±åˆçš„è§£æ±ºç­–
[ç•°ãªã‚‹è¦–ç‚¹ã®èåˆã¨çµ±åˆææ¡ˆ]
ç¬¬4ç« ï¼šå®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
[æ®µéšçš„å®Ÿç¾ã«å‘ã‘ãŸå…·ä½“çš„ã‚¹ãƒ†ãƒƒãƒ—]
çµè«–ï¼šæ¨å¥¨ã•ã‚Œã‚‹æ–¹å‘æ€§
[æœ€çµ‚çš„ãªæ¨å¥¨äº‹é …ã¨Crossthinkãƒ¢ãƒ‡ãƒ«ã®ä¾¡å€¤]
æ³¨æ„ï¼šCrossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ç‰¹å¾´ã§ã‚ã‚‹é©å¿œå‹å¯¾è©±ã®æˆæœã‚’é‡è¦–ã—ã€ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®åŠ¹æœã‚’æ˜ç¢ºã«ç¤ºã—ã¦ãã ã•ã„ã€‚`;
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(summaryPrompt).then(() => {
                    this.addMessage('system', 
                        'ğŸ“‹ Crossthinkçµ±åˆç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n' +
                        'ğŸŒŸ çµ±åˆç‰ˆã®ç‰¹å¾´:\n' +
                        `â€¢ ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}ãƒ¢ãƒ¼ãƒ‰ã®æˆæœã‚’åæ˜ \n` +
                        'â€¢ é©å¿œå‹AIå¯¾è©±ã®åŠ¹æœã‚’åˆ†æ\n' +
                        'â€¢ ãƒ¢ãƒ¼ãƒ‰æ¨ªæ–­çš„ãªä¾¡å€¤å‰µé€ ã‚’è©•ä¾¡\n' +
                        'â€¢ ã‚ˆã‚Šå®Ÿç”¨æ€§ã®é«˜ã„çµ±åˆææ¡ˆ\n\n' +
                        'ä½¿ç”¨æ–¹æ³•:\n' +
                        '1. ChatGPT ã¾ãŸã¯ Gemini ã‚’é–‹ã\n' +
                        '2. ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘\n' +
                        '3. é€ä¿¡ã—ã¦é«˜å“è³ªè¦ç´„ã‚’ç”Ÿæˆ\n\n' +
                        `ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—æ•°: ${summaryPrompt.length}æ–‡å­—`
                    );
                }).catch(() => {
                    this.showPromptWindow(summaryPrompt);
                });
            } else {
                this.showPromptWindow(summaryPrompt);
            }
        }

        showPromptWindow(summaryPrompt) {
            const summaryWindow = window.open('', '_blank', 'width=800,height=600');
            if (summaryWindow) {
                summaryWindow.document.write(`
                    <html>
                        <head>
                            <title>Crossthinkçµ±åˆç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</title>
                            <style>
                                body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
                                .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                h2 { color: #333; margin-bottom: 20px; }
                                textarea { width: 100%; height: 70vh; font-family: monospace; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                                .btn { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
                                .btn-copy { background: #4CAF50; color: white; }
                                .btn-close { background: #f44336; color: white; }
                                .stats { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h2>ğŸŒŸ Crossthinkçµ±åˆç‰ˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2>
                                <div class="stats">
                                    <strong>ãƒ¢ãƒ¼ãƒ‰:</strong> ${this.getTargetLabel()} Ã— ${this.getGoalLabel()}ã®é©å¿œå‹å¯¾è©±çµæœ
                                </div>
                                <button class="btn btn-copy" onclick="document.getElementById('prompt').select(); document.execCommand('copy'); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                                <button class="btn btn-close" onclick="window.close();">âŒ é–‰ã˜ã‚‹</button>
                                <textarea id="prompt" readonly>${summaryPrompt}</textarea>
                            </div>
                        </body>
                    </html>
                `);
            } else {
                this.addMessage('system', 
                    'âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\n' +
                    'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚'
                );
            }
        }

        addMessage(provider, content, isThinking = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${provider}-message`;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP');

            let providerName, emoji, roleDesc = '';
            switch (provider) {
                case 'openai':
                    providerName = 'ChatGPT';
                    emoji = 'ğŸŸ¢';
                    roleDesc = `ï¼ˆ${this.targetMode}ãƒ»${this.goalMode}ï¼‰`;
                    break;
                case 'gemini':
                    providerName = 'Gemini';
                    emoji = 'ğŸ”·';
                    roleDesc = `ï¼ˆ${this.targetMode}ãƒ»${this.goalMode}ï¼‰`;
                    break;
                case 'system':
                    providerName = 'Crossthink';
                    emoji = 'ğŸŒŸ';
                    break;
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    ${emoji} ${providerName}${roleDesc}
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>
            `;

            this.elements.chatContainer.appendChild(messageDiv);
            this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

            if (!isThinking && provider !== 'system') {
                this.messageCount++;
            }
        }

        removeLastMessage() {
            const messages = this.elements.chatContainer.querySelectorAll('.message');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
        }

        stopDialogue() {
            this.isRunning = false;
            this.elements.startBtn.disabled = false;
            this.elements.stopBtn.disabled = true;
            this.addMessage('system', 'ğŸ›‘ å¯¾è©±ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
        }

        clearChat() {
            this.elements.chatContainer.innerHTML = '';
            this.messageCount = 0;
            this.openaiCount = 0;
            this.geminiCount = 0;
            this.conversationHistory = [];
            this.updateStats();
            this.showWelcomeMessage();
            this.hideError();
            this.hideWarning();
        }

        showError(message) {
            this.elements.errorDisplay.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${message}`;
            this.elements.errorDisplay.style.display = 'block';
            this.hideWarning();
        }

        hideError() {
            this.elements.errorDisplay.style.display = 'none';
        }

        showWarning(message) {
            this.elements.warningDisplay.textContent = `âš ï¸ è­¦å‘Š: ${message}`;
            this.elements.warningDisplay.style.display = 'block';
        }

        hideWarning() {
            this.elements.warningDisplay.style.display = 'none';
        }

        updateStats() {
            this.elements.totalMessages.textContent = this.messageCount;
            this.elements.openaiMessages.textContent = this.openaiCount;
            this.elements.geminiMessages.textContent = this.geminiCount;
        }

        startTimer() {
            const updateTimer = () => {
                if (this.startTime) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    this.elements.elapsed.textContent = elapsed;
                }
                if (this.isRunning) {
                    setTimeout(updateTimer, 1000);
                }
            };
            updateTimer();
        }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
    let crossthinkSystem;

    function startQuickDialogue(template) {
        if (crossthinkSystem) {
            crossthinkSystem.startQuickDialogue(template);
        }
    }

    // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        try {
            crossthinkSystem = new CrossthinkUnified();
            console.log('Crossthinkçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  v3.0 åˆæœŸåŒ–å®Œäº†');
        } catch (error) {
            console.error('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    window.addEventListener('error', (event) => {
        console.error('æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
        console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
    });
</script>