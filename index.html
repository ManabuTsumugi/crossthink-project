<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v5.0 - AIËá™ÂæãÂØæË©±„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .demo-label {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: bold;
        }

        .mode-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4facfe;
            color: #4facfe;
        }

        .tab-button:hover:not(.active) {
            background: rgba(79, 172, 254, 0.1);
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Ëá™ÂæãÂØæË©±„É¢„Éº„Éâ */
        .autonomous-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .autonomous-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cae4);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* ‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ */
        .intervention-section {
            background: #fff8e1;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .human-input-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .human-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .human-input:focus {
            outline: none;
            border-color: #ffc107;
        }

        .intervention-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Â≠¶ÁøíÊ©üËÉΩ */
        .learning-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }

        .knowledge-base {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .knowledge-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .knowledge-item:last-child {
            border-bottom: none;
        }

        .knowledge-topic {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .knowledge-content {
            font-size: 0.9em;
            color: #666;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .config-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .api-config h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .openai-config h3::before {
            content: "üü¢";
            font-size: 1.2em;
        }

        .gemini-config h3::before {
            content: "üî∑";
            font-size: 1.2em;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .topic-section {
            padding: 20px 30px;
        }

        .topic-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8800 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-section {
            padding: 20px 30px;
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .openai-stat .stat-number { color: #10a37f; }
        .gemini-stat .stat-number { color: #4285f4; }
        .human-stat .stat-number { color: #ffc107; }
        .learning-stat .stat-number { color: #4caf50; }

        .error-display, .warning-display {
            padding: 15px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .error-display {
            background: #ff6b6b;
            color: white;
        }

        .warning-display {
            background: #ffa500;
            color: white;
        }

        .chat-container {
            padding: 30px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.8em;
            opacity: 0.7;
        }

        .system-message {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 5px solid #fdcb6e;
        }

        .openai-message {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            border-left: 5px solid #10a37f;
        }

        .gemini-message {
            background: linear-gradient(135deg, #b3d9ff 0%, #d4edda 100%);
            border-left: 5px solid #4285f4;
        }

        .human-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
        }

        .learning-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
        }

        .thinking {
            font-style: italic;
            opacity: 0.8;
            color: #666;
        }

        .intervention-prompt {
            background: #fffbf0;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #856404;
        }

        .deepening-request {
            background: #f0f8ff;
            border: 2px dashed #4facfe;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            color: #0056b3;
        }

        .auto-pause-notice {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .monetization-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
        }

        .monetization-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .monetization-info ul {
            list-style: none;
            padding: 0;
        }

        .monetization-info li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .monetization-info li::before {
            content: "üöÄ";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .config-grid, .quick-buttons, .autonomous-controls {
                grid-template-columns: 1fr;
            }
            
            .controls, .intervention-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .mode-tabs {
                flex-direction: column;
            }

            .tab-button {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .tab-button.active {
                border-right-color: #4facfe;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†</h1>
            <p>AIËá™ÂæãÂØæË©±„Éª‰∫∫Èñì‰ªãÂÖ•„ÉªÂ≠¶ÁøíÊ©üËÉΩÊê≠Ëºâ„Ç∑„Çπ„ÉÜ„É†</p>
            <div class="demo-label">
                üöÄ v5.0 - Advanced Interactive Edition
            </div>
        </div>

        <div class="mode-tabs">
            <button class="tab-button active" onclick="switchTab('autonomous')">
                ü§ñ AIËá™ÂæãÂØæË©±
            </button>
            <button class="tab-button" onclick="switchTab('intervention')">
                üë§ ‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ
            </button>
            <button class="tab-button" onclick="switchTab('learning')">
                üß† Â≠¶ÁøíÊ©üËÉΩ
            </button>
        </div>

        <div id="autonomous-tab" class="tab-content active">
            <div class="autonomous-section">
                <h3>ü§ñ AIËá™ÂæãÂØæË©±Ë®≠ÂÆö</h3>
                <div class="autonomous-controls">
                    <div class="control-group">
                        <h4>üéØ ÂØæË©±„É¢„Éº„Éâ</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>üè† ÂÆüÁî®ÁöÑ</span>
                                <span>üíº „Éì„Ç∏„Éç„Çπ</span>
                                <span>üß† Âì≤Â≠¶ÁöÑ</span>
                            </div>
                            <input type="range" id="targetModeSlider" class="range-slider" min="0" max="100" value="33">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>üí° Ê°àÂá∫„Åó</span>
                                <span>ü§ù ÂêàÊÑèÂΩ¢Êàê</span>
                                <span>üîç Êé¢Á¥¢</span>
                            </div>
                            <input type="range" id="goalModeSlider" class="range-slider" min="0" max="100" value="50">
                        </div>
                    </div>

                    <div class="control-group">
                        <h4>‚öôÔ∏è Ëá™ÂæãÂØæË©±Ë®≠ÂÆö</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Áü≠ÊôÇÈñìÈõÜ‰∏≠</span>
                                <span id="autonomyLengthLabel">Ê®ôÊ∫ñ (8„É°„ÉÉ„Çª„Éº„Ç∏)</span>
                                <span>Ê∑±„ÅÑÊé¢Ê±Ç</span>
                            </div>
                            <input type="range" id="autonomyLengthSlider" class="range-slider" min="4" max="20" value="8">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>‰∫∫Èñì‰ªãÂÖ•: „Å™„Åó</span>
                                <span id="interventionFreqLabel">‰∏≠Á®ãÂ∫¶</span>
                                <span>È†ªÁπÅ</span>
                            </div>
                            <input type="range" id="interventionFreqSlider" class="range-slider" min="0" max="10" value="3">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="intervention-tab" class="tab-content">
            <div class="intervention-section">
                <h3>üë§ ‰∫∫Èñì‰ªãÂÖ•„Ç≥„É≥„Éà„É≠„Éº„É´</h3>
                <div class="human-input-area">
                    <h4>üí¨ „ÅÇ„Å™„Åü„ÅÆÁô∫Ë®Ä</h4>
                    <textarea id="humanInput" class="human-input" 
                                placeholder="AI„ÅÆÂØæË©±„Å´‰ªãÂÖ•„Åó„Åü„ÅÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË≥™Âïè„ÄÅÊåáÊëò„ÄÅÊñ∞„Åó„ÅÑË¶ñÁÇπ„ÅÆÊèê‰æõ„Å™„Å©„ÄÅËá™Áî±„Å´Áô∫Ë®Ä„Åß„Åç„Åæ„Åô„ÄÇ"></textarea>
                    
                    <div class="intervention-buttons">
                        <button class="btn btn-warning" onclick="humanIntervention()">
                            üí¨ ÂØæË©±„Å´‰ªãÂÖ•
                        </button>
                        <button class="btn btn-secondary" onclick="requestDeepening()">
                            üîç Ë´ñÁÇπ„ÇíÊ∑±Êéò„ÇäË¶ÅÊ±Ç
                        </button>
                        <button class="btn btn-primary" onclick="redirectDialogue()">
                            üéØ ÂØæË©±„ÅÆÊñπÂêëËª¢Êèõ
                        </button>
                        <button class="btn btn-success" onclick="saveInsight()">
                            üí° Ê¥ûÂØü„ÇíÂ≠¶Áøí„Éá„Éº„Çø„Å´‰øùÂ≠ò
                        </button>
                    </div>
                </div>
                
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="quickIntervention('ÂÖ∑‰Ωì‰æã')">
                        üìù „ÄåÂÖ∑‰Ωì‰æã„ÇíÊïô„Åà„Å¶„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ÂèçÂØæÊÑèË¶ã')">
                        üîÑ „ÄåÂèçÂØæ„ÅÆË¶ñÁÇπ„Åß„ÅØÔºü„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('ÂÆüÁî®ÊÄß')">
                        üõ†Ô∏è „ÄåÂÆüÁî®ÊÄß„ÇíÈáçË¶ñ„Åó„Å¶„Äç
                    </button>
                    <button class="quick-btn" onclick="quickIntervention('Á∞°ÊΩî„Å´')">
                        ‚úÇÔ∏è „Äå„ÇÇ„Å£„Å®Á∞°ÊΩî„Å´„Äç
                    </button>
                </div>
            </div>
        </div>

        <div id="learning-tab" class="tab-content">
            <div class="learning-section">
                <h3>üß† Ê±éÁî®AIÂ≠¶ÁøíÊ©üËÉΩ</h3>
                <div class="knowledge-base" id="knowledgeBase">
                    <div class="knowledge-item">
                        <div class="knowledge-topic">„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ</div>
                        <div class="knowledge-content">Crossthink v5.0 Â≠¶ÁøíÊ©üËÉΩ„ÅåÊúâÂäπÂåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇÂØæË©±„Åã„ÇâÂæó„Çâ„Çå„ÅüÊ¥ûÂØü„ÇíËá™ÂãïÂ≠¶Áøí„Åó„Åæ„Åô„ÄÇ</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-success" onclick="exportKnowledge()">
                        üì§ Â≠¶Áøí„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-primary" onclick="importKnowledge()">
                        üì• Â≠¶Áøí„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
                    </button>
                    <button class="btn btn-warning" onclick="clearKnowledge()">
                        üóëÔ∏è Â≠¶Áøí„Éá„Éº„Çø„ÇØ„É™„Ç¢
                    </button>
                    <button class="btn btn-secondary" onclick="showLearningStats()">
                        üìä Â≠¶ÁøíÁµ±Ë®àË°®Á§∫
                    </button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h2>üîß APIË®≠ÂÆö</h2>
            <div class="config-grid">
                <div class="api-config openai-config">
                    <h3>OpenAI API Key:</h3>
                    <input type="password" id="openaiKey" class="api-input" placeholder="sk-proj-...">
                </div>
                <div class="api-config gemini-config">
                    <h3>Gemini API Key:</h3>
                    <input type="password" id="geminiKey" class="api-input" placeholder="AIza...">
                </div>
            </div>
        </div>

        <div class="topic-section">
            <h2>üìù ÂØæË©±„Éà„Éî„ÉÉ„ÇØ:</h2>
            <input type="text" id="topicInput" class="topic-input" 
                    placeholder="AIÂêåÂ£´„Å´ÂØæË©±„Åï„Åõ„Åü„ÅÑ„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" 
                    value="AIÊôÇ‰ª£„Å´„Åä„Åë„Çã‰∫∫Èñì„ÅÆÂâµÈÄ†ÊÄß„Å®„ÅØ‰Ωï„ÅãÔºü">
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">üöÄ ÂØæË©±ÈñãÂßã</button>
                <button id="pauseBtn" class="btn btn-warning" disabled>‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                <button id="stopBtn" class="btn btn-danger" disabled>‚èπÔ∏è ÂÅúÊ≠¢</button>
                <button id="clearBtn" class="btn btn-secondary">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                <button id="exportBtn" class="btn btn-secondary">üìù Ë¶ÅÁ¥ÑÁîüÊàê</button>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìä ÂØæË©±Áµ±Ë®à</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞</div>
                </div>
                <div class="stat-card openai-stat">
                    <div class="stat-number" id="openaiMessages">0</div>
                    <div class="stat-label">ChatGPTÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card gemini-stat">
                    <div class="stat-number" id="geminiMessages">0</div>
                    <div class="stat-label">GeminiÁô∫Ë®Ä</div>
                </div>
                <div class="stat-card human-stat">
                    <div class="stat-number" id="humanMessages">0</div>
                    <div class="stat-label">‰∫∫Èñì‰ªãÂÖ•</div>
                </div>
                <div class="stat-card learning-stat">
                    <div class="stat-number" id="learningItems">1</div>
                    <div class="stat-label">Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="elapsed">0</div>
                    <div class="stat-label">ÁµåÈÅéÊôÇÈñì(Áßí)</div>
                </div>
            </div>
        </div>

        <div class="error-display" id="errorDisplay"></div>
        <div class="warning-display" id="warningDisplay"></div>

        <div class="monetization-info">
            <h3>üöÄ v5.0 Advanced Interactive Edition „ÅÆÁâπÂæ¥:</h3>
            <ul>
                <li>AIÂêåÂ£´„ÅÆËá™ÂæãÂØæË©±„Ç∑„Çπ„ÉÜ„É†ÔºöË®≠ÂÆöÂèØËÉΩ„Å™ÂØæË©±Èï∑„Å®‰ªãÂÖ•È†ªÂ∫¶</li>
                <li>„É™„Ç¢„É´„Çø„Ç§„É†‰∫∫Èñì‰ªãÂÖ•ÔºöÂØæË©±„ÅÆÊµÅ„Çå„ÇíÂ§â„Åà„ÇãÂº∑Âäõ„Å™‰ªãÂÖ•Ê©üËÉΩ</li>
                <li>Ê±éÁî®Â≠¶ÁøíÊ©üËÉΩÔºöÂØæË©±„Åã„ÇâÂæó„Çâ„Çå„ÅüÊ¥ûÂØü„ÇíËá™ÂãïÂ≠¶Áøí„ÉªËìÑÁ©ç</li>
                <li>Ê∑±Êéò„ÇäË¶ÅÊ±Ç„Ç∑„Çπ„ÉÜ„É†ÔºöÁâπÂÆö„ÅÆË´ñÁÇπ„ÇíÊ∑±„ÅèÊé¢Ê±Ç</li>
                <li>ÊñπÂêëËª¢ÊèõÊ©üËÉΩÔºöÂØæË©±„ÅÆÊµÅ„Çå„ÇíÊà¶Áï•ÁöÑ„Å´„Ç≥„É≥„Éà„É≠„Éº„É´</li>
                <li>Â≠¶Áøí„Éá„Éº„ÇøÁÆ°ÁêÜÔºö„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éª„Ç§„É≥„Éù„Éº„ÉàÊ©üËÉΩ‰ªò„Åç</li>
            </ul>
        </div>

        <div class="chat-container" id="chatContainer">
            </div>
    </div>

    <script>
        class CrossthinkAdvanced {
            constructor() {
                this.isRunning = false;
                this.isPaused = false;
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.startTime = null;
                this.currentSpeaker = 'openai';
                this.conversationHistory = [];
                this.maxMessages = 8;
                this.interventionPoints = [];
                this.knowledgeBase = new Map();
                this.waitingForIntervention = false;
                
                // „É¢„Éº„ÉâË®≠ÂÆö
                this.targetMode = 'philosophical';
                this.goalMode = 'exploration';
                this.interventionFrequency = 3;
                this.currentTab = 'autonomous';
                
                // Â≠¶ÁøíÊ©üËÉΩ
                this.learningEnabled = true;
                this.autoLearnKeywords = ['ÈáçË¶Å', 'Êú¨Ë≥™', 'Ê†∏ÂøÉ', 'ÁµêË´ñ', 'Áô∫Ë¶ã', 'Ê¥ûÂØü', 'Èù©Êñ∞'];
                
                this.initializeElements();
                this.bindEvents();
                this.showWelcomeMessage();
                this.initializeKnowledgeBase();
                this.updateSliderLabels();
            }

            initializeElements() {
                this.elements = {
                    openaiKey: document.getElementById('openaiKey'),
                    geminiKey: document.getElementById('geminiKey'),
                    topicInput: document.getElementById('topicInput'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    chatContainer: document.getElementById('chatContainer'),
                    errorDisplay: document.getElementById('errorDisplay'),
                    warningDisplay: document.getElementById('warningDisplay'),
                    totalMessages: document.getElementById('totalMessages'),
                    openaiMessages: document.getElementById('openaiMessages'),
                    geminiMessages: document.getElementById('geminiMessages'),
                    humanMessages: document.getElementById('humanMessages'),
                    learningItems: document.getElementById('learningItems'),
                    elapsed: document.getElementById('elapsed'), // ‚òÖ‰øÆÊ≠£ÁÇπ1: ‰∏çË¶Å„Å™ÊñáÂ≠óÂàó„ÇíÂâäÈô§
                    // „Çπ„É©„Ç§„ÉÄ„ÉºË¶ÅÁ¥†
                    targetModeSlider: document.getElementById('targetModeSlider'),
                    goalModeSlider: document.getElementById('goalModeSlider'),
                    autonomyLengthSlider: document.getElementById('autonomyLengthSlider'),
                    interventionFreqSlider: document.getElementById('interventionFreqSlider'),
                    autonomyLengthLabel: document.getElementById('autonomyLengthLabel'),
                    interventionFreqLabel: document.getElementById('interventionFreqLabel'),
                    
                    // ‰∫∫Èñì‰ªãÂÖ•Ë¶ÅÁ¥†
                    humanInput: document.getElementById('humanInput'),
                    
                    // Â≠¶ÁøíÊ©üËÉΩË¶ÅÁ¥†
                    knowledgeBase: document.getElementById('knowledgeBase')
                };
            }

            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startDialogue());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseDialogue());
                this.elements.stopBtn.addEventListener('click', () => this.stopDialogue());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.exportBtn.addEventListener('click', () => this.generateSummaryPrompt());
                
                // „Çπ„É©„Ç§„ÉÄ„Éº„Ç§„Éô„É≥„Éà
                this.elements.targetModeSlider.addEventListener('input', () => this.updateTargetMode());
                this.elements.goalModeSlider.addEventListener('input', () => this.updateGoalMode());
                this.elements.autonomyLengthSlider.addEventListener('input', () => this.updateAutonomyLength());
                this.elements.interventionFreqSlider.addEventListener('input', () => this.updateInterventionFreq());
                
                // Enter„Ç≠„Éº„Åß„ÅÆ‰ªãÂÖ•
                this.elements.humanInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.humanIntervention();
                    }
                });
            }

            updateSliderLabels() {
                // ÂØæË©±Èï∑„É©„Éô„É´Êõ¥Êñ∞
                this.elements.autonomyLengthSlider.addEventListener('input', () => {
                    const value = this.elements.autonomyLengthSlider.value;
                    this.elements.autonomyLengthLabel.textContent = `${value}„É°„ÉÉ„Çª„Éº„Ç∏`;
                    this.maxMessages = parseInt(value);
                });
                
                // ‰ªãÂÖ•È†ªÂ∫¶„É©„Éô„É´Êõ¥Êñ∞
                this.elements.interventionFreqSlider.addEventListener('input', () => {
                    const value = parseInt(this.elements.interventionFreqSlider.value);
                    const labels = ['„Å™„Åó', 'Á®Ä', 'Â∞ë', '‰∏≠', 'Â§ö', 'È†ªÁπÅ', 'ÈùûÂ∏∏„Å´È†ªÁπÅ', 'Â∏∏ÊôÇ', '„É™„Ç¢„É´„Çø„Ç§„É†', '„Ç∑„É≥„ÇØ„É≠', '„Éï„É´‰ªãÂÖ•'];
                    this.elements.interventionFreqLabel.textContent = labels[value] || '‰∏≠Á®ãÂ∫¶';
                    this.interventionFrequency = value;
                });
            }

            updateTargetMode() {
                const value = parseInt(this.elements.targetModeSlider.value);
                if (value < 33) this.targetMode = 'practical';
                else if (value < 66) this.targetMode = 'business';
                else this.targetMode = 'philosophical';
            }

            updateGoalMode() {
                const value = parseInt(this.elements.goalModeSlider.value);
                if (value < 33) this.goalMode = 'ideation';
                else if (value < 66) this.goalMode = 'consensus';
                else this.goalMode = 'exploration';
            }

            updateAutonomyLength() {
                this.maxMessages = parseInt(this.elements.autonomyLengthSlider.value);
                // „É©„Éô„É´„ÅÆÊõ¥Êñ∞„ÅØ updateSliderLabels ÂÜÖ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅßË°å„Çè„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂÄ§„ÅÆÊõ¥Êñ∞„ÅÆ„Åø
            }

            updateInterventionFreq() {
                this.interventionFrequency = parseInt(this.elements.interventionFreqSlider.value);
                 // „É©„Éô„É´„ÅÆÊõ¥Êñ∞„ÅØ updateSliderLabels ÂÜÖ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅßË°å„Çè„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂÄ§„ÅÆÊõ¥Êñ∞„ÅÆ„Åø
            }

            initializeKnowledgeBase() {
                this.knowledgeBase.set('system_init', {
                    topic: '„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ',
                    content: 'Crossthink v5.0 Advanced Interactive Edition „ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇ',
                    timestamp: new Date(),
                    source: 'system'
                });
                this.updateKnowledgeDisplay();
                this.updateStats(); // ÂàùÊúü„Ç¢„Ç§„ÉÜ„É†Êï∞„ÇíÂèçÊò†
            }

            showWelcomeMessage() {
                this.addMessage('system', 
                    'Crossthink Áµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v5.0 Advanced Interactive Edition „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ\n\n' +
                    'üöÄ v5.0 „ÅÆÊñ∞Ê©üËÉΩ:\n' +
                    '‚Ä¢ ü§ñ AIËá™ÂæãÂØæË©±: AI„ÅåËá™‰∏ªÁöÑ„Å´Ë≠∞Ë´ñ„ÇíÂ±ïÈñã\n' +
                    '‚Ä¢ üë§ ‰∫∫Èñì‰ªãÂÖ•: „É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂØæË©±„Å´ÂèÇÂä†ÂèØËÉΩ\n' +
                    '‚Ä¢ üß† Â≠¶ÁøíÊ©üËÉΩ: ÂØæË©±„Åã„ÇâÊ¥ûÂØü„ÇíËá™ÂãïÂ≠¶Áøí„ÉªËìÑÁ©ç\n' +
                    '‚Ä¢ üîç Ê∑±Êéò„ÇäË¶ÅÊ±Ç: ÁâπÂÆö„ÅÆË´ñÁÇπ„ÇíË©≥„Åó„ÅèÊé¢Ê±Ç\n' +
                    '‚Ä¢ üéØ ÊñπÂêëËª¢Êèõ: ÂØæË©±„ÅÆÊµÅ„Çå„ÇíÊà¶Áï•ÁöÑ„Å´„Ç≥„É≥„Éà„É≠„Éº„É´\n\n' +
                    'üí° ‰Ωø„ÅÑÊñπ:\n' +
                    '1. „Çø„Éñ„ÇíÂàá„ÇäÊõø„Åà„Å¶Ê©üËÉΩ„ÇíË®≠ÂÆö\n' +
                    '2. AIËá™ÂæãÂØæË©±„Åß„Éë„É©„É°„Éº„ÇøË™øÊï¥\n' +
                    '3. API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Éà„Éî„ÉÉ„ÇØÂÖ•Âäõ\n' +
                    '4. ÂØæË©±ÈñãÂßãÂæå„ÄÅ„ÅÑ„Å§„Åß„ÇÇ‰ªãÂÖ•ÂèØËÉΩ\n\n' +
                    'üéØ Advanced Features:\n' +
                    'üìà „É™„Ç¢„É´„Çø„Ç§„É†Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†\n' +
                    'üéì ‰∫∫Èñì-AIÂçîÂÉçÊúÄÈÅ©Âåñ\n' +
                    'üí° ÂãïÁöÑ„Å™Ê¥ûÂØüÊäΩÂá∫\n' +
                    'üî¨ ÈÄ≤Âåñ„Åô„ÇãÂØæË©±ÂìÅË≥™'
                );
            }

            async startDialogue() {
                if (!this.validateInputs()) return;

                this.isRunning = true;
                this.isPaused = false;
                this.startTime = Date.now();
                this.currentSpeaker = 'openai'; // ÂàùÊúü„Çπ„Éî„Éº„Ç´„Éº
                this.conversationHistory = [];
                this.interventionPoints = [];
                
                // Áµ±Ë®à„É™„Çª„ÉÉ„Éà
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                // this.knowledgeBase.clear(); // ÂØæË©±ÈñãÂßãÊôÇ„Å´„Éä„É¨„ÉÉ„Ç∏„Éô„Éº„Çπ„Çí„ÇØ„É™„Ç¢„Åô„Çã„Åã„ÅØ‰ªïÊßò„Å´„Çà„Çã„ÄÇ„Åì„Åì„Åß„ÅØ„ÇØ„É™„Ç¢„Åó„Å™„ÅÑ„ÄÇ
                // this.initializeKnowledgeBase(); // „ÇØ„É™„Ç¢„Åô„ÇãÂ†¥Âêà„ÅØÂÜçÂàùÊúüÂåñ
                this.updateStats();


                this.elements.startBtn.disabled = true;
                this.elements.pauseBtn.disabled = false;
                this.elements.stopBtn.disabled = false;
                this.hideError();
                this.hideWarning();

                const topic = this.elements.topicInput.value.trim();
                
                this.addMessage('system', 
                    `üöÄ AIËá™ÂæãÂØæË©±ÈñãÂßã\n` +
                    `üìù „Éà„Éî„ÉÉ„ÇØ: "${topic}"\n` +
                    `üé™ „É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}\n` +
                    `‚è±Ô∏è ÊúÄÂ§ß„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.maxMessages}\n` +
                    `üë§ ‰ªãÂÖ•Ë®≠ÂÆö: ${this.getInterventionLabel()}\n` +
                    `üß† Â≠¶ÁøíÊ©üËÉΩ: ÊúâÂäπ\n` +
                    `ü§ñ AI„ÅåËá™ÂæãÁöÑ„Å´Ë≠∞Ë´ñ„ÇíÈñãÂßã„Åó„Åæ„Åô...`
                );

                // Â≠¶Áøí„Éá„Éº„Çø„Å´ÂØæË©±ÈñãÂßã„ÇíË®òÈå≤
                this.learnFromDialogue('ÂØæË©±ÈñãÂßã', `Êñ∞„Åó„ÅÑÂØæË©±„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü: ${topic}`);

                this.startTimer();

                // ÂàùÊúü„Éó„É≠„É≥„Éó„ÉàÁîüÊàê
                const initialPrompt = this.generateInitialPrompt(topic);
                await this.sendMessage('openai', initialPrompt);
            }

            generateInitialPrompt(topic) {
                const basePrompt = this.generateModeSpecificPrompt(topic);
                
                const autonomyInstructions = `\n\nü§ñ **Ëá™ÂæãÂØæË©±ÊåáÁ§∫ (v5.0)**:\n` +
                    `‚Ä¢ „ÅÇ„Å™„Åü„ÅØChatGPT(OpenAI)„Åß„Åô\n` +
                    `‚Ä¢ Gemini„Å®ÊúÄÂ§ß${this.maxMessages}„É°„ÉÉ„Çª„Éº„Ç∏„ÅßÂª∫Ë®≠ÁöÑ„Å™Ë≠∞Ë´ñ„ÇíË°å„ÅÑ„Åæ„Åô\n` + // "ÊúÄÂ§ß" „ÇíËøΩÂä†
                    `‚Ä¢ ${this.getInterventionDescription()}\n` +
                    `‚Ä¢ Ë≥™„ÅÆÈ´ò„ÅÑÊ¥ûÂØü„ÇíÊèê‰æõ„Åó„ÄÅË≠∞Ë´ñ„ÇíÊ∑±Âåñ„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ\n` +
                    `‚Ä¢ ‰∫∫Èñì„Åå‰ªãÂÖ•„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆË¶ñÁÇπ„ÇíÂ∞äÈáç„Åó„Å¶Ë≠∞Ë´ñ„Å´Âèñ„ÇäÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ`;

                return basePrompt + autonomyInstructions;
            }

            generateModeSpecificPrompt(topic) {
                const modePrompts = {
                    'practical-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶ÂÆüÁî®ÁöÑ„Å™„Ç¢„Ç§„Éá„Ç¢„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'practical-consensus': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶ÂÆüÁî®ÁöÑ„Å™ÂêàÊÑèÁÇπ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                    'practical-exploration': `„Äå${topic}„Äç„ÅÆÂÆüÁî®ÁöÑÂÅ¥Èù¢„ÇíÊ∑±„ÅèÊé¢Ê±Ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶Èù©Êñ∞ÁöÑ„Å™„Éì„Ç∏„Éç„ÇπË¶ñÁÇπ„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'business-consensus': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„Éì„Ç∏„Éç„ÇπÁöÑ„Å™ÊúÄÈÅ©Ëß£„ÇíÂ∞é„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                    'business-exploration': `„Äå${topic}„Äç„ÅÆ„Éì„Ç∏„Éç„Çπ‰æ°ÂÄ§„ÇíÊ∑±„ÅèÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-ideation': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶Âì≤Â≠¶ÁöÑ„Å™Êñ∞„Åó„ÅÑÊÄùËÄÉ„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    'philosophical-consensus': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶Âì≤Â≠¶ÁöÑ„Å™Ê∑±„ÅÑÁêÜËß£„ÇíÂÖ±Êúâ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                    'philosophical-exploration': `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶Ê†πÊ∫êÁöÑ„Å™Êé¢Ê±Ç„ÇíË°å„ÅÑ„Åæ„Åó„Çá„ÅÜ„ÄÇ`
                };
                
                const key = `${this.targetMode}-${this.goalMode}`;
                return modePrompts[key] || `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶Ê∑±„ÅèË≠∞Ë´ñ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
            }

            getInterventionDescription() {
                if (this.interventionFrequency === 0) return '‰∫∫Èñì„ÅÆ‰ªãÂÖ•„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
                if (this.interventionFrequency <= 2) return 'Á®Ä„Å´‰∫∫Èñì„Åå‰ªãÂÖ•„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô';
                if (this.interventionFrequency <= 5) return 'ÊôÇ„ÄÖ‰∫∫Èñì„ÅåË≠∞Ë´ñ„Å´ÂèÇÂä†„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô';
                if (this.interventionFrequency <= 8) return 'È†ªÁπÅ„Å´‰∫∫Èñì„ÅåÂØæË©±„Å´‰ªãÂÖ•„Åó„Åæ„Åô';
                return '‰∫∫Èñì„Åå„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂØæË©±„Çí„É™„Éº„Éâ„Åó„Åæ„Åô';
            }

            validateInputs() {
                const openaiKey = this.elements.openaiKey.value.trim();
                const geminiKey = this.elements.geminiKey.value.trim();
                const topic = this.elements.topicInput.value.trim();

                if (!openaiKey) {
                    this.showError('OpenAI API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                if (!geminiKey) {
                    this.showError('Gemini API „Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                if (!topic) {
                    this.showError('ÂØæË©±„Éà„Éî„ÉÉ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return false;
                }

                return true;
            }

            async sendMessage(provider, prompt, isHumanIntervention = false) {
                if (!this.isRunning || (this.isPaused && !isHumanIntervention)) return; // ‰∫∫Èñì‰ªãÂÖ•ÊôÇ„ÅØisPaused„Åß„ÇÇÈÄÅ‰ø°

                try {
                    this.addMessage(provider, 'ÊÄùËÄÉ‰∏≠...', true);
                    
                    let response;
                    if (provider === 'openai') {
                        response = await this.callOpenAI(prompt);
                        if(!isHumanIntervention) this.openaiCount++; // ÊÄùËÄÉ‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈô§„Åç„ÄÅAIÂøúÁ≠îÊôÇ„ÅÆ„Åø„Ç´„Ç¶„É≥„Éà
                    } else if (provider === 'gemini') {
                        response = await this.callGemini(prompt);
                        if(!isHumanIntervention) this.geminiCount++; // ÊÄùËÄÉ‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈô§„Åç„ÄÅAIÂøúÁ≠îÊôÇ„ÅÆ„Åø„Ç´„Ç¶„É≥„Éà
                    }

                    this.removeLastMessage(); // "ÊÄùËÄÉ‰∏≠..." „ÇíÂâäÈô§
                    this.addMessage(provider, response);
                    this.conversationHistory.push({ provider, message: response, timestamp: new Date() });
                    // this.updateStats(); // addMessageÂÜÖ„ÅßmessageCount„ÅåÂ¢ó„Åà„Çã„ÅÆ„Åß„ÄÅ„Åù„ÅÆÂæå„ÅßÂëº„Å∂

                    // Â≠¶ÁøíÊ©üËÉΩ: ÈáçË¶Å„Å™Ê¥ûÂØü„ÇíËá™ÂãïÂ≠¶Áøí
                    this.autoLearnFromMessage(response, provider);

                    // ‰ªãÂÖ•„Éù„Ç§„É≥„Éà„ÅÆÂà§ÂÆö
                    if (this.shouldTriggerIntervention() && !isHumanIntervention && provider !== 'human') {
                        this.triggerInterventionPrompt();
                        return; // ‰∫∫Èñì„ÅÆ‰ªãÂÖ•„ÇíÂæÖ„Å§
                    }

                    // Ê¨°„ÅÆAI„Å´ÂøúÁ≠î„Åï„Åõ„Çã (‰∫∫Èñì‰ªãÂÖ•„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø)
                    if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages && !isHumanIntervention) {
                        setTimeout(() => {
                            const nextProvider = provider === 'openai' ? 'gemini' : 'openai';
                            const nextPrompt = this.generateNextPrompt(nextProvider, response);
                            this.sendMessage(nextProvider, nextPrompt);
                        }, 2000);
                    } else if (this.messageCount >= this.maxMessages && !isHumanIntervention) {
                        this.addMessage('system', 'üéØ Ë®≠ÂÆö„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Å´Âà∞ÈÅî„Åó„Åæ„Åó„Åü„ÄÇÂØæË©±„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÄÇ');
                        this.stopDialogue();
                    }

                } catch (error) {
                    this.removeLastMessage(); // "ÊÄùËÄÉ‰∏≠..." „ÇíÂâäÈô§
                    this.showError(`API„Ç®„É©„Éº (${provider}): ${error.message}`);
                    console.error('API Error:', error);
                    // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„Å´ÂØæË©±„ÇíÂÅúÊ≠¢„Åô„Çã„Åã„ÄÅÁ∂ôÁ∂ö„ÇíË©¶„Åø„Çã„Åã„ÅØ‰ªïÊßò„Å´„Çà„Çã
                    // this.stopDialogue(); 
                } finally {
                    if (provider === 'openai' || provider === 'gemini' || provider === 'human') {
                        this.updateStats(); // ÊúÄÁµÇÁöÑ„Å™Áµ±Ë®à„ÇíÊõ¥Êñ∞
                    }
                }
            }

            shouldTriggerIntervention() {
                if (this.interventionFrequency === 0) return false;
                if (this.waitingForIntervention) return false;
                
                // ‰ªãÂÖ•È†ªÂ∫¶„Å´Âü∫„Å•„ÅèÁ¢∫ÁéáÁöÑÂà§ÂÆö
                const interventionProbability = this.interventionFrequency / 10;
                const shouldIntervene = Math.random() < interventionProbability;
                
                // „Åæ„Åü„ÅØÁâπÂÆö„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„Åß„ÅÆÂº∑Âà∂‰ªãÂÖ• (‰æã)
                // „Åì„Åì„Åß„ÅØÁ¢∫Áéá„ÅÆ„Åø„ÅßÂà§ÂÆö„ÄÇ„Çà„ÇäË§áÈõë„Å™„É≠„Ç∏„ÉÉ„ÇØ„ÇÇÂèØËÉΩ„ÄÇ
                // const forceInterventionPoints = [Math.floor(this.maxMessages / 3), Math.floor(this.maxMessages * 2 / 3)];
                // const forceIntervention = forceInterventionPoints.includes(this.messageCount) && this.interventionFrequency >= 5;
                
                return shouldIntervene; // || forceIntervention;
            }

            triggerInterventionPrompt() {
                this.waitingForIntervention = true;
                // this.isPaused = true; // pauseDialogue„ÇíÂëº„Å∂„Åã„ÄÅ„Åì„Åì„ÅßÁõ¥Êé•Âà∂Âæ°

                const interventionDiv = document.createElement('div');
                interventionDiv.className = 'intervention-prompt';
                interventionDiv.innerHTML = `
                    <h4>üë§ ‰∫∫Èñì‰ªãÂÖ•„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„Åô</h4>
                    <p>AI„ÅÆÂØæË©±„Å´‰Ωï„ÅãËøΩÂä†„Åó„Åü„ÅÑË¶ñÁÇπ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü<br>‰ªãÂÖ•„Çø„Éñ„ÅßÂÖ•Âäõ„Åô„Çã„Åã„ÄÅAI„Å´Á∂öË°å„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <button class="btn btn-warning" onclick="continueAutonomously()">
                        ü§ñ AI„Å´Á∂öË°å„Åï„Åõ„Çã
                    </button>
                    <button class="btn btn-primary" onclick="switchToInterventionTab()">
                        üë§ ‰ªãÂÖ•„Çø„Éñ„Å∏
                    </button>
                `;
                
                this.elements.chatContainer.appendChild(interventionDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
                this.pauseDialogue(true); // ÂØæË©±„Çí‰∏ÄÊôÇÂÅúÊ≠¢Áä∂ÊÖã„Å´„Åô„Çã
            }

            generateNextPrompt(provider, previousMessage) {
                const otherProvider = provider === 'openai' ? 'Gemini' : 'ChatGPT';
                // const originalTopic = this.elements.topicInput.value.trim(); // ÂøÖË¶Å„Å™„Çâ‰ΩøÁî®
                
                let basePrompt = `${otherProvider}„Åå‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´Ëø∞„Åπ„Åæ„Åó„ÅüÔºö\n\n"${previousMessage}"\n\n`;
                
                const roleInstruction = this.getProviderRoleInstruction(provider);
                const contextualInstruction = this.getContextualInstruction();
                
                return basePrompt + roleInstruction + contextualInstruction;
            }

            getProviderRoleInstruction(provider) {
                const instructions = {
                    'openai': {
                        'practical': 'üè† **ÂÆüÁî®ÁöÑË¶ñÁÇπÔºàChatGPTÔºâ**: ÂÖ∑‰ΩìÁöÑ„ÅßÂÆüË°åÂèØËÉΩ„Å™ÊèêÊ°à„ÇíÈáçË¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'business': 'üíº **„Éì„Ç∏„Éç„ÇπË¶ñÁÇπÔºàChatGPTÔºâ**: Â∏ÇÂ†¥‰æ°ÂÄ§„Å®ÂÆüÁèæÂèØËÉΩÊÄß„ÇíÊòéÁ¢∫„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'philosophical': 'üß† **Âì≤Â≠¶ÁöÑË¶ñÁÇπÔºàChatGPTÔºâ**: Ê∑±„ÅÑÊ¥ûÂØü„Å®Êñ∞„Åó„ÅÑË¶ñÁÇπ„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    },
                    'gemini': {
                        'practical': 'üîß **ÂàÜÊûêÁöÑÊ§úË®ºÔºàGeminiÔºâ**: Ë´ñÁêÜÁöÑ„Å´Ê§úË®º„Åó„ÄÅÊßãÈÄ†Âåñ„Åï„Çå„ÅüÂõûÁ≠î„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'business': 'üìä **Êà¶Áï•ÁöÑÂàÜÊûêÔºàGeminiÔºâ**: „Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÊà¶Áï•ÁöÑÂà§Êñ≠„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                        'philosophical': 'üîç **ÊâπÂà§ÁöÑËÄÉÂØüÔºàGeminiÔºâ**: Ê¶ÇÂøµ„ÇíÁ≤æÊüª„Åó„ÄÅË´ñÁêÜÁöÑÊï¥ÂêàÊÄß„ÇíÈáçË¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                    }
                };
                return instructions[provider]?.[this.targetMode] || 'Âª∫Ë®≠ÁöÑ„ÅßÊ¥ûÂØü„Å´ÂØå„ÇÄÂøúÁ≠î„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ';
            }

            getContextualInstruction() {
                return `\n\nüéØ **ÂØæË©±‰øÉÈÄ≤ÊåáÁ§∫**:\n` +
                    `‚Ä¢ Áõ∏Êâã„ÅÆÊÑèË¶ã„ÇíË∏è„Åæ„Åà„Å¶„ÄÅ„Åï„Çâ„Å´Ë≠∞Ë´ñ„ÇíÊ∑±Âåñ„Åï„Åõ„Çã\n` +
                    `‚Ä¢ Êñ∞„Åó„ÅÑË¶ñÁÇπ„ÇÑÁñëÂïè„ÇíÊèêËµ∑„Åô„Çã\n` +
                    `‚Ä¢ ÂÖ∑‰Ωì‰æã„ÇÑÂÆü‰æã„Çí‰∫§„Åà„Å¶Ë™¨ÂæóÂäõ„ÇíÈ´ò„ÇÅ„Çã\n` +
                    `‚Ä¢ ÊúÄÂ§ß${this.maxMessages}„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂà∂ÈôêÂÜÖ„Åß‰æ°ÂÄ§„ÅÇ„ÇãË≠∞Ë´ñ„ÇíË°å„ÅÜ`;
            }

            // ‰∫∫Èñì‰ªãÂÖ•Ê©üËÉΩ
            humanIntervention() {
                if (!this.isRunning) { // ÂØæË©±„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªãÂÖ•„Åß„Åç„Å™„ÅÑ
                    this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                const humanMessage = this.elements.humanInput.value.trim();
                if (!humanMessage) {
                    this.showError('‰ªãÂÖ•ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                this.addMessage('human', humanMessage);
                this.humanCount++;
                // this.updateStats(); // addMessageÂÜÖ„ÅßÊõ¥Êñ∞„Åï„Çå„Çã„ÅÆ„Åß‰∏çË¶Å„Åã„ÇÇ

                // Â≠¶Áøí„Éá„Éº„Çø„Å´Ë®òÈå≤
                this.learnFromDialogue('‰∫∫Èñì‰ªãÂÖ•', humanMessage);
                
                // ‰ªãÂÖ•Âæå„ÅÆAIÂøúÁ≠î„Çí‰øÉ„Åô
                // ‰ªãÂÖ•ÊôÇ„ÅØ„ÄÅÊúÄÂæå„Å´Áô∫Ë®Ä„Åó„ÅüAI„Åß„ÅØ„Å™„Åè„ÄÅÊ¨°„Å´Áô∫Ë®Ä„Åô„Çã‰∫àÂÆö„Å†„Å£„ÅüAI„Å´ÂøúÁ≠î„Åï„Åõ„Çã„ÅÆ„ÅåËá™ÁÑ∂
                const nextSpeakerAfterIntervention = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const interventionPrompt = this.generateInterventionResponse(humanMessage, nextSpeakerAfterIntervention);
                
                // ÂØæË©±„Åå‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Åü„ÇâÂÜçÈñã
                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                     this.addMessage('system', '‚ñ∂Ô∏è ‰∫∫Èñì‰ªãÂÖ•„Å´„Çà„ÇäÂØæË©±„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü');
                }
                
                this.waitingForIntervention = false; // ‰ªãÂÖ•ÂæÖÊ©üÁä∂ÊÖã„ÇíËß£Èô§
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(nextSpeakerAfterIntervention, interventionPrompt, true); // isHumanIntervention = true
                
                this.elements.humanInput.value = '';
            }

            generateInterventionResponse(humanMessage, respondingAI) {
                const aiName = respondingAI === 'openai' ? 'ChatGPT' : 'Gemini';
                return `‰∫∫Èñì„Åå‰ª•‰∏ã„ÅÆ‰ªãÂÖ•„ÇíË°å„ÅÑ„Åæ„Åó„ÅüÔºö\n\n"${humanMessage}"\n\n` +
                    `„ÅÇ„Å™„Åü„ÅØ ${aiName} „Åß„Åô„ÄÇ„Åì„ÅÆ‰∫∫Èñì„ÅÆ‰ªãÂÖ•„ÇíË∏è„Åæ„Åà„ÄÅÂª∫Ë®≠ÁöÑ„Å´ÂøúÁ≠î„Åó„ÄÅË≠∞Ë´ñ„ÇíÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂøÖË¶Å„Åß„ÅÇ„Çå„Å∞„ÄÅ„Åì„Çå„Åæ„Åß„ÅÆË≠∞Ë´ñ„ÅÆÊñπÂêëÊÄß„Çí‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            }

            requestDeepening() {
                if (!this.isRunning || this.conversationHistory.length === 0) {
                    this.showError('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„ÄÅAI„ÅÆÁô∫Ë®Ä„Åå„ÅÇ„ÇãÁä∂ÊÖã„Åß‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const lastAIMessage = this.conversationHistory.filter(m => m.provider === 'openai' || m.provider === 'gemini').pop();
                if (!lastAIMessage) {
                     this.showError('Ê∑±Êéò„ÇäÂØæË±°„Å®„Å™„ÇãAI„ÅÆÁô∫Ë®Ä„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }

                const deepeningRequestText = `„É¶„Éº„Ç∂„Åå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁõ¥Ââç„ÅÆÁô∫Ë®Ä„Äå${lastAIMessage.message.substring(0,100)}...„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ„Çà„ÇäÊ∑±„ÅÑÊé¢Ê±Ç„ÇíÊ±Ç„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÖ∑‰Ωì‰æã„ÄÅÂÆüË®º„Éá„Éº„Çø„ÄÅÁï∞„Å™„ÇãË¶ñÁÇπ„Åã„Çâ„ÅÆÊ§úË®º„Å™„Å©„ÄÅÂ§öËßíÁöÑ„Å´Ê∑±Êéò„Çä„Åó„Å¶Ë≠∞Ë´ñ„ÇíË±ä„Åã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                this.addMessage('system', 'üîç **Ê∑±Êéò„ÇäË¶ÅÊ±Ç**: AI„Å´ÂâçÂõû„ÅÆË´ñÁÇπ„ÅÆ„Çà„ÇäÊ∑±„ÅÑÊé¢Ê±Ç„Çí‰æùÈ†º„Åó„Åæ„Åó„Åü');
                
                // ÊúÄÂæå„Å´Áô∫Ë®Ä„Åó„ÅüAI„Å´Ê∑±Êéò„Çä„Çí‰æùÈ†º
                this.sendMessage(lastAIMessage.provider, deepeningRequestText, true); // isHumanIntervention = true (AI„ÅÆÈÄöÂ∏∏„ÅÆÊµÅ„Çå„Çí‰∏≠Êñ≠„Åô„Çã„Åü„ÇÅ)
                this.learnFromDialogue('Ê∑±Êéò„ÇäË¶ÅÊ±Ç', `ÂØæË±°: ${lastAIMessage.provider} - ${lastAIMessage.message.substring(0,50)}...`);
            }

            redirectDialogue() {
                 if (!this.isRunning) {
                    this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                const redirectionText = this.elements.humanInput.value.trim();
                if (!redirectionText) {
                    this.showError('ÊñπÂêëËª¢Êèõ„ÅÆÊåáÁ§∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (‰æã: „Äå„ÇÇ„Å£„Å®ÂÆüÁî®ÁöÑ„Å™ÂÅ¥Èù¢„Å´ÁÑ¶ÁÇπ„ÇíÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„Äç)');
                    return;
                }

                this.addMessage('human', `üéØ **ÊñπÂêëËª¢ÊèõË¶ÅÊ±Ç**: ${redirectionText}`);
                this.humanCount++;
                // this.updateStats();

                const nextSpeakerAfterRedirect = this.currentSpeaker === 'openai' ? 'gemini' : 'openai';
                const redirectionPrompt = `‰∫∫Èñì„ÅåÂØæË©±„ÅÆÊñπÂêëËª¢Êèõ„ÇíË¶ÅÊ±Ç„Åó„Å¶„ÅÑ„Åæ„ÅôÔºö\n\n"${redirectionText}"\n\n` +
                    `„ÅÇ„Å™„Åü„ÅØ ${nextSpeakerAfterRedirect === 'openai' ? 'ChatGPT' : 'Gemini'} „Åß„Åô„ÄÇ„Åì„ÅÆÊåáÁ§∫„Å´Âæì„ÅÑ„ÄÅË≠∞Ë´ñ„ÅÆÊµÅ„Çå„ÇíË™øÊï¥„Åó„ÄÅÊñ∞„Åó„ÅÑË¶ñÁÇπ„Åã„ÇâË≠∞Ë´ñ„ÇíÁ∂ôÁ∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                if (this.isPaused) {
                    this.isPaused = false;
                    this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                    this.addMessage('system', '‚ñ∂Ô∏è ÊñπÂêëËª¢ÊèõË¶ÅÊ±Ç„Å´„Çà„ÇäÂØæË©±„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü');
                }
                this.waitingForIntervention = false;
                const interventionPrompts = this.elements.chatContainer.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());

                this.sendMessage(nextSpeakerAfterRedirect, redirectionPrompt, true); // isHumanIntervention = true
                this.learnFromDialogue('ÊñπÂêëËª¢Êèõ', redirectionText);
                this.elements.humanInput.value = '';
            }

            saveInsight() {
                const insightText = this.elements.humanInput.value.trim();
                if (!insightText) {
                    this.showError('‰øùÂ≠ò„Åô„ÇãÊ¥ûÂØü„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const timestamp = new Date();
                const insightId = `insight_${timestamp.getTime()}`;
                
                this.knowledgeBase.set(insightId, {
                    topic: '‰∫∫Èñì„ÅÆÊ¥ûÂØü',
                    content: insightText,
                    timestamp: timestamp,
                    source: 'human_insight'
                });

                this.updateKnowledgeDisplay();
                this.updateStats();
                
                this.addMessage('learning', `üí° Ê¥ûÂØü„ÇíÂ≠¶Áøí„Éá„Éº„Çø„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü: "${insightText.substring(0,50)}..."`);
                this.elements.humanInput.value = '';
            }

            quickIntervention(type) {
                if (!this.isRunning) {
                     this.showWarning('„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                const quickMessages = {
                    'ÂÖ∑‰Ωì‰æã': 'ÂÖ∑‰Ωì‰æã„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÆüÈöõ„ÅÆ‰∫ã‰æã„ÇÑ„Éá„Éº„Çø„Åå„ÅÇ„Çã„Å®ÁêÜËß£„ÅåÊ∑±„Åæ„Çä„Åæ„Åô„ÄÇ',
                    'ÂèçÂØæÊÑèË¶ã': 'ÂèçÂØæ„ÅÆË¶ñÁÇπ„Åã„Çâ„ÅØ„Å©„ÅÜË¶ã„Åà„Çã„Åß„Åó„Çá„ÅÜ„ÅãÔºüÊâπÂà§ÁöÑ„Å™Ë¶ãËß£„ÇÇËÅû„Åã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                    'ÂÆüÁî®ÊÄß': 'ÂÆüÁî®ÊÄß„ÇíÈáçË¶ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÆüÈöõ„Å´‰Ωø„Åà„ÇãÂΩ¢„Åß„ÅÆÊèêÊ°à„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ',
                    'Á∞°ÊΩî„Å´': '„ÇÇ„Å£„Å®Á∞°ÊΩî„Å´„Åæ„Å®„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË¶ÅÁÇπ„ÇíÁµû„Å£„Å¶Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                };

                this.elements.humanInput.value = quickMessages[type] || '';
                this.humanIntervention();
            }

            // Â≠¶ÁøíÊ©üËÉΩ
            autoLearnFromMessage(message, provider) {
                if (!this.learningEnabled) return;

                const hasImportantKeywords = this.autoLearnKeywords.some(keyword => 
                    message.includes(keyword));

                if (hasImportantKeywords || message.length > 200) { // „É°„ÉÉ„Çª„Éº„Ç∏Èï∑„ÇÇËÄÉÊÖÆ
                    const timestamp = new Date();
                    const learnId = `auto_${provider}_${timestamp.getTime()}`;
                    
                    const importantPart = this.extractImportantPart(message);
                    
                    this.knowledgeBase.set(learnId, {
                        topic: `${provider}„ÅÆÊ¥ûÂØü (Ëá™Âãï)`,
                        content: importantPart,
                        timestamp: timestamp,
                        source: `auto_${provider}`,
                        fullMessage: message // ÂÖÉ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇÇ‰øùÂ≠ò„Åó„Å¶„Åä„Åè„Å®Âæå„ÅßÂèÇÁÖß„Åß„Åç„Çã
                    });

                    this.updateKnowledgeDisplay();
                    this.updateStats();
                }
            }

            extractImportantPart(message) {
                const sentences = message.split(/[„ÄÇÔºéÔºÅÔºü\n]+/).filter(s => s.trim() !== '');
                let importantSentences = sentences.filter(sentence => 
                    this.autoLearnKeywords.some(keyword => sentence.includes(keyword))
                );

                if (importantSentences.length === 0 && sentences.length > 0) {
                    // „Ç≠„Éº„ÉØ„Éº„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊúÄÂàù„ÅÆ1-2Êñá„ÇíÂèñ„Çã„Å™„Å©„ÄÅÂà•„ÅÆÊà¶Áï•„ÇÇËÄÉ„Åà„Çâ„Çå„Çã
                    importantSentences = sentences.slice(0, 2); 
                }
                
                let result = importantSentences.slice(0, 3).join('„ÄÇ'); // ÊúÄÂ§ß3ÊñáÁ®ãÂ∫¶
                if (result.length > 150) result = result.substring(0, 150) + "..."; // Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØÂàá„ÇäË©∞„ÇÅ„Çã
                else if (result.length === 0 && message.length > 0) result = message.substring(0,100) + "..."; // ‰Ωï„ÇÇÊäΩÂá∫„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆÈÉ®ÂàÜ

                return result || "ÈáçË¶Å„Å™Ê¥ûÂØüÔºàË©≥Á¥∞„ÅØ„É≠„Ç∞ÂèÇÁÖßÔºâ";
            }

            learnFromDialogue(topic, content) {
                const timestamp = new Date();
                const learnId = `dialogue_${timestamp.getTime()}`;
                
                this.knowledgeBase.set(learnId, {
                    topic: topic,
                    content: content,
                    timestamp: timestamp,
                    source: 'dialogue_event' // „ÇΩ„Éº„Çπ„Çí„Çà„ÇäÊòéÁ¢∫„Å´
                });

                this.updateKnowledgeDisplay();
                this.updateStats();
            }

            updateKnowledgeDisplay() {
                const knowledgeContainer = this.elements.knowledgeBase;
                knowledgeContainer.innerHTML = '';

                const sortedItems = Array.from(this.knowledgeBase.values()) // Map.values() „Çí‰ΩøÁî®
                    .sort((a, b) => b.timestamp - a.timestamp);
                    // .slice(0, 10); // ÊúÄÊñ∞10‰ª∂„Å´ÈôêÂÆö„Åô„ÇãÂ†¥Âêà„ÅØ„Ç≥„É°„É≥„ÉàËß£Èô§

                if (sortedItems.length === 0) {
                     knowledgeContainer.innerHTML = '<div class="knowledge-item"><div class="knowledge-content">Â≠¶Áøí„Éá„Éº„Çø„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div></div>';
                } else {
                    sortedItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'knowledge-item';
                        itemDiv.innerHTML = `
                            <div class="knowledge-topic">${item.topic}</div>
                            <div class="knowledge-content">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                ${item.timestamp.toLocaleString()} | ${item.source}
                            </div>
                        `;
                        knowledgeContainer.appendChild(itemDiv);
                    });
                }
            }

            exportKnowledge() {
                if (this.knowledgeBase.size === 0) {
                    this.showWarning("„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„ÇãÂ≠¶Áøí„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                    return;
                }
                const knowledgeArray = Array.from(this.knowledgeBase.values()).map(item => ({
                    // id „ÅØ Map „ÅÆ„Ç≠„Éº„Å™„ÅÆ„Åß„ÄÅ„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊôÇ„Å´„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åã„ÄÅÂà•ÈÄîÁîüÊàê„Åô„Çã
                    ...item,
                    timestamp: item.timestamp.toISOString() // ISOÂΩ¢Âºè„Åß‰øùÂ≠ò
                }));

                const dataStr = JSON.stringify(knowledgeArray, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `crossthink_knowledge_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link); // Firefox„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´ÂøÖË¶Å
                link.click();
                document.body.removeChild(link); // „Åô„Åê„Å´ÂâäÈô§
                
                URL.revokeObjectURL(url);
                
                this.addMessage('learning', 
                    `üì§ Â≠¶Áøí„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü (${knowledgeArray.length}‰ª∂)`);
            }

            importKnowledge() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const importedData = JSON.parse(event.target.result);
                                let importCount = 0;
                                
                                if (!Array.isArray(importedData)) {
                                    this.showError('„Ç§„É≥„Éù„Éº„Éà„Éï„Ç°„Ç§„É´„ÅØJSONÈÖçÂàóÂΩ¢Âºè„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                                    return;
                                }

                                importedData.forEach((item, index) => {
                                    // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                                    if (item.topic && item.content && item.timestamp && item.source) {
                                        // ID„ÅØ„Ç§„É≥„Éù„Éº„ÉàÊôÇ„Å´Êñ∞Ë¶èÁîüÊàê„Åô„Çã„Åã„ÄÅ„Éï„Ç°„Ç§„É´ÂÜÖ„Å´„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÜ
                                        const itemId = item.id || `imported_${new Date(item.timestamp).getTime()}_${index}`;
                                        this.knowledgeBase.set(itemId, {
                                            ...item,
                                            timestamp: new Date(item.timestamp) // Date„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ
                                        });
                                        importCount++;
                                    } else {
                                        console.warn(`Skipping invalid item at index ${index}:`, item);
                                    }
                                });
                                
                                this.updateKnowledgeDisplay();
                                this.updateStats();
                                this.addMessage('learning', 
                                    `üì• Â≠¶Áøí„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü (${importCount}‰ª∂)`);
                            } catch (error) {
                                this.showError('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Åæ„Åü„ÅØËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                                console.error("Import error:", error);
                            }
                        };
                        reader.onerror = () => {
                            this.showError('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            }

            clearKnowledge() {
                if (confirm('Â≠¶Áøí„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÊôÇ„ÅÆ„Éá„Éº„Çø‰ª•Â§ñ„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                    const systemInitData = this.knowledgeBase.get('system_init');
                    this.knowledgeBase.clear();
                    if(systemInitData) this.knowledgeBase.set('system_init', systemInitData); // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Éá„Éº„Çø„ÅØÊÆã„Åô
                    
                    this.updateKnowledgeDisplay();
                    this.updateStats();
                    this.addMessage('learning', 'üóëÔ∏è Â≠¶Áøí„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü (ÂàùÊúüÂåñ„Éá„Éº„ÇøÈô§„Åè)');
                }
            }

            showLearningStats() {
                const totalItems = this.knowledgeBase.size;
                const sourceStats = {};
                
                this.knowledgeBase.forEach(item => {
                    sourceStats[item.source] = (sourceStats[item.source] || 0) + 1;
                });

                let statsText = `üìä Â≠¶ÁøíÁµ±Ë®à:\nÁ∑è„Ç¢„Ç§„ÉÜ„É†Êï∞: ${totalItems}\n\n„ÇΩ„Éº„ÇπÂà•ÂÜÖË®≥:\n`;
                Object.entries(sourceStats).forEach(([source, count]) => {
                    statsText += `  ‚Ä¢ ${source}: ${count}‰ª∂\n`;
                });

                this.addMessage('learning', statsText);
            }

            pauseDialogue(triggeredBySystem = false) { // „Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÂëº„Å≥Âá∫„Åó„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
                if (!this.isRunning) return;

                this.isPaused = !this.isPaused;
                this.elements.pauseBtn.textContent = this.isPaused ? '‚ñ∂Ô∏è ÂÜçÈñã' : '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                
                const statusMessage = this.isPaused ? '‚è∏Ô∏è ÂØæË©±„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü' : '‚ñ∂Ô∏è ÂØæË©±„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü';
                if (!triggeredBySystem || !this.isPaused) { // „Ç∑„Çπ„ÉÜ„É†„Åå‰ªãÂÖ•„Éó„É≠„É≥„Éó„ÉàË°®Á§∫„ÅßÂÅúÊ≠¢„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÂÜçÈñãÊôÇ„ÅÆ„Åø„É°„ÉÉ„Çª„Éº„Ç∏
                    this.addMessage('system', statusMessage);
                }
                
                if (!this.isPaused && this.isRunning && !this.waitingForIntervention) {
                    // ÂÜçÈñãÊôÇ„Å´„ÄÅÊúÄÂæå„Å´Áô∫Ë®Ä„Åó„ÅüAI„ÅÆÊ¨°„ÅÆAI„Åã„ÇâÁ∂ôÁ∂ö
                    setTimeout(() => {
                        if (this.isRunning && !this.isPaused && this.messageCount < this.maxMessages && this.conversationHistory.length > 0) {
                            const lastMessage = this.conversationHistory[this.conversationHistory.length -1];
                            const nextProvider = lastMessage.provider === 'openai' ? 'gemini' : 'openai';
                            const resumePrompt = this.generateResumePrompt(lastMessage.message);
                            this.sendMessage(nextProvider, resumePrompt);
                        } else if (this.conversationHistory.length === 0) { // „Åæ„Å†‰Ωï„ÇÇÁô∫Ë®Ä„Åå„Å™„ÅÑÂ†¥Âêà
                             const topic = this.elements.topicInput.value.trim();
                             const initialPrompt = this.generateInitialPrompt(topic);
                             this.sendMessage('openai', initialPrompt); //ÊúÄÂàù„ÅÆAI„Åã„Çâ
                        }
                    }, 1000);
                }
            }

            generateResumePrompt(lastMessageContent) {
                return `ÂØæË©±„ÅåÂÜçÈñã„Åï„Çå„Åæ„Åó„Åü„ÄÇÁõ¥Ââç„ÅÆÁô∫Ë®Ä„ÅØ„Äå${lastMessageContent.substring(0,100)}...„Äç„Åß„Åó„Åü„ÄÇ„Åì„ÅÆË≠∞Ë´ñ„ÇíË∏è„Åæ„Åà„Å¶„ÄÅ„Åï„Çâ„Å´Ê∑±„ÅÑÊ¥ûÂØü„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            }

            stopDialogue() {
                this.isRunning = false;
                this.isPaused = false; // ÂÅúÊ≠¢ÊôÇ„ÅØ‰∏ÄÊôÇÂÅúÊ≠¢„ÇÇËß£Èô§
                this.waitingForIntervention = false;
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.stopBtn.disabled = true;
                this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                
                const finalStatsSummary = this.generateFinalStats();
                this.addMessage('system', 
                    `üõë ÂØæË©±ÁµÇ‰∫Ü\n\n` + // ‚òÖ‰øÆÊ≠£ÁÇπ2: ‰∏çË¶Å„Å™ÊñáÂ≠óÂàó„Å®Ë°å„ÇíÊï¥ÁêÜ
                    `üìä ÊúÄÁµÇÁµ±Ë®à:\n` +
                    `‚Ä¢ Á∑è„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.messageCount}\n` +
                    `‚Ä¢ ChatGPT: ${this.openaiCount}Âõû\n` +
                    `‚Ä¢ Gemini: ${this.geminiCount}Âõû\n` +
                    `‚Ä¢ ‰∫∫Èñì‰ªãÂÖ•: ${this.humanCount}Âõû\n` +
                    `‚Ä¢ Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†: ${this.knowledgeBase.size}‰ª∂\n` +
                    `‚Ä¢ ÂØæË©±ÊôÇÈñì: ${this.startTime ? Math.floor((Date.now() - this.startTime) / 1000) : 0}Áßí\n\n` +
                    `üß† Â≠¶Áøí„Åï„Çå„Åü‰∏ªË¶Å„Å™Ê¥ûÂØü„Åå„Éä„É¨„ÉÉ„Ç∏„Éô„Éº„Çπ„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ`
                );
                
                this.learnFromDialogue('ÂØæË©±ÁµÇ‰∫Ü', `ÂØæË©±„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ${finalStatsSummary}`);
            }

            generateFinalStats() {
                return `Á∑è„É°„ÉÉ„Çª„Éº„Ç∏: ${this.messageCount}, ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount}, ‰∫∫Èñì‰ªãÂÖ•: ${this.humanCount}, Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†: ${this.knowledgeBase.size}`;
            }

            async callOpenAI(prompt) {
                const apiKey = this.elements.openaiKey.value.trim();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo', // „É¢„Éá„É´„ÅØÈÅ©ÂÆúÂ§âÊõ¥ÂèØËÉΩ
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1500, // ÂøúÁ≠î„ÅÆÊúÄÂ§ßÈï∑
                        temperature: 0.7, // ÂøúÁ≠î„ÅÆÂ§öÊßòÊÄß (0-1)
                        top_p: 0.9,       // „Éà„Éº„ÇØ„É≥ÈÅ∏Êäû„ÅÆÂ§öÊßòÊÄß
                        // frequency_penalty: 0.1 // È†ªÂá∫„Éà„Éº„ÇØ„É≥„ÅÆÊäëÂà∂ (ÂøÖË¶Å„Å´Âøú„Åò„Å¶)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: "Unknown API error" }));
                    throw new Error(`OpenAI API error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('OpenAI API„Åã„Çâ‰∫àÊúü„Åó„Å™„ÅÑÂΩ¢Âºè„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åó„Åü„ÄÇ');
                }
            }

            async callGemini(prompt) {
                const apiKey = this.elements.geminiKey.value.trim();
                
                // Êé®Â•®„É¢„Éá„É´È†Ü„Å´Ë©¶Ë°å (‰æã: Flash -> Pro)
                const models = ['gemini-1.5-flash-latest', 'gemini-pro'];
                let lastError = null;

                for (const model of models) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }],
                                generationConfig: {
                                    maxOutputTokens: 1500,
                                    temperature: 0.6,
                                    topP: 0.8,
                                    // topK: 40 // ÂøÖË¶Å„Å´Âøú„Åò„Å¶
                                }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                                return data.candidates[0].content.parts[0].text;
                            } else {
                                // „É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„Åå‰∏çÊ≠£„Å™Â†¥Âêà„ÇÇ„Ç®„É©„Éº„Å®„Åó„Å¶Êâ±„ÅÜ
                                lastError = new Error(`Gemini API (${model}) „Åã„Çâ‰∫àÊúü„Åó„Å™„ÅÑÂΩ¢Âºè„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åó„Åü„ÄÇ`);
                                continue; // Ê¨°„ÅÆ„É¢„Éá„É´„ÇíË©¶Ë°å
                            }
                        } else {
                             const errorData = await response.json().catch(() => ({ message: "Unknown API error" }));
                             lastError = new Error(`Gemini API error (${model}): ${response.status} - ${errorData.error?.message || response.statusText}`);
                             if (response.status === 429) { // Rate limit „ÅÆÂ†¥Âêà„ÅØ„Åô„Åê„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                                 console.warn(`Gemini API (${model}) rate limit exceeded.`);
                                 break;
                             }
                             // ‰ªñ„ÅÆ„Ç®„É©„Éº„Å™„ÇâÊ¨°„ÅÆ„É¢„Éá„É´„ÇíË©¶„Åô
                        }
                    } catch (error) {
                        lastError = error; // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Å™„Å©
                        console.error(`Error calling Gemini API (${model}):`, error);
                    }
                }
                // „Åô„Åπ„Å¶„ÅÆ„É¢„Éá„É´„ÅßÂ§±Êïó„Åó„ÅüÂ†¥Âêà
                console.warn("All Gemini models failed. Using fallback response.", lastError);
                return this.generateFallbackResponse(prompt, lastError ? lastError.message : "APIÂëº„Å≥Âá∫„Åó„Å´Â§±Êïó");
            }

            generateFallbackResponse(prompt, reason = "APIÂëº„Å≥Âá∫„Åó„Å´Â§±Êïó") {
                return `Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅÊäÄË°ìÁöÑ„Å™ÂïèÈ°å„Å´„Çà„ÇäAI„Åã„Çâ„ÅÆÂøúÁ≠î„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ(ÁêÜÁî±: ${reason})\n` +
                        "ÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„ÅÑ„Åü„Å†„Åè„Åã„ÄÅÁÆ°ÁêÜËÄÖ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ\n" +
                        "‚Äª„Åì„Çå„ÅØ‰ª£ÊõøÂøúÁ≠î„Åß„Åô„ÄÇ";
            }

            generateSummaryPrompt() {
                const topic = this.elements.topicInput.value.trim();
                
                if (this.conversationHistory.length === 0) {
                    this.showError('Ë¶ÅÁ¥ÑÂØæË±°„ÅÆÂØæË©±„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂØæË©±„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                let conversationLog = '';
                let humanInterventionsLog = ''; // ‰∫∫Èñì‰ªãÂÖ•„ÅÆ„Åø„ÇíÊäΩÂá∫
                let learningInsightsLog = '';   // Â≠¶Áøí„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Åø„ÇíÊäΩÂá∫

                this.conversationHistory.forEach(entry => {
                    const formattedMessage = `${entry.provider.toUpperCase()}: ${entry.message}\n`;
                    conversationLog += formattedMessage;
                    if(entry.provider === 'human') {
                        humanInterventionsLog += `${entry.message}\n\n`;
                    }
                });
                
                this.elements.chatContainer.querySelectorAll('.learning-message div:not(.message-header)').forEach(el => {
                    learningInsightsLog += el.textContent.trim() + '\n\n';
                });


                let knowledgeBaseSummary = '‰∏ª„Å™Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†:\n';
                let count = 0;
                for (const item of this.knowledgeBase.values()) {
                    if (item.source !== 'system_init' && item.source !== 'dialogue_event' && count < 5) { // ‰∏ªË¶Å„Å™„ÇÇ„ÅÆ„Çí5‰ª∂Á®ãÂ∫¶
                        knowledgeBaseSummary += `  - [${item.source}] ${item.topic}: ${item.content.substring(0, 80)}...\n`;
                        count++;
                    }
                }
                if (count === 0) knowledgeBaseSummary = "Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†„ÅØ„Åæ„Å†Â∞ë„Å™„ÅÑ„Åß„Åô„ÄÇ\n";


                const summaryPrompt = `Crossthink v5.0 Advanced Interactive Edition „ÅßË°å„Çè„Çå„Åü‰ª•‰∏ã„ÅÆÂØæË©±„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁ∑èÂêàÁöÑ„Å´ÂàÜÊûê„Åó„ÄÅ„Éà„Éî„ÉÉ„ÇØ„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶ÂåÖÊã¨ÁöÑ„Å™„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Äê„Çª„ÉÉ„Ç∑„Éß„É≥Ê¶ÇË¶Å„Äë
- ÂØæË©±„É¢„Éº„Éâ: ${this.getTargetLabel()} √ó ${this.getGoalLabel()}
- Á∑èAI„É°„ÉÉ„Çª„Éº„Ç∏Êï∞: ${this.openaiCount + this.geminiCount} (ChatGPT: ${this.openaiCount}, Gemini: ${this.geminiCount})
- ‰∫∫Èñì‰ªãÂÖ•ÂõûÊï∞: ${this.humanCount}
- Ëá™ÂãïÂ≠¶Áøí„Ç¢„Ç§„ÉÜ„É†Êï∞ (ÊäúÁ≤ã): ${Math.min(count, 5)} / ${this.knowledgeBase.size -1} (ÂàùÊúüÂåñ„Éá„Éº„ÇøÈô§„Åè)

„Äêv5.0 Advanced Interactive Edition „ÅÆÁâπÂæ¥„ÇíËÄÉÊÖÆ„Åó„ÅüÂàÜÊûêË¶ÅÊ±Ç„Äë
1.  **AIËá™ÂæãÂØæË©±„ÅÆÂìÅË≥™Ë©ï‰æ°**:
    * ChatGPT„Å®Gemini„Åå„Åù„Çå„Åû„Çå„Å©„ÅÆ„Çà„ÅÜ„Å™Ë≤¢ÁåÆ„Çí„Åó„Åü„Åã„ÄÇ
    * AIÈñì„ÅÆË≠∞Ë´ñ„ÅØÂª∫Ë®≠ÁöÑ„Åß„ÄÅ„Éà„Éî„ÉÉ„ÇØ„ÅÆÊé¢Ê±Ç„Å´Ê∑±„Åø„Çí„ÇÇ„Åü„Çâ„Åó„Åü„Åã„ÄÇ
2.  **‰∫∫Èñì‰ªãÂÖ•„ÅÆÂäπÊûúÂàÜÊûê**:
    * ‰∫∫Èñì‰ªãÂÖ•„ÅØË≠∞Ë´ñ„ÅÆÊñπÂêëÊÄß„ÇÑË≥™„Å´„Å©„ÅÆ„Çà„ÅÜ„Å™ÂΩ±Èüø„Çí‰∏é„Åà„Åü„Åã„ÄÇ
    * AI„Å®‰∫∫Èñì„ÅÆÂçîÂÉç„ÅØÂäπÊûúÁöÑ„Å†„Å£„Åü„Åã„ÄÇ
3.  **Ëá™ÂãïÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†„ÅÆÊàêÊûú**:
    * Ëá™ÂãïÂ≠¶ÁøíÊ©üËÉΩ„Å´„Çà„Å£„Å¶„Å©„ÅÆ„Çà„ÅÜ„Å™ÈáçË¶Å„Å™Ê¥ûÂØü„ÅåÊäΩÂá∫„Åï„Çå„Åü„ÅãÔºà‰∏äË®ò„Äå‰∏ª„Å™Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†„ÄçÂèÇÁÖßÔºâ„ÄÇ
    * „Åì„ÅÆÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†„ÅØÂØæË©±ÂÜÖÂÆπ„ÅÆ‰æ°ÂÄ§„ÇíÊçâ„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Åã„ÄÇ
4.  **Á∑èÂêàÁöÑÁµêË´ñ„Å®ÊèêË®Ä**:
    * „Åì„ÅÆÂØæË©±„Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÂæó„Çâ„Çå„ÅüÊúÄ„ÇÇÈáçË¶Å„Å™Áô∫Ë¶ã„ÇÑÁµêË´ñ„ÅØ‰Ωï„Åã„ÄÇ
    * Crossthink v5.0 „ÅÆ„Çà„ÅÜ„Å™Áµ±Âêà„Ç∑„Çπ„ÉÜ„É†ÔºàËá™ÂæãÂØæË©±„Éª‰∫∫Èñì‰ªãÂÖ•„ÉªÂ≠¶ÁøíÔºâ„ÅÆÊΩúÂú®ÁöÑ„Å™‰æ°ÂÄ§„ÇÑÊîπÂñÑÁÇπ„ÅØ‰Ωï„Åã„ÄÇ

„ÄêÂØæË©±„É≠„Ç∞ÂÖ®Êñá„Äë
${conversationLog}
${humanInterventionsLog ? "\n„Äê‰∏ª„Å™‰∫∫Èñì‰ªãÂÖ•ÂÜÖÂÆπ„Äë\n" + humanInterventionsLog : ""}
${learningInsightsLog ? "\n„ÄêÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆÈÄöÁü•„Äë\n" + learningInsightsLog : ""}
${knowledgeBaseSummary}

„Äê„É¨„Éù„Éº„ÉàÊßãÊàêÊ°à„Äë
1.  „ÅØ„Åò„ÇÅ„Å´ („Éà„Éî„ÉÉ„ÇØ„Å®„Çª„ÉÉ„Ç∑„Éß„É≥Ê¶ÇË¶Å)
2.  AIËá™ÂæãÂØæË©±„ÅÆÂàÜÊûê (ÂêÑAI„ÅÆË≤¢ÁåÆ„ÄÅÁõ∏‰∫í‰ΩúÁî®)
3.  ‰∫∫Èñì‰ªãÂÖ•„ÅÆÂΩ±Èüø„Å®AI-‰∫∫ÈñìÂçîÂÉç„ÅÆË©ï‰æ°
4.  Â≠¶ÁøíÊ©üËÉΩ„Å´„Çà„ÇãÊ¥ûÂØüÊäΩÂá∫„ÅÆË©ï‰æ°
5.  Á∑èÂêàÁöÑÁµêË´ñ„Å®‰ªäÂæå„ÅÆÂ±ïÊúõ/ÊèêË®Ä

„É¨„Éù„Éº„Éà„ÅØË©≥Á¥∞„Åã„Å§ÂÖ∑‰ΩìÁöÑ„Åß„ÄÅ4000ÔΩû5000Â≠óÁ®ãÂ∫¶„ÇíÁõÆÂÆâ„Å®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇCrossthink v5.0„ÅÆÂêÑÊ©üËÉΩ„Åå„Å©„ÅÆ„Çà„ÅÜ„Å´ÈÄ£Êê∫„Åó„ÄÅ„Å©„ÅÆ„Çà„ÅÜ„Å™‰æ°ÂÄ§„ÇíÁîü„ÅøÂá∫„Åó„Åü„Åã„ÇíÊòéÁ¢∫„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(summaryPrompt).then(() => {
                        this.addMessage('system', 
                            'üìã Crossthink v5.0 Advanced Interactive Edition Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ\n\n' +
                            '„Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÈ´òÊÄßËÉΩ„Å™LLM (‰æã: GPT-4, Claude 3 Opus, Gemini Advanced„Å™„Å©) „Å´ÂÖ•Âäõ„Åó„Å¶„ÄÅË©≥Á¥∞„Å™„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            `„Éó„É≠„É≥„Éó„ÉàÊñáÂ≠óÊï∞: ${summaryPrompt.length}ÊñáÂ≠ó`
                        );
                    }).catch(err => {
                        console.error('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó:', err);
                        this.showPromptWindow(summaryPrompt); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    });
                } else {
                    this.showPromptWindow(summaryPrompt); // HTTPS„Åß„Å™„ÅÑÂ†¥Âêà„Å™„Å©
                }
            }

            showPromptWindow(summaryPrompt) {
                const summaryWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
                if (summaryWindow) {
                    summaryWindow.document.write(`
                        <html>
                            <head>
                                <title>Crossthink v5.0 Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà</title>
                                <style>
                                    body { font-family: system-ui, sans-serif; margin: 0; padding: 1em; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                                    .container { background-color: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 90%; max-width: 800px; }
                                    h2 { margin-top: 0; color: #333; }
                                    textarea { width: 100%; height: 60vh; margin-bottom: 1em; padding: 0.8em; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 0.9em; box-sizing: border-box; }
                                    button { padding: 0.8em 1.5em; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 0.5em; }
                                    .copy-btn { background-color: #4CAF50; color: white; }
                                    .close-btn { background-color: #f44336; color: white; }
                                    .stats { font-size: 0.9em; background-color: #e7f3fe; padding: 0.8em; border-radius: 4px; margin-bottom: 1em; border-left: 4px solid #2196F3;}
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <h2>üöÄ Crossthink v5.0 Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà</h2>
                                    <div class="stats">
                                      <strong>ÊÉÖÂ†±:</strong> „Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÈ´òÊÄßËÉΩLLM„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÄÅÂØæË©±„ÅÆÂåÖÊã¨ÁöÑ„Å™„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                                      ÊñáÂ≠óÊï∞: ${summaryPrompt.length}
                                    </div>
                                    <textarea id="promptArea" readonly>${summaryPrompt.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</textarea>
                                    <button class="copy-btn" onclick="document.getElementById('promptArea').select(); document.execCommand('copy'); alert('„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');">üìã „Ç≥„Éî„Éº</button>
                                    <button class="close-btn" onclick="window.close();">‚ùå Èñâ„Åò„Çã</button>
                                </div>
                            </body>
                        </html>
                    `);
                    summaryWindow.document.close(); // ÈáçË¶Å
                } else {
                    this.addMessage('system', 
                        '‚ö†Ô∏è „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                        '„Éó„É≠„É≥„Éó„Éà„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ„Åï„Çå„Åæ„Åó„Åü„ÄÇ'
                    );
                    console.log("Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà:\n", summaryPrompt);
                }
            }

            addMessage(provider, content, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${provider}-message`;

                const now = new Date();
                const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit'});

                let providerName, emoji, roleDesc = '';
                switch (provider) {
                    case 'openai':
                        providerName = 'ChatGPT'; emoji = 'üü¢'; roleDesc = ` (${this.targetMode})`;
                        this.currentSpeaker = 'openai'; // ÊúÄÂæå„Å´Áô∫Ë®Ä„Åó„ÅüAI„ÇíË®òÈå≤
                        break;
                    case 'gemini':
                        providerName = 'Gemini'; emoji = 'üî∑'; roleDesc = ` (${this.targetMode})`;
                        this.currentSpeaker = 'gemini'; // ÊúÄÂæå„Å´Áô∫Ë®Ä„Åó„ÅüAI„ÇíË®òÈå≤
                        break;
                    case 'human':
                        providerName = '„ÅÇ„Å™„Åü'; emoji = 'üë§';
                        break;
                    case 'learning':
                        providerName = 'Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†'; emoji = 'üß†';
                        break;
                    case 'system': default:
                        providerName = 'Crossthink v5.0'; emoji = 'üöÄ';
                        break;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${emoji} ${providerName}${roleDesc}
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="${isThinking ? 'thinking' : ''}">${content.replace(/\n/g, '<br>')}</div>
                `;

                this.elements.chatContainer.appendChild(messageDiv);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;

                if (!isThinking && (provider === 'openai' || provider === 'gemini' || provider === 'human')) {
                    this.messageCount++; // AI„Å®‰∫∫Èñì„ÅÆÂøúÁ≠î„ÅÆ„Åø„Ç´„Ç¶„É≥„Éà
                    // this.updateStats(); // sendMessage „ÅÆ finally „Åß„Åæ„Å®„ÇÅ„Å¶Êõ¥Êñ∞
                }
            }

            removeLastMessage() {
                const messages = this.elements.chatContainer.querySelectorAll('.message');
                if (messages.length > 0) {
                    messages[messages.length - 1].remove();
                }
            }

            clearChat() {
                this.elements.chatContainer.innerHTML = '';
                this.messageCount = 0;
                this.openaiCount = 0;
                this.geminiCount = 0;
                this.humanCount = 0;
                this.conversationHistory = [];
                this.interventionPoints = [];
                if (this.startTime) this.startTime = null; // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
                this.elements.elapsed.textContent = '0';

                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇÇ„É™„Çª„ÉÉ„Éà
                this.elements.startBtn.disabled = false;
                this.elements.pauseBtn.disabled = true;
                this.elements.pauseBtn.textContent = '‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢';
                this.elements.stopBtn.disabled = true;
                this.isPaused = false;
                this.isRunning = false;


                this.updateStats(); // Áµ±Ë®àË°®Á§∫„Çí0„Å´
                this.showWelcomeMessage();
                this.hideError();
                this.hideWarning();
            }

            showError(message) {
                this.elements.errorDisplay.textContent = `‚ùå „Ç®„É©„Éº: ${message}`;
                this.elements.errorDisplay.style.display = 'block';
                this.elements.warningDisplay.style.display = 'none'; // „Ç®„É©„ÉºË°®Á§∫ÊôÇ„ÅØË≠¶Âëä„ÇíÈö†„Åô
            }

            hideError() {
                this.elements.errorDisplay.style.display = 'none';
            }

            showWarning(message) {
                this.elements.warningDisplay.textContent = `‚ö†Ô∏è Ë≠¶Âëä: ${message}`;
                this.elements.warningDisplay.style.display = 'block';
                 this.elements.errorDisplay.style.display = 'none'; // Ë≠¶ÂëäË°®Á§∫ÊôÇ„ÅØ„Ç®„É©„Éº„ÇíÈö†„Åô
            }

            hideWarning() {
                this.elements.warningDisplay.style.display = 'none';
            }

            updateStats() {
                this.elements.totalMessages.textContent = this.messageCount;
                this.elements.openaiMessages.textContent = this.openaiCount;
                this.elements.geminiMessages.textContent = this.geminiCount;
                this.elements.humanMessages.textContent = this.humanCount;
                this.elements.learningItems.textContent = this.knowledgeBase.size;
            }

            startTimer() {
                const updateTimerDisplay = () => {
                    if (this.isRunning && !this.isPaused && this.startTime) { // ÂÆüË°å‰∏≠„Åß‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞
                        const elapsedSeconds = Math.floor((Date.now() - this.startTime) / 1000);
                        this.elements.elapsed.textContent = elapsedSeconds;
                    }
                    if (this.isRunning) { // isRunning„ÅÆÈñì„ÅØ„Çø„Ç§„Éû„Éº„ÇíÂëº„Å≥Âá∫„ÅóÁ∂ö„Åë„Çã
                        setTimeout(updateTimerDisplay, 1000);
                    }
                };
                if (this.isRunning) {
                    updateTimerDisplay();
                }
            }

            getTargetLabel() {
                const labels = { 'practical': 'üè† ÂÆüÁî®ÁöÑ', 'business': 'üíº „Éì„Ç∏„Éç„Çπ', 'philosophical': 'üß† Âì≤Â≠¶ÁöÑ' };
                return labels[this.targetMode] || this.targetMode;
            }

            getGoalLabel() {
                const labels = { 'ideation': 'üí° Ê°àÂá∫„Åó', 'consensus': 'ü§ù ÂêàÊÑèÂΩ¢Êàê', 'exploration': 'üîç Êé¢Á¥¢' };
                return labels[this.goalMode] || this.goalMode;
            }

            getInterventionLabel() {
                const labels = ['„Å™„Åó', 'Á®Ä', 'Â∞ë', '‰∏≠', 'Â§ö', 'È†ªÁπÅ', 'ÈùûÂ∏∏„Å´È†ªÁπÅ', 'Â∏∏ÊôÇ', '„É™„Ç¢„É´„Çø„Ç§„É†', '„Ç∑„É≥„ÇØ„É≠', '„Éï„É´‰ªãÂÖ•'];
                return labels[this.interventionFrequency] || '‰∏≠Á®ãÂ∫¶';
            }
        }

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // event.target „Åå button Ë¶ÅÁ¥†„Åß„ÅÇ„Çã„Åì„Å®„Çí‰øùË®º (button Ë¶ÅÁ¥†„Å´ onclick „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ)
            const clickedButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.textContent.trim().includes(
                tabName === 'autonomous' ? 'AIËá™ÂæãÂØæË©±' :
                tabName === 'intervention' ? '‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ' :
                'Â≠¶ÁøíÊ©üËÉΩ'
            ));

            if (clickedButton) {
                 clickedButton.classList.add('active');
            }
           
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (window.crossthinkSystem) {
                window.crossthinkSystem.currentTab = tabName;
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºà‰ªãÂÖ•„Éó„É≠„É≥„Éó„ÉàÁî®„Å™„Å©Ôºâ
        function continueAutonomously() {
            if (window.crossthinkSystem) {
                window.crossthinkSystem.waitingForIntervention = false;
                
                const interventionPrompts = document.querySelectorAll('.intervention-prompt');
                interventionPrompts.forEach(prompt => prompt.remove());
                
                // ÂØæË©±„ÇíÂÜçÈñãÔºàpauseDialogue„ÅåÂÜÖÈÉ®„ÅßisPaused„ÇíÂèçËª¢„Åï„Åõ„Çã„ÅÆ„Åß„ÄÅfalse„ÇíÊ∏°„Åó„Å¶ÂÜçÈñã„Åï„Åõ„ÇãÔºâ
                window.crossthinkSystem.pauseDialogue(true); // „Ç∑„Çπ„ÉÜ„É†„Åå‰ªãÂÖ•„Éó„É≠„É≥„Éó„Éà„Åã„ÇâÂÜçÈñã„Åó„Åü„Åì„Å®„ÇíÁ§∫„Åô
            }
        }

        function switchToInterventionTab() {
            // `event.target` „Çí‰Ωø„Çè„Åö„Å´„Çø„Éñ„Éú„Çø„É≥„ÇíÁâπÂÆö„Åó„Å¶„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åï„Åõ„Çã„Åã„ÄÅÁõ¥Êé• `switchTab` „ÇíÂëº„Å∂
            const interventionButton = Array.from(document.querySelectorAll('.tab-button')).find(btn => btn.textContent.trim().includes('‰∫∫Èñì‰ªãÂÖ•„É¢„Éº„Éâ'));
            if (interventionButton) {
                 interventionButton.click(); // „Åì„Çå„Åß switchTab('intervention') „ÅåÂëº„Å∞„Çå„Çã
            } else {
                 switchTab('intervention'); // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            }
            
            if (window.crossthinkSystem) {
                window.crossthinkSystem.addMessage('system', 'üë§ ‰∫∫Èñì‰ªãÂÖ•„Çø„Éñ„Å´Âàá„ÇäÊõø„Çè„Çä„Åæ„Åó„Åü„ÄÇ‰ªãÂÖ•ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„ÄÅ„ÄåÂØæË©±„Å´‰ªãÂÖ•„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                window.crossthinkSystem.elements.humanInput.focus();
            }
        }

        // HTML„ÅÆonclickÂ±ûÊÄß„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„Çã„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Áæ§
        function humanIntervention() { if (window.crossthinkSystem) window.crossthinkSystem.humanIntervention(); }
        function requestDeepening() { if (window.crossthinkSystem) window.crossthinkSystem.requestDeepening(); }
        function redirectDialogue() { if (window.crossthinkSystem) window.crossthinkSystem.redirectDialogue(); }
        function saveInsight() { if (window.crossthinkSystem) window.crossthinkSystem.saveInsight(); }
        function quickIntervention(type) { if (window.crossthinkSystem) window.crossthinkSystem.quickIntervention(type); }
        function exportKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.exportKnowledge(); }
        function importKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.importKnowledge(); }
        function clearKnowledge() { if (window.crossthinkSystem) window.crossthinkSystem.clearKnowledge(); }
        function showLearningStats() { if (window.crossthinkSystem) window.crossthinkSystem.showLearningStats(); }

        // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.crossthinkSystem = new CrossthinkAdvanced();
                console.log('CrossthinkÁµ±Âêà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É† v5.0 Advanced Interactive Edition ÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                alert('„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åô„Çã„Åã„ÄÅÈñãÁô∫ËÄÖ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
        window.addEventListener('error', (event) => {
            console.error('Êú™Âá¶ÁêÜ„ÅÆ„Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº:', event.error, 'Message:', event.message, 'File:', event.filename, 'Line:', event.lineno);
            if (window.crossthinkSystem && window.crossthinkSystem.showError) {
                window.crossthinkSystem.showError(`‰∫àÊúü„Åõ„Å¨„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${event.message}`);
            } else {
                // alert(`‰∫àÊúü„Åõ„Å¨„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n${event.message}`);
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Êú™Âá¶ÁêÜ„ÅÆPromiseÊãíÂê¶:', event.reason);
            if (window.crossthinkSystem && window.crossthinkSystem.showWarning) {
                let message = 'ÈùûÂêåÊúüÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                if (event.reason && event.reason.message) {
                    message += ` ${event.reason.message}`;
                } else if (typeof event.reason === 'string') {
                    message += ` ${event.reason}`;
                }
                window.crossthinkSystem.showWarning(message);
            } else {
                // alert('ÈùûÂêåÊúüÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });
    </script>
</body>
</html>